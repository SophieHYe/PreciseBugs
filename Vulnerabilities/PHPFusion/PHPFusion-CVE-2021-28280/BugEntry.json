{"buggy_code": ["<?php\n/*-------------------------------------------------------+\n| PHPFusion Content Management System\n| Copyright (C) PHP Fusion Inc\n| https://phpfusion.com/\n+--------------------------------------------------------+\n| Filename: form_buttons.php\n| Author: Frederick MC Chan (Chan)\n| Co-Author: Tyler Hurlbut\n+--------------------------------------------------------+\n| This program is released as free software under the\n| Affero GPL license. You can redistribute it and/or\n| modify it under the terms of this license which you\n| can read by viewing the included agpl.txt or online\n| at www.gnu.org/licenses/agpl.html. Removal of this\n| copyright header is strictly prohibited without\n| written permission from the original author(s).\n+--------------------------------------------------------*/\n\nfunction form_button($input_name, $title, $input_value, array $options = []) {\n    $html = \"\";\n\n    $input_value = stripinput($input_value);\n\n    $default_options = [\n        'input_id'    => $input_name,\n        'input_value' => $input_name,\n        'class'       => \"btn-default\",\n        'icon_class'  => \"m-r-10\",\n        'icon'        => \"\",\n        'deactivate'  => FALSE,\n        'type'        => \"submit\",\n        'block'       => FALSE,\n        'alt'         => $title,\n        'data'        => [],\n    ];\n    $options += $default_options;\n\n    if ($options['block']) {\n        $options['class'] = $options['class'].\" btn-block\";\n    }\n\n    array_walk($options['data'], function ($a, $b) use (&$options_data) {\n        $options_data[] = \"data-$b='$a'\";\n    }, $options_data);\n\n    if ($options['type'] == 'link') {\n        $html .= \"<a id='\".$options['input_id'].\"' title='\".$options['alt'].\"' class='\".($options['deactivate'] ? 'disabled ' : '').\"btn \".$options['class'].\" button' href='\".$input_name.\"' data-value='\".$input_value.\"' \".(!empty($options_data) ? implode(' ', $options_data) : '').($options['deactivate'] ? \"disabled='disabled'\" : '').\" >\".($options['icon'] ? \"<i class='\".$options['icon'].\" \".$options['icon_class'].\"'></i>\" : '').$title.\"</a>\";\n    } else if ($options['type'] == 'button') {\n        $html .= \"<button id='\".$options['input_id'].\"' title='\".$options['alt'].\"' class='\".($options['deactivate'] ? 'disabled ' : '').\"btn \".$options['class'].\" button' name='\".$input_name.\"' value='\".$input_value.\"' type='button'\".(!empty($options_data) ? implode(' ', $options_data) : '').($options['deactivate'] ? \" disabled='disabled'\" : '').\" >\".($options['icon'] ? \"<i class='\".$options['icon'].\" \".$options['icon_class'].\"'></i>\" : '').$title.\"</button>\\n\";\n    } else {\n        $html .= \"<button id='\".$options['input_id'].\"' title='\".$options['alt'].\"' class='\".($options['deactivate'] ? 'disabled ' : '').\"btn \".$options['class'].\" button' name='\".$input_name.\"' value='\".$input_value.\"' type='submit'\".(!empty($options_data) ? implode(' ', $options_data) : '').($options['deactivate'] ? \" disabled='disabled'\" : '').\" >\".($options['icon'] ? \"<i class='\".$options['icon'].\" \".$options['icon_class'].\"'></i>\" : '').$title.\"</button>\\n\";\n    }\n\n    return $html;\n}\n\n/**\n * Button Groups\n *\n * @param        $input_name\n * @param string $label\n * @param        $input_value\n * @param array  $options\n *\n * @return string\n */\nfunction form_btngroup($input_name, $label, $input_value, array $options = []) {\n    $locale = fusion_get_locale();\n\n    $title = $label ? stripinput($label) : ucfirst(strtolower(str_replace(\"_\", \" \", $input_name)));\n    $input_value = (isset($input_value) && (!empty($input_value))) ? stripinput($input_value) : NULL;\n\n    $default_options = [\n        'options'        => [$locale['disable'], $locale['enable']],\n        'input_id'       => $input_name,\n        'class'          => \"btn-default\",\n        'type'           => 'button',\n        'icon'           => \"\",\n        'multiple'       => FALSE,\n        'delimiter'      => \",\",\n        'deactivate'     => FALSE,\n        'error_text'     => \"\",\n        'inline'         => FALSE,\n        'safemode'       => FALSE,\n        'required'       => FALSE,\n        'ext_tip'        => '',\n        'callback_check' => '',\n    ];\n\n    $options += $default_options;\n\n    $error_class = \"\";\n    if (\\defender::inputHasError($input_name)) {\n        $error_class = \"has-error\";\n        if (!empty($options['error_text'])) {\n            $new_error_text = \\defender::getErrorText($input_name);\n            if (!empty($new_error_text)) {\n                $options['error_text'] = $new_error_text;\n            }\n            addNotice('danger', \"<strong>$title</strong> - \".$options['error_text']);\n        }\n    }\n\n    $html = \"<div id='\".$options['input_id'].\"-field' class='form-group \".($options['inline'] && $label ? 'row ' : '').$error_class.\" clearfix'>\\n\";\n    $html .= ($label) ? \"<label class='control-label \".($options['inline'] ? \"col-xs-12 col-sm-12 col-md-3 col-lg-3\" : '').\"' for='\".$options['input_id'].\"'>\".$label.($options['required'] ? \"<span class='required'>&nbsp;*</span>\" : '').\"</label>\\n\" : '';\n    $html .= ($options['inline'] && $label) ? \"<div class='col-xs-12 col-sm-12 col-md-9 col-lg-9'>\\n\" : \"\";\n\n    $html .= \"<div class='btn-group' id='\".$options['input_id'].\"'>\";\n\n    if (!empty($options['options']) && is_array($options['options'])) {\n        $i = 1;\n        $option_count = count($options['options']);\n\n        foreach ($options['options'] as $arr => $v) {\n            $child_class = ($option_count == $i ? ' last-child ' : '');\n            $active_class = ($input_value == $arr ? ' active' : '');\n\n            if ($options['type'] == 'submit') {\n                $html .= \"<button name='$arr' type='submit' data-value='$arr' value='$arr' class='btn \".$options['class'].$child_class.$active_class.\"'>$v</button>\\n\";\n            } else {\n                $html .= \"<button type='button' data-value='$arr' class='btn \".$options['class'].$child_class.$active_class.\"'>$v</button>\\n\";\n            }\n\n            $i++;\n        }\n    }\n\n    $html .= \"</div>\\n\";\n    $html .= \"<input name='$input_name' type='hidden' id='\".$options['input_id'].\"-text' value='$input_value' />\\n\";\n\n    $html .= $options['ext_tip'] ? \"<br/>\\n<div class='m-t-10 tip'><i>\".$options['ext_tip'].\"</i></div>\" : \"\";\n    $html .= \\defender::inputHasError($input_name) ? \"<div id='\".$options['input_id'].\"-help' class='label label-danger p-5 display-inline-block'>\".$options['error_text'].\"</div>\" : \"\";\n    $html .= ($options['inline'] && $label) ? \"</div>\\n\" : \"\";\n    $html .= \"</div>\\n\";\n\n    $input_name = ($options['multiple']) ? str_replace(\"[]\", \"\", $input_name) : $input_name;\n\n    \\defender::add_field_session([\n        'input_name'     => $input_name,\n        'title'          => trim($title, '[]'),\n        'id'             => $options['input_id'],\n        'type'           => 'dropdown',\n        'required'       => $options['required'],\n        'callback_check' => $options['callback_check'],\n        'safemode'       => $options['safemode'],\n        'error_text'     => $options['error_text'],\n        'delimiter'      => $options['delimiter'],\n    ]);\n    add_to_jquery(\"\n    $('#\".$options['input_id'].\" button').bind('click', function(e){\n        $('#\".$options['input_id'].\" button').removeClass('active');\n        $(this).toggleClass('active');\n        value = $(this).data('value');\n        $('#\".$options['input_id'].\"-text').val(value);\n    });\n    \");\n\n    return $html;\n}\n", "<?php\n/*-------------------------------------------------------+\n| PHPFusion Content Management System\n| Copyright (C) PHP Fusion Inc\n| https://phpfusion.com/\n+--------------------------------------------------------+\n| Filename: form_checkbox.php\n| Author: Core Development Team (coredevs@phpfusion.com)\n+--------------------------------------------------------+\n| This program is released as free software under the\n| Affero GPL license. You can redistribute it and/or\n| modify it under the terms of this license which you\n| can read by viewing the included agpl.txt or online\n| at www.gnu.org/licenses/agpl.html. Removal of this\n| copyright header is strictly prohibited without\n| written permission from the original author(s).\n+--------------------------------------------------------*/\n\n/**\n * @param        $input_name\n * @param string $label\n * @param string $input_value\n * @param array  $options\n *\n * @return string\n */\nfunction form_checkbox($input_name, $label = '', $input_value = '0', array $options = []) {\n\n    $locale = fusion_get_locale('', LOCALE.LOCALESET.'global.php');\n\n    $default_options = [\n        'input_id'       => $input_name,\n        'inline'         => FALSE,\n        'inline_options' => FALSE,\n        'required'       => FALSE,\n        'deactivate'     => FALSE,\n        'class'          => '',\n        'type'           => 'checkbox',\n        'toggle'         => FALSE,\n        'toggle_text'    => [$locale['no'], $locale['yes']],\n        'options'        => [],\n        'options_value'  => [],\n        'delimiter'      => ',',\n        'safemode'       => FALSE,\n        'keyflip'        => FALSE,\n        'error_text'     => $locale['error_input_checkbox'],\n        'value'          => 1,\n        'tip'            => '',\n        'ext_tip'        => '',\n        'inner_width'    => '',\n        'reverse_label'  => FALSE,\n        'deactivate_key' => NULL,\n        'onclick'        => '',\n    ];\n\n    $options += $default_options;\n\n    $error_class = '';\n\n    $option_value = [];\n\n    $default_checked = FALSE;\n\n    if ($options['toggle']) {\n        if (!defined(\"CHECKBOX_SWITCH_CSS\")) {\n            define(\"CHECKBOX_SWITCH_CSS\", TRUE);\n            add_to_head(\"<link rel='stylesheet' href='\".DYNAMICS.\"assets/switch/switch.min.css'>\");\n        }\n    }\n\n    $title = ($label ? stripinput($label) : ucfirst(strtolower(str_replace(\"_\", \" \", $input_name))));\n\n    // 'input_id[]' becomes 'input_id-', due to foreach has multiple options, and these DOM selectors are needed\n    $options['input_id'] = trim(str_replace('[', '-', $options['input_id']), \"]\");\n\n    if (\\defender::inputHasError($input_name)) {\n        $error_class = \" has-error\";\n        if (!empty($options['error_text'])) {\n            $new_error_text = \\defender::getErrorText($input_name);\n            if (!empty($new_error_text)) {\n                $options['error_text'] = $new_error_text;\n            }\n            addNotice(\"danger\", \"<strong>$title</strong> - \".$options['error_text']);\n        }\n    }\n\n    if (!empty($options['options']) && is_array($options['options'])) {\n\n        $options['toggle'] = FALSE; // force toggle to be false if options existed\n\n        if (!empty($input_value) && !is_array($input_value)) {\n            $option_value = array_flip(explode($options['delimiter'], (string)$input_value)); // require key to value\n        }\n\n        // if there are options, and i want the options to be having input value.\n        // options_value\n        $input_value = [];\n\n        $default_checked = empty($option_value);\n\n        foreach (array_keys($options['options']) as $key) {\n            $input_value[$key] = isset($option_value[$key]) ? (!empty($options['options_value'][$key]) ? $options['options_value'][$key] : 1) : 0;\n        }\n    }\n\n    $checkbox = $options['inline'] && $label ? \"<div class='col-xs-12 col-sm-12 col-md-9 col-lg-9'>\" : \"\";\n\n    if (!empty($options['options']) && is_array($options['options'])) {\n\n        foreach ($options['options'] as $key => $value) {\n\n            if ($options['deactivate_key'] !== NULL && $options['deactivate_key'] == $key) {\n                $checkbox .= form_hidden($input_name, '', $key);\n            }\n\n            $checkbox .= \"<div class='\".($options['type'] == 'radio' ? 'radio' : 'checkbox').($options['inline_options'] ? ' display-inline-block m-r-5' : '').\"'>\";\n\n            $checkbox .= \"<label class='control-label m-r-10' for='\".$options['input_id'].\"-$key'\".($options['inner_width'] ? \" style='width: \".$options['inner_width'].\"'\" : '').\">\";\n\n            $checkbox .= \"<input id='\".$options['input_id'].\"-$key' name='$input_name' value='$key' type='\".$options['type'].\"'\n\n            \".($options['deactivate'] || $options['deactivate_key'] === $key ? 'disabled' : '').($options['onclick'] ? ' onclick=\"'.$options['onclick'].'\"' : '').($input_value[$key] == TRUE || $default_checked && $key == FALSE ? ' checked' : '').\" />\";\n\n            $checkbox .= $value;\n\n            $checkbox .= \"</label>\";\n\n            $checkbox .= \"</div>\";\n        }\n\n    } else {\n        $checkbox .= \"<div class='\".(!empty($label) ? 'pull-left' : 'text-center').\" m-r-10'>\";\n        $checkbox .= \"<input id='\".$options['input_id'].\"' style='margin:0;vertical-align:middle;' name='$input_name' value='\".$options['value'].\"' type='\".$options['type'].\"'\".($options['deactivate'] ? ' disabled' : '').($options['onclick'] ? ' onclick=\"'.$options['onclick'].'\"' : '').($input_value == $options['value'] ? ' checked' : '').\">\";\n        $checkbox .= \"</div>\";\n    }\n\n    $html = \"<div id='\".$options['input_id'].\"-field' class='\".($options['toggle'] ? 'checkbox-switch clearfix ' : '').\"form-group \".($options['inline'] && $label ? 'row ' : '').($error_class ? $error_class : '').($options['class'] ? ' '.$options['class'] : '').\"'>\";\n\n    $html .= (!empty($label)) ? \"<label class='control-label\".($options['inline'] ? \" col-xs-12 col-sm-3 col-md-3 col-lg-3\" : '').\"' data-checked='\".(!empty($input_value) ? \"1\" : \"0\").\"' for='\".$options['input_id'].\"'\".($options['inner_width'] ? \" style='width: \".$options['inner_width'].\"'\" : '').\">\" : \"\";\n\n    $html .= ($options['reverse_label'] == TRUE ? $checkbox : \"\");\n\n    $html .= (!empty($label)) ? \"<div class='overflow-hide'>\".$label.($options['required'] ? \"<span class='required'>&nbsp;*</span>\" : '').($options['tip'] ? \" <i class='pointer fa fa-question-circle text-lighter' title='\".$options['tip'].\"'></i>\" : '').\"</div></label>\" : \"\";\n\n    $html .= ($options['reverse_label'] == FALSE ? $checkbox : \"\");\n\n    $html .= $options['ext_tip'] ? \"<br/><span class='tip'><i>\".$options['ext_tip'].\"</i></span>\" : \"\";\n\n    $html .= \\defender::inputHasError($input_name) ? \"<span class='m-l-10'></span>\" : \"\";\n\n    $html .= \\defender::inputHasError($input_name) ? \"<div id='\".$options['input_id'].\"-help' class='label label-danger p-5 display-inline-block'>\".$options['error_text'].\"</div>\" : \"\";\n\n    $html .= $options['inline'] && $label ? \"</div>\" : \"\";\n\n    $html .= \"</div>\";\n\n    \\defender::add_field_session([\n        'input_name' => clean_input_name($input_name),\n        'title'      => trim($title, '[]'),\n        'id'         => $options['input_id'],\n        'type'       => $options['type'],\n        'required'   => $options['required'],\n        'safemode'   => $options['safemode'],\n        'error_text' => $options['error_text'],\n        'delimiter'  => $options['delimiter'],\n    ]);\n\n    return (string)$html;\n}\n", "<?php\n/*-------------------------------------------------------+\n| PHPFusion Content Management System\n| Copyright (C) PHP Fusion Inc\n| https://phpfusion.com/\n+--------------------------------------------------------+\n| Filename: form_colorpicker.php\n| Author: Frederick MC CHan (Chan)\n| Credits: https://farbelous.github.io/bootstrap-colorpicker/\n+--------------------------------------------------------+\n| This program is released as free software under the\n| Affero GPL license. You can redistribute it and/or\n| modify it under the terms of this license which you\n| can read by viewing the included agpl.txt or online\n| at www.gnu.org/licenses/agpl.html. Removal of this\n| copyright header is strictly prohibited without\n| written permission from the original author(s).\n+--------------------------------------------------------*/\nfunction form_colorpicker($input_name, $label = '', $input_value = '', array $options = []) {\n    $locale = fusion_get_locale();\n\n    if (!defined(\"COLORPICKER\")) {\n        define(\"COLORPICKER\", TRUE);\n\n        if (defined('BOOTSTRAP4')) {\n            add_to_head(\"<link href='\".DYNAMICS.\"assets/colorpick/bs4/css/bootstrap-colorpicker.min.css' rel='stylesheet'>\");\n            add_to_head(\"<script src='\".DYNAMICS.\"assets/colorpick/bs4/js/bootstrap-colorpicker.min.js'></script>\");\n        } else {\n            add_to_head(\"<link href='\".DYNAMICS.\"assets/colorpick/css/bootstrap-colorpicker.min.css' rel='stylesheet'>\");\n            add_to_head(\"<script src='\".DYNAMICS.\"assets/colorpick/js/bootstrap-colorpicker.min.js'></script>\");\n        }\n    }\n\n    $title = $label ? stripinput($label) : ucfirst(strtolower(str_replace(\"_\", \" \", $input_name)));\n    $input_name = stripinput($input_name);\n    $input_value = stripinput($input_value);\n    $default_options = [\n        'input_id'    => $input_name,\n        'required'    => FALSE,\n        'placeholder' => '',\n        'deactivate'  => FALSE,\n        'width'       => '',\n        'inner_width' => '100%',\n        'class'       => '',\n        'inline'      => FALSE,\n        'error_text'  => $locale['error_input_default'],\n        'safemode'    => FALSE,\n        'icon'        => \"\",\n        \"tip\"         => \"\",\n        'format'      => 'hex', //options = the color format - hex | rgb | rgba.\n    ];\n    $options += $default_options;\n    if (!$options['width']) {\n        $options['width'] = $default_options['width'];\n    }\n    $input_id = $options['input_id'] ?: $default_options['input_id'];\n\n    $error_class = \"\";\n    if (\\defender::inputHasError($input_name)) {\n        $error_class = \"has-error \";\n        if (!empty($options['error_text'])) {\n            $new_error_text = \\defender::getErrorText($input_name);\n            if (!empty($new_error_text)) {\n                $options['error_text'] = $new_error_text;\n            }\n            addNotice(\"danger\", \"<strong>$title</strong> - \".$options['error_text']);\n        }\n    }\n\n    $html = \"<div id='$input_id-field' class='form-group \".($options['inline'] && $label ? 'row ' : '').$error_class.$options['class'].\" '>\\n\";\n    $html .= $label ? \"<label class='control-label \".($options['inline'] ? 'col-xs-12 col-sm-3 col-md-3 col-lg-3' : '').\"' for='$input_id'>\".$label.($options['required'] ? \"<span class='required'>&nbsp;*</span>\" : '').\"\n    \".($options['tip'] ? \"<i class='pointer fa fa-question-circle' title='\".$options['tip'].\"'></i>\" : '').\"\n    </label>\\n\" : '';\n    $html .= $options['inline'] && $label ? \"<div class='col-xs-12 col-sm-9 col-md-9 col-lg-9'>\\n\" : \"\";\n    $html .= \"<div id='$input_id' \".($options['width'] ? \"style='width: \".$options['width'].\"'\" : '').\" class='input-group colorpicker-component bscp colorpicker-element m-b-10' data-color='$input_value' data-color-format='\".$options['format'].\"'>\";\n    $html .= \"<input type='text' name='$input_name' class='form-control \".$options['class'].\"' id='\".$input_id.\"' value='$input_value' data-color-format='\".$options['format'].\"'\".($options['placeholder'] ? \" placeholder='\".$options['placeholder'].\"'\" : '').\"\".($options['deactivate'] ? \" readonly\" : \"\").\">\";\n    $html .= \"<span class='input-group-addon input-group-append'>\";\n    $html .= \"<i class='input-group-text colorpicker-input-addon' style='background: rgba(255,255,255,1);'></i>\";\n    $html .= \"</span></div>\";\n    $html .= $options['inline'] && $label ? \"</div>\\n\" : \"\";\n    $html .= \"</div>\\n\";\n\n    \\defender::getInstance()->add_field_session([\n        'input_name' => clean_input_name($input_name),\n        'type'       => 'color',\n        'title'      => $title,\n        'id'         => $input_id,\n        'required'   => $options['required'],\n        'safemode'   => $options['safemode'],\n        'error_text' => $options['error_text']\n    ]);\n    add_to_jquery(\"$('#$input_id').colorpicker({format: '\".$options['format'].\"' \".(defined('BOOTSTRAP4') ? \", fallbackColor: '#000'\" : '').\" });\");\n\n    return $html;\n}\n", "<?php\n/*-------------------------------------------------------+\n| PHPFusion Content Management System\n| Copyright (C) PHP Fusion Inc\n| https://phpfusion.com/\n+--------------------------------------------------------+\n| Filename: form_contact.php\n| Author: Frederick MC CHan (Chan)\n+--------------------------------------------------------+\n| This program is released as free software under the\n| Affero GPL license. You can redistribute it and/or\n| modify it under the terms of this license which you\n| can read by viewing the included agpl.txt or online\n| at www.gnu.org/licenses/agpl.html. Removal of this\n| copyright header is strictly prohibited without\n| written permission from the original author(s).\n+--------------------------------------------------------*/\n\n/**\n * @param        $input_name\n * @param        $label\n * @param string $input_value\n * @param array  $options\n *\n * @return string\n */\nfunction form_contact($input_name, $label, $input_value = \"\", $options = []) {\n\n    $locale = fusion_get_locale();\n\n    $title = $label ? stripinput($label) : ucfirst(strtolower(str_replace(\"_\", \" \", $input_name)));\n\n    $id = trim($input_name, \"[]\");\n\n    $default_options = [\n        'type'              => 'text',\n        'required'          => FALSE,\n        'label_icon'        => '',\n        'feedback_icon'     => '',\n        'safemode'          => FALSE,\n        'regex'             => '',\n        'regex_error_text'  => '',\n        'callback_check'    => FALSE,\n        'input_id'          => $id,\n        'placeholder'       => '',\n        'deactivate'        => FALSE,\n        'width'             => '',\n        'inner_width'       => '',\n        'class'             => '',\n        'inner_class'       => '',\n        'inline'            => FALSE,\n        'min_length'        => 1,\n        'max_length'        => 200,\n        'icon'              => '',\n        'autocomplete_off'  => FALSE,\n        'tip'               => '',\n        'ext_tip'           => '',\n        // prepend is prohibited\n        'append_id'         => \"p-\".$id.\"-append\",\n        'append_button'     => '',\n        'append_value'      => '',\n        'append_form_value' => '',\n        'append_size'       => '',\n        'append_class'      => 'btn-default',\n        'append_type'       => 'submit',\n        'delimiter'         => '|',\n        'stacked'           => '',\n        'group_size'        => '', // http://getbootstrap.com/components/#input-groups-sizing - sm, md, lg\n        'data'              => [],\n        'append_html'       => '',\n        'descript'          => TRUE,\n        'error_text'        => !empty($options['error_text']) ? $options['error_text'] : $locale['prefix_error'],\n        'error_text_2'      => !empty($options['error_text_2']) ? $options['error_text_2'] : $locale['contact_error'],\n    ];\n\n    $options += $default_options;\n\n    $options['type'] = \"tel\";\n\n    // NOTE (remember to parse readback value as of '|' seperator)\n    if (isset($input_value) && (!empty($input_value))) {\n        if (!is_array($input_value)) {\n            $input_value = explode($options[\"delimiter\"], $input_value);\n        }\n    } else {\n        $input_value = [];\n        $input_value['0'] = \"\";\n        $input_value['1'] = \"\";\n    }\n\n    $options += [\n        'append_button_name' => !empty($options['append_button_name']) ? $options['append_button_name'] : \"p-submit-\".$options['input_id'],\n        'append_button_id'   => !empty($options['append_button_id']) ? $options['append_button_id'] : $options['input_id'].'-append-btn',\n    ];\n\n    if (!empty($options['data'])) {\n        array_walk($options['data'], function ($a, $b) use (&$options_data) {\n            $options_data[] = \"data-$b='$a'\";\n        }, $options_data);\n    }\n\n    $error_class = \"\";\n    if (\\defender::inputHasError($input_name)) {\n        $error_class = \" has-error\";\n        if (!empty($options['error_text'])) {\n            $new_error_text = \\defender::getErrorText($input_name);\n            if (!empty($new_error_text)) {\n                $options['error_text'] = $new_error_text;\n            }\n            addNotice(\"danger\", \"<strong>$title</strong> - \".$options['error_text']);\n        }\n    }\n\n    // Fixes HTML DOM type number that does not respect max_length prop.\n    $max_length = '';\n    if ($options['max_length'] && isnum($options['max_length'])) {\n        $max_length = ' maxlength=\"'.$options['max_length'].'\"';\n    }\n\n    // Formats a prefix number\n\n    $html = \"<div id='\".$options['input_id'].\"-field' class='form-group \".($options['inline'] && $label ? 'row ' : '').($error_class ? $error_class : '').($options['class'] ? ' '.$options['class'] : '').($options['icon'] ? ' has-feedback' : '').\"'\".($options['width'] && !$label ? \" style='width: \".$options['width'].\"'\" : '').\">\";\n\n    $html .= ($label ? \"<label class='control-label\".($options['inline'] ? \" col-xs-12 col-sm-12 col-md-3 col-lg-3\" : '').\"' for='\".$options['input_id'].\"'>\".$options['label_icon'].$label.($options['required'] ? \"<span class='required'>&nbsp;*</span>\" : '').\" \".($options['tip'] ? \"<i class='pointer fa fa-question-circle' title='\".$options['tip'].\"'></i>\" : '').\"</label>\" : \"\");\n\n    $html .= ($options['inline'] && $label) ? \"<div class='col-xs-12 col-sm-12 col-md-9 col-lg-9'>\" : \"\";\n\n    $html .= \"<div class='input-group\".($options['group_size'] ? ' input-group-'.$options['group_size'] : '').\"' \".($options['width'] ? \"style='width: \".$options['width'].\"'\" : '').\">\";\n\n    $html .= \"<span class='input-group-addon input-group-prepend p-0 br-0'>\";\n\n    $html .= \"<span class='input-group-text'>\";\n\n    $html .= form_select($input_name.\"_prefix\", \"\", $input_value[0], [\"options\" => calling_codes(), \"class\" => \"m-0\", \"width\" => \"250px\"]);\n\n    $html .= \"</span>\";\n\n    $html .= \"</span>\";\n\n    $html .= \"<input type='tel' data-type='tel' \".(!empty($options_data) ? implode(' ', $options_data) : '').\" \".\"class='form-control textbox \".($options['inner_class'] ? \" \".$options['inner_class'].\" \" : '').\"' \".($options['inner_width'] ? \"style='width:\".$options['inner_width'].\";'\" : '').$max_length.\" name='$input_name' id='\".$options['input_id'].\"_contact' value='\".$input_value['1'].\"'\".($options['placeholder'] ? \" placeholder='\".$options['placeholder'].\"' \" : '').\"\".($options['autocomplete_off'] ? \" autocomplete='off'\" : '').\" \".($options['deactivate'] ? 'readonly' : '').\">\";\n\n    if ($options['append_button'] && $options['append_type'] && $options['append_form_value'] && $options['append_class'] && $options['append_value']) {\n\n        $html .= \"<span class='input-group-btn'>\\n\";\n\n        $html .= \"<button id='\".$options['append_button_id'].\"' name='\".$options['append_button_name'].\"' type='\".$options['append_type'].\"' value='\".$options['append_form_value'].\"' class='btn \".$options['append_size'].\" \".$options['append_class'].\"'>\".$options['append_value'].\"</button>\\n\";\n\n        $html .= \"</span>\\n\";\n\n    } else if ($options['append_value']) {\n\n        $html .= \"<span class='input-group-addon input-group-append' id='\".$options['append_id'].\"'><span class='input-group-text'>\".$options['append_value'].\"</span></span>\\n\";\n\n    }\n\n    $html .= ($options['feedback_icon']) ? \"<div class='form-control-feedback' style='top:0;'><i class='\".$options['icon'].\"'></i></div>\" : '';\n\n    $html .= $options['stacked'];\n\n    $html .= ($options['append_button'] || $options['append_value']) ? \"</div>\" : \"\";\n\n    $html .= $options['append_html'];\n\n    $html .= ($options['inline'] && $label) ? \"</div>\" : \"\";\n\n    $html .= ($options['ext_tip'] ? \"<br/><span class='tip'><i>\".$options['ext_tip'].\"</i></span>\" : \"\");\n\n    $html .= \\defender::inputHasError($input_name) ? \"<div class='input-error\".((!$options['inline'] || $options['append_button'] || $options['append_value']) ? \" display-block\" : \"\").\"'><div id='\".$options['input_id'].\"-help' class='label label-danger p-5 display-inline-block'>\".$options['error_text'].\"</div></div>\" : \"\";\n\n    $html .= \"</div>\";\n\n    $html .= \"</div>\";\n\n    \\defender::add_field_session([\n        'input_name'     => clean_input_name($input_name),\n        'title'          => $title,\n        'id'             => $options['input_id'],\n        'type'           => 'contact',\n        'required'       => $options['required'],\n        'safemode'       => $options['safemode'],\n        'regex'          => $options['regex'],\n        'callback_check' => $options['callback_check'],\n        'delimiter'      => $options['delimiter'],\n        'min_length'     => $options['min_length'],\n        'max_length'     => $options['max_length']\n    ]);\n\n    // This should affect all number inputs by type, not by ID\n    if (!defined('TEL_ONLY_JS')) {\n        define('TEL_ONLY_JS', TRUE);\n        // Add plugin codes\n        add_to_jquery(\"\n        // Restricts input for each element in the set of matched elements to the given inputFilter.\n        (function($) {\n          $.fn.inputFilter = function(inputFilter) {\n            return this.on(\\\"input keydown keyup mousedown mouseup select contextmenu drop\\\", function() {\n              if (inputFilter(this.value)) {\n                this.oldValue = this.value;\n                this.oldSelectionStart = this.selectionStart;\n                this.oldSelectionEnd = this.selectionEnd;\n              } else if (this.hasOwnProperty(\\\"oldValue\\\")) {\n                this.value = this.oldValue;\n                this.setSelectionRange(this.oldSelectionStart, this.oldSelectionEnd);\n              } else {\n                this.value = \\\"\\\";\n              }\n            });\n          };\n        }(jQuery));\n       \");\n    }\n    add_to_jquery(\"\n    $('#\".$options['input_id'].\"_contact').inputFilter(function(value) { return /^-?\\d*$/.test(value); });\n    \");\n\n    // Live Regex Error Check\n    if ($options['regex'] && $options['regex_error_text']) {\n        add_to_jquery(\"\n        $('#\".$options['input_id'].\"').blur(function(ev) {\n            var Inner_Object = $(this).parent('div').find('.label-danger');\n            var Outer_Object = $(this).parent('div').find('.input-error');\n            if (!$(this).val().match(/\".$options['regex'].\"/g) && $(this).val()) {\n                var ErrorText = '\".$options['regex_error_text'].\"';\n                var ErrorDOM = '<div class=\\'input-error spacer-xs\\'><div class=\\'label label-danger p-5\\'>'+ ErrorText +'</div></div>';\n                if (Inner_Object.length > 0) {\n                    object.html(ErrorText);\n                } else {\n                    $(this).after(function() {\n                        return ErrorDOM;\n                    });\n                }\n            } else {\n               Outer_Object.remove();\n            }\n        });\n        \");\n    }\n\n    if ($options['autocomplete_off']) {\n        // Delay by 20ms and reset values.\n        add_to_jquery(\"\n            $('#\".$options['input_id'].\"').val(' ');\n            setTimeout( function(){ $('#\".$options['input_id'].\"').val(''); }, 20);\n        \");\n    }\n\n    return $html;\n}\n\n/**\n * @param null $country_code\n *\n * @return array|mixed|null\n */\nfunction calling_codes($country_code = NULL) {\n    $countries = [];\n    static $calling_codes = [];\n    require_once INCLUDES.\"geomap/callingcodes.inc.php\";\n    if (!empty($countries) && empty($calling_codes)) {\n        foreach ($countries as $country) {\n            // there is an array for these areas replicated.\n            $calling_codes[$country[\"code\"].\"*\".$country[\"prefix\"]] = $country[\"name\"].\" (\".$country[\"prefix\"].\")\";\n        }\n    }\n\n    return $country_code === NULL ? $calling_codes : (isset($calling_codes[$country_code]) ? $calling_codes[$country_code] : NULL);\n}\n", "<?php\n/*-------------------------------------------------------+\n| PHPFusion Content Management System\n| Copyright (C) PHP Fusion Inc\n| https://phpfusion.com/\n+--------------------------------------------------------+\n| Filename: form_datepicker.php\n| Author: Frederick MC Chan (Chan)\n| Credits:  eternicode @ http://bootstrap-datepicker.readthedocs.org/en/latest/\n| Docs: http://bootstrap-datepicker.readthedocs.org/en/release/options.html\n+--------------------------------------------------------+\n| This program is released as free software under the\n| Affero GPL license. You can redistribute it and/or\n| modify it under the terms of this license which you\n| can read by viewing the included agpl.txt or online\n| at www.gnu.org/licenses/agpl.html. Removal of this\n| copyright header is strictly prohibited without\n| written permission from the original author(s).\n+--------------------------------------------------------*/\n/**\n * Input to save date using datepicker\n * Datetimepicker documentation - http://eonasdan.github.io/bootstrap-datetimepicker/Options/\n *\n * @param        $input_name\n * @param string $label\n * @param string $input_value\n * @param array  $options\n *                <ul>\n *                <li><strong>class</strong> (string): Empty string by default.\n *                The value of attribute class of the input.</li>\n *                <li><strong>date_format</strong> (string): dd-mm-yyyy by default.\n *                Date format for datepicker plugin.</li>\n *                <li><strong>deactivate</strong> (boolean): FALSE by default.\n *                You can pass TRUE and turn off the javascript datepicker plugin</li>\n *                <li><strong>error_text</strong> (string): empty string by default.\n *                An error message</li>\n *                <li><strong>fieldicon_off</strong> (boolean): FALSE by default.\n *                If TRUE, the calendar icon will be not displayed in the input.</li>\n *                <li><strong>inline</strong> (boolean): FALSE by default.\n *                TRUE if the input should be an inline element.</li>\n *                <li><strong>input_id</strong> (string): $input name by default.\n *                The value of attribute id of input.</li>\n *                <li><strong>required</strong> (boolean): FALSE by default</li>\n *                <li><strong>type</strong> (string): timestamp by default.\n *                Valid types:\n *                <ul>\n *                <li>date: The date will be saved as mysql date.</li>\n *                <li>timestamp: A timestamp will be saved as an integer</li>\n *                </ul>\n *                </li>\n *                <li><strong>week_start</strong> (int): 0 by default.\n *                An integer between 0 and 6. It is the same as\n *                the attribute weekStart of datepicker.</li>\n *                <li><strong>width</strong> (string): 250px by default.\n *                A valid value for CSS width</li>\n *                </ul>\n *\n * Callback Usages !important\n * ==========================\n * Configuration when type is 'timestamp'\n * Token used for $options['date_format_php'] is the <a href=\"http://php.net/manual/en/function.date.php\">PHP token equivalent.</a>\n * Token used for $options['date_format_js'] must be formatted with <a href=\"http://momentjs.com/docs/#/displaying/\">moment.js.</a>\n * Both token must match each other to parse the callback properly.\n * Example 1:\n *  \"date_format_php\" => \"d-m-Y\",\n * \"date_format_js\"  => \"DD-MM-YYYY\",\n *\n * Example 2:\n *  'date_format_js'  => 'YYYY-M-DD',\n * 'date_format_php' => 'Y-m-d',\n *\n * Currently, only user birthdate in `entire project` uses date format.\n *\n * Joining 2 datepickers (Start and End)\n * =======================================\n * In Start Datepicker, add $options['join_to_id'] with End Datepicker's input_id\n * In End Datepicker, add $options['join_from_id'] with Start Datepicker's input_id\n *\n * @return string\n */\n\n\nfunction form_datepicker($input_name, $label = '', $input_value = '', array $options = []) {\n\n    $locale = fusion_get_locale();\n\n    if (!defined('DATEPICKER')) {\n        define('DATEPICKER', TRUE);\n        if (file_exists(DYNAMICS.\"assets/datepicker/locale/tooltip/\".$locale['datepicker'].\".js\")) {\n            $lang = $locale['datepicker'];\n        } else {\n            $lang = 'en-gb';\n        }\n        add_to_footer(\"<script src='\".DYNAMICS.\"assets/datepicker/locale/tooltip/\".$lang.\".js'></script>\");\n\n        if (defined('BOOTSTRAP4')) {\n            add_to_head(\"<link href='\".DYNAMICS.\"assets/datepicker/bs4/tempusdominus-bootstrap-4.min.css' rel='stylesheet'>\");\n        } else {\n            add_to_head(\"<link href='\".DYNAMICS.\"assets/datepicker/css/bootstrap-datetimepicker.min.css' rel='stylesheet'>\");\n        }\n\n        add_to_footer(\"<script src='\".DYNAMICS.\"assets/datepicker/js/moment.min.js'></script>\");\n\n        if (defined('BOOTSTRAP4')) {\n            add_to_footer(\"<script src='\".DYNAMICS.\"assets/datepicker/bs4/tempusdominus-bootstrap-4.min.js'></script>\");\n        } else {\n            add_to_footer(\"<script src='\".DYNAMICS.\"assets/datepicker/js/bootstrap-datetimepicker.min.js'></script>\");\n        }\n        add_to_footer(\"<script src='\".DYNAMICS.\"assets/datepicker/locale/\".$locale['datepicker'].\".js'></script>\");\n    }\n\n    $title = $label ? stripinput($label) : ucfirst(strtolower(str_replace(\"_\", \" \", $input_name)));\n\n    $input_name = stripinput($input_name);\n\n    $default_options = [\n        'input_id'               => $input_name,\n        'required'               => FALSE,\n        'placeholder'            => '',\n        'deactivate'             => FALSE,\n        'width'                  => '',\n        'inner_width'            => '', // in px i.e. 250px\n        'class'                  => '',\n        'inline'                 => FALSE,\n        'error_text'             => $locale['error_input_default'],\n        'date_format_js'         => 'M-DD-YYYY H:mm:ss',\n        'date_format_php'        => 'm-d-Y H:i:s',\n        'delimiter'              => '-',\n        'fieldicon_off'          => FALSE,\n        'filtered_dates'         => [], // must be an array\n        'include_filtered_dates' => (boolean)FALSE, // if TRUE, then only days filtered are selectable\n        'weekend'                => [], // 0 for Sunday, 1 for Monday, 6 for Saturday\n        'disable_weekend'        => (boolean)FALSE, // if true, all weekend will be non-selectable\n        'type'                   => 'timestamp',\n        'tip'                    => '',\n        'showTime'               => (boolean)FALSE,\n        'week_start'             => fusion_get_settings('week_start'),\n        'join_to_id'             => '',\n        'join_from_id'           => '',\n        'debug'                  => '',\n        'stacked'                => '',\n    ];\n\n    $options += $default_options;\n\n    if (!empty($input_value)) {\n        if ($options['type'] == \"timestamp\") {\n            $input_value = date($options['date_format_php'], isnum($input_value) ? $input_value : strtotime(str_replace('-', '/', $input_value)));\n        } else if ($options['type'] == \"date\") {\n            if (stristr($input_value, $options['delimiter'])) {\n                $input_value = explode($options['delimiter'], $input_value);\n                if (count($input_value) == 3) {\n                    $params = [\n                        'year'  => $input_value[0],\n                        'month' => $input_value[1],\n                        'day'   => $input_value[2]\n                    ];\n                    if (checkdate($params['month'], $params['day'], $params['year'])) {\n                        $input_value = (implode(\"-\", $params).\" 00:00:00\");\n                    }\n                }\n            }\n        }\n    } else {\n        $input_value = \"\";\n    }\n\n    if (!$options['width']) {\n        $options['width'] = $default_options['width'];\n    }\n\n    // Format disabled or enabled dates as JS array\n    $dateFilter = [];\n    if (!empty($options['filtered_dates']) && is_array($options['filtered_dates'])) {\n        $date_filtered = [];\n        $dateFilter[0] = \"disabledDates: \";\n        if ($options['include_filtered_dates'] == TRUE) {\n            $dateFilter[0] = \"enabledDates: \";\n        }\n        foreach ($options['filtered_dates'] as $value) {\n            $date_filtered[] = date(\"m/d/Y\", $value);\n        }\n        $dateFilter[1] = (string)\"['\".implode(\"','\", $date_filtered).\"']\";\n    }\n\n    // Format for Weekend\n    $weekendFilter = [];\n    if ($options['disable_weekend']) {\n        $weekendFilter[0] = \"daysOfWeekDisabled: \";\n        $weekendFilter[1] = (!empty($options['weekend']) && is_array($options['weekend'])) ? \"[\".implode(\",\", $options['weekend']).\"]\" : \"[0,6]\";\n    }\n\n    if (!in_array($options['type'], ['date', 'timestamp'])) {\n        $options['type'] = $default_options['type'];\n    }\n\n    $options['week_start'] = (int)$options['week_start'];\n\n    $error_class = \"\";\n    if (\\defender::inputHasError($input_name)) {\n        $error_class = \"has-error \";\n        if (!empty($options['error_text'])) {\n            $new_error_text = \\defender::getErrorText($input_name);\n            if (!empty($new_error_text)) {\n                $options['error_text'] = $new_error_text;\n            }\n            addNotice(\"danger\", \"<strong>$title</strong> - \".$options['error_text']);\n        }\n    }\n\n\n    $html = \"<div id='\".$options[\"input_id\"].\"-field' class='form-group \".($options['inline'] && $label ? 'row ' : '').$error_class.$options['class'].\"'>\\n\";\n\n    $html .= ($label ? \"<label class='control-label\".($options['inline'] ? \" col-xs-12 col-sm-3 col-md-3 col-lg-3\" : '').\"' for='\".$options[\"input_id\"].\"'>\".$label.($options['required'] ? \"<span class='required'>&nbsp;*</span> \" : '').($options['tip'] ? \"<i class='pointer fa fa-question-circle' title='\".$options['tip'].\"'></i>\" : '').\"</label>\" : \"\");\n\n    $html .= $options['inline'] && $label ? \"<div class='col-xs-12 col-sm-9 col-md-9 col-lg-9'>\\n\" : \"\";\n\n    $html .= \"<div id='\".$options[\"input_id\"].\"_datepicker' data-target-input='nearest' class='input-group date'\".($options['width'] ? \" style='width: \".$options['width'].\"'\" : \"\").\">\\n\";\n\n    $html .= \"<input type='text' name='\".$input_name.\"' id='\".$options[\"input_id\"].\"' data-target='#\".$options[\"input_id\"].\"-datepicker' value='\".$input_value.\"' class='datetimepicker-input form-control textbox'\".($options['inner_width'] ? \" style='width:\".$options['inner_width'].\";'\" : '').($options['placeholder'] ? \" placeholder='\".$options['placeholder'].\"'\" : '').\"/>\\n\";\n\n    $html .= \"<span class='input-group-addon input-group-append \".($options['fieldicon_off'] ? 'display-none' : '').\"' data-target='#\".$options[\"input_id\"].\"-datepicker' data-toggle='datetimepicker'><i class='input-group-text fa fa-calendar'></i></span>\\n\";\n\n    $html .= \"</div>\\n\";\n\n    $html .= (($options['required'] == 1 && \\defender::inputHasError($input_name)) || \\defender::inputHasError($input_name) ? \"<div id='\".$options[\"input_id\"].\"-help' class='label label-danger p-5 display-inline-block'>\".$options['error_text'].\"</div>\" : \"\");\n\n    $html .= $options['stacked'];\n\n    $html .= ($options['inline'] && $label ? \"</div>\" : \"\");\n\n    $html .= \"</div>\";\n\n    \\defender::add_field_session([\n        'input_name'  => clean_input_name($input_name),\n        'type'        => $options['type'],\n        'title'       => $title,\n        'id'          => $options[\"input_id\"],\n        'required'    => $options['required'],\n        'error_text'  => $options['error_text'],\n        \"delimiter\"   => $options['delimiter'],\n        'date_format' => $options['date_format_php'],\n        'safemode'    => TRUE,\n    ]);\n\n    if (!$options['deactivate']) {\n\n        /**\n         * Bind to and from together\n         */\n        $bindingJs = \"\";\n        if (!empty($options['join_from_id'])) {\n            if (defined('BOOTSTRAP4')) {\n                $bindingJs = \"\n                    $('#\".$options['join_from_id'].\"_datepicker').on('change.datetimepicker', function (e) {\n                        $('#\".$options[\"input_id\"].\"_datepicker').datetimepicker('minDate', e.date);\n                    });\n                    $('#\".$options[\"input_id\"].\"_datepicker').on('change.datetimepicker', function (e) {\n                        $('#\".$options['join_from_id'].\"_datepicker').datetimepicker('maxDate', e.date);\n                    });\n                \";\n            } else {\n                $bindingJs = \"\n                    $('#\".$options['join_from_id'].\"_datepicker').on('dp.change', function(e) {\n                        $('#\".$options[\"input_id\"].\"_datepicker').data('DateTimePicker').minDate(e.date);\n                    });\n                    $('#\".$options[\"input_id\"].\"_datepicker').on('dp.change', function(e) {\n                        $('#\".$options['join_from_id'].\"_datepicker').data('DateTimePicker').maxDate(e.date);\n                    });\n                \";\n            }\n        }\n\n        if (defined('BOOTSTRAP4')) {\n            $dpbuttons = \"\n                buttons: {\n                    showToday: true,\n                    showClear: true,\n                    showClose: true\n                },\n            \";\n        } else {\n            $dpbuttons = \"\n                showTodayButton: true,\n                showClear: true,\n                showClose: true,\n            \";\n        }\n\n        add_to_jquery(\"\n        moment.updateLocale('\".$locale['datepicker'].\"', {\n            week: {dow: \".$options['week_start'].\"}\n        });\n        \n        let \".$options[\"input_id\"].\"_datepicker = $('#\".$options[\"input_id\"].\"_datepicker').datetimepicker({\n            locale: '\".$locale['datepicker'].\"',\n            \".$dpbuttons.\"\n            allowInputToggle: true,\n            icons: {\n                time: 'fa fa-clock',\n                date: 'fa fa-calendar',\n                up: 'fa fa-caret-up',\n                down: 'fa fa-caret-down',\n                previous: 'fa fa-caret-left',\n                next: 'fa fa-caret-right',\n                today: 'fa fa-calendar-day',\n                clear: 'fa fa-trash',\n                close: 'fa fa-close'\n            },\n            tooltips: tooltips_locale,\n            \".($options['showTime'] == TRUE ? \"sideBySide: true,\" : \"\").\"\n            \".(!empty($dateFilter) ? $dateFilter[0].$dateFilter[1].\",\" : \"\").\"\n            \".(!empty($weekendFilter) ? $weekendFilter[0].$weekendFilter[1].\",\" : \"\").\"\n            format: '\".$options['date_format_js'].\"',\n            \".(!empty($options['join_from_id']) ? \"useCurrent: false\" : \"\").\"\n        });\n        \".$bindingJs.\"\n        \");\n    }\n\n    return (string)$html;\n}\n", "<?php\n/*-------------------------------------------------------+\n| PHPFusion Content Management System\n| Copyright (C) PHP Fusion Inc\n| https://phpfusion.com/\n+--------------------------------------------------------+\n| Filename: form_fileinput.php\n| Author: Frederick MC CHan (Chan)\n| Credits: http://plugins.krajee.com/file-input\n+--------------------------------------------------------+\n| This program is released as free software under the\n| Affero GPL license. You can redistribute it and/or\n| modify it under the terms of this license which you\n| can read by viewing the included agpl.txt or online\n| at www.gnu.org/licenses/agpl.html. Removal of this\n| copyright header is strictly prohibited without\n| written permission from the original author(s).\n+--------------------------------------------------------*/\n\n/**\n * @param            $input_name\n * @param string     $label\n * @param bool|FALSE $input_value\n * @param array      $options\n * if media is true, defender will check if any file uploaded. If no, select from media selection\n *\n * @return string\n */\nfunction form_fileinput($input_name, $label = '', $input_value = FALSE, array $options = []) {\n    $locale = fusion_get_locale();\n\n    $title = $label ? stripinput($label) : ucfirst(strtolower(str_replace(\"_\", \" \", $input_name)));\n    $input_name = (isset($input_name) && (!empty($input_name))) ? stripinput($input_name) : \"\";\n\n    $template_choices = ['classic', 'modern', 'thumbnail'];\n\n    $default_options = [\n        'input_id'          => $input_name,\n        'upload_path'       => IMAGES,\n        'required'          => FALSE,\n        'safemode'          => FALSE,\n        'deactivate'        => FALSE,\n        'preview_off'       => FALSE,\n        'type'              => 'image', //// ['image', 'html', 'text', 'video', 'audio', 'flash', 'object', 'file']\n        'width'             => '',\n        'label'             => $locale['browse'],\n        'inline'            => TRUE,\n        'class'             => \"\",\n        'tip'               => \"\",\n        'ext_tip'           => \"\",\n        'error_text'        => $locale['error_input_file'],\n        'btn_class'         => 'btn-default',\n        'icon'              => 'fa fa-upload',\n        'jsonurl'           => FALSE,\n        'dropzone'          => FALSE,\n        'valid_ext'         => '.jpg,.png,.PNG,.JPG,.JPEG,.gif,.GIF,.bmp,.BMP',\n        'thumbnail'         => FALSE,\n        'thumbnail_w'       => 300,\n        'thumbnail_h'       => 300,\n        'thumbnail_folder'  => \"\",\n        'thumbnail_ratio'   => 0,\n        'thumbnail_suffix'  => '_t1',\n        'thumbnail2'        => FALSE,\n        'thumbnail2_w'      => 600,\n        'thumbnail2_h'      => 400,\n        'thumbnail2_suffix' => '_t2',\n        'thumbnail2_ratio'  => 0,\n        'delete_original'   => FALSE,\n        'max_width'         => 1800,\n        'max_height'        => 1600,\n        'max_byte'          => 15728640,\n        'max_count'         => 1,\n        'multiple'          => FALSE,\n        'template'          => 'classic',\n        'media'             => FALSE,\n        'placeholder'       => '',\n        'form_id'           => '',\n        'hide_upload'       => TRUE,\n        'hide_remove'       => FALSE,\n        'krajee_disabled'   => FALSE,\n        'replace_upload'    => FALSE, // makes upload unique (i.e. overwrite instead of creating new)\n    ];\n\n    $options += $default_options;\n\n    if (!is_dir($options['upload_path']) && !$options['jsonurl']) {\n        $options['upload_path'] = IMAGES;\n    }\n\n    $options['thumbnail_folder'] = rtrim($options['thumbnail_folder'], \"/\");\n\n    if (!in_array($options['template'], $template_choices)) {\n        $options['template'] = \"classic\";\n    }\n\n    $options['input_id'] = trim(str_replace(\"[\", \"-\", $options['input_id']), \"]\");\n\n    $error_class = \"\";\n    if (\\defender::inputHasError($input_name)) {\n        $error_class = \"has-error \";\n        if (!empty($options['error_text'])) {\n            $new_error_text = \\defender::getErrorText($input_name);\n            if (!empty($new_error_text)) {\n                $options['error_text'] = $new_error_text;\n            }\n            addNotice(\"danger\", \"<strong>$title</strong> - \".$options['error_text']);\n        }\n    }\n\n    // default max file size\n    $format = '';\n    $browseLabel = $locale['df_300'];\n    $type_for_js = NULL;\n    if ($options['type']) {\n        // file type if single filter, if not will accept as object if left empty.\n        if (!stristr($options['type'], ',') && $options['type']) {\n            if ($options['type'] == 'image') {\n                $format = \"image/*\";\n                $browseLabel = $locale['df_301'];\n            } else if ($options['type'] == 'video') {\n                $format = \"video/*\";\n                $browseLabel = $locale['df_302'];\n            } else if ($options['type'] == 'audio') {\n                $format = \"audio/*\";\n                $browseLabel = $locale['df_303'];\n            }\n        }\n        $type_for_js = json_encode((array)$options['type']);\n    }\n\n    $html = \"<div id='\".$options['input_id'].\"-field' class='form-group \".($options['inline'] && $label ? 'row ' : '').$error_class.$options['class'].\"'\".($options['width'] ? \" style='width: \".$options['width'].\" !important;'\" : '').\">\\n\";\n    $html .= ($label) ? \"<label class='control-label \".($options['inline'] ? \"col-xs-12 col-sm-3 col-md-3 col-lg-3\" : '').\"' for='\".$options['input_id'].\"'>\".$label.($options['required'] ? \"<span class='required'>&nbsp;*</span>\" : '').\"\n    \".($options['tip'] ? \"<i class='pointer fa fa-question-circle' title='\".$options['tip'].\"'></i>\" : '').\"\n    </label>\\n\" : '';\n    $html .= $options['inline'] && $label ? \"<div class='col-xs-12 col-sm-9 col-md-9 col-lg-9'>\\n\" : \"\";\n    $html .= \"<input type='file'\".($options['krajee_disabled'] == TRUE ? \" class='form-control' \" : \"\").($format ? \" accept='\".$format.\"'\" : '').\" name='\".$input_name.\"' id='\".$options['input_id'].\"'\".($options['width'] ? \" style='width: \".$options['width'].\";' \" : '').\"\".($options['deactivate'] ? 'readonly' : '').\" \".($options['multiple'] ? \"multiple='1'\" : '').\" />\\n\";\n    $html .= $options['ext_tip'] ? \"<span class='tip'><i>\".$options['ext_tip'].\"</i></span><br/>\" : \"\";\n    $html .= (\\defender::inputHasError($input_name)) ? \"<div id='\".$options['input_id'].\"-help' class='label label-danger p-5 display-inline-block'>\".$options['error_text'].\"</div>\" : '';\n\n    // Inserts Media Selector\n    // Draw the framework first\n    if ($options['media'] == TRUE) {\n        $files_list = makefilelist($options['upload_path'], \".|..|index.php|\", TRUE, 'files', 'psd|txt|md|php|exe|bat|pdf|js');\n        $container_height = 300;\n        $image_container_height = floor($container_height / 2.5);\n        $html .= \"<div id='\".$options['input_id'].\"-media' class='panel panel-default spacer-sm'>\";\n        $html .= \"<div class='panel-body'>\\n\";\n        $html .= \"<h5>\".$locale['global_901'].\"</h5>\";\n        if (!empty($files_list)) {\n            $html .= form_hidden($input_name.\"-mediaSelector\", '', $input_value,\n                ['input_id' => $options['input_id'].\"-mediaSelector\"]);\n            $html .= \"<hr/>\";\n            $html .= \"<div id='\".$options['input_id'].\"-mediaContainer' class='row' style='max-height:\".$container_height.\"px; overflow-y: scroll'>\";\n            foreach ($files_list as $files) {\n                $html .= \"<div class='col-xs-6 col-sm-3 clearfix text-center m-b-15'>\\n\";\n                $html .= \"<div class='media-container' title='$files' data-file='$files' style='height:\".$image_container_height.\"px;'>\\n\";\n                $html .= \"<img class='center-y' style='margin: 0 auto;' src='\".$options['upload_path'].$files.\"' alt='$files'/>\";\n                $html .= \"</div>\\n\";\n                $html .= \"<small>$files</small>\";\n                $html .= \"</div>\\n\";\n            }\n            $html .= \"</div>\\n\";\n            // single file selector only\n            add_to_jquery(\"\n                function mediaSelect() {\n                    $('#\".$options['input_id'].\"-media .media-container').bind('click', function(){\n                        $('.media-container').removeClass('selected');\n                        $(this).addClass('selected');\n                        var current_folder = $('#\".$options['input_id'].\"-mediaFolder').val();\n                        var file_path = $(this).data('file');\n                        $('#\".$options['input_id'].\"-mediaSelector').val(file_path);\n                    });\n                }\n                mediaSelect();\n            \");\n        }\n        $html .= (\\defender::inputHasError($input_name.\"-mediaSelector\")) ? \"<div id='\".$options['input_id'].\"-mediaSelector' class='label label-danger p-5 display-inline-block'>\".$options['error_text'].\"</div>\" : \"\";\n\n        $html .= \"</div>\\n\";\n        $html .= \"</div>\\n\";\n    }\n    $html .= $options['inline'] && $label ? \"</div>\\n\" : \"\";\n    $html .= \"</div>\\n\";\n\n    \\defender::getInstance()->add_field_session(\n        [\n            'input_name'        => trim($input_name, '[]'),\n            'type'              => ((array)$options['type'] == ['image'] ? 'image' : 'file'),\n            'title'             => $title,\n            'id'                => $options['input_id'],\n            'required'          => $options['required'],\n            'safemode'          => $options['safemode'],\n            'error_text'        => $options['error_text'],\n            'path'              => $options['upload_path'],\n            'thumbnail_folder'  => $options['thumbnail_folder'],\n            'thumbnail'         => $options['thumbnail'],\n            'thumbnail_suffix'  => $options['thumbnail_suffix'],\n            'thumbnail_w'       => $options['thumbnail_w'],\n            'thumbnail_h'       => $options['thumbnail_h'],\n            'thumbnail_ratio'   => $options['thumbnail_ratio'],\n            'thumbnail2'        => $options['thumbnail2'],\n            'thumbnail2_w'      => $options['thumbnail2_w'],\n            'thumbnail2_h'      => $options['thumbnail2_h'],\n            'thumbnail2_suffix' => $options['thumbnail2_suffix'],\n            'thumbnail2_ratio'  => $options['thumbnail2_ratio'],\n            'delete_original'   => $options['delete_original'],\n            'max_width'         => $options['max_width'],\n            'max_height'        => $options['max_height'],\n            'max_count'         => $options['max_count'],\n            'max_byte'          => $options['max_byte'],\n            'multiple'          => $options['multiple'],\n            'valid_ext'         => $options['valid_ext'],\n            'replace_upload'    => $options['replace_upload'],\n        ]\n    );\n\n\n    if ($options['krajee_disabled'] === FALSE) {\n        $browseLabel = $options['placeholder'] ?: $browseLabel;\n        $value = \"\";\n        if (!empty($input_value)) {\n            if (is_array($input_value)) {\n                $value = [];\n                foreach ($input_value as $c_value) {\n                    $value[] = (file_exists($options['upload_path'].$c_value) ? $options['upload_path'].$c_value : $c_value);\n                }\n            } else {\n                $value = (file_exists($options['upload_path'].$input_value) ? $options['upload_path'].$input_value : $input_value);\n            }\n            $value = json_encode($value);\n        }\n\n        $extra_data_js = \"\";\n        if ($options['form_id'] && $options['jsonurl']) {\n            $extra_data_js = \"\n                uploadExtraData: function() {\n                    var inputs = $('#\".$options['form_id'].\" :input');\n                    var obj = $.map(inputs, function(x, y) {\n                        return {\n                            Key: x.name,\n                            Value: $(x).val()\n                        };\n                    });\n                    return obj;\n                },\n            \";\n        }\n        if ($options['media']) {\n            \\defender::getInstance()->add_field_session(\n                [\n                    'input_name' => $input_name.\"-mediaSelector\",\n                    'title'      => trim($title, '[]'),\n                    'id'         => $options['input_id'].\"-mediaSelector\",\n                    'type'       => 'mediaSelect',\n                    'path'       => $options['upload_path'],\n                    'required'   => $options['required'],\n                    'safemode'   => $options['safemode'],\n                ]\n            );\n        }\n\n        $lang = file_exists(DYNAMICS.'assets/fileinput/js/locales/'.$locale['short_lang_name'].'.js') ? 'language: \"'.$locale['short_lang_name'].'\",' : '';\n\n        switch ($options['template']) {\n            case \"classic\":\n                add_to_jquery(\"\n                    $('#\".$options['input_id'].\"').fileinput({\n                        allowedFileTypes: \".$type_for_js.\",\n                        allowedPreviewTypes : \".$type_for_js.\",\n                        \".($value ? \"initialPreview: \".$value.\", \" : '').\"\n                        \".($options['preview_off'] ? \"showPreview: false, \" : '').\"\n                        initialPreviewAsData: true,\n                        browseClass: 'btn \".$options['btn_class'].\" button',\n                        uploadClass: 'btn btn-default button',\n                        captionClass : '',\n                        maxFileCount: '\".$options['max_count'].\"',\n                        removeClass : 'btn \".$options['btn_class'].\" button',\n                        browseLabel: '\".$browseLabel.\"',\n                        browseIcon: '<i class=\\\"\".$options['icon'].\" m-r-10\\\"></i>',\n                        \".($options['jsonurl'] ? \"uploadUrl : '\".$options['jsonurl'].\"',\" : '').\"\n                        \".($options['hide_upload'] ? 'showUpload: false,' : '').\"\n                        \".($options['hide_remove'] ? 'showRemove: false,' : '').\"\n                        dropZoneEnabled: \".($options['dropzone'] ? \"true\" : \"false\").\",\n                        \".($locale['text-direction'] == 'rtl' ? 'rtl: true,' : '').\"\n                        $extra_data_js\n                        \".$lang.\"\n                    });\n                \");\n                break;\n            case \"modern\":\n                add_to_jquery(\"\n                    $('#\".$options['input_id'].\"').fileinput({\n                        allowedFileTypes: \".$type_for_js.\",\n                        allowedPreviewTypes : \".$type_for_js.\",\n                        \".($value ? \"initialPreview: \".$value.\", \" : '').\"\n                        initialPreviewAsData: true,\n                        \".($options['preview_off'] ? \"showPreview: false, \" : '').\"\n                        browseClass: 'btn btn-modal btn-lg',\n                        uploadClass: 'btn btn-modal btn-lg',\n                        captionClass : '',\n                        maxFileCount: '\".$options['max_count'].\"',\n                        removeClass : 'btn button',\n                        browseLabel: '\".$browseLabel.\"',\n                        browseIcon: '<i class=\\\"\".$options['icon'].\"\\\"></i>',\n                        showCaption: false,\n                        showRemove: false,\n                        \".($options['jsonurl'] ? \"uploadUrl : '\".$options['jsonurl'].\"',\" : '').\"\n                        dropZoneEnabled: \".($options['dropzone'] ? \"true\" : \"false\").\",\n                        \".($options['hide_upload'] ? 'showUpload: false,' : '').\"\n                        \".($options['hide_remove'] ? 'showRemove: false,' : '').\"\n                        $extra_data_js\n                        layoutTemplates: {\n                            main2: '<div class=\\\"btn-photo-upload btn-link\\\">'+' {browse}'+' </div></span></div> {preview}',\n                        },\n                        \".$lang.\"\n                    });\n                \");\n                break;\n            case \"thumbnail\":\n                add_to_jquery(\"\n                    $('#\".$options['input_id'].\"').fileinput({\n                        allowedFileTypes: \".$type_for_js.\",\n                        allowedPreviewTypes : \".$type_for_js.\",\n                        \".($value ? \"initialPreview: \".$value.\", \" : '').\"\n                        \".($options['preview_off'] ? \"showPreview: false, \" : '').\"\n                        initialPreviewAsData: true,\n                        defaultPreviewContent: '<img class=\\\"img-responsive\\\" src=\\\"\".IMAGES.\"no_photo.png\\\" alt=\\\"\".$browseLabel.\"\\\" style=\\\"width:100%;\\\">',\n                        browseClass: 'btn btn-block btn-default',\n                        uploadClass: 'btn btn-modal',\n                        captionClass : '',\n                        maxFileCount: '\".$options['max_count'].\"',\n                        removeClass : 'btn button',\n                        browseLabel: '\".$browseLabel.\"',\n                        browseIcon: '<i class=\\\"\".$options['icon'].\"\\\"></i>',\n                        showCaption: false,\n                        showRemove: false,\n                        \".($options['jsonurl'] ? \"uploadUrl : '\".$options['jsonurl'].\"',\" : '').\"\n                        \".($options['hide_upload'] ? 'showUpload: false,' : '').\"\n                        \".($options['hide_remove'] ? 'showRemove: false,' : '').\"\n                        dropZoneEnabled: \".($options['dropzone'] ? \"true\" : \"false\").\",\n                        $extra_data_js\n                        layoutTemplates: {\n                            main2: '<div class=\\\"panel panel-default\\\">' + '{preview}' + '<div class=\\\"panel-body\\\">' + ' {browse}' + '</div></div>',\n                        },\n                        \".$lang.\"\n                    });\n                \");\n                break;\n        }\n\n        if (!defined('form_fileinput')) {\n            add_to_head(\"<link href='\".DYNAMICS.\"assets/fileinput/css/fileinput.min.css' media='all' rel='stylesheet' type='text/css' />\");\n            if ($locale['text-direction'] == 'rtl') {\n                add_to_head(\"<link href='\".DYNAMICS.\"assets/fileinput/css/fileinput-rtl.min.css' media='all' rel='stylesheet' type='text/css' />\");\n            }\n            add_to_footer(\"<script src='\".DYNAMICS.\"assets/fileinput/js/fileinput.min.js' type='text/javascript'></script>\");\n\n            if (file_exists(DYNAMICS.'assets/fileinput/js/locales/'.$locale['short_lang_name'].'.js')) {\n                add_to_footer(\"<script src='\".DYNAMICS.\"assets/fileinput/js/locales/\".$locale['short_lang_name'].\".js' type='text/javascript'></script>\");\n                //$lang = 'language: \"'.$locale['short_lang_name'].'\",';\n            }\n            define('form_fileinput', TRUE);\n        }\n\n    }\n\n    return (string)$html;\n}\n", "<?php\n/*-------------------------------------------------------+\n| PHPFusion Content Management System\n| Copyright (C) PHP Fusion Inc\n| https://phpfusion.com/\n+--------------------------------------------------------+\n| Project File: Form API - Geo Input Based\n| Filename: form_geomap.php\n| Author: Frederick MC Chan (Chan)\n| Co-Author: Joakim Falk (Falk)\n+--------------------------------------------------------+\n| This program is released as free software under the\n| Affero GPL license. You can redistribute it and/or\n| modify it under the terms of this license which you\n| can read by viewing the included agpl.txt or online\n| at www.gnu.org/licenses/agpl.html. Removal of this\n| copyright header is strictly prohibited without\n| written permission from the original author(s).\n+--------------------------------------------------------*/\n\n/**\n * @param        $input_name\n * @param string $label\n * @param string $input_value\n * @param array  $options\n *\n * @return string\n */\nfunction form_geo($input_name, $label = \"\", $input_value = \"\", array $options = []) {\n\n    $locale = fusion_get_locale();\n    $title = (isset($title) && (!empty($title))) ? $title : ucfirst(strtolower(str_replace(\"_\", \" \", $input_name)));\n    $countries = [];\n    require(INCLUDES.'geomap/geomap.inc.php');\n\n    $id = trim($input_name, \"[]\");\n\n    // NOTE (remember to parse readback value as of '|' seperator)\n    if (isset($input_value) && (!empty($input_value))) {\n        if (!is_array($input_value)) {\n            $input_value = explode('|', $input_value);\n        }\n    } else {\n        $input_value = [];\n        $input_value[0] = \"\";\n        $input_value[1] = \"\";\n        $input_value[2] = \"\";\n        $input_value[3] = \"\";\n        $input_value[4] = \"\";\n        $input_value[5] = \"\";\n    }\n\n    $default_options = [\n        'input_id'     => $id,\n        'required'     => FALSE,\n        'placeholder'  => '',\n        'deactivate'   => FALSE,\n        'width'        => '100%',\n        'class'        => '',\n        'inline'       => FALSE,\n        'tip'          => '',\n        'error_text'   => !empty($options['error_text']) ? $options['error_text'] : $locale['street_error'],\n        'error_text_2' => !empty($options['error_text_2']) ? $options['error_text_2'] : $locale['street_error'],\n        'error_text_3' => !empty($options['error_text_3']) ? $options['error_text_3'] : $locale['country_error'],\n        'error_text_4' => !empty($options['error_text_4']) ? $options['error_text_4'] : $locale['state_error'],\n        'error_text_5' => !empty($options['error_text_5']) ? $options['error_text_5'] : $locale['city_error'],\n        'error_text_6' => !empty($options['error_text_6']) ? $options['error_text_6'] : $locale['postcode_error'],\n        'safemode'     => FALSE,\n        'flag'         => '',\n        'stacked'      => '',\n    ];\n\n    $options += $default_options;\n\n    $input_id = $options['input_id'];\n\n    $validation_key = [\n        0 => 'street-1',\n        1 => 'street-2',\n        2 => 'country',\n        3 => 'region',\n        4 => 'city',\n        5 => 'postcode',\n    ];\n\n    $error_key = [\n        0 => $options['error_text'],\n        1 => $options['error_text_2'],\n        2 => $options['error_text_3'],\n        3 => $options['error_text_4'],\n        4 => $options['error_text_5'],\n        5 => $options['error_text_6'],\n    ];\n\n    $error_class = \"\";\n    for ($i = 0; $i <= 5; $i++) {\n        if (\\defender::inputHasError($input_name.'-'.$validation_key[$i])) {\n            $error_class = \"has-error \";\n            addNotice(\"danger\", \"<strong>$title</strong> - \".$error_key[$i]);\n        }\n    }\n\n    $html = \"<div id='$input_id-field' class='form-group \".($options['inline'] && $label ? 'row ' : '').$error_class.$options['class'].\"' >\";\n\n    $html .= ($label) ? \"<label class='control-label\".($options['inline'] ? \" col-xs-12 col-sm-3 col-md-3 col-lg-3\" : '').\"' for='$input_id'>\".$label.($options['required'] ? \"<span class='required'>&nbsp;*</span>\" : '').\"\n    \".($options['tip'] ? \"<i class='pointer fa fa-question-circle' title='\".$options['tip'].\"'></i>\" : '').\"\n    </label>\" : '';\n\n    $html .= $options['inline'] && $label ? \"<div class='col-xs-12 col-sm-9 col-md-9 col-lg-9'>\" : '';\n\n    $html .= \"<div class='row'>\";\n\n    $html .= \"<div class='col-xs-12 col-sm-12 col-md-12 col-lg-12 m-b-10'>\";\n\n    $html .= \"<input type='text' name='\".$input_name.\"[]' class='form-control' id='\".$input_id.\"-street' value='\".$input_value['0'].\"' placeholder='\".$locale['street1'].($options['required'] ? \"*\" : '').\"'\".($options['deactivate'] ? \" readonly\" : '').\" />\";\n\n    $html .= (($options['required'] == 1 && \\defender::inputHasError($input_name.'-'.$validation_key[0])) || \\defender::inputHasError($input_name.'-'.$validation_key[0])) ? \"<div id='\".$options['input_id'].\"-street-help' class='label label-danger p-5 display-inline-block'>\".$options['error_text'].\"</div>\" : \"\";\n\n    $html .= \"</div>\";\n\n    $html .= \"<div class='col-xs-12 col-sm-12 col-md-12 col-lg-12 m-b-10'>\";\n    // Street 2 is not needed even on required.\n    $html .= \"<input type='text' name='\".$input_name.\"[]' class='form-control' id='\".$input_id.\"-street2' value='\".$input_value['1'].\"' placeholder='\".$locale['street2'].\"'\".($options['deactivate'] ? \" readonly\" : '').\" />\";\n\n    $html .= \"</div>\";\n\n    $html .= \"<div class='col-xs-12 col-sm-5 col-md-5 col-lg-5 m-b-10'>\";\n\n    $html .= \"<select name='\".$input_name.\"[]' id='$input_id-country' style='width:100%;'>\";\n\n    $html .= \"<option value=''></option>\";\n    foreach ($countries as $arv => $countryname) { // outputs: key, value, class - in order\n        $country_key = str_replace(\" \", \"-\", $countryname);\n        $select = ($input_value[2] == $country_key) ? \"selected\" : '';\n        $html .= \"<option value='$country_key' \".$select.\">\".translate_country_names($countryname).\"</option>\";\n    }\n\n    $html .= \"</select>\";\n\n    $html .= (($options['required'] == 1 && \\defender::inputHasError($input_name.'-'.$validation_key[2])) || \\defender::inputHasError($input_name.'-'.$validation_key[2])) ? \"<div id='\".$options['input_id'].\"-country-help' class='label label-danger p-5 display-inline-block'>\".$options['error_text_3'].\"</div>\" : \"\";\n\n    $html .= \"</div>\";\n\n    $html .= \"<div class='col-xs-12 col-sm-7 col-md-7 col-lg-7 m-b-10'>\";\n\n    $html .= \"<div id='state-spinner' style='display:none;'><img src='\".fusion_get_settings('siteurl').\"images/loader.svg'></div>\";\n\n    $html .= \"<input type='hidden' name='\".$input_name.\"[]' id='$input_id-state' value='\".$input_value['3'].\"' style='width:100%;' />\";\n\n    $html .= (($options['required'] == 1 && \\defender::inputHasError($input_name.'-'.$validation_key[3])) || \\defender::inputHasError($input_name.'-'.$validation_key[3])) ? \"<div id='\".$options['input_id'].\"-state-help' class='label label-danger p-5 display-inline-block'>\".$options['error_text_4'].\"</div>\" : \"\";\n\n    $html .= \"</div>\";\n\n    $html .= \"<div class='col-xs-12 col-sm-5 col-md-5 col-lg-5 m-b-10'>\";\n\n    $html .= \"<input type='text' name='\".$input_name.\"[]' id='\".$input_id.\"-city' class='form-control textbox' value='\".$input_value['4'].\"' placeholder='\".$locale['city'].($options['required'] ? \"*\" : '').\"'\".($options['deactivate'] ? \" readonly\" : '').\" />\";\n\n    $html .= (($options['required'] == 1 && \\defender::inputHasError($input_name)) || \\defender::inputHasError($input_name)) ? \"<div id='\".$options['input_id'].\"-city-help' class='label label-danger p-5 display-inline-block'>\".$options['error_text_5'].\"</div>\" : \"\";\n\n    $html .= \"</div>\";\n\n    $html .= \"<div class='col-xs-12 col-sm-7 col-md-4 col-lg-7 m-b-10'>\";\n\n    $html .= \"<input type='text' name='\".$input_name.\"[]'  id='\".$input_id.\"-postcode' class='form-control textbox' value='\".$input_value['5'].\"' placeholder='\".$locale['postcode'].($options['required'] ? \"*\" : '').\"'\".($options['deactivate'] ? \" readonly\" : '').\" />\";\n\n    $html .= (($options['required'] == 1 && \\defender::inputHasError($input_name.'-'.$validation_key[5])) || \\defender::inputHasError($input_name.'-'.$validation_key[5])) ? \"<div id='\".$options['input_id'].\"-postcode-help' class='label label-danger p-5 display-inline-block'>\".$options['error_text_6'].\"</div>\" : \"\";\n\n    $html .= \"</div>\";\n\n    $html .= \"</div>\"; // close inner row\n\n    $html .= $options['stacked'];\n\n    $html .= $options['inline'] && $label ? \"</div>\" : \"\";\n\n    $html .= \"</div>\";\n\n    \\defender::getInstance()->add_field_session([\n        'input_name'   => $input_name,\n        'type'         => 'address',\n        'title'        => $title,\n        'id'           => $input_id,\n        'required'     => $options['required'],\n        'safemode'     => $options['safemode'],\n        'error_text'   => $options['error_text'],\n        'error_text_2' => $options['error_text_2'],\n        'error_text_3' => $options['error_text_3'],\n        'error_text_4' => $options['error_text_4'],\n        'error_text_5' => $options['error_text_5'],\n        'error_text_6' => $options['error_text_6']\n    ]);\n\n    $flag_function = '';\n    $flag_plugin = '';\n    if ($options['flag']) {\n        $flag_function = \"\n        function show_flag(item) {\n        if(!item.id) {return item.text;}\n        var icon = '\".IMAGES.\"small_flag/flag_'+ item.id.replace(/-/gi,'_').toLowerCase() +'.png';\n        return '<img style=\\\"float:left; margin-right:5px; margin-top:3px;\\\" src=\\\"' + icon + '\\\"/></i>' + item.text;\n        }\";\n        $flag_plugin = \"\n         formatResult: show_flag,\n         formatSelection: show_flag,\n         escapeMarkup: function(m) { return m; },\n        \";\n    }\n\n    $states_array[] = [\"id\" => \"Other\", \"text\" => fusion_get_locale('other_states')];\n    $states_array = json_encode($states_array);\n\n    add_to_jquery(\"\n    \".$flag_function.\"\n    $('#$input_id-country').select2({\n    $flag_plugin\n    placeholder: '\".$locale['sel_country'].\" \".($options['required'] == 1 ? '*' : '').\"'\n    });\n\n    $('#\".$input_id.\"-state').select2({\n            placeholder: '\".$locale['sel_state'].\" \".($options['required'] == 1 ? '*' : '').\"',\n            allowClear: true,\n            data: $states_array\n    });\n\n    $('#\".$input_id.\"-country').bind('change', function(){\n        var ce_id = $(this).val();\n        $.ajax({\n        url: '\".fusion_get_settings('site_path').\"includes/geomap/form_geomap.json.php',\n        type: 'GET',\n        data: { id : ce_id },\n        dataType: 'json',\n        beforeSend: function(e) {\n            //$('#state-spinner').show();\n            $('#\".$input_id.\"-state').hide();\n        },\n        success: function(data) {\n            console.log(data);\n            //$('#state-spinner').hide();\n            $('#\".$input_id.\"-state').select2({\n                placeholder: '\".$locale['sel_state'].\" \".($options['required'] == 1 ? '*' : '').\"',\n                allowClear: true,\n                data : data\n            });\n        },\n        error : function() {\n            console.log('Error Fetching');\n        }\n        })\n    }).trigger('change');\n    \");\n\n    load_select2_script();\n\n    return $html;\n}\n\nfunction form_location($input_name, $label = '', $input_value = FALSE, array $options = []) {\n    $locale = fusion_get_locale();\n    $title = $label ? stripinput($label) : ucfirst(strtolower(str_replace(\"_\", \" \", $input_name)));\n\n    if (!defined('PLOCATION')) {\n        define('PLOCATION', TRUE);\n        add_to_jquery(\"\n        function plocation(item) {\n            if(!item.id) {return item.text;}\n            var flag = item.flag;\n            var region = item.region;\n            return '<table><tr><td style=\\\"\\\"><img style=\\\"height:16px;\\\" src=\\\"\".IMAGES.\"/' + flag + '\\\"/></td><td style=\\\"padding-left:10px\\\"><div>' + item.text + '</div></div></td></tr></table>';\n        }\n        \");\n    }\n\n    $input_name = (isset($input_name) && (!empty($input_name))) ? stripinput($input_name) : \"\";\n\n    $default_options = [\n        'options'        => [],\n        'required'       => FALSE,\n        'regex'          => '',\n        'input_id'       => $input_name,\n        'placeholder'    => $locale['choose-location'],\n        'deactivate'     => FALSE,\n        'safemode'       => FALSE,\n        'allowclear'     => FALSE,\n        'flag'           => FALSE,\n        'multiple'       => FALSE,\n        'width'          => '250px',\n        'keyflip'        => FALSE,\n        'tags'           => FALSE,\n        'jsonmode'       => FALSE,\n        'chainable'      => FALSE,\n        'max_select'     => 1,\n        'error_text'     => $locale['error_input_default'],\n        'class'          => '',\n        'inline'         => FALSE,\n        'tip'            => '',\n        'ext_tip'        => '',\n        'delimiter'      => ',',\n        'callback_check' => '',\n        \"stacked\"        => \"\",\n        'icon'           => '',\n        'file'           => '',\n    ];\n\n    $options += $default_options;\n\n    $countries = [];\n    if ($options['multiple'] == FALSE) {\n        require(INCLUDES.'geomap/geomap.inc.php');\n    }\n\n    // always trim id\n    $options['input_id'] = trim($options['input_id'], \"[]\");\n\n    $length = \"minimumInputLength: 1,\";\n\n    $error_class = \"\";\n    if (\\defender::inputHasError($input_name)) {\n        $error_class = \"has-error \";\n        if (!empty($options['error_text'])) {\n            $new_error_text = \\defender::getErrorText($input_name);\n            if (!empty($new_error_text)) {\n                $options['error_text'] = $new_error_text;\n            }\n            addNotice(\"danger\", \"<strong>$title</strong> - \".$options['error_text']);\n        }\n    }\n\n    $html = \"<div id='\".$options['input_id'].\"-field' class='form-group \".($options['inline'] ? 'row ' : '').$error_class.$options['class'].\" \".($options['icon'] ? 'has-feedback' : '').\"'  \".($options['width'] && !$label ? \"style='width: \".$options['width'].\"'\" : '').\">\";\n\n    $html .= ($label) ? \"<label class='control-label \".($options['inline'] ? \"col-xs-12 col-sm-3 col-md-3 col-lg-3\" : 'col-xs-12 col-sm-12 col-md-12 col-lg-12 p-l-0').\"' for='\".$options['input_id'].\"'>$label \".($options['required'] == TRUE ? \"<span class='required'>*</span>\" : '').\"\n    \".($options['tip'] ? \"<i class='pointer fa fa-question-circle' title='\".$options['tip'].\"'></i>\" : '').\"\n    </label>\" : '';\n\n    $html .= ($options['inline'] && $label) ? \"<div class='col-xs-12 \".($label ? \"col-sm-9 col-md-9 col-lg-9\" : \"col-sm-12\").\"'>\" : \"\";\n\n    if ($options['multiple'] == TRUE) {\n\n        $html .= \"<input \".($options['required'] ? \"class='req'\" : '').\" type='hidden' name='$input_name' id='\".$options['input_id'].\"' data-placeholder='\".$options['placeholder'].\"' style='width: \".($options['width'] ? $options['width'] : $default_options['width']).\"' \".($options['deactivate'] ? 'disabled' : '').\" />\";\n\n        $path = $options['file'] ? $options['file'] : DYNAMICS.\"assets/location/location.json.php\";\n        if (!empty($input_value)) {\n            // json mode.\n            $encoded = $options['file'] ? $options['file'] : location_search($input_value);\n        } else {\n            $encoded = json_encode([]);\n        }\n        add_to_jquery(\"\n        $('#\".$options['input_id'].\"').select2({\n        $length\n        multiple: \".($options['multiple'] ? \"true\" : \"false\").\",\n        maximumSelectionSize: \".$options['max_select'].\",\n        ajax: {\n        url: '$path',\n        dataType: 'json',\n        data: function (term, page) {\n                return {q: term};\n              },\n              results: function (data, page) {\n                return {results: data};\n              }\n        },\n        formatSelection: plocation,\n        escapeMarkup: function(m) { return m; },\n        formatResult: plocation,\n        \".$options['allowclear'].\"\n        })\".(!empty($encoded) ? \".select2('data', $encoded );\" : '').\"\n    \");\n\n    } else {\n\n        $html .= \"<select name='\".$input_name.\"' id='\".$options['input_id'].\"' style='width:\".($options['width'] ? $options['width'] : $default_options['width']).\"' />\";\n        $html .= \"<option value=''></option>\";\n        foreach ($countries as $arv => $countryname) { // outputs: key, value, class - in order\n            $country_key = str_replace(\" \", \"-\", $countryname);\n            $select = ($input_value == $country_key) ? \"selected\" : '';\n            $html .= \"<option value='$country_key' \".$select.\">\".translate_country_names($countryname).\"</option>\";\n        }\n        $html .= \"</select>\";\n\n        $flag_function = '';\n        $flag_plugin = '';\n        if ($options['flag']) {\n            $flag_function = \"\n            function show_flag(item) {\n                if(!item.id) {return item.text;}\n                var icon = '\".IMAGES.\"small_flag/flag_'+ item.id.replace(/-/gi,'_').toLowerCase() +'.png';\n                return '<img style=\\\"float:left; margin-right:5px; margin-top:3px;\\\" src=\\\"' + icon + '\\\"/></i>' + item.text;\n            }\n            \";\n            $flag_plugin = \"\n            formatResult: show_flag,\n            formatSelection: show_flag,\n            escapeMarkup: function(m) { return m; },\n            \";\n        }\n\n        add_to_jquery(\"\n        \".$flag_function.\"\n        $('#\".$options['input_id'].\"').select2({\n            $flag_plugin\n            placeholder: '\".$locale['sel_country'].\" \".($options['required'] == 1 ? '*' : '').\"'\n        });\n        \");\n\n    }\n\n    $html .= $options['stacked'];\n    $html .= $options['ext_tip'] ? \"<br/><span class='tip'><i>\".$options['ext_tip'].\"</i></span>\" : \"\";\n    if ($options['deactivate']) {\n        $html .= form_hidden($input_name, \"\", $input_value, [\"input_id\" => $options['input_id']]);\n    }\n\n    $html .= \\defender::inputHasError($input_name) ? \"<div class='input-error\".((!$options['inline']) ? \" display-block\" : \"\").\"'><div id='\".$options['input_id'].\"-help' class='label label-danger p-5 display-inline-block'>\".$options['error_text'].\"</div></div>\" : '';\n\n    $html .= ($options['inline'] && $label) ? \"</div>\" : \"\";\n\n    $html .= \"</div>\";\n\n    \\defender::add_field_session([\n        'input_name'     => clean_input_name($input_name),\n        'type'           => 'textbox',\n        'title'          => trim($title, '[]'),\n        'id'             => $options['input_id'],\n        'regex'          => $options['regex'],\n        'callback_check' => $options['callback_check'],\n        'required'       => $options['required'],\n        'safemode'       => $options['safemode'],\n        'error_text'     => $options['error_text']\n    ]);\n\n    load_select2_script();\n\n    return $html;\n}\n\nfunction map_country($states, $country) {\n    $states_list = [];\n    $flag = \"small_flag/flag_\".str_replace('-', '_', strtolower($country)).\".png\";\n    foreach ($states[$country] as $states_name) {\n        $states_list[] = [\n            'id' => \"$states_name\", 'text' => \"$states_name, $country\", 'flag' => \"$flag\", \"region\" => \"$country\"\n        ];\n    }\n\n    return $states_list;\n}\n\nfunction map_region($states) {\n    $states_list = [];\n    foreach ($states as $country_name => $country_states) {\n        $flag = \"small_flag/flag_\".str_replace('-', '_', strtolower($country_name)).\".png\";\n        foreach ($country_states as $states_name) { // add [] to prevent duplicate since Sabah exist in Yemen and Malaysia.\n            $states_list[$states_name][] = [\n                'id'     => \"$states_name\", 'text' => \"$states_name, $country_name\", 'flag' => \"$flag\",\n                \"region\" => \"$country_name\"\n            ];\n        }\n    }\n\n    return $states_list;\n}\n\n/* Returns Json Encoded Object used in form_select_user */\nfunction location_search($q) {\n    $states = [];\n    include INCLUDES.\"geomap/geomap.inc.php\";\n    // since search is on user_name.\n    $found = 0;\n    foreach (array_keys($states) as $k) { // type the country then output full states\n        if (preg_match('/^'.$q.'/', $k, $matches)) {\n            header('Content-Type: application/json');\n            $states_list = map_country($states, $k);\n            return json_encode($states_list);\n        }\n    }\n    if (!$found) { // a longer version\n        $region_list = map_region($states);\n        if (array_key_exists($q, $region_list)) {\n            header('Content-Type: application/json');\n            return json_encode($region_list[$q]);\n        }\n    }\n\n    return FALSE;\n}\n", "<?php\n/*-------------------------------------------------------+\n| PHPFusion Content Management System\n| Copyright (C) PHP Fusion Inc\n| https://phpfusion.com/\n+--------------------------------------------------------+\n| Filename: form_hidden.php\n| Author: Frederick MC Chan (Chan)\n+--------------------------------------------------------+\n| This program is released as free software under the\n| Affero GPL license. You can redistribute it and/or\n| modify it under the terms of this license which you\n| can read by viewing the included agpl.txt or online\n| at www.gnu.org/licenses/agpl.html. Removal of this\n| copyright header is strictly prohibited without\n| written permission from the original author(s).\n+--------------------------------------------------------*/\n/**\n * @param        $input_name\n * @param string $label\n * @param string $input_value\n * @param array  $options\n *\n * @return string\n */\nfunction form_hidden($input_name, $label = \"\", $input_value = \"\", array $options = []) {\n    $title = $label ? stripinput($label) : ucfirst(strtolower(str_replace(\"_\", \" \", $input_name)));\n    $html = '';\n    $default_options = [\n        'input_id'    => $input_name,\n        'show_title'  => FALSE,\n        'width'       => '100%',\n        'class'       => '',\n        'inline'      => FALSE,\n        'required'    => FALSE,\n        'placeholder' => '',\n        'deactivate'  => FALSE,\n        'delimiter'   => ',',\n        'error_text'  => '',\n    ];\n    $options += $default_options;\n\n    if ($options['show_title']) {\n        $html .= \"<div id='\".$options['input_id'].\"-field' class='form-group \".($options['inline'] ? 'display-block overflow-hide ' : '').$options['class'].\" '>\\n\";\n        $html .= ($label) ? \"<label class='control-label\".($options['inline'] ? \" col-xs-12 col-sm-3 col-md-3 col-lg-3\" : '').\"' for='\".$options['input_id'].\"'>\".$title.($options['required'] ? \"<span class='required'>&nbsp;*</span>\" : '').\"</label>\\n\" : '';\n        $html .= $options['inline'] ? \"<div class='col-xs-12 col-sm-9 col-md-9 col-lg-9'>\\n\" : '';\n    }\n    $html .= \"<input type='hidden' name='$input_name' id='\".$options['input_id'].\"' value='$input_value'\".($options['width'] ? \" style='width:\".$options['width'].\"'\" : '').($options['show_title'] ? \"\" : \" readonly\").\" />\\n\";\n    if ($options['show_title']) {\n        $html .= \"<div id='\".$options['input_id'].\"-help'></div>\";\n        $html .= ($options['inline']) ? \"</div>\\n\" : \"\";\n        $html .= \"</div>\\n\";\n    }\n\n    \\defender::add_field_session([\n        'input_name' => clean_input_name($input_name),\n        'title'      => trim($title, '[]'),\n        'type'       => 'textbox',\n        'id'         => $options['input_id'],\n        'required'   => $options['required'],\n        'safemode'   => '0',\n        \"delimiter\"  => $options['delimiter'],\n        'error_text' => $options['error_text']\n    ]);\n\n    return $html;\n}\n", "<?php\n/*-------------------------------------------------------+\n| PHPFusion Content Management System\n| Copyright (C) PHP Fusion Inc\n| https://phpfusion.com/\n+--------------------------------------------------------+\n| Filename: form_main.php\n| Author: Frederick MC Chan (Chan)\n+--------------------------------------------------------+\n| This program is released as free software under the\n| Affero GPL license. You can redistribute it and/or\n| modify it under the terms of this license which you\n| can read by viewing the included agpl.txt or online\n| at www.gnu.org/licenses/agpl.html. Removal of this\n| copyright header is strictly prohibited without\n| written permission from the original author(s).\n+--------------------------------------------------------*/\n/**\n * @param string $form_name\n * @param string $method     - 'post' or 'get'\n * @param string $action_url - form current uri (defaults: FORM_REQUEST)\n * @param array  $options    :\n *                           form_id = default as form_name\n *                           class = default empty\n *                           enctype = true or false , set true to allow file upload\n *                           max_tokens = store into session number of tokens , default as 1.\n *\n * @return string\n */\nfunction openform($form_name, $method, $action_url = FORM_REQUEST, array $options = []) {\n\n    $method = (strtolower($method) == 'post') ? 'post' : 'get';\n\n    $default_options = [\n        'form_id'    => $form_name,\n        'class'      => '',\n        'enctype'    => FALSE,\n        'max_tokens' => fusion_get_settings('form_tokens'),\n        'inline'     => FALSE,\n        'on_submit'  => '',\n        'honeypot'   => TRUE,\n    ];\n\n    $options += $default_options;\n\n    if (!$action_url) {\n        $action_url = FORM_REQUEST;\n    }\n\n    $class = $options['class'];\n\n    if (!fusion_safe()) {\n        $class .= \" warning\";\n    }\n\n    $html = \"<form name='\".$form_name.\"' id='\".$options['form_id'].\"' method='\".$method.\"' action='\".$action_url.\"' class='\".($options['inline'] ? \"form-inline \" : '').($class ? $class : 'm-0').\"'\".($options['enctype'] ? \" enctype='multipart/form-data'\" : '').($options['on_submit'] ? \" onSubmit='\".$options['on_submit'].\"'\" : '').\">\\n\";\n\n    if ($method == 'post') {\n        $token = fusion_get_token($options['form_id'], $options['max_tokens']);\n        $html .= \"<input type='hidden' name='fusion_token' value='\".$token.\"' />\\n\";\n        $html .= \"<input type='hidden' name='form_id' value='\".$options['form_id'].\"' />\\n\";\n        if ($options['honeypot']) {\n            $input_name = 'fusion_'.random_string();\n            $html .= \"<input type='hidden' name='$input_name' value=''>\\n\";\n            Defender::getInstance()->addHoneypot([\n                'honeypot'   => $options['form_id'].'_honeypot',\n                'input_name' => $input_name,\n                'form_name'  => $form_name,\n                'type'       => 'honeypot',\n            ]);\n        }\n    }\n\n    return (string)$html;\n}\n\n/**\n * @return string\n */\nfunction closeform() {\n    return (string)\"</form>\\n\";\n}\n\nfunction clean_input_name($value) {\n    $re = '/\\[(.*?)\\]/m';\n    return preg_replace($re, '', $value);\n}\n\nfunction load_select2_script() {\n    static $loaded = FALSE;\n    if ($loaded === FALSE) {\n        /**\n         * @return string\n         * @see load_select2_script()\n         */\n        function select2csspath() {\n            return DYNAMICS.\"assets/select2/select2.css\";\n        }\n\n        $select2_locale_path = DYNAMICS.\"assets/select2/select2_locale_\".fusion_get_locale('select2').\".js\";\n        fusion_load_script(DYNAMICS.\"assets/select2/select2.js\");\n\n        if (is_file($select2_locale_path)) {\n            fusion_load_script($select2_locale_path);\n        }\n\n        /**\n         * @uses  select2csspath()\n         */\n        fusion_add_hook(\"fusion_core_styles\", \"select2csspath\");\n\n        $loaded = TRUE;\n    }\n}\n", "<?php\n/*-------------------------------------------------------+\n| PHPFusion Content Management System\n| Copyright (C) PHP Fusion Inc\n| https://phpfusion.com/\n+--------------------------------------------------------+\n| Filename: form_name.php\n| Author: Frederick MC CHan (Chan)\n+--------------------------------------------------------+\n| This program is released as free software under the\n| Affero GPL license. You can redistribute it and/or\n| modify it under the terms of this license which you\n| can read by viewing the included agpl.txt or online\n| at www.gnu.org/licenses/agpl.html. Removal of this\n| copyright header is strictly prohibited without\n| written permission from the original author(s).\n+--------------------------------------------------------*/\n\nfunction form_name($input_name, $label = \"\", $input_value = FALSE, array $options = []) {\n\n    $locale = fusion_get_locale();\n\n    $title = (isset($label) && (!empty($label))) ? $label : ucfirst(strtolower(str_replace(\"_\", \" \", $input_name)));\n\n    // NOTE (remember to parse readback value as of '|' seperator)\n    if (!empty($input_value)) {\n        if (!is_array($input_value)) {\n            $input_value = explode('|', $input_value);\n        }\n    } else {\n        $input_value['0'] = '';\n        $input_value['1'] = '';\n        $input_value['2'] = '';\n    }\n\n    $options += [\n        'input_id'     => $input_name,\n        'required'     => FALSE,\n        'placeholder'  => '',\n        'deactivate'   => FALSE,\n        'width'        => '100%',\n        'class'        => '',\n        'inline'       => FALSE,\n        'error_text'   => !empty($options['error_text']) ? $options['error_text'] : $locale['firstname_error'],\n        'error_text_2' => !empty($options['error_text']) ? $options['error_text_2'] : $locale['lastname_error'],\n        'tip'          => '',\n        'safemode'     => FALSE,\n        'stacked'      => '',\n    ];\n\n    $error_class = \\defender::inputHasError($input_name.'-firstname') || \\defender::inputHasError($input_name.'-lastname') ? \"has-error \" : \"\";\n    $html = \"<div id='\".$options['input_id'].\"-field' class='form-group \".($options['inline'] && $label ? 'row ' : '').$error_class.$options['class'].\"' >\\n\";\n\n    if ($label) {\n        $html .= \"<label class='control-label \".($options['inline'] ? \"col-xs-12 col-sm-3 col-md-3 col-lg-3\" : '').\"' for='\".$options['input_id'].\"'> \".$label.($options['required'] ? \"<span class='required'>&nbsp;*</span>\" : '').\"\n\t    \".($options['tip'] ? \"<i class='pointer fa fa-question-circle' title='\".$options['tip'].\"'></i>\" : '').\"\n\t    </label>\\n\";\n    }\n\n    $html .= $options['inline'] && $label ? \"<div class='col-xs-12 col-sm-9 col-md-9 col-lg-9'>\\n\" : \"\";\n\n    $html .= \"<div class='row p-l-15'>\\n\";\n\n    $html .= \"<div class='col-xs-12 col-sm-4 col-md-4 col-lg-4 m-b-10 p-l-0'>\\n\";\n\n    $html .= \"<input type='text' name='\".$input_name.\"[]' class='form-control textbox' id='\".$options['input_id'].\"-firstname' value='\".$input_value['0'].\"' placeholder='\".$locale['first_name'].\" \".($options['required'] ? '*' : '').\"' \".($options['deactivate'] == \"1\" ? \"readonly\" : '').\" />\\n\";\n\n    $html .= ($options['required'] == 1 && \\defender::inputHasError($input_name[0])) || \\defender::inputHasError($input_name[0]) ? \"<div id='\".$options['input_id'].\"-firstname-help' class='label label-danger p-5 display-inline-block'>\".$options['error_text'].\"</div>\" : \"\";\n\n    $html .= \"</div>\\n\";\n\n    $html .= \"<div class='col-xs-12 col-sm-4 col-md-4 col-lg-4 m-b-10'>\\n\";\n    $html .= \"<input type='text' name='\".$input_name.\"[]' class='form-control textbox' id='\".$options['input_id'].\"-lastname' value='\".$input_value['1'].\"' placeholder='\".$locale['last_name'].\" \".($options['required'] ? '*' : '').\"' \".($options['deactivate'] == \"1\" ? \"readonly\" : '').\" />\\n\";\n    $html .= ($options['required'] == 1 && \\defender::inputHasError($input_name[1])) || \\defender::inputHasError($input_name[1]) ? \"<div id='\".$options['input_id'].\"-lastname-help' class='label label-danger p-5 display-inline-block'>\".$options['error_text_2'].\"</div>\" : \"\";\n    $html .= \"</div>\\n\";\n\n    $html .= $options['stacked'];\n\n    $html .= \"</div>\\n\"; // close inner row\n\n    $html .= $options['inline'] && $label ? \"</div>\\n\" : \"\";\n\n    $html .= \"</div>\\n\";\n\n    \\defender::getInstance()->add_field_session([\n        'input_name'   => $input_name,\n        'type'         => 'name',\n        'title'        => $title,\n        'id'           => $options['input_id'],\n        'required'     => $options['required'],\n        'safemode'     => $options['safemode'],\n        'error_text'   => $options['error_text'],\n        'error_text_2' => $options['error_text_2']\n    ]);\n\n    return $html;\n}\n", "<?php\n/*-------------------------------------------------------+\n| PHPFusion Content Management System\n| Copyright (C) PHP Fusion Inc\n| https://phpfusion.com/\n+--------------------------------------------------------+\n| Filename: form_ordering.php\n| Author: Core Development Team (coredevs@phpfusion.com)\n+--------------------------------------------------------+\n| This program is released as free software under the\n| Affero GPL license. You can redistribute it and/or\n| modify it under the terms of this license which you\n| can read by viewing the included agpl.txt or online\n| at www.gnu.org/licenses/agpl.html. Removal of this\n| copyright header is strictly prohibited without\n| written permission from the original author(s).\n+--------------------------------------------------------*/\n\nfunction make_order_opts($result, $id_col, $cat_col, $title_col, $order_col) {\n    $master_sort = sorter($result, $order_col);\n    $option = [];\n    foreach ($master_sort as $data) {\n        $title = $data[$title_col];\n        $order = $data[$order_col];\n        $cat = $data[$cat_col];\n        $id = $data[$id_col];\n        $option[] = [\"id\" => \"$id\", \"title\" => \"\".$order.\". \".$title.\"\", \"order\" => \"$order\", \"cat\" => \"$cat\"];\n        if (array_key_exists(\"children\", $data)) {\n            $option = array_merge($option,\n                make_order_opts($data['children'], $id_col, $cat_col, $title_col, $order_col));\n        }\n    }\n\n    return $option;\n}\n\nfunction form_select_order($title, $input_name, $input_id, $option_array, $input_value, $chain_to_parent_id, $array = FALSE) {\n\n    if (isset($title) && ($title !== \"\")) {\n        $title = stripinput($title);\n    } else {\n        $title = \"\";\n    }\n    if (isset($input_name) && ($input_name !== \"\")) {\n        $input_name = stripinput($input_name);\n    } else {\n        $input_name = \"\";\n    }\n    if (!is_array($array)) {\n        $state_validation = \"\";\n        $placeholder = \"\";\n        $multiple = \"\";\n        $allowclear = \"\";\n        $width = \"style='width:250px;'\";\n    } else {\n        $required = (array_key_exists('required', $array)) ? $array['required'] : \"\";\n        $is_multiple = (array_key_exists('is_multiple', $array)) ? $array['is_multiple'] : \"\";\n        $placeholder = (array_key_exists('placeholder', $array)) ? $array['placeholder'] : \"\";\n        $width = (array_key_exists('width', $array)) ? \"style='width:\".$array['width'].\"'\" : \"style='width:250px;'\";\n        $allowclear = ($placeholder !== \"\") ? \"allowClear:true\" : \"\";\n        // $requested by Tyler for his project\n        if (($required == \"1\") && (empty($_POST['$input_name']))) {\n            $state_validation = \"has-error\";\n        } else {\n            $state_validation = \"\";\n        }\n        $multiple = ($is_multiple == \"1\") ? \"multiple\" : \"\";\n    }\n    $html = \"\";\n    $html .= \"<div class='form-group \".$state_validation.\" lres'><label class='col-lg-3 control-label' for='$input_id'>$title</label>\";\n    $html .= \"<div class='col-lg-9'>\";\n    $html .= \"<select name='$input_name' id='$input_id' $width $multiple>\";\n    if (is_array($option_array)) {\n        foreach ($option_array as $arr) { // outputs: key, value, class - in order\n            // will not select\n            //print_p($option_array);\n            //print_p($input_value);\n            // accepts format input:\n            /*\n             *  $arr['cat'] = \"the parent's value\"\n             *  $arr['order'] = \"the order\"\n             *  $arr['title'] = \"the name\"\n             */\n            if (array_key_exists(\"cat\", $arr)) {\n                $subclass = \"class='\".$arr['cat'].\"'\";\n            } else {\n                $subclass = \"\";\n            } // this one is used as chain selects\n            $html .= \"<option $subclass value='\".$arr['order'].\"'>\".$arr['title'].\"</option>\";\n        }\n    } else {\n        $html .= \"<option value=''></option>\";\n    }\n    $html .= \"</select>\";\n    add_to_jquery(\"\n        $('#\".$input_id.\"').select2({\n        placeholder: '\".$placeholder.\"',\n        $allowclear\n        });\n    \");\n    add_to_jquery(\"$('#\".$input_id.\"').chained('#\".$chain_to_parent_id.\"');\");\n    $html .= \"</div></div>\";\n\n    load_select2_script();\n    fusion_load_script(DYNAMICS.\"assets/chainselect/jquery.chained.js\");\n\n    return $html;\n}\n", "<?php\n/*-------------------------------------------------------+\n| PHPFusion Content Management System\n| Copyright (C) PHP Fusion Inc\n| https://phpfusion.com/\n+--------------------------------------------------------+\n| Filename: form_select.php\n| Author: Frederick MC Chan (Chan)\n| Co-Author: Tak\u00e1cs \u00c1kos (Rimelek)\n+--------------------------------------------------------+\n| This program is released as free software under the\n| Affero GPL license. You can redistribute it and/or\n| modify it under the terms of this license which you\n| can read by viewing the included agpl.txt or online\n| at www.gnu.org/licenses/agpl.html. Removal of this\n| copyright header is strictly prohibited without\n| written permission from the original author(s).\n+--------------------------------------------------------*/\n\n/**\n * Select2 dynamics plugin version 3.5 (stable)\n *\n * Note on Tags Support\n * $options['tags'] = default $input_value must not be multidimensional array but only as $value = array(TRUE,'2','3');\n * For tagging - set both tags and multiple to TRUE\n * http://select2.github.io/select2/\n *\n * @param        $input_name\n * @param string $label\n * @param        $input_value\n * @param array  $options\n *\n * Setting up a select chain\n *\n * There will be 2 select box, Parent Select and Child Select\n * Parent Select has options value of: array(1 => 'Parent A', 2 => 'Parent B')\n * Parent Child has options value of: array(3 => 'Child A', 4 => 'Child B');\n * The way that these two select chain to each other is via $options['chain_index'] with a value of:\n * array(3 => 1, 4 => 1); ***\n * The above array is the 'id of child A' => 'id of parent of A'\n * key - current option value (i.e. +60)\n * value - parent value that this option value is chained against (i.e. Malaysia)\n *\n * Implementation\n * 1. Do nothing for Parent Select\n * 2. In Child Select add:\n * $options['chainable'] - set to true\n * $options['chain_to_id'] - unique input_id of the Parent Select\n * $options['chain_index'] - the chain array (see ***)\n *\n * Example code\n * form_select('parent', 'Parent Sample', $parent_callback_value, ['options'=>$parent_opts]);\n * form_select('child', 'Child Sample', $child_callback_value, ['options' => $child_opts, 'chainable'=>TRUE, 'chain_to_id'=>'parent', 'chain_index'=>$chain_index_opts]);\n *\n * @return string\n *\n * @package dynamics/select2\n */\nfunction form_select($input_name, $label, $input_value, $options = []) {\n    $locale = fusion_get_locale();\n\n    $title = $label ? stripinput($label) : ucfirst(strtolower(str_replace(\"_\", \" \", $input_name)));\n\n    $default_options = [\n        'options'              => [],\n        'required'             => FALSE,\n        'regex'                => '',\n        'input_id'             => $input_name,\n        'placeholder'          => $locale['choose'],\n        'deactivate'           => FALSE,\n        'safemode'             => FALSE,\n        'allowclear'           => FALSE,\n        'multiple'             => FALSE,\n        'width'                => '',\n        'inner_width'          => '250px',\n        'keyflip'              => FALSE,\n        'tags'                 => FALSE,\n        'jsonmode'             => FALSE,\n        'chainable'            => FALSE,      // Set to True to Enable Chaining\n        'chain_to_id'          => '',         // Set which select it has to be chained to.\n        'db'                   => '',         // Specify which DB to map\n        'id_col'               => '',         // Chain Primary Key Column Name\n        'cat_col'              => '',         // Chain Category Column Name\n        'title_col'            => '',         // Chain Title Column Name\n        'custom_query'         => '',         // SQL query replacements\n        'value_filter'         => ['col' => '', 'value' => NULL], // Specify if building opts has to specifically match these conditions\n        'optgroup'             => FALSE,      // Enable the option group output - if db, id_col, cat_col, and title_col is specified.\n        'option_pattern'       => \"&#8212;\",\n        'display_search_count' => \"5\",\n        'max_select'           => FALSE,\n        'error_text'           => $locale['error_input_default'],\n        'class'                => '',\n        'inline'               => FALSE,\n        'tip'                  => '',\n        'ext_tip'              => '',\n        'delimiter'            => ',',\n        'callback_check'       => '',\n        'stacked'              => '',\n        'onchange'             => '',\n        'select2_disabled'     => FALSE, // if select2_disabled is set to true, then we will not use the select2 plugin\n        'parent_value'         => $locale['root'],\n        'add_parent_opts'      => FALSE,\n        'disable_opts'         => '',\n        'hide_disabled'        => FALSE,\n        'no_root'              => FALSE,\n        'show_current'         => FALSE,\n        'db_cache'             => TRUE,\n        'data'                 => []\n    ];\n\n    $options += $default_options;\n    $disable_opts = '';\n    if ($options['disable_opts']) {\n        $disable_opts = is_array($options['disable_opts']) ? $options['disable_opts'] : explode(',', $options['disable_opts']);\n    }\n    $list = [];\n\n    static $select_db = [];\n    // New DB Caching Function.\n    if ($options['db'] && $options['id_col'] && $options['title_col']) {\n\n        // Cache result\n        $cache = ($options['custom_query'] ? FALSE : TRUE);\n\n        if (empty($select_db[$options['db']]) || (!$cache or $options['db_cache'] === FALSE)) {\n            if (!empty($options['cat_col'])) {\n                $select_db[$options['db']] = dbquery_tree_full($options['db'], $options['id_col'], $options['cat_col'], \"ORDER BY \".$options['cat_col'].\" ASC, \".$options['id_col'].\" ASC, \".$options['title_col'].\" ASC\", ($options['custom_query'] ?: \"\"));\n            } else {\n                // if there is a custom query\n                if ($options['custom_query']) {\n                    $select_result = dbquery($options['custom_query']);\n                } else {\n                    $select_result = dbquery(\"SELECT * FROM \".$options['db'].\" ORDER BY \".$options['id_col'].\" ASC, \".$options['title_col'].\" ASC\");\n                }\n\n                // then make into hierarchy\n                if (dbrows($select_result)) {\n                    while ($data = dbarray($select_result)) {\n                        $list[0][$data[$options['id_col']]] = $data;\n                    }\n                    $select_db[$options['db']] = $list;\n                }\n            }\n            /*\n             * Build opt functions\n             */\n            if (!function_exists('get_form_select_opts')) {\n                // @todo: implement all options settings inherited from dbquery_select_hierarchy\n                function get_form_select_opts($data, $options, $id = 0, $level = 0) {\n                    $list = [];\n                    //array('text' => 'Parent Text', 'children' => array(1 => 'Child A' , 2 => 'Child B'));\n                    if (!empty($data[$id])) {\n                        foreach ($data[$id] as $key => $value) {\n                            // Displays defined pattern\n                            $pattern = \"\";\n                            if ($options['option_pattern']) {\n                                $pattern = str_repeat($options['option_pattern'], $level).\" \";\n                            }\n                            // Build List\n                            if (!empty($options['value_filter']['col']) && (!empty($options['value_filter']['value']) || $options['value_filter']['value'] !== NULL)) {\n                                if (isset($value[$options['value_filter']['col']]) && $value[$options['value_filter']['col']] == $options['value_filter']['value']) {\n                                    $list[$key] = $pattern.$value[$options['title_col']];\n                                }\n                            } else {\n                                $list[$key] = $pattern.$value[$options['title_col']];\n                            }\n                            // Build Child\n                            if (isset($data[$key])) {\n                                $child = get_form_select_opts($data, $options, $key, $level + 1);\n                                if ($options['optgroup']) {\n                                    $list[$key] = [\n                                        'text'     => $list[$key],\n                                        'children' => $child,\n                                    ];\n                                } else {\n                                    $list = (!empty($list)) ? $list + $child : $child;\n                                }\n                            }\n                        }\n                    } else {\n                        // the list does not start with a root\n                        foreach (array_keys($data) as $id) {\n                            foreach ($data[$id] as $key => $value) {\n                                // Displays defined pattern\n                                $pattern = \"\";\n                                if ($options['option_pattern']) {\n                                    $pattern = str_repeat($options['option_pattern'], $level).\" \";\n                                }\n                                // Build List\n                                if (!empty($options['value_filter']['col']) && (!empty($options['value_filter']['value']) || $options['value_filter']['value'] !== NULL)) {\n                                    if (isset($value[$options['value_filter']['col']]) && $value[$options['value_filter']['col']] == $options['value_filter']['value']) {\n                                        $list[$key] = $pattern.html_entity_decode($value[$options['title_col']]);\n                                    }\n                                } else {\n                                    $list[$key] = $pattern.html_entity_decode($value[$options['title_col']]);\n                                }\n                                // Build Child\n                                if (isset($data[$key])) {\n                                    $child = get_form_select_opts($data, $options, $key, $level + 1);\n                                    if ($options['optgroup']) {\n                                        $list[$key] = [\n                                            'text'     => $list[$key],\n                                            'children' => $child,\n                                        ];\n                                    } else {\n                                        $list = (!empty($list)) ? $list + $child : $child;\n                                    }\n                                }\n                            }\n                        }\n                    }\n\n                    return (array)$list;\n                }\n            }\n            /**\n             * Build Chainable Reference Array\n             * array key    current id\n             *      value   parent id\n             */\n            if (!function_exists('get_form_select_chain_index')) {\n                function get_form_select_chain_index($data, $options) {\n                    $list = [];\n                    if (!empty($data)) {\n                        $data = flatten_array($data);\n                        foreach ($data as $value) {\n                            $list[$value[$options['id_col']]] = $value[$options['cat_col']];\n                        }\n                    }\n\n                    return (array)$list;\n                }\n            }\n        }\n        // Automatic build chain index.\n        if ($options['chainable'] && $options['chain_to_id'] && empty($options['chain_index'])) {\n            $options['chain_index'] = get_form_select_chain_index($select_db[$options['db']], $options);\n        }\n\n        if (!empty($select_db[$options['db']])) {\n            // Build options and override declared options\n            $options['options'] = get_form_select_opts($select_db[$options['db']], $options);\n        } else {\n            $options['options'] = ['0' => $locale['no_opts']];\n            $options['deactivate'] = 1;\n        }\n    } else if (empty($options['options'])) {\n        $options['options'] = ['0' => $locale['no_opts']];\n        $options['deactivate'] = 1;\n    }\n\n    // Build a chain index and initialize the JS chain plugin\n    // $options['chainable']    - true\n    // $options['chain_to_id']  - parent id\n    // $options['chain_index'] - a list of array of current id and the parent id as value (see get_form_select_chain_index function how it's done)\n    if ($options['chainable'] && $options['chain_to_id'] && !empty($options['chain_index'])) {\n\n        fusion_load_script(DYNAMICS.\"assets/chainselect/jquery.chained.js\");\n\n        add_to_jquery(\"$('#\".$options['input_id'].\"').chained('#\".$options['chain_to_id'].\"');\");\n    }\n\n    // Optgroup with Hierarchy\n    if (!function_exists('form_select_build_optgroup')) {\n        function form_select_build_optgroup($array, $input_value, $options) {\n            $html = '';\n            $disable_opts = '';\n            if ($options['disable_opts']) {\n                $disable_opts = is_array($options['disable_opts']) ? $options['disable_opts'] : explode(',', $options['disable_opts']);\n            }\n\n            foreach ($array as $arr => $value) {\n\n                // where options is more than one value, pass to data attributes.\n                $data_attributes = '';\n                if (count($value) > 1) {\n                    $data_options = [];\n                    foreach ($value as $datakey => $dataval) {\n                        $data_options[] = \"data-$datakey='$dataval'\";\n                    }\n                    $data_attributes = \" \".implode(' ', $data_options).\" \";\n                }\n\n                $select = \"\";\n                $chain = (isset($options['chain_index'][$arr]) ? \" class='\".$options['chain_index'][$arr].\"' \" : \"\");\n                $text_value = isset($value['text']) ? $value['text'] : $value;\n                // if you have data attributes, you must have text key\n                if (!empty($text_value) && !is_array($text_value)) {\n                    if ($options['keyflip']) { // flip mode = store array values\n                        if ($input_value !== '') {\n                            $select = ($input_value == $text_value) ? \" selected\" : \"\";\n                        }\n                        $disabled = $disable_opts && in_array($arr, $disable_opts);\n                        $hide = $disabled && $options['hide_disabled'];\n                        $item = (!$hide ? \"<option\".$data_attributes.\"value='$text_value'\".$chain.$select.($disabled ? 'disabled' : '').\">\".html_entity_decode($text_value).\" \".($options['show_current'] && $input_value == $text_value ? '(Current Item)' : '').\"</option>\\n\" : \"\");\n\n                    } else {\n                        if ($input_value !== '') {\n                            $input_value = stripinput($input_value); // not sure if can turn FALSE to zero not null.\n                            $select = (isset($input_value) && $input_value == $arr) ? ' selected' : '';\n                        }\n                        $disabled = $disable_opts && in_array($arr, $disable_opts);\n                        $hide = $disabled && $options['hide_disabled'];\n                        $item = (!$hide ? \"<option\".$data_attributes.\"value='$arr'\".$chain.$select.($disabled ? 'disabled' : '').\">\".html_entity_decode($text_value).\" \".($options['show_current'] && $input_value == $text_value ? '(Current Item)' : '').\"</option>\\n\" : \"\");\n                        //$item = \"<option value='$arr'\".$chain.$select.\">$text_value</option>\\n\";\n                    }\n                    if (isset($value['children'])) {\n                        $html .= \"<optgroup label='\".$value['text'].\"'>\\n\";\n                        $html .= $item;\n                        $html .= form_select_build_optgroup($value['children'], $input_value, $options);\n                        $html .= \"</optgroup>\\n\";\n                    } else {\n                        $html .= $item;\n                    }\n                }\n\n            }\n\n            return (string)$html;\n        }\n    }\n\n    if (!$options['width']) {\n        $options['width'] = $default_options['width'];\n    }\n    if ($options['multiple']) {\n        if ($input_value) {\n            $input_value = explode($options['delimiter'], $input_value);\n        } else {\n            $input_value = [];\n        }\n    }\n\n    // always trim id\n    $options['input_id'] = trim($options['input_id'], \"[]\");\n    $allowclear = ($options['placeholder'] && $options['multiple'] || $options['allowclear']) ? \"allowClear:true,\" : '';\n\n    $error_class = \"\";\n    if (\\defender::inputHasError($input_name)) {\n        $error_class = \" has-error \";\n        if (!empty($options['error_text'])) {\n            $new_error_text = \\defender::getErrorText($input_name);\n            if (!empty($new_error_text)) {\n                $options['error_text'] = $new_error_text;\n            }\n            addNotice(\"danger\", \"<strong>$title</strong> - \".$options['error_text']);\n        }\n    }\n\n    $html = \"<div id='\".$options['input_id'].\"-field' class='form-group \".($options['inline'] && $label ? 'row' : '').$error_class.' '.$options['class'].\"' \".($options['width'] && !$label ? \"style='width: \".$options['width'].\"'\" : '').\">\\n\";\n    $html .= ($label) ? \"<label class='control-label \".($options['inline'] ? \"col-xs-12 col-sm-12 col-md-3 col-lg-3\" : '').\"' for='\".$options['input_id'].\"'>\".$label.($options['required'] == TRUE ? \"<span class='required'>&nbsp;*</span>\" : '').\"\n    \".($options['tip'] ? \"<i class='pointer fa fa-question-circle' title='\".$options['tip'].\"'></i>\" : '').\"\n    </label>\\n\" : '';\n    $html .= $options['inline'] && $label ? \"<div class='col-xs-12 col-sm-9 col-md-9 col-lg-9'>\\n\" : \"\";\n    if ($options['jsonmode'] || $options['tags']) {\n        // json mode.\n        $html .= \"<div id='\".$options['input_id'].\"-spinner' style='display:none;'>\\n<img src='\".fusion_get_settings('siteurl').\"images/loader.svg'>\\n</div>\\n\";\n        $html .= \"<input \".($options['required'] ? \"class='req'\" : '').\" type='hidden' name='$input_name' id='\".$options['input_id'].\"' style='width: \".($options['width'] ? $options['inner_width'] : $default_options['width']).\"'/>\\n\";\n    } else {\n        // normal mode\n\n        $html .= \"<select \".($options['select2_disabled'] == TRUE ? \" class='form-control' \" : \"\").\" name='$input_name' id='\".$options['input_id'].\"' style='width: \".($options['inner_width'] ? $options['inner_width'] : $default_options['inner_width']).\"'\".($options['deactivate'] ? \" disabled\" : \"\").($options['onchange'] ? ' onchange=\"'.$options['onchange'].'\"' : '').($options['multiple'] ? \" multiple\" : \"\").\">\\n\";\n        $html .= ($options['allowclear']) ? \"<option value=''></option>\\n\" : '';\n        // add parent value\n        if ($options['no_root'] == FALSE && !empty($options['cat_col']) || $options['add_parent_opts'] === TRUE) { // api options to remove root from selector. used in items creation.\n            $this_select = '';\n            if ($input_value !== NULL) {\n                if ($input_value !== '') {\n                    $this_select = 'selected';\n                }\n            }\n            $html .= \"<option value='0' \".$this_select.\" >\".$options['parent_value'].\"</option>\\n\";\n        }\n\n        /**\n         * Supported Formatting\n         * ---------------------\n         * Have an array that looks like this in 'options' key\n         * array('text' => 'Parent Text', 'children' => array(1 => 'Child A' , 2 => 'Child B'));\n         * or\n         * array(1 => 'Option A', 2 => 'Option B');\n         */\n        if (is_array($options['options'])) {\n            // Test if this is an optgroup\n            $test_array = $options['options'];\n            foreach ($test_array as $id => $v) {\n                if (isset($v['text'])) {\n                    $options['optgroup'] = TRUE;\n                    break;\n                }\n            }\n            if ($options['optgroup']) {\n                $html .= form_select_build_optgroup($options['options'], $input_value, $options);\n            } else {\n                foreach ($options['options'] as $arr => $v) { // outputs: key, value, class - in order\n                    $select = '';\n                    $chain = '';\n                    // Chain method always bind to options's array key\n                    if (isset($options['chain_index'][$arr])) {\n                        $chain = \" class='\".$options['chain_index'][$arr].\"' \";\n                    }\n\n                    // do a disable for filter_opts item.\n                    if ($options['keyflip']) { // flip mode = store array values\n                        if ($input_value !== '') {\n                            $select = ($input_value == $v) ? \" selected\" : \"\";\n                        }\n                        $disabled = $disable_opts && in_array($arr, $disable_opts);\n                        $hide = $disabled && $options['hide_disabled'];\n                        $html .= (!$hide ? \"<option value='$v'\".$chain.$select.($disabled ? 'disabled' : '').\">\".html_entity_decode($v).\" \".($options['show_current'] && $input_value == $v ? '(Current Item)' : '').\"</option>\\n\" : \"\");\n                    } else {\n                        if ($input_value !== '') {\n                            //$input_value = stripinput($input_value); // not sure if can turn FALSE to zero not null.\n                            $select = (isset($input_value) && $input_value == $arr) ? ' selected' : '';\n                        }\n                        $disabled = $disable_opts && in_array($arr, $disable_opts);\n                        $hide = $disabled && $options['hide_disabled'];\n                        $html .= (!$hide ? \"<option value='$arr'\".$chain.$select.($disabled ? 'disabled' : '').\">\".html_entity_decode($v).\" \".($options['show_current'] && $input_value == $v ? '(Current Item)' : '').\"</option>\\n\" : \"\");\n                    }\n                }\n            }\n        }\n        $html .= \"</select>\\n\";\n    }\n\n    $html .= $options['stacked'];\n    $html .= $options['ext_tip'] ? \"<br/>\\n<div class='m-t-10 tip'><i>\".$options['ext_tip'].\"</i></div>\" : \"\";\n    $html .= \\defender::inputHasError($input_name) && !$options['inline'] ? \"<br/>\" : \"\";\n    $html .= \\defender::inputHasError($input_name) ? \"<div id='\".$options['input_id'].\"-help' class='label label-danger p-5 display-inline-block'>\".$options['error_text'].\"</div>\" : \"\";\n    $html .= $options['inline'] && $label ? \"</div>\\n\" : '';\n    $html .= \"</div>\\n\";\n    if ($options['required']) {\n        $html .= \"<input class='req' id='dummy-\".$options['input_id'].\"' type='hidden'>\\n\"; // for jscheck\n    }\n    // Generate Defender Tag\n    $input_name = ($options['multiple']) ? str_replace(\"[]\", \"\", $input_name) : $input_name;\n    \\defender::add_field_session([\n        'input_name'     => clean_input_name($input_name),\n        'title'          => clean_input_name($title),\n        'id'             => $options['input_id'],\n        'type'           => 'dropdown',\n        'regex'          => $options['regex'],\n        'required'       => $options['required'],\n        'safemode'       => $options['safemode'],\n        'error_text'     => $options['error_text'],\n        'callback_check' => $options['callback_check'],\n        'delimiter'      => $options['delimiter'],\n    ]);\n    // Initialize Select2\n    if ($options['select2_disabled'] === FALSE) {\n        // Select 2 Multiple requires hidden DOM.\n        if ($options['jsonmode'] === FALSE) {\n            // not json mode (normal)\n            $max_js = '';\n            if ($options['multiple'] && $options['max_select']) {\n                $max_js = \"maximumSelectionSize : \".$options['max_select'].\",\";\n            }\n\n            $tag_js = '';\n            if ($options['tags']) {\n                $tag_value = json_encode(array_values($options['options']));\n                // The format yield must be : `tags:[\"red\", \"green\", \"blue\", \"orange\", \"white\", \"black\", \"purple\", \"cyan\", \"teal\"]`\n                $tag_js = ($tag_value) ? \"tags: \".html_entity_decode($tag_value).\"\" : \"tags: []\";\n            }\n\n\n            if ($options['required']) {\n                add_to_jquery(\"\n                if ($('#\".$options['input_id'].\"').select2('val')) { $('dummy-\".$options['input_id'].\"').val($('#\".$options['input_id'].\"').select2('val'));} else { $('dummy-\".$options['input_id'].\"').val('');}\n                $('#\".$options['input_id'].\"').select2({\n                    \".($options['placeholder'] ? \"placeholder: '\".$options['placeholder'].\"',\" : '').\"\n                    minimumResultsForSearch: \".$options['display_search_count'].\",\n                    \".$max_js.\"\n                    \".$allowclear.\"\n                    \".$tag_js.\"\n                }).bind('change', function(e) {\t$('#dummy-\".$options['input_id'].\"').val($(this).val()); });\n                \");\n            } else {\n                add_to_jquery(\"\n                $('#\".$options['input_id'].\"').select2({\n                    \".($options['placeholder'] ? \"placeholder: '\".$options['placeholder'].\"',\" : '').\"\n                    minimumResultsForSearch: \".$options['display_search_count'].\",\n                    \".$max_js.\"\n                    \".$allowclear.\"\n                    \".$tag_js.\"\n                });\n            \");\n            }\n\n        } else {\n            // json mode\n            add_to_jquery(\"\n                var this_data = [{id:0, text: '\".$options['placeholder'].\"'}];\n                $('#\".$options['input_id'].\"').select2({\n                placeholder: '\".$options['placeholder'].\"',\n                data: this_data\n                });\n            \");\n        }\n\n        // For Multiple Callback JS\n        if (is_array($input_value) && $options['multiple']) { // stores as value;\n            $vals = '';\n            foreach ($input_value as $arr => $val) {\n                $val = html_entity_decode($val);\n                $vals .= ($arr == count($input_value) - 1) ? \"'$val'\" : \"'$val',\";\n            }\n            add_to_jquery(\"$('#\".$options['input_id'].\"').select2('val', [$vals]);\");\n        }\n    }\n\n    load_select2_script();\n\n    return (string)$html;\n}\n\n/**\n * Selector for registered user\n *\n * @param        $input_name\n * @param string $label\n * @param bool   $input_value - user id\n * @param array  $options\n *\n * @return string\n */\nfunction form_user_select($input_name, $label = \"\", $input_value = FALSE, array $options = []) {\n    $locale = fusion_get_locale();\n\n    $title = $label ? stripinput($label) : ucfirst(strtolower(str_replace(\"_\", \" \", $input_name)));\n\n    $default_options = [\n        'required'          => FALSE,\n        'regex'             => '',\n        'input_id'          => $input_name,\n        'placeholder'       => $locale['sel_user'],\n        'deactivate'        => FALSE,\n        'safemode'          => FALSE,\n        'allowclear'        => FALSE,\n        'multiple'          => FALSE,\n        'inner_width'       => '250px',\n        'width'             => '',\n        'keyflip'           => FALSE,\n        'tags'              => FALSE,\n        'jsonmode'          => FALSE,\n        'chainable'         => FALSE,\n        'max_select'        => 1,\n        'error_text'        => '',\n        'class'             => '',\n        'stacked'           => '',\n        'inline'            => FALSE,\n        'tip'               => '',\n        'ext_tip'           => '',\n        'delimiter'         => ',',\n        'callback_check'    => '',\n        'file'              => '',\n        'allow_self'        => FALSE,\n        'callback_function' => '',\n        'image_path'        => IMAGES.\"avatars/\",\n    ];\n\n    $options += $default_options;\n\n    $options['input_id'] = trim($options['input_id'], \"[]\");\n\n    $allowclear = ($options['placeholder'] && $options['multiple'] || $options['allowclear']) ? \"allowClear:true,\" : '';\n    $length = \"minimumInputLength: 1,\";\n    $error_class = \"\";\n\n    if (defender::inputHasError($input_name)) {\n        $error_class = \"has-error \";\n        $new_error_text = defender::getErrorText($input_name);\n        if (!empty($new_error_text)) {\n            $options['error_text'] = $new_error_text;\n        }\n        addNotice(\"danger\", \"<strong>$title</strong> - \".$options['error_text']);\n    }\n\n    $html = \"<div id='\".$options['input_id'].\"-field' class='form-group \".($options['inline'] && $label ? 'row ' : '').$error_class.$options['class'].\"' style='width:\".$options['width'].\"'>\\n\";\n    $html .= ($label) ? \"<label class='control-label \".($options['inline'] ? 'col-xs-12 col-sm-12 col-md-3 col-lg-3' : '').\"' for='\".$options['input_id'].\"'>$label \".($options['required'] == TRUE ? \"<span class='required'>*</span>\" : '').\"</label>\\n\" : '';\n    $html .= $options['inline'] && $label ? \"<div class='col-xs-12 col-sm-9 col-md-9 col-lg-9'>\\n\" : \"\";\n    $html .= \"<input \".($options['required'] ? \"class='req'\" : '').\" type='hidden' name='$input_name' id='\".$options['input_id'].\"' data-placeholder='\".$options['placeholder'].\"' style='width:\".$options['inner_width'].\"'\".($options['deactivate'] ? ' disabled' : '').\"/>\\n\";\n    if ($options['deactivate']) {\n        $html .= form_hidden($input_name, '', $input_value, [\"input_id\" => $options['input_id']]);\n    }\n\n    $html .= $options['stacked'];\n    $html .= $options['ext_tip'] ? \"<br/>\\n<div class='m-t-10 tip'><i>\".$options['ext_tip'].\"</i></div>\" : \"\";\n    $html .= \\defender::inputHasError($input_name) && !$options['inline'] ? \"<br/>\" : \"\";\n    $html .= \\defender::inputHasError($input_name) ? \"<div id='\".$options['input_id'].\"-help' class='label label-danger p-5 display-inline-block'>\".$options['error_text'].\"</div>\" : \"\";\n\n    $html .= $options['inline'] && $label ? \"</div>\\n\" : '';\n\n    $html .= \"</div>\\n\";\n\n    $root_prefix = fusion_get_settings(\"site_seo\") == 1 ? fusion_get_settings('siteurl').\"includes/\" : INCLUDES;\n\n    $root_img = fusion_get_settings(\"site_seo\") == 1 && !defined('ADMIN_PANEL') ? fusion_get_settings('siteurl') : '';\n\n    $path = $options['file'] ? $options['file'] : $root_prefix.\"dynamics/assets/users/users.json.php\".($options['allow_self'] ? \"?allow_self=true\" : \"\");\n\n    if (!empty($input_value)) {\n        // json mode.\n        $encoded = $options['callback_function'] && is_callable($options['callback_function']) ? $options['callback_function']($input_value) : user_search($input_value);\n    } else {\n        $encoded = json_encode([]);\n    }\n\n    defender::getInstance()->add_field_session([\n        'input_name' => clean_input_name($input_name),\n        'title'      => $title,\n        'id'         => $options['input_id'],\n        'type'       => 'dropdown',\n        'required'   => $options['required'],\n        'safemode'   => $options['safemode'],\n        'error_text' => $options['error_text']\n    ]);\n\n    add_to_jquery(\"\n        function avatar(item) {\n            if(!item.id) {return item.text;}\n            var avatar = item.avatar;\n            var level = item.level;\n            return '<table><tr><td style=\\\"\\\"><img style=\\\"height:35px;\\\" class=\\\"img-rounded\\\" src=\\\"\".$root_img.$options['image_path'].\"' + avatar + '\\\"/></td><td style=\\\"padding-left:10px; padding-right:10px;line-height:1.2;\\\"><div><strong>' + item.text + '</strong></div>' + level + '</div></td></tr></table>';\n        }\n        $('#\".$options['input_id'].\"').select2({\n        $length\n        multiple: true,\n        maximumSelectionSize: \".$options['max_select'].\",\n        placeholder: '\".$options['placeholder'].\"',\n        ajax: {\n        url: '$path',\n        dataType: 'json',\n        data: function (term, page) {\n                return {q: term};\n              },\n              results: function (data, page) {\n                //console.log(page);\n                return {results: data};\n              }\n        },\n        formatSelection: avatar,\n        escapeMarkup: function(m) { return m; },\n        formatResult: avatar,\n        \".$allowclear.\"\n        })\".(!empty($encoded) ? \".select2('data', $encoded );\" : '').\"\n    \");\n\n    load_select2_script();\n\n    return $html;\n}\n\n/* Returns Json Encoded Object used in form_select_user */\nfunction user_search($user_id) {\n    $encoded = json_encode([]);\n    if (isnum($user_id)) {\n        $user_id = stripinput($user_id);\n        $result = dbquery(\"SELECT user_id, user_name, user_avatar, user_level FROM \".DB_USERS.\" WHERE user_status=:status AND user_id=:id\", [':status' => 0, ':id' => $user_id]);\n        if (dbrows($result) > 0) {\n            while ($udata = dbarray($result)) {\n                $user_id = $udata['user_id'];\n                $user_avatar = ($udata['user_avatar']) ? $udata['user_avatar'] : \"no-avatar.jpg\";\n                $user_name = $udata['user_name'];\n                $user_level = getuserlevel($udata['user_level']);\n                $user_opts[] = [\n                    'id'     => $user_id,\n                    'text'   => $user_name,\n                    'avatar' => $user_avatar,\n                    \"level\"  => $user_level\n                ];\n            }\n            if (!isset($user_opts)) {\n                $user_opts = [];\n            }\n            $encoded = json_encode($user_opts);\n        }\n    }\n\n    return $encoded;\n}\n\n/**\n * Select2 hierarchy\n * Returns a full hierarchy nested dropdown.\n *\n * @param        $input_name\n * @param string $label\n * @param string $input_value\n * @param array  $options\n * @param        $db       - your db\n * @param        $name_col - the option text to show\n * @param        $id_col   - unique id\n * @param        $cat_col  - parent id\n *                         ## The rest of the Params are used by the function itself -- no need to handle ##\n * @param bool   $self_id  - not required\n * @param bool   $id       - not required\n * @param bool   $level    - not required\n * @param bool   $index    - not required\n * @param bool   $data     - not required\n *\n * @return string\n */\nfunction form_select_tree($input_name, $label, $input_value, array $options, $db, $name_col, $id_col, $cat_col, $self_id = FALSE, $id = FALSE, $level = FALSE, $index = FALSE, $data = FALSE) {\n    $html = '';\n    $locale = fusion_get_locale();\n    $title = $label ? stripinput($label) : ucfirst(strtolower(str_replace(\"_\", \" \", $input_name)));\n    $default_options = [\n        'required'        => FALSE,\n        'regex'           => '',\n        'input_id'        => $input_name,\n        'placeholder'     => $locale['choose'],\n        'deactivate'      => FALSE,\n        'safemode'        => FALSE,\n        'allowclear'      => FALSE,\n        'multiple'        => FALSE,\n        'width'           => '',\n        'inner_width'     => '250px',\n        'keyflip'         => FALSE,\n        'tags'            => FALSE,\n        'jsonmode'        => FALSE,\n        'chainable'       => FALSE,\n        'max_select'      => FALSE,\n        'error_text'      => $locale['error_input_default'],\n        'class'           => '',\n        'inline'          => FALSE,\n        'tip'             => '',\n        'delimiter'       => ',',\n        'callback_check'  => '',\n        'file'            => '',\n        'parent_value'    => $locale['root'],\n        'add_parent_opts' => FALSE,\n        'disable_opts'    => '',\n        'hide_disabled'   => FALSE,\n        'no_root'         => FALSE,\n        'show_current'    => FALSE,\n        'query'           => '',\n        'full_query'      => '',\n    ];\n    $options += $default_options;\n\n    $options['input_id'] = trim($options['input_id'], \"[]\");\n    if ($options['multiple']) {\n        if ($input_value) {\n            $input_value = explode('|', $input_value);\n        } else {\n            $input_value = [];\n        }\n    }\n    if (!$options['width']) {\n        $options['width'] = $default_options['width'];\n    }\n    $allowclear = ($options['placeholder'] && $options['multiple'] || $options['allowclear']) ? \"allowClear:true\" : '';\n    $disable_opts = '';\n    if ($options['disable_opts']) {\n        $disable_opts = is_array($options['disable_opts']) ? $options['disable_opts'] : explode(',', $options['disable_opts']);\n    }\n    /* Child patern */\n    $opt_pattern = str_repeat(\"&#8212;\", $level);\n\n    if (!$level) {\n        $level = 0;\n        if (!isset($index[$id])) {\n            $index[$id] = ['0' => $locale['no_opts']];\n        }\n\n        $error_class = '';\n        if (\\defender::inputHasError($input_name)) {\n            $error_class = \"has-error \";\n            if (!empty($options['error_text'])) {\n                $new_error_text = \\defender::getErrorText($input_name);\n                if (!empty($new_error_text)) {\n                    $options['error_text'] = $new_error_text;\n                }\n                addNotice(\"danger\", \"<strong>$title</strong> - \".$options['error_text']);\n            }\n        }\n\n        $html = \"<div id='\".$options['input_id'].\"-field' class='form-group \".($options['inline'] && $label ? 'row ' : '').$error_class.$options['class'].\"' \".($options['inline'] && $options['width'] && !$label ? \"style='width: \".$options['width'].\"'\" : '').\">\\n\";\n        $html .= ($label) ? \"<label class='control-label \".($options['inline'] ? 'col-xs-12 col-sm-12 col-md-3 col-lg-3' : '').\"' for='\".$options['input_id'].\"'>\".$label.($options['required'] == TRUE ? \"<span class='required'>&nbsp;*</span>\" : '').\" \".($options['tip'] ? \"<i class='pointer fa fa-question-circle' label=\".$options['tip'].\"></i>\" : '').\"</label>\\n\" : '';\n        $html .= $options['inline'] && $label ? \"<div class='col-xs-12 col-sm-9 col-md-9 col-lg-9'>\\n\" : \"\";\n    }\n    if ($level == 0) {\n        add_to_jquery(\"\n        $('#\".$options['input_id'].\"').select2({\n        placeholder: '\".$options['placeholder'].\"',\n        $allowclear\n        });\n        \");\n        if (is_array($input_value) && $options['multiple']) { // stores as value;\n            $vals = '';\n            foreach ($input_value as $arr => $val) {\n                $vals .= ($arr == count($input_value) - 1) ? \"'$val'\" : \"'$val',\";\n            }\n            add_to_jquery(\"$('#\".$options['input_id'].\"').select2('val', [$vals]);\");\n        }\n        $html .= \"<select name='$input_name' id='\".$options['input_id'].\"' style='width: \".($options['inner_width'] ? $options['inner_width'] : $default_options['inner_width']).\"'\".($options['deactivate'] ? \" disabled\" : \"\").($options['multiple'] ? \" multiple\" : \"\").\">\";\n        $html .= $options['allowclear'] ? \"<option value=''></option>\\n\" : '';\n        if ($options['no_root'] == FALSE) { // api options to remove root from selector. used in items creation.\n            $this_select = '';\n            if ($input_value !== NULL) {\n                if ($input_value !== '') {\n                    $this_select = 'selected';\n                }\n            }\n            $html .= ($options['add_parent_opts'] == TRUE) ? \"<option value='0' \".$this_select.\">$opt_pattern \".$locale['parent'].\"</option>\\n\" : \"<option value='0' \".$this_select.\" >$opt_pattern \".$options['parent_value'].\"</option>\\n\";\n        }\n\n        $index = dbquery_tree($db, $id_col, $cat_col, $options['query'], $options['full_query']);\n        if (!empty($index)) {\n            $data = dropdown_select($db, $id_col, $name_col, $cat_col, implode(',', flatten_array($index)), $options['query'], $options['full_query']);\n        }\n    }\n\n    if (!$id) {\n        $id = 0;\n    }\n\n    if (isset($index[$id]) && !empty($data)) {\n        foreach ($index[$id] as $key => $value) {\n            // value is the array\n            //$hide = $disable_branch && $value == $self_id ? 1 : 0;\n            $name = $data[$value][$name_col];\n            //print_p($data[$value]);\n\n            $name = PHPFusion\\QuantumFields::parse_label($name);\n            $select = ($input_value !== \"\" && ($input_value == $value)) ? 'selected' : '';\n            $disabled = $disable_opts && in_array($value, $disable_opts);\n            $hide = $disabled && $options['hide_disabled'];\n            // do a disable for filter_opts item.\n            $html .= (!$hide) ? \"<option value='$value' \".$select.\" \".($disable_opts && in_array($value, $disable_opts) ? 'disabled' : '').\" >$opt_pattern $name \".($options['show_current'] && $self_id == $value ? '(Current Item)' : '').\"</option>\\n\" : '';\n            if (isset($index[$value]) && (!$hide)) {\n                $html .= form_select_tree($input_name, $label, $input_value, $options, $db, $name_col, $id_col, $cat_col, $self_id, $value, $level + TRUE, $index, $data);\n            }\n        }\n    }\n    if (!$level) {\n        $html .= \"</select>\\n\";\n        $html .= (($options['required'] == 1 && \\defender::inputHasError($input_name)) || \\defender::inputHasError($input_name)) ? \"<div id='\".$options['input_id'].\"-help' class='label label-danger p-5 display-inline-block'>\".$options['error_text'].\"</div>\" : \"\";\n        $html .= $options['inline'] && $label ? \"</div>\\n\" : '';\n        $html .= \"</div>\\n\";\n        if ($options['required']) {\n            $html .= \"<input class='req' id='dummy-\".$options['input_id'].\"' type='hidden'>\\n\"; // for jscheck\n        }\n        $input_name = ($options['multiple']) ? str_replace(\"[]\", \"\", $input_name) : $input_name;\n        \\defender::add_field_session(\n            [\n                'input_name'     => $input_name,\n                'title'          => trim($title, '[]'),\n                'id'             => $options['input_id'],\n                'type'           => 'dropdown',\n                'regex'          => $options['regex'],\n                'required'       => $options['required'],\n                'safemode'       => $options['safemode'],\n                'error_text'     => $options['error_text'],\n                'callback_check' => $options['callback_check'],\n                'delimiter'      => $options['delimiter'],\n            ]\n        );\n    }\n\n    load_select2_script();\n\n    return $html;\n}\n\n/*\n * Optimized performance by adding a self param to implode to fetch only certain rows\n */\nfunction dropdown_select($db, $id_col, $name_col, $cat_col, $index_values, $filter = '', $query_replace = '') {\n    $data = [];\n    $query = \"SELECT $id_col, $name_col, $cat_col FROM \".$db.\" \".($filter ? $filter.\" AND \" : 'WHERE').\" $id_col IN ($index_values) ORDER BY $name_col ASC\";\n    if (!empty($query_replace)) {\n        $query = $query_replace;\n    }\n    $result = dbquery($query);\n    while ($row = dbarray($result)) {\n        $id = $row[$id_col];\n        $data[$id] = $row;\n    }\n\n    return $data;\n}\n", "<?php\n/*-------------------------------------------------------+\n| PHPFusion Content Management System\n| Copyright (C) PHP Fusion Inc\n| https://phpfusion.com/\n+--------------------------------------------------------+\n| Filename: form_text.php\n| Author: Frederick MC Chan (Chan)\n| Co-Author: Dan C. (JoiNNN)\n+--------------------------------------------------------+\n| This program is released as free software under the\n| Affero GPL license. You can redistribute it and/or\n| modify it under the terms of this license which you\n| can read by viewing the included agpl.txt or online\n| at www.gnu.org/licenses/agpl.html. Removal of this\n| copyright header is strictly prohibited without\n| written permission from the original author(s).\n+--------------------------------------------------------*/\n\n/**\n * Generates a text input\n * TODO: Document each option\n *\n * Generates the HTML for a textbox or password input\n *\n * @param string $input_name  Name of the input, by\n *                            default it's also used as the ID for the input\n * @param string $label       The label\n * @param string $input_value The value to be displayed\n *                            in the input, usually a value from DB prev. saved\n * @param array  $options     Various options\n *\n * @return string\n *\n * To add an inline button (set prepend or append - respectively)\n * register these options accordingly into the function\n * $options['append_button'] = true\n * $options['append_type'] = button or submit\n * $options['append_form_value'] = the value of the button\n * $options['append_class'] = your pick of .btn classes (bootstrap .btn-success, .btn-info, etc)\n * $options['append_value'] = the label\n * $options['append_button_name'] = your button name , default: p-submit-\".$options['input_id'].\"\n * $options['append_button_id'] = your button name , default: \".$input_name.\"-append-btn\n *\n * To add a decorative labels (set prepend or append - respectively)\n * $options['append_value'] = \"your-value\" - You can also insert HTML <i class='fa fa-something'></i> for glyphs\n *\n */\n\nfunction form_text($input_name, $label = \"\", $input_value = \"\", array $options = []) {\n\n    $locale = fusion_get_locale();\n\n    $title = $label ? stripinput($label) : ucfirst(strtolower(str_replace(\"_\", \" \", $input_name)));\n\n    $input_id = trim(str_replace(\"[\", \"-\", $input_name), \"]\");\n\n    $default_options = [\n        'type'               => 'text',\n        'required'           => FALSE,\n        'label_icon'         => '',\n        'feedback_icon'      => '',\n        'safemode'           => FALSE,\n        'regex'              => '',\n        'regex_error_text'   => '',\n        'callback_check'     => FALSE,\n        'input_id'           => $input_id,\n        'placeholder'        => '',\n        'deactivate'         => FALSE,\n        'width'              => '',\n        'inner_width'        => '',\n        'class'              => '',\n        'inner_class'        => '',\n        'inline'             => FALSE,\n        'min_length'         => 1,\n        'max_length'         => 200,\n        'number_min'         => 0,\n        'number_max'         => 0,\n        'number_step'        => 1,\n        'icon'               => '',\n        'autocomplete_off'   => FALSE,\n        'tip'                => '',\n        'ext_tip'            => '',\n        'append_button'      => '',\n        'append_value'       => '',\n        'append_form_value'  => '',\n        'append_size'        => '',\n        'append_class'       => 'btn-default',\n        'append_type'        => 'submit',\n        'prepend_id'         => \"p-\".$input_id.\"-prepend\",\n        'append_id'          => \"p-\".$input_id.\"-append\",\n        'prepend_button'     => '',\n        'prepend_value'      => '',\n        'prepend_form_value' => '',\n        'prepend_size'       => '',\n        'prepend_class'      => 'btn-default',\n        'prepend_type'       => 'submit',\n        'error_text'         => '',\n        'delimiter'          => ',',\n        'stacked'            => '',\n        'group_size'         => '', // http://getbootstrap.com/components/#input-groups-sizing - sm, md, lg\n        'password_strength'  => FALSE,\n        'data'               => [],\n        'append_html'        => '',\n        'censor_words'       => TRUE,\n        'password_toggle'    => TRUE,\n        'descript'           => TRUE\n    ];\n\n    $options += $default_options;\n\n    $valid_types = [\n        'text', 'number', 'password', 'email', 'url', 'color', 'date', 'datetime', 'datetime-local', 'month', 'range', 'search', 'tel', 'time', 'week'\n    ];\n\n    $options['type'] = in_array($options['type'], $valid_types) ? $options['type'] : 'text';\n\n    $options += [\n        'append_button_name'  => !empty($options['append_button_name']) ? $options['append_button_name'] : \"p-submit-\".$options['input_id'],\n        'prepend_button_name' => !empty($options['append_button_name']) ? $options['append_button_name'] : \"p-submit-\".$options['input_id'],\n        'append_button_id'    => !empty($options['append_button_id']) ? $options['append_button_id'] : $options['input_id'].'-append-btn',\n        'prepend_button_id'   => !empty($options['prepend_button_id']) ? $options['prepend_button_id'] : $options['input_id'].'-prepend-btn',\n    ];\n\n    if (!empty($options['data'])) {\n        array_walk($options['data'], function ($a, $b) use (&$options_data) {\n            $options_data[] = \"data-$b='$a'\";\n        }, $options_data);\n    }\n\n    // Error messages based on settings\n    if ($options['type'] == 'password') {\n        $options['error_text'] = empty($options['error_text']) ? $locale['error_input_password'] : $options['error_text'];\n    } else if ($options['type'] == 'email') {\n        $options['error_text'] = empty($options['error_text']) ? $locale['error_input_email'] : $options['error_text'];\n    } else if ($options['type'] == 'number') {\n        $options['error_text'] = empty($options['error_text']) ? $locale['error_input_number'] : $options['error_text'];\n    } else if ($options['type'] == 'url') {\n        $options['error_text'] = empty($options['error_text']) ? $locale['error_input_url'] : $options['error_text'];\n    } else if ($options['regex']) {\n        $options['error_text'] = empty($options['error_text']) ? $locale['error_input_regex'] : $options['error_text'];\n    } else if ($options['safemode']) {\n        $options['error_text'] = empty($options['error_text']) ? $locale['error_input_safemode'] : $options['error_text'];\n    } else {\n        $options['error_text'] = empty($options['error_text']) ? $locale['error_input_default'] : $options['error_text'];\n    }\n\n    $error_class = \"\";\n    if (\\defender::inputHasError($input_name)) {\n        $error_class = \" has-error\";\n        if (!empty($options['error_text'])) {\n            $new_error_text = \\defender::getErrorText($input_name);\n            if (!empty($new_error_text)) {\n                $options['error_text'] = $new_error_text;\n            }\n            addNotice(\"danger\", \"<strong>$title</strong> - \".$options['error_text']);\n        }\n    }\n\n    $min = '';\n    $max = '';\n    $step = '';\n    switch ($options['type']) {\n        case \"number\":\n            $input_type = \"number\";\n            $min = ((!empty($options['number_min']) || $options['number_min'] === \"0\") && isnum($options['number_min']) ? \"min='\".$options['number_min'].\"' \" : '');\n            $max = ((!empty($options['number_max']) || $options['number_max'] === \"0\") && isnum($options['number_max']) ? \"max='\".$options['number_max'].\"' \" : '');\n            // $step = \"step='\".str_replace(\",\", \".\", $options['number_step']).\"' \";\n            $step = \"step='any' \";\n            break;\n        case \"text\":\n            $input_type = \"text\";\n            break;\n        case \"password\":\n            $input_type = \"password\";\n\n            if ($options['password_toggle'] == TRUE) {\n                if (!defined('PWTOGGLE')) {\n                    define('PWTOGGLE', TRUE);\n                    add_to_footer(\"<script>function togglePasswordInput(button_id, field_id) {var button=$('#'+button_id);var input=$('#'+field_id);if(input.attr('type')=='password'){input.attr('type','text');button.text('\".$locale['hide'].\"');}else{input.attr('type','password');button.text('\".$locale['show'].\"');}}</script>\");\n                }\n\n                $options['append_button'] = TRUE;\n                $options['append_type'] = \"button\";\n                $options['append_form_value'] = 'show';\n                $options['append_class'] = 'btn-default';\n                $options['append_value'] = $locale['show'];\n                $options['append_button_name'] = $options['input_id'].'_pwdToggle';\n                $options['append_button_id'] = $options['input_id'].'_pwdToggle';\n                add_to_jquery(\"\n                    $('#\".$options['input_id'].\"_pwdToggle').bind('click', function(e) {\n                        togglePasswordInput('\".$options['input_id'].\"_pwdToggle', '\".$options['input_id'].\"');\n                    });\n                \");\n            }\n            break;\n        default:\n            $input_type = \"text\";\n    }\n\n    // Fixes HTML DOM type number that does not respect max_length prop.\n    $max_length = '';\n    if ($options['max_length'] && isnum($options['max_length'])) {\n        $max_length = ' maxlength=\"'.$options['max_length'].'\"';\n        if ($input_type == 'number') {\n            $max_length .= ' oninput=\"javascript: if (this.value.length > this.maxLength) this.value = this.value.slice(0, this.maxLength);\"';\n        }\n    }\n\n    if ($options['password_strength'] == TRUE) {\n        if (!defined('PWSTRENGTH')) {\n            define('PWSTRENGTH', TRUE);\n\n            if (file_exists(DYNAMICS.\"assets/password/lang/\".$locale['password_strength'].\".js\")) {\n                $path = DYNAMICS.\"assets/password/lang/\".$locale['password_strength'].\".js\";\n            } else {\n                $path = DYNAMICS.\"assets/password/lang/en.js\";\n            }\n\n            add_to_footer(\"<script type='text/javascript' src='$path'></script>\");\n            add_to_footer(\"<script src='\".DYNAMICS.\"assets/password/i18next.js'></script>\");\n            add_to_footer(\"<script src='\".DYNAMICS.\"assets/password/pwstrength-bootstrap.min.js'></script>\");\n        }\n\n        add_to_jquery(\"\n            i18next.init({\n                lng: '\".$locale['password_strength'].\"',resources: {\".$locale['password_strength'].\": {translation: pwstrength_locale}}\n            }, function () {\n                var options = {};\n                options.ui = {\n                    \".(!defined('BOOTSTRAP4') ? 'bootstrap3: true,' : '').\"\n                    container: '#\".$options['input_id'].\"-field',\n                    showVerdictsInsideProgressBar: true,\n                    viewports: {\n                        progress: '.pwstrength_viewport_progress'\n                    }\n                };\n\n                $('#\".$options['input_id'].\"').pwstrength(options);\n            });\n        \");\n    }\n\n    $html = \"<div id='\".$options['input_id'].\"-field' class='form-group \".($options['inline'] && $label ? 'row ' : '').($error_class ? $error_class : '').($options['class'] ? ' '.$options['class'] : '').($options['icon'] ? ' has-feedback' : '').\"'\".($options['width'] && !$label ? \" style='width: \".$options['width'].\"'\" : '').\">\";\n    $html .= ($label) ? \"<label class='control-label \".($options['inline'] ? \"col-xs-12 col-sm-12 col-md-3 col-lg-3\" : '').\"' for='\".$options['input_id'].\"'>\".$options['label_icon'].$label.($options['required'] ? \"<span class='required'>&nbsp;*</span>\" : '').\" \".($options['tip'] ? \"<i class='pointer fa fa-question-circle' title='\".$options['tip'].\"'></i>\" : '').\"</label>\" : '';\n    $html .= ($options['inline'] && $label) ? \"<div class='col-xs-12 col-sm-12 col-md-9 col-lg-9'>\" : \"\";\n\n    $html .= ($options['append_button'] || $options['prepend_button'] || $options['append_value'] || $options['prepend_value']) ? \"<div class='input-group\".($options['group_size'] ? ' input-group-'.$options['group_size'] : '').\"' \".($options['width'] ? \"style='width: \".$options['width'].\"'\" : '').\">\" : \"\";\n\n    if ($options['prepend_button'] && $options['prepend_type'] && $options['prepend_form_value'] && $options['prepend_class'] && $options['prepend_value']) {\n        $html .= \"<span class='input-group-btn input-group-prepend'>\";\n        $html .= \"<button id='\".$options['prepend_button_id'].\"' name='\".$options['prepend_button_name'].\"' type='\".$options['prepend_type'].\"' value='\".$options['prepend_form_value'].\"' class='btn \".$options['prepend_size'].\" \".$options['prepend_class'].\"'>\".$options['prepend_value'].\"</button>\";\n        $html .= \"</span>\\n\";\n    } else if ($options['prepend_value']) {\n        $html .= \"<span class='input-group-addon input-group-prepend' id='\".$options['prepend_id'].\"'><span class='input-group-text'>\".$options['prepend_value'].\"</span></span>\";\n    }\n\n    $html .= \"<input type='\".$input_type.\"' data-type='\".$input_type.\"' \".(!empty($options_data) ? implode(' ', $options_data) : '').\" \".$min.$max.$step.\"class='form-control textbox \".($options['inner_class'] ? \" \".$options['inner_class'].\" \" : '').\"' \".($options['inner_width'] ? \"style='width:\".$options['inner_width'].\";'\" : '').$max_length.\" name='\".$input_name.\"' id='\".$options['input_id'].\"' value='\".$input_value.\"'\".($options['placeholder'] ? \" placeholder='\".$options['placeholder'].\"' \" : '').\"\".($options['autocomplete_off'] ? \" autocomplete='off'\" : '').\" \".($options['deactivate'] ? 'readonly' : '').\">\";\n\n    if ($options['append_button'] && $options['append_type'] && $options['append_form_value'] && $options['append_class'] && $options['append_value']) {\n        $html .= \"<span class='input-group-btn input-group-append'>\";\n        $html .= \"<button id='\".$options['append_button_id'].\"' name='\".$options['append_button_name'].\"' type='\".$options['append_type'].\"' value='\".$options['append_form_value'].\"' class='btn \".$options['append_size'].\" \".$options['append_class'].\"'>\".$options['append_value'].\"</button>\";\n        $html .= \"</span>\\n\";\n\n    } else if ($options['append_value']) {\n        $html .= \"<span class='input-group-addon input-group-append' id='\".$options['append_id'].\"'><span class='input-group-text'>\".$options['append_value'].\"</span></span>\";\n    }\n\n    $html .= ($options['feedback_icon'] ? \"<div class='form-control-feedback' style='top:0;'><i class='\".$options['icon'].\"'></i></div>\" : '');\n\n    $html .= $options['stacked'];\n\n    $html .= ($options['append_button'] || $options['prepend_button'] || $options['append_value'] || $options['prepend_value']) ? \"</div>\" : \"\";\n\n    $html .= $options['ext_tip'] ? \"<br/>\\n<span class='tip'><i>\".$options['ext_tip'].\"</i></span>\" : \"\";\n\n    $html .= (\\defender::inputHasError($input_name) ? \"<div class='input-error\".((!$options['inline'] || $options['append_button'] || $options['prepend_button'] || $options['append_value'] || $options['prepend_value']) ? \" display-block\" : \"\").\"'><div id='\".$options['input_id'].\"-help' class='label label-danger p-5 display-inline-block'>\".$options['error_text'].\"</div></div>\" : \"\");\n\n    $html .= $options['append_html'];\n\n    $html .= ($options['password_strength'] == TRUE ? '<div class=\"m-t-5 pwstrength_viewport_progress\"></div>' : \"\");\n\n    $html .= (($options['inline'] && $label) ? \"</div>\" : \"\");\n\n    $html .= \"</div>\";\n\n    // Add input settings in the SESSION\n    \\defender::add_field_session([\n        'input_name'     => clean_input_name($input_name),\n        'title'          => clean_input_name($title),\n        'id'             => $options['input_id'],\n        'type'           => $options['type'],\n        'required'       => $options['required'],\n        'safemode'       => $options['safemode'],\n        'regex'          => $options['regex'],\n        'callback_check' => $options['callback_check'],\n        'delimiter'      => $options['delimiter'],\n        'min_length'     => $options['min_length'],\n        'max_length'     => $options['max_length'],\n        'censor_words'   => $options['censor_words'],\n        'descript'       => $options['descript']\n    ]);\n\n    // This should affect all number inputs by type, not by ID\n    if ($options['type'] == 'number' && !defined('NUMBERS_ONLY_JS')) {\n        define('NUMBERS_ONLY_JS', TRUE);\n        add_to_jquery(\"$('input[data-type=\\\"number\\\"]').keypress(function(e) {\n        var key_codes = [96, 97, 98, 99, 100, 101, 102, 103, 44, 46, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 0, 8];\n        if (!($.inArray(e.which, key_codes) >= 0)) { e.preventDefault(); }\n        });\\n\");\n    }\n\n    // Live Regex Error Check\n    if ($options['regex'] && $options['regex_error_text']) {\n\n        add_to_jquery(\"\n        $('#\".$options['input_id'].\"').blur(function(ev) {\n            var Inner_Object = $(this).parent('div').find('.label-danger');\n            var Outer_Object = $(this).parent('div').find('.input-error');\n            if (!$(this).val().match(/\".$options['regex'].\"/g) && $(this).val()) {\n                var ErrorText = '\".$options['regex_error_text'].\"';\n                var ErrorDOM = '<div class=\\'input-error spacer-xs\\'><div class=\\'label label-danger p-5\\'>'+ ErrorText +'</div></div>';\n                if (Inner_Object.length > 0) {\n                    object.html(ErrorText);\n                } else {\n                    $(this).after(function() {\n                        return ErrorDOM;\n                    });\n                }\n            } else {\n               Outer_Object.remove();\n            }\n        });\n        \");\n    }\n\n    if ($options['autocomplete_off']) {\n        // Delay by 20ms and reset values.\n        add_to_jquery(\"\n            $('#\".$options['input_id'].\"').val(' ');\n            setTimeout( function(){ $('#\".$options['input_id'].\"').val(''); }, 20);\n        \");\n    }\n\n    return $html;\n}\n", "<?php\n/*-------------------------------------------------------+\n| PHPFusion Content Management System\n| Copyright (C) PHP Fusion Inc\n| https://phpfusion.com/\n+--------------------------------------------------------+\n| Filename: form_textarea.php\n| Author: Frederick MC Chan (Chan)\n+--------------------------------------------------------+\n| This program is released as free software under the\n| Affero GPL license. You can redistribute it and/or\n| modify it under the terms of this license which you\n| can read by viewing the included agpl.txt or online\n| at www.gnu.org/licenses/agpl.html. Removal of this\n| copyright header is strictly prohibited without\n| written permission from the original author(s).\n+--------------------------------------------------------*/\nfunction form_textarea($input_name, $label = '', $input_value = '', array $options = []) {\n\n    $locale = fusion_get_locale('', [\n        LOCALE.LOCALESET.\"admin/html_buttons.php\",\n        LOCALE.LOCALESET.\"error.php\"\n    ]);\n\n    require_once INCLUDES.\"bbcode_include.php\";\n    require_once INCLUDES.\"html_buttons_include.php\";\n\n    $title = $label ? stripinput($label) : ucfirst(strtolower(str_replace(\"_\", \" \", $input_name)));\n\n    $input_name = (isset($input_name) && (!empty($input_name))) ? stripinput($input_name) : \"\";\n\n    if (!empty($options['bbcode'])) {\n        $options['type'] = \"bbcode\";\n    } else if (!empty($options['html'])) {\n        $options['type'] = \"html\";\n    }\n\n    $default_options = [\n        'input_id'            => $input_name,\n        'type'                => '',\n        'inline_editing'      => FALSE,\n        'required'            => FALSE,\n        'tinymce_forced_root' => TRUE,\n        'placeholder'         => '',\n        'deactivate'          => FALSE,\n        'width'               => '',\n        'inner_width'         => '100%',\n        'height'              => '200px',\n        'class'               => '',\n        'inner_class'         => '',\n        'inline'              => FALSE,\n        'length'              => 200,\n        'error_text'          => $locale['error_input_default'],\n        'safemode'            => FALSE,\n        'form_name'           => 'input_form',\n        'tinymce'             => 'simple',\n        'tinymce_css'         => '',\n        'tinymce_image'       => TRUE, // Turns on or off the image selection feature in TinyMCE\n        'no_resize'           => FALSE,\n        'autosize'            => FALSE,\n        'bbcode'              => FALSE,\n        'html'                => FALSE,\n        'preview'             => FALSE,\n        'path'                => IMAGES,\n        'maxlength'           => '',\n        'tip'                 => '',\n        'ext_tip'             => '',\n        'input_bbcode'        => '',\n        'wordcount'           => FALSE,\n        'file_filter'         => ['.png', '.PNG', '.svg', '.SVG', '.bmp', '.BMP', '.jpg', '.JPG', '.jpeg', '.gif', '.GIF', '.tiff', '.TIFF'],\n        'tinymce_theme'       => 'modern',\n        'tinymce_skin'        => 'lightgray',\n        'tinymce_spellcheck'  => TRUE,\n        'rows'                => 5,\n        'censor_words'        => TRUE,\n        'descript'            => TRUE\n    ];\n\n    $options += $default_options;\n\n    if ($options['type'] == \"tinymce\") {\n\n        $options['tinymce'] = !empty($options['tinymce']) && in_array($options['tinymce'], [TRUE, 'simple', 'advanced']) ? $options['tinymce'] : \"simple\";\n\n        $default_tinymce_css = (defined(\"ADMIN_PANEL\") && file_exists(THEMES.\"admin_themes/\".fusion_get_settings(\"admin_theme\").\"/tinymce.css\") ? THEMES.\"admin_themes/\".fusion_get_settings(\"admin_theme\").\"/tinymce.css\" : THEMES.\"templates/tinymce.css\");\n\n        $options['tinymce_css'] = (!empty($options['tinymce_css']) && file_exists($options['tinymce_css']) ? $options['tinymce_css'] : $default_tinymce_css);\n\n        $options['tinymce_spellcheck'] = $options['tinymce_spellcheck'] == TRUE ? 'true' : 'false';\n\n        $tinymce_list = [];\n        if (!empty($options['path']) && $options['tinymce_image'] == TRUE) {\n            $image_list = [];\n            if (is_array($options['path'])) {\n                foreach ($options['path'] as $dir) {\n                    if (file_exists($dir) && is_dir($dir)) {\n                        $image_list[$dir] = makefilelist($dir, \".|..|\");\n                    }\n                }\n            } else {\n                if (file_exists($options['path']) && is_dir($options['path'])) {\n                    $image_list[$options['path']] = makefilelist($options['path'], '.|..|');\n                }\n            }\n            foreach ($image_list as $key => $images) {\n                foreach ($images as $keys => $image_name) {\n                    $image_1 = explode('.', $image_name);\n                    $last_str = count($image_1) - 1;\n                    if (in_array(\".\".$image_1[$last_str], $options['file_filter'])) {\n                        $tinymce_list[] = ['title' => $image_name, 'value' => $key.$image_name];\n                    }\n                }\n            }\n        }\n\n        $tinymce_list = json_encode($tinymce_list);\n        $tinymce_smiley_vars = \"\";\n        if (!defined('tinymce')) {\n            add_to_head('<script src=\"'.INCLUDES.'jquery/jquery-ui/jquery-ui.min.js\"></script>');\n            add_to_head('<link rel=\"stylesheet\" href=\"'.INCLUDES.'jquery/jquery-ui/jquery-ui.min.css\">');\n            add_to_head('<script src=\"'.INCLUDES.'elFinder/js/elfinder.min.js\"></script>');\n            add_to_head('<link rel=\"stylesheet\" href=\"'.INCLUDES.'elFinder/css/elfinder.min.css\">');\n            add_to_head('<link rel=\"stylesheet\" href=\"'.INCLUDES.'elFinder/css/theme.css\">');\n            add_to_head(\"<script src='\".INCLUDES.\"jscripts/tinymce/tinymce.min.js'></script>\");\n            add_to_head(\"<script src='\".INCLUDES.\"elFinder/js/tinymceElfinder.min.js'></script>\");\n\n            add_to_jquery('\n                const mceElf = new tinymceElfinder({\n                    // connector URL (Set your connector)\n                    url: \"'.fusion_get_settings('siteurl').'includes/elFinder/php/connector.php'.fusion_get_aidlink().'\",\n                    // upload target folder hash for this tinyMCE\n                    uploadTargetHash: \"l1_lw\", // Hash value on elFinder of writable folder\n                    // elFinder dialog node id\n                    nodeId: \"elfinder\", // Any ID you decide\n                        ui: [\"toolbar\", \"tree\", \"path\", \"stat\"],\n                        uiOptions: {\n                            toolbar: [\n                                [\"home\", \"back\", \"forward\", \"up\", \"reload\"],\n                                [\"mkdir\", \"mkfile\", \"upload\"],\n                                [\"open\"],\n                                [\"copy\", \"cut\", \"paste\", \"rm\", \"empty\"],\n                                [\"duplicate\", \"rename\", \"edit\", \"resize\", \"chmod\"],\n                                [\"quicklook\", \"info\"],\n                                [\"extract\", \"archive\"],\n                                [\"search\"],\n                                [\"view\", \"sort\"],\n                                [\"preference\", \"help\"]\n                            ]\n                        }\n                });\n            ');\n\n            define('tinymce', TRUE);\n            // PHPFusion Parse Cache Smileys\n            $smileys = cache_smileys();\n            $tinymce_smiley_vars = \"\";\n            if (!empty($smileys)) {\n                $tinymce_smiley_vars = \"var shortcuts = {\\n\";\n                foreach ($smileys as $params) {\n                    $tinymce_smiley_vars .= \"'\".strtolower($params['smiley_code']).\"' : '<img alt=\\\"\".$params['smiley_text'].\"\\\" src=\\\"\".IMAGES.\"smiley/\".$params['smiley_image'].\"\\\"/>',\\n\";\n                }\n                $tinymce_smiley_vars .= \"};\\n\";\n                $tinymce_smiley_vars .= \"\n                ed.on('keyup', function(e){\n                    var marker = tinymce.activeEditor.selection.getBookmark();\n                    // Store editor contents\n                    var content = tinymce.activeEditor.getContent({'format':'raw'});\n                    // Loop through all shortcuts\n                    for(var key in shortcuts){\n                        // Check if the editor html contains the looped shortcut\n                        if(content.toLowerCase().indexOf(key) != -1) {\n                            // Escaping special characters to be able to use the shortcuts in regular expression\n                            var k = key.replace(/[<>*()?']/ig, \\\"\\\\$&\\\");\n                            tinymce.activeEditor.setContent(content.replace(k, shortcuts[key]));\n                        }\n                    }\n                    // Now put cursor back where it was\n                    tinymce.activeEditor.selection.moveToBookmark(marker);\n                });\n                \";\n            }\n        }\n\n        $images = '';\n\n        if ($options['tinymce_image']) {\n            $images = \"file_picker_callback : mceElf.browser,\";\n        }\n\n        // Mode switching for TinyMCE\n        switch ($options['tinymce']) {\n            case 'advanced':\n                add_to_jquery(\"\n                tinymce.init({\n                    \".$images.\"\n                    relative_urls: false,\n                    remove_script_host: false,\n                    selector: '#\".$options['input_id'].\"',\n                    inline: \".($options['inline_editing'] == TRUE ? \"true\" : \"false\").\",\n                    theme: '\".$options['tinymce_theme'].\"',\n                    skin: '\".(defined('TINYMCE_SKIN') ? TINYMCE_SKIN : $options['tinymce_skin']).\"',\n                    \".(defined('TINYMCE_SKIN_PATH') ? \"skin_url: '\".TINYMCE_SKIN_PATH.\"', \" : '').\"\n                    browser_spellcheck: \".$options['tinymce_spellcheck'].\",\n                    entity_encoding: 'raw',\n                    language:'\".$locale['tinymce'].\"',\n                    directionality : '\".$locale['text-direction'].\"',\n                    \".($options['tinymce_forced_root'] ? \"forced_root_block: '',\" : '').\"\n                    width: '100%',\n                    height: 300,\n                    plugins: [\n                        'advlist autolink \".($options['autosize'] ? \" autoresize \" : \"\").\" link image lists charmap print preview hr anchor pagebreak spellchecker',\n                        'searchreplace wordcount visualblocks visualchars code fullscreen insertdatetime media nonbreaking',\n                        'save table contextmenu directionality template paste textcolor \".($options['inline_editing'] ? \" save \" : \"\").\"'\n                    ],\n                    image_list: $tinymce_list,\n                    content_css: '\".$options['tinymce_css'].\"',\n                    toolbar1: '\".($options['inline_editing'] ? \" save \" : \"\").\" insertfile undo redo | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | newdocument fullscreen preview cut copy paste pastetext spellchecker searchreplace code',\n                    toolbar2: 'styleselect formatselect removeformat | fontselect fontsizeselect bold italic underline strikethrough subscript superscript blockquote | forecolor backcolor',\n                    toolbar3: 'hr pagebreak insertdatetime | link unlink anchor | image media | table charmap visualchars visualblocks emoticons',\n                    image_advtab: true,\n                    style_formats: [\n                        {title: 'Bold text', inline: 'b'},\n                        {title: 'Red text', inline: 'span', styles: {color: '#ff0000'}},\n                        {title: 'Red header', block: 'h1', styles: {color: '#ff0000'}},\n                        {title: 'Example 1', inline: 'span', classes: 'example1'},\n                        {title: 'Example 2', inline: 'span', classes: 'example2'},\n                        {title: 'Table styles'},\n                        {title: 'Table row 1', selector: 'tr', classes: 'tablerow1'}\n                    ],\n                    setup: function(ed) {\n                        // add tabkey listener\n                        ed.on('keydown', function(event) {\n                            if (event.keyCode == 9) { // tab pressed\n                                if (event.shiftKey) { ed.execCommand('Outdent'); } else { ed.execCommand('Indent'); }\n                                event.preventDefault();\n                                return false;\n                            }\n                        });\n                        // auto smileys parsing\n                        \".$tinymce_smiley_vars.\"\n                    }\n                });\n                \");\n                break;\n            case 'simple':\n                add_to_jquery(\"\n                tinymce.init({\n                    \".$images.\"\n                    relative_urls: false,\n                    remove_script_host: false,\n                    selector: '#\".$options['input_id'].\"',\n                    inline: \".($options['inline_editing'] == TRUE ? \"true\" : \"false\").\",\n                    theme: '\".$options['tinymce_theme'].\"',\n                    skin: '\".(defined('TINYMCE_SKIN') ? TINYMCE_SKIN : $options['tinymce_skin']).\"',\n                    \".(defined('TINYMCE_SKIN_PATH') ? \"skin_url: '\".TINYMCE_SKIN_PATH.\"', \" : '').\"\n                    browser_spellcheck: \".$options['tinymce_spellcheck'].\",\n                    entity_encoding: 'raw',\n                    menubar: false,\n                    statusbar: false,\n                    content_css: '\".$options['tinymce_css'].\"',\n                    image_list: $tinymce_list,\n                    plugins: [\n                        'advlist autolink \".($options['autosize'] ? \" autoresize \" : \"\").\" link image lists charmap print preview hr anchor pagebreak spellchecker',\n                        'searchreplace wordcount visualblocks visualchars code fullscreen insertdatetime media nonbreaking',\n                        'contextmenu directionality template paste\".($options['bbcode'] ? \" bbcode \" : \"\").($options['autosize'] ? \" autoresize \" : \"\").($options['inline_editing'] ? \" save \" : \"\").\"'\n                    ],\n                    width: '100%',\n                    height: 100,\n                    image_advtab: true,\n                    toolbar1: 'undo redo | bold italic underline | emoticons | visualblocks | bullist numlist blockquote | hr \".($options['tinymce_image'] ? \" image \" : \"\").\" | fullscreen \".($options['inline_editing'] ? \" save \" : \"\").\" | code',\n                    language: '\".$locale['tinymce'].\"',\n                    directionality : '\".$locale['text-direction'].\"',\n                    \".($options['tinymce_forced_root'] ? \"forced_root_block: '',\" : '').\"\n                    object_resizing: \".($options['autosize'] ? \"false\" : \"true\").\",\n                    resize: \".($options['autosize'] ? \"false\" : \"true\").\",\n                    setup: function(ed) {\n                        // add tabkey listener\n                        ed.on('keydown', function(event) {\n                            if (event.keyCode == 9) { // tab pressed\n                                if (event.shiftKey) { ed.execCommand('Outdent'); } else { ed.execCommand('Indent'); }\n                                event.preventDefault();\n                                return false;\n                            }\n                        });\n                        // auto smileys parsing\n                        \".$tinymce_smiley_vars.\"\n                    }\n                });\n\n                $('#inject').bind('click', function () {\n                    tinyMCE.activeEditor.execCommand(\\\"mceInsertContent\\\", true, '[b]I am injecting in stuff..[/b]');\n                });\n                \");\n                break;\n            case 'default':\n                add_to_jquery(\"\n                tinymce.init({\n                    \".$images.\"\n                    relative_urls: false,\n                    remove_script_host: false,\n                    selector: '#\".$options['input_id'].\"',\n                    inline: \".($options['inline_editing'] == TRUE ? \"true\" : \"false\").\",\n                    content_css: '\".$options['tinymce_css'].\"',\n                    theme: '\".$options['tinymce_theme'].\"',\n                    skin: '\".(defined('TINYMCE_SKIN') ? TINYMCE_SKIN : $options['tinymce_skin']).\"',\n                    \".(defined('TINYMCE_SKIN_PATH') ? \"skin_url: '\".TINYMCE_SKIN_PATH.\"', \" : '').\"\n                    browser_spellcheck: \".$options['tinymce_spellcheck'].\",\n                    entity_encoding: 'raw',\n                    language:'\".$locale['tinymce'].\"',\n                    directionality : '\".$locale['text-direction'].\"',\n                    \".($options['tinymce_forced_root'] ? \"forced_root_block: '',\" : '').\"\n                    setup: function(ed) {\n                        // add tabkey listener\n                        ed.on('keydown', function(event) {\n                            if (event.keyCode == 9) { // tab pressed\n                                if (event.shiftKey) { ed.execCommand('Outdent'); } else { ed.execCommand('Indent'); }\n                                event.preventDefault();\n                                return false;\n                            }\n                        });\n                        // auto smileys parsing\n                        \".$tinymce_smiley_vars.\"\n                    }\n                });\n                \");\n                break;\n        }\n    } else {\n\n        if ($options['bbcode']) {\n            $options['type'] = 'bbcode';\n        } else if ($options['html']) {\n            $options['type'] = 'html';\n        }\n\n        if ($options['autosize'] || defined('AUTOSIZE')) {\n            add_to_footer(\"<script src='\".DYNAMICS.\"assets/autosize/autosize.min.js'></script>\");\n            add_to_jquery(\"autosize($('#\".$options['input_id'].\"'));\");\n        }\n    }\n\n    if ($input_value) {\n        $input_value = html_entity_decode(stripslashes($input_value), ENT_QUOTES, $locale['charset']);\n        $input_value = htmlspecialchars_decode($input_value);\n    }\n\n    $error_class = \"\";\n    if (\\defender::inputHasError($input_name)) {\n        $error_class = \" has-error\";\n        if (!empty($options['error_text'])) {\n            $new_error_text = \\defender::getErrorText($input_name);\n            if (!empty($new_error_text)) {\n                $options['error_text'] = $new_error_text;\n            }\n            addNotice(\"danger\", \"<strong>$title</strong> - \".$options['error_text']);\n        }\n    }\n\n    $html = \"<div id='\".$options['input_id'].\"-field' class='form-group \".($options['inline'] && $label ? 'row' : '').$error_class.$options['class'].\"'\".($options['width'] ? \" style='width: \".$options['width'].\" !important;'\" : '').\">\\n\";\n    $html .= ($label) ? \"<label class='control-label \".($options['inline'] ? \"col-xs-12 col-sm-3 col-md-3 col-lg-3\" : '').\"' for='\".$options['input_id'].\"'>\".$label.($options['required'] == 1 ? \"<span class='required'>&nbsp;*</span>\" : '').\" \".($options['tip'] ? \"<i class='pointer fa fa-question-circle' title='\".$options['tip'].\"'></i>\" : '').\"</label>\\n\" : '';\n    $html .= ($options['inline']) ? \"<div class='clearfix\".($label ? ' col-xs-12 col-sm-9 col-md-9 col-lg-9' : '').\"'>\\n\" : '';\n    $tab_active = 0;\n    $tab_title = [];\n    if ($options['preview'] && ($options['type'] == \"html\" || $options['type'] == \"bbcode\")) {\n        $tab_title['title'][] = $locale['preview'];\n        $tab_title['id'][] = \"prw-\".$options['input_id'];\n        $tab_title['icon'][] = '';\n        $tab_title['title'][] = $locale['texts'];\n        $tab_title['id'][] = \"txt-\".$options['input_id'];\n        $tab_title['icon'][] = '';\n        $tab_active = tab_active($tab_title, 1);\n    }\n\n    $html .= ($options['type'] == \"html\" || $options['type'] == \"bbcode\") ? \"<div class='panel panel-default panel-txtarea m-b-0' \".($options['preview'] ? \"style='border-radius:0;'\" : '').\">\\n\n    <div class='panel-heading clearfix'>\\n\" : '';\n\n    if ($options['preview'] && ($options['type'] == \"bbcode\" || $options['type'] == \"html\")) {\n        $html .= openeditortab($tab_title, $tab_active, $options['input_id'].\"-link\", \"\", \"editor-wrapper\");\n    }\n\n    if ($options['type'] == \"bbcode\" && $options['form_name']) {\n        $html .= \"<div class='bbcode_input'>\\n\";\n        $html .= display_bbcodes('100%', $options['input_id'], $options['form_name'], $options['input_bbcode']);\n        $html .= $options['preview'] ? \"</div>\\n\" : \"\";\n    } else if ($options['type'] == \"html\" && $options['form_name']) {\n        $html .= \"<div class='m-t-10 m-b-10'>\\n\";\n        $html .= display_html($options['form_name'], $options['input_id'], TRUE, TRUE, TRUE, $options['path']); // @todo: image_path to be turned off by default\n        $html .= $options['preview'] ? \"</div>\\n\" : \"\";\n    }\n\n    $html .= ($options['type'] == \"html\" || $options['type'] == \"bbcode\") ? \"</div>\\n</div>\\n<div class='panel-body p-0'>\\n\" : '';\n\n    if ($options['preview'] && ($options['type'] == \"bbcode\" || $options['type'] == \"html\")) {\n        $html .= \"<div id='tab-content-\".$options['input_id'].\"-link' class='tab-content p-0'>\\n\";\n        $html .= opentabbody($tab_title['title'][1], \"txt-\".$options['input_id'], $tab_active);\n    }\n\n    if ($options['inline_editing'] == TRUE) {\n        $html .= \"<div id='\".$options['input_id'].\"' \".($options['width'] ? \"style='display:block; width: \".$options['width'].\";'\" : '').\">\".$input_value.\"</div>\\n\";\n    } else {\n        $html .= \"<textarea name='$input_name' style='display:block; width: \".$options['inner_width'].\"; height:\".$options['height'].\";\".($options['no_resize'] ? ' resize: none;' : '').\"' rows='\".$options['rows'].\"' cols='' class='form-control m-0 \".($options['inner_class'] ? \" \".$options['inner_class'].\" \" : '').($options['autosize'] ? 'animated-height' : '').\" \".(($options['type'] == \"html\" || $options['type'] == \"bbcode\") ? \"no-shadow no-border\" : '').\" textbox'\".($options['placeholder'] ? \" placeholder='\".$options['placeholder'].\"' \" : '').\" id='\".$options['input_id'].\"'\".($options['deactivate'] ? ' readonly' : '').\" \".($options['maxlength'] ? \" maxlength='\".$options['maxlength'].\"'\" : '').\">\".$input_value.\"</textarea>\\n\";\n    }\n\n    if ($options['preview'] && ($options['type'] == \"bbcode\" || $options['type'] == \"html\")) {\n        $html .= closetabbody();\n        $html .= opentabbody($tab_title['title'][0], \"prw-\".$options['input_id'].\"\", $tab_active);\n        $html .= $locale['global_003'];\n        $html .= closetabbody();\n        $html .= \"</div>\\n\";\n        add_to_jquery(\"\n            // preview syntax\n            var form = $('#\".$options['form_name'].\"');\n            $('#tab-prw-\".$options['input_id'].\"').bind('click',function(){\n            var text = $('#\".$options['input_id'].\"').val();\n            var format = '\".($options['type'] == \"bbcode\" ? 'bbcode' : 'html').\"';\n            var data = {\n                \".(defined('ADMIN_PANEL') ? \"'mode': 'admin', \" : \"\").\"\n                'text' : text,\n                'editor' : format,\n                'url' : '\".$_SERVER['REQUEST_URI'].\"',\n                'form_id' : 'prw-\".$options['form_name'].\"',\n                'fusion_token' : '\".fusion_get_token(\"prw-\".$options['form_name'], 30).\"'\n            };\n            var sendData = form.serialize() + '&' + $.param(data);\n            $.ajax({\n                url: '\".FUSION_ROOT.INCLUDES.\"dynamics/assets/preview/preview.ajax.php',\n                type: 'POST',\n                dataType: 'html',\n                data : sendData,\n                success: function(result) {\n                    //console.log(result);\n                    $('#prw-\".$options['input_id'].\"').html(result);\n                },\n                error: function(result) {\n                    alert('\".$locale['error_preview'].\"' + '\\\\n\".$locale['error_preview_text'].\"');\n                }\n                });\n            });\n        \");\n    }\n\n    if (($options['type'] == \"html\" || $options['type'] == \"bbcode\") && $options['wordcount'] === TRUE) {\n        $html .= \"</div>\\n<div class='panel-footer clearfix'>\\n\";\n        $html .= \"<div class='overflow-hide'><i><small>\".$locale['word_count'].\": <span id='\".$options['input_id'].\"-wordcount'></span></small></i></div>\";\n        add_to_jquery(\"\n        if ($('#\".$options['input_id'].\"').length) {\n            var init_str = $('#\".$options['input_id'].\"').val().replace(/<[^>]+>/ig, '').replace(/\\\\n/g,'').replace(/ /g, '').length;\n            $('#\".$options['input_id'].\"-wordcount').text(init_str);\n        }\n        $('#\".$options['input_id'].\"').on('input propertychange paste', function() {\n        var str = $(this).val().replace(/<[^>]+>/ig, '').replace(/\\\\n/g,'').replace(/ /g, '').length;\n        $('#\".$options['input_id'].\"-wordcount').text(str);\n        });\n        \");\n        $html .= \"</div>\\n<!---panel-footer-->\";\n    }\n    if ((!$options['type'] == \"bbcode\" && !$options['type'] == \"html\")) {\n        $html .= $options['ext_tip'] ? \"<span class='tip'><i>\".$options['ext_tip'].\"</i></span>\" : \"\";\n    }\n    $html .= $options['inline'] ? \"</div>\\n\" : '';\n    if (($options['type'] == \"bbcode\" || $options['type'] == \"html\")) {\n        if ($options['wordcount']) {\n            $html .= \"</div>\\n\";\n            $html .= $options['ext_tip'] ? \"<br/>\\n<span class='tip'><i>\".$options['ext_tip'].\"</i></span>\" : \"\";\n\n        } else {\n            $html .= \"</div>\\n\";\n            $html .= \"</div>\\n\";\n            $html .= $options['ext_tip'] ? \"<br/>\\n<span class='tip'><i>\".$options['ext_tip'].\"</i></span>\" : \"\";\n\n        }\n    }\n\n    $html .= (($options['required'] == 1 && \\defender::inputHasError($input_name)) || \\defender::inputHasError($input_name)) ? \"<div id='\".$options['input_id'].\"-help' class='label label-danger text-white p-5 display-inline-block'>\".$options['error_text'].\"</div>\" : \"\";\n    $html .= \"</div>\\n\";\n\n    \\defender::add_field_session([\n        'input_name'   => clean_input_name($input_name),\n        'type'         => 'textarea',\n        'title'        => $label,\n        'id'           => $options['input_id'],\n        'required'     => $options['required'],\n        'safemode'     => $options['safemode'],\n        'error_text'   => $options['error_text'],\n        'censor_words' => $options['censor_words'],\n        'descript'     => $options['descript']\n    ]);\n\n    return $html;\n}\n\nfunction openeditortab($tab_title, $link_active_arrkey, $id, $link = FALSE, $class = FALSE, $getname = \"section\") {\n    $link_mode = $link ? $link : 0;\n    $html = \"<div class='nav-wrapper $class'>\\n\";\n    $html .= \"<ul class='nav' \".($id ? \"id='\".$id.\"'\" : \"\").\" >\\n\";\n    if (!empty($tab_title['title'])) {\n        foreach ($tab_title['title'] as $arr => $v) {\n            $v_title = str_replace(\"-\", \" \", $v);\n            $tab_id = $tab_title['id'][$arr];\n            $icon = (isset($tab_title['icon'][$arr])) ? $tab_title['icon'][$arr] : \"\";\n            $link_url = $link ? clean_request($getname.'='.$tab_id, [$getname], FALSE) : '#';\n            if ($link_mode) {\n                $html .= ($link_active_arrkey == $tab_id) ? \"<li class='active m-r-10'>\\n\" : \"<li class='m-r-10'>\\n\";\n            } else {\n                $html .= ($link_active_arrkey == \"\".$tab_id) ? \"<li class='active m-r-10'>\\n\" : \"<li  class='m-r-10'>\\n\";\n            }\n            $html .= \"<a class='btn btn-default btn-sm m-l-10 pointer' \".(!$link_mode ? \"id='tab-\".$tab_id.\"' data-toggle='tab' data-target='#\".$tab_id.\"'\" : \"href='$link_url'\").\">\\n\".($icon ? \"<i class='\".$icon.\"'></i>\" : '').\" \".$v_title.\" </a>\\n\";\n            $html .= \"</li>\\n\";\n        }\n    }\n    $html .= \"</ul>\\n\";\n\n    return $html;\n}\n", ".label-danger{margin-top:5px}.top-0{top:0!important}.top-5{top:5px!important}.top-10{top:10px!important}.top-20{top:20px!important}.top-30{top:30px!important}.top-40{top:40px!important}.top-50{top:50px!important}.bottom-0{bottom:0!important}.bottom-5{bottom:5px!important}.bottom-10{bottom:10px!important}.bottom-20{bottom:20px!important}.bottom-30{bottom:30px!important}.bottom-40{bottom:40px!important}.bottom-50{bottom:50px!important}.left-0{left:0!important}.left-10{left:10px!important}.left-15{left:15px!important}.left-20{left:20px!important}.left-30{left:30px!important}.left-40{left:40px!important}.left-50{left:50px!important}.right-0{right:0!important}.right-10{right:10px!important}.right-15{right:15px!important}.right-20{right:20px!important}.right-30{right:30px!important}.right-40{right:40px!important}.right-50{right:50px!important}.center-margin-x{margin:0 auto}.row.flexbox{display:-webkit-box;display:flex;overflow:hidden}.row.flexbox.auto_width>div{-webkit-box-flex:1;flex:1}.row.equal-height{display:-webkit-box;display:flex;flex-wrap:wrap}.row.equal-height>[class*=col-]{-webkit-background-clip:content-box;-o-background-clip:content-box;background-clip:content-box;display:-webkit-box;display:-webkit-flex;display:flex;-webkit-flex-wrap:wrap;flex-wrap:wrap;-webkit-box-orient:vertical;-webkit-box-direction:normal;flex-direction:column;-webkit-flex-direction:row}.row.equal-height:after,.row.equal-height:before{content:normal}.row.equal-height>[class*=col-]>*{width:100%}.center-y{position:relative;top:50%;-webkit-transform:translateY(-50%);-ms-transform:translateY(-50%);transform:translateY(-50%)}.center-x{position:relative;left:50%;-webkit-transform:translateX(-50%);-ms-transform:translateX(-50%);transform:translateX(-50%)}.center-xy{position:relative;left:50%;top:50%;-webkit-transform:translate(-50%,-50%);-ms-transform:translate(-50%,-50%);transform:translate(-50%,-50%)}.align-top,.vt{vertical-align:top!important;display:table-cell}.align-middle,.va{vertical-align:middle!important;display:table-cell}.align-bottom,.vb{vertical-align:bottom!important;display:table-cell}.align-left{text-align:left}.align-center{text-align:center}.align-right{text-align:right}.pull-left{float:left}.pull-right{float:right}.spacer-xs{margin:15px 0}.spacer-sm{margin:20px 0}.spacer-md{margin:40px 0}.spacer-lg{margin:80px 0}.m-0{margin:0!important}.m-1{margin:1px!important}.m-2{margin:2px!important}.m-3{margin:3px!important}.m-5{margin:5px!important}.m-10{margin:10px!important}.m-b-0{margin-bottom:0!important}.m-b-5{margin-bottom:5px!important}.m-b-10{margin-bottom:10px!important}.m-b-15{margin-bottom:15px!important}.m-b-20{margin-bottom:20px!important}.m-b-50{margin-bottom:50px!important}.m-t-0{margin-top:0!important}.m-t-3{margin-top:3px!important}.m-t-5{margin-top:5px!important}.m-t-10{margin-top:10px!important}.m-t-15{margin-top:15px!important}.m-t-20{margin-top:20px!important}.m-t-30{margin-top:30px!important}.m-l-0{margin-left:0!important}.m-l-5{margin-left:5px!important}.m-l-10{margin-left:10px!important}.m-l-15{margin-left:15px!important}.m-l-20{margin-left:20px!important}.m-l-30{margin-left:30px!important}.m-r-0{margin-right:0!important}.m-r-5{margin-right:5px!important}.m-r-10{margin-right:10px!important}.m-r-15{margin-right:15px!important}.m-r-20{margin-right:20px!important}.m-r-30{margin-right:30px!important}.m-auto{margin:0 auto!important}.m-l--15{margin-left:-15px!important}.m-r--15{margin-right:-15px!important}.p-0{padding:0!important}.p-5{padding:5px!important}.p-10{padding:10px!important}.p-15{padding:15px!important}.p-20{padding:20px!important}.p-25{padding:25px!important}.p-t-0{padding-top:0!important}.p-t-5{padding-top:5px!important}.p-t-10{padding-top:10px!important}.p-t-15{padding-top:15px!important}.p-t-20{padding-top:20px!important}.p-l-0{padding-left:0!important}.p-l-5{padding-left:5px!important}.p-l-10{padding-left:10px!important}.p-l-15{padding-left:15px!important}.p-l-20{padding-left:20px!important}.p-r-0{padding-right:0!important}.p-r-5{padding-right:5px!important}.p-r-10{padding-right:10px!important}.p-r-15{padding-right:15px!important}.p-r-20{padding-right:20px!important}.p-b-0{padding-bottom:0!important}.p-b-5{padding-bottom:5px!important}.p-b-10{padding-bottom:10px!important}.p-b-15{padding-bottom:15px!important}.p-b-20{padding-bottom:20px!important}.overflow-hide{overflow:hidden}.display-none{display:none}.display-block{display:block;width:100%}.display-inline{display:inline}.display-inline-block{display:inline-block}.display-table{display:table}.display-table-row{display:table-row}.display-table-cell{display:table-cell}.position-relative{position:relative}.position-absolute{position:absolute}.transition{-webkit-transition:all 0.2s ease-in-out;transition:all 0.2s ease-in-out}.no-shadow{box-shadow:none!important}.bbr-0{border-radius:0!important}.br-0,.no-border{border:0!important}.br-l-0{border-left:0}.br-r-0{border-right:0}.br-t-0{border-top:0}.br-b-0{border-bottom:0}.text-white{color:#FFF!important}.text-dark{color:#333!important}.text-black{color:#444!important}.text-lighter{opacity:0.8}.text-darker{opacity:1}.text-bigger{font-size:110%!important}.text-smaller{font-size:85%!important}.font-bold,.strong,.text-bold{font-weight:bold!important}.font-light,.text-light{font-weight:300!important}.font-normal,.text-normal{font-weight:normal!important;text-transform:none!important;text-decoration:none!important;color:inherit!important}.text-active{color:rgb(66,139,202)}.text-disabled{color:#F7F7F7}.text-serif{font-family:'Times New Roman',Courier,\"Courier New\",serif}.uppercase{text-transform:uppercase}.text-uppercase{text-transform:uppercase}.text-capitalize{text-transform:capitalize}.text-underline{text-decoration:underline}.img-center{display:inline-block;position:relative!important;left:100%!important;margin-left:-200%!important}.thumb>img{width:auto;height:auto;margin-left:auto;margin-right:auto;display:inline-block}.thumb>span{background-color:#DDD;text-align:center}.pdisabled{background-color:rgb(252,248,227)!important;border-color:rgb(250,235,204)!important}.pdisabled>.handle>a{color:rgb(138,109,59)!important}.blur{-webkit-filter:blur(5px) grayscale(50%)}.pointer{cursor:pointer}.no-border{border:0!important}.bordered{border:1px solid}ul.block,ul.error-list{list-style:none outside none}ol.decimal{list-style:decimal inside}ul{padding:0}li.panel{box-shadow:none!important;margin-bottom:0!important;background:none;border:0}.list-style-none>li{list-style:none}ul>li{padding:0;list-style-position:inside}.icon-xs{font-size:16px!important;width:16px}.icon-sm{font-size:32px!important;width:32px}.icon-md{font-size:48px!important;width:48px}.icon-lg{font-size:128px!important;width:128px}.icon-xl{font-size:256px!important;width:256px}.clearfix{display:block}.clearfix:after,li:after{visibility:hidden;display:block;font-size:0;content:\" \";clear:both;height:0}* html,* html .clearfix{zoom:1}.floatfix{overflow:hidden}* html .floatfix{width:100%}.no-opacity,.opacity-none{opacity:0}.low-opacity{opacity:0.2}.mid-opacity{opacity:0.45}.high-opacity{opacity:0.8}.full-opacity{opacity:1}#profile-li ul{padding:0}#profile-li>li{padding:0}#profile-li>li>a{padding:8px 3px;width:100%;display:inline-block;outline:none}.select2-input{color:#999!important;border:none!important}.select2-offscreen{display:none}.tbl{display:table-cell!important}.required{color:red!important}a img{border:0}dd,dl,dt{margin:0;padding:0;overflow:hidden}.dms-switch:hover,.list-group-item:hover .status{text-decoration:underline}.animated-height{-webkit-transition:height 0.2s;transition:height 0.2s}.user-tooltip{width:250px;padding-bottom:10px}.form-inline>.form-group{width:auto!important}table{font-size:100%}.icon-wrapper img{max-width:48px;margin:15px auto 5px}.icon-wrapper>.icon-container{text-align:center}.tablesorter-default .header,.tablesorter-default .tablesorter-header{background:url(data:image/gif;base64,R0lGODlhFQAJAIAAACMtMP///yH5BAEAAAEALAAAAAAVAAkAAAIXjI+AywnaYnhUMoqt3gZXPmVg94yJVQAAOw==) no-repeat center right}.tablesorter-default thead .headerSortUp,.tablesorter-default thead .tablesorter-headerAsc,.tablesorter-default thead .tablesorter-headerSortUp{background:url(data:image/gif;base64,R0lGODlhFQAEAIAAACMtMP///yH5BAEAAAEALAAAAAAVAAQAAAINjI8Bya2wnINUMopZAQA7) no-repeat center right}.tablesorter-default thead .headerSortDown,.tablesorter-default thead .tablesorter-headerDesc,.tablesorter-default thead .tablesorter-headerSortDown{background:url(data:image/gif;base64,R0lGODlhFQAEAIAAACMtMP///yH5BAEAAAEALAAAAAAVAAQAAAINjB+gC+jP2ptn0WskLQA7) no-repeat center right}td.min,th.min{width:1%}.image-wrap{position:relative;overflow:hidden;width:100%}.image-wrap.cropfix{max-width:100%!important;margin:0!important}.word-break{word-break:break-all;word-wrap:break-word}.no-break{white-space:nowrap}.sl{margin:20px 0}.sl .uip{margin:5px 0}.side>li img,.sl>li img{width:19px;margin-right:8px!important}.HTML-img:hover ul.dropdown-menu{display:block}.stacked{display:inline-block;width:auto;margin-right:10px}.icon-stack{position:relative;display:inline-block;width:100%;line-height:2em;vertical-align:middle;text-align:center}.icon-stack>.icon,.icon-stack>.icon:before{position:absolute;top:50%;-webkit-transform:translateY(-50%);-ms-transform:translateY(-50%);transform:translateY(-50%);width:100%;text-align:center;left:0;margin:0}.clearBg{background-color:transparent!important}.whiteBg{background-color:#fff!important}.btn-modal.btn-file{border:1px dashed #ccc;width:100%}.file-preview-frame{display:block!important}.panel>.file-preview{border:transparent}.file-preview-image{width:100%;height:200px}.file-input .panel{width:200px}.file-input .panel .file-preview-image{display:inline-block;max-width:100%;vertical-align:middle}.file-input .panel .file-default-preview,.file-input .panel .file-preview-frame,.file-input .panel .file-preview-other{height:143px;max-height:143px;width:100%;display:block;margin:0;border:0;box-shadow:none;padding:0;float:none;overflow:hidden}.file-input img{height:100%;width:auto;margin:0 auto}.comments-form-panel,.comments-panel{margin-bottom:20px}.comments-form-header,.comments-header{position:relative;padding:10px 0}.comments-form-header:after,.comments-form-header:before,.comments-header:after,.comments-header:before{top:100%;left:5%;border:solid transparent;content:\" \";height:0;width:0;position:absolute;pointer-events:none}.arrow_box{position:relative;background:#fff;border:1px solid #ddd;margin-left:15px;margin-bottom:20px;padding:3px 15px 15px}.arrow_box:after,.arrow_box:before{right:100%;top:33%;border:solid transparent;content:\" \";height:0;width:0;position:absolute;pointer-events:none}.arrow_box:after{border:12px rgba(255,255,255,0);border-right-color:#fff;margin-top:-12px}.arrow_box:before{border:14px rgba(221,221,221,0);border-right-color:#ddd;margin-top:-14px}.comment-actions{margin-top:10px}.comment-actions>.btn-group{display:-webkit-inline-box;display:inline-flex}.comments_reply_form{margin-bottom:30px}.panel-txtarea .preview-response{background-color:#f5f4f4;word-wrap:break-word;word-break:break-all}.panel-txtarea .bbcode{margin:5px 1px}.editor-wrapper .nav{display:inline-block;float:right;padding:0}.editor-wrapper .panel-footer,.editor-wrapper .panel-heading{background:transparent}.editor-wrapper>ul>li{float:right}.media-container{position:relative;overflow:hidden;border:3px solid transparent}.media-container.selected{border:3px solid #3879D9}.media-container img{position:relative}.shoutboxwrapper{margin-top:20px;word-wrap:break-word}ul>li.divider{display:block;height:10px;border-bottom:1px solid #ddd}#delete_status-field{float:left;width:auto;margin-bottom:0}.logo-xs-left{text-align:left}.logo-xs-center{text-align:center;margin-left:auto;margin-right:auto}.logo-xs-right{text-align:right}@media (min-width:768px){.logo-sm-left{text-align:left}.logo-sm-center{text-align:center;margin-left:auto;margin-right:auto}.logo-sm-right{text-align:right}}@media (min-width:992px){.logo-md-left{text-align:left}.logo-md-center{text-align:center;margin-left:auto;margin-right:auto}.logo-md-right{text-align:right}}@media (min-width:1200px){.logo-lg-left{text-align:left}.logo-lg-center{text-align:center;margin-left:auto;margin-right:auto}.logo-lg-right{text-align:right}}ul.navbar-nav li.no-link{position:relative}ul.dropdown-menu,ul.dropdown-menu>li>ul{list-style:none}.control-label>img,label img{margin-right:5px;max-width:24px}.text-overflow-hide{overflow:hidden;text-overflow:ellipsis}.order-caret-down-current:hover:after,.order-caret-up-current:after,.order-caret-up:hover:after{font-family:'FontAwesome 5 Free',sans-serif;content:'\\f0d8';display:inline-block;color:#23282d;margin-left:10px}.order-caret-down-current:after,.order-caret-down:hover:after,.order-caret-up-current:hover:after{font-family:'FontAwesome 5 Free',sans-serif;content:'\\f0d7';display:inline-block;color:#23282d;margin-left:10px}.tbl_actions{display:none}tr:hover>td .tbl_actions{display:block}.tbl_actions>span:after{content:\"|\";display:inline-block;padding:0 5px;color:#ccc}.tbl_actions>span:last-child:after{content:\"\"}.text-normal label{font-weight:400}.thumb>img{display:block;width:100%}.avatar.img-rounded>svg{border-radius:6px}.avatar.img-circle>svg{border-radius:50%}.rank-label{padding:6px 10px}.rank-label>.detail{background:rgba(0,0,0,.1);margin:0 -10px 0 10px;padding:7px 12px;border-radius:0 .28571429rem .28571429rem 0;display:inline-block;font-weight:700;opacity:.8}.rank-label.label-super-admin{background-color:#504cc7}.rank-label.label-mod{background-color:#00B5AD;border-color:#00B5AD}.rank-label.label-member{background-color:#2185D0;border-color:#2185D0}#site-links{list-style:none;min-height:20px;height:auto!important}#site-links li{display:block;margin:30px;padding:10px}#site-links li img.handle{cursor:ns-resize}.state-highlight{background:#FFC;height:20px}.floatfix{overflow:hidden}#panel-side1,#panel-side2,#panel-side3,#panel-side4,#panel-side5,#panel-side6{list-style:none;height:auto!important}#panel-side1 li,#panel-side2 li,#panel-side3 li,#panel-side4 li,#panel-side5 li,#panel-side6 li{display:block}#panel-side1 li img.handle,#panel-side2 li img.handle,#panel-side3 li img.handle,#panel-side4 li img.handle,#panel-side5 li img.handle,#panel-side6 li img.handle{cursor:ns-resize}html[dir=rtl] body{direction:rtl}html[dir=rtl] .pull-left{float:right!important}html[dir=rtl] .pull-right{float:left!important}html[dir=rtl] .center-x{left:inherit;right:50%;-webkit-transform:translateX(50%);-ms-transform:translateX(50%);transform:translateX(50%)}html[dir=rtl] .center-xy{left:inherit;right:50%;-webkit-transform:translate(50%,-50%);-ms-transform:translate(50%,-50%);transform:translate(50%,-50%)}.admin-form-type-1{display:-ms-grid;display:grid;-ms-grid-columns:70% 30%;grid-template-columns:70% 30%}@media (max-width:991px){.admin-form-type-1{-ms-grid-columns:1fr;grid-template-columns:1fr}}"], "fixing_code": ["<?php\n/*-------------------------------------------------------+\n| PHPFusion Content Management System\n| Copyright (C) PHP Fusion Inc\n| https://phpfusion.com/\n+--------------------------------------------------------+\n| Filename: form_buttons.php\n| Author: Frederick MC Chan (Chan)\n| Co-Author: Tyler Hurlbut\n+--------------------------------------------------------+\n| This program is released as free software under the\n| Affero GPL license. You can redistribute it and/or\n| modify it under the terms of this license which you\n| can read by viewing the included agpl.txt or online\n| at www.gnu.org/licenses/agpl.html. Removal of this\n| copyright header is strictly prohibited without\n| written permission from the original author(s).\n+--------------------------------------------------------*/\n\nfunction form_button($input_name, $title, $input_value, array $options = []) {\n    $html = \"\";\n\n    $input_value = clean_input_value($input_value);\n\n    $default_options = [\n        'input_id'    => $input_name,\n        'input_value' => $input_name,\n        'class'       => \"btn-default\",\n        'icon_class'  => \"m-r-10\",\n        'icon'        => \"\",\n        'deactivate'  => FALSE,\n        'type'        => \"submit\",\n        'block'       => FALSE,\n        'alt'         => $title,\n        'data'        => [],\n    ];\n    $options += $default_options;\n\n    if ($options['block']) {\n        $options['class'] = $options['class'].\" btn-block\";\n    }\n\n    array_walk($options['data'], function ($a, $b) use (&$options_data) {\n        $options_data[] = \"data-$b='$a'\";\n    }, $options_data);\n\n    if ($options['type'] == 'link') {\n        $html .= \"<a id='\".$options['input_id'].\"' title='\".$options['alt'].\"' class='\".($options['deactivate'] ? 'disabled ' : '').\"btn \".$options['class'].\" button' href='\".$input_name.\"' data-value='\".$input_value.\"' \".(!empty($options_data) ? implode(' ', $options_data) : '').($options['deactivate'] ? \"disabled='disabled'\" : '').\" >\".($options['icon'] ? \"<i class='\".$options['icon'].\" \".$options['icon_class'].\"'></i>\" : '').$title.\"</a>\";\n    } else if ($options['type'] == 'button') {\n        $html .= \"<button id='\".$options['input_id'].\"' title='\".$options['alt'].\"' class='\".($options['deactivate'] ? 'disabled ' : '').\"btn \".$options['class'].\" button' name='\".$input_name.\"' value='\".$input_value.\"' type='button'\".(!empty($options_data) ? implode(' ', $options_data) : '').($options['deactivate'] ? \" disabled='disabled'\" : '').\" >\".($options['icon'] ? \"<i class='\".$options['icon'].\" \".$options['icon_class'].\"'></i>\" : '').$title.\"</button>\\n\";\n    } else {\n        $html .= \"<button id='\".$options['input_id'].\"' title='\".$options['alt'].\"' class='\".($options['deactivate'] ? 'disabled ' : '').\"btn \".$options['class'].\" button' name='\".$input_name.\"' value='\".$input_value.\"' type='submit'\".(!empty($options_data) ? implode(' ', $options_data) : '').($options['deactivate'] ? \" disabled='disabled'\" : '').\" >\".($options['icon'] ? \"<i class='\".$options['icon'].\" \".$options['icon_class'].\"'></i>\" : '').$title.\"</button>\\n\";\n    }\n\n    return $html;\n}\n\n/**\n * Button Groups\n *\n * @param        $input_name\n * @param string $label\n * @param        $input_value\n * @param array  $options\n *\n * @return string\n */\nfunction form_btngroup($input_name, $label, $input_value, array $options = []) {\n    $locale = fusion_get_locale();\n\n    $title = $label ? stripinput($label) : ucfirst(strtolower(str_replace(\"_\", \" \", $input_name)));\n    $input_value = (isset($input_value) && (!empty($input_value))) ? stripinput($input_value) : NULL;\n\n    $default_options = [\n        'options'        => [$locale['disable'], $locale['enable']],\n        'input_id'       => $input_name,\n        'class'          => \"btn-default\",\n        'type'           => 'button',\n        'icon'           => \"\",\n        'multiple'       => FALSE,\n        'delimiter'      => \",\",\n        'deactivate'     => FALSE,\n        'error_text'     => \"\",\n        'inline'         => FALSE,\n        'safemode'       => FALSE,\n        'required'       => FALSE,\n        'ext_tip'        => '',\n        'callback_check' => '',\n    ];\n\n    $options += $default_options;\n\n    $error_class = \"\";\n    if (\\defender::inputHasError($input_name)) {\n        $error_class = \"has-error\";\n        if (!empty($options['error_text'])) {\n            $new_error_text = \\defender::getErrorText($input_name);\n            if (!empty($new_error_text)) {\n                $options['error_text'] = $new_error_text;\n            }\n            addNotice('danger', \"<strong>$title</strong> - \".$options['error_text']);\n        }\n    }\n\n    $html = \"<div id='\".$options['input_id'].\"-field' class='form-group \".($options['inline'] && $label ? 'row ' : '').$error_class.\" clearfix'>\\n\";\n    $html .= ($label) ? \"<label class='control-label \".($options['inline'] ? \"col-xs-12 col-sm-12 col-md-3 col-lg-3\" : '').\"' for='\".$options['input_id'].\"'>\".$label.($options['required'] ? \"<span class='required'>&nbsp;*</span>\" : '').\"</label>\\n\" : '';\n    $html .= ($options['inline'] && $label) ? \"<div class='col-xs-12 col-sm-12 col-md-9 col-lg-9'>\\n\" : \"\";\n\n    $html .= \"<div class='btn-group' id='\".$options['input_id'].\"'>\";\n\n    if (!empty($options['options']) && is_array($options['options'])) {\n        $i = 1;\n        $option_count = count($options['options']);\n\n        foreach ($options['options'] as $arr => $v) {\n            $child_class = ($option_count == $i ? ' last-child ' : '');\n            $active_class = ($input_value == $arr ? ' active' : '');\n\n            if ($options['type'] == 'submit') {\n                $html .= \"<button name='$arr' type='submit' data-value='$arr' value='$arr' class='btn \".$options['class'].$child_class.$active_class.\"'>$v</button>\\n\";\n            } else {\n                $html .= \"<button type='button' data-value='$arr' class='btn \".$options['class'].$child_class.$active_class.\"'>$v</button>\\n\";\n            }\n\n            $i++;\n        }\n    }\n\n    $html .= \"</div>\\n\";\n    $html .= \"<input name='$input_name' type='hidden' id='\".$options['input_id'].\"-text' value='$input_value' />\\n\";\n\n    $html .= $options['ext_tip'] ? \"<br/>\\n<div class='m-t-10 tip'><i>\".$options['ext_tip'].\"</i></div>\" : \"\";\n    $html .= \\defender::inputHasError($input_name) ? \"<div id='\".$options['input_id'].\"-help' class='label label-danger p-5 display-inline-block'>\".$options['error_text'].\"</div>\" : \"\";\n    $html .= ($options['inline'] && $label) ? \"</div>\\n\" : \"\";\n    $html .= \"</div>\\n\";\n\n    $input_name = ($options['multiple']) ? str_replace(\"[]\", \"\", $input_name) : $input_name;\n\n    \\defender::add_field_session([\n        'input_name'     => $input_name,\n        'title'          => trim($title, '[]'),\n        'id'             => $options['input_id'],\n        'type'           => 'dropdown',\n        'required'       => $options['required'],\n        'callback_check' => $options['callback_check'],\n        'safemode'       => $options['safemode'],\n        'error_text'     => $options['error_text'],\n        'delimiter'      => $options['delimiter'],\n    ]);\n    add_to_jquery(\"\n    $('#\".$options['input_id'].\" button').bind('click', function(e){\n        $('#\".$options['input_id'].\" button').removeClass('active');\n        $(this).toggleClass('active');\n        value = $(this).data('value');\n        $('#\".$options['input_id'].\"-text').val(value);\n    });\n    \");\n\n    return $html;\n}\n", "<?php\n/*-------------------------------------------------------+\n| PHPFusion Content Management System\n| Copyright (C) PHP Fusion Inc\n| https://phpfusion.com/\n+--------------------------------------------------------+\n| Filename: form_checkbox.php\n| Author: Core Development Team (coredevs@phpfusion.com)\n+--------------------------------------------------------+\n| This program is released as free software under the\n| Affero GPL license. You can redistribute it and/or\n| modify it under the terms of this license which you\n| can read by viewing the included agpl.txt or online\n| at www.gnu.org/licenses/agpl.html. Removal of this\n| copyright header is strictly prohibited without\n| written permission from the original author(s).\n+--------------------------------------------------------*/\n\n/**\n * @param        $input_name\n * @param string $label\n * @param string $input_value\n * @param array  $options\n *\n * @return string\n */\nfunction form_checkbox($input_name, $label = '', $input_value = '0', array $options = []) {\n\n    $locale = fusion_get_locale('', LOCALE.LOCALESET.'global.php');\n\n    $input_value = clean_input_value($input_value);\n\n    $default_options = [\n        'input_id'       => $input_name,\n        'inline'         => FALSE,\n        'inline_options' => FALSE,\n        'required'       => FALSE,\n        'deactivate'     => FALSE,\n        'class'          => '',\n        'type'           => 'checkbox',\n        'toggle'         => FALSE,\n        'toggle_text'    => [$locale['no'], $locale['yes']],\n        'options'        => [],\n        'options_value'  => [],\n        'delimiter'      => ',',\n        'safemode'       => FALSE,\n        'keyflip'        => FALSE,\n        'error_text'     => $locale['error_input_checkbox'],\n        'value'          => 1,\n        'tip'            => '',\n        'ext_tip'        => '',\n        'inner_width'    => '',\n        'reverse_label'  => FALSE,\n        'deactivate_key' => NULL,\n        'onclick'        => '',\n    ];\n\n    $options += $default_options;\n\n    $error_class = '';\n\n    $option_value = [];\n\n    $default_checked = FALSE;\n\n    if ($options['toggle']) {\n        if (!defined(\"CHECKBOX_SWITCH_CSS\")) {\n            define(\"CHECKBOX_SWITCH_CSS\", TRUE);\n            add_to_head(\"<link rel='stylesheet' href='\".DYNAMICS.\"assets/switch/switch.min.css'>\");\n        }\n    }\n\n    $title = ($label ? stripinput($label) : ucfirst(strtolower(str_replace(\"_\", \" \", $input_name))));\n\n    // 'input_id[]' becomes 'input_id-', due to foreach has multiple options, and these DOM selectors are needed\n    $options['input_id'] = trim(str_replace('[', '-', $options['input_id']), \"]\");\n\n    if (\\defender::inputHasError($input_name)) {\n        $error_class = \" has-error\";\n        if (!empty($options['error_text'])) {\n            $new_error_text = \\defender::getErrorText($input_name);\n            if (!empty($new_error_text)) {\n                $options['error_text'] = $new_error_text;\n            }\n            addNotice(\"danger\", \"<strong>$title</strong> - \".$options['error_text']);\n        }\n    }\n\n    if (!empty($options['options']) && is_array($options['options'])) {\n\n        $options['toggle'] = FALSE; // force toggle to be false if options existed\n\n        if (!empty($input_value) && !is_array($input_value)) {\n            $option_value = array_flip(explode($options['delimiter'], (string)$input_value)); // require key to value\n        }\n\n        // if there are options, and i want the options to be having input value.\n        // options_value\n        $input_value = [];\n\n        $default_checked = empty($option_value);\n\n        foreach (array_keys($options['options']) as $key) {\n            $input_value[$key] = isset($option_value[$key]) ? (!empty($options['options_value'][$key]) ? $options['options_value'][$key] : 1) : 0;\n        }\n    }\n\n    $checkbox = $options['inline'] && $label ? \"<div class='col-xs-12 col-sm-12 col-md-9 col-lg-9'>\" : \"\";\n\n    if (!empty($options['options']) && is_array($options['options'])) {\n\n        foreach ($options['options'] as $key => $value) {\n\n            if ($options['deactivate_key'] !== NULL && $options['deactivate_key'] == $key) {\n                $checkbox .= form_hidden($input_name, '', $key);\n            }\n\n            $checkbox .= \"<div class='\".($options['type'] == 'radio' ? 'radio' : 'checkbox').($options['inline_options'] ? ' display-inline-block m-r-5' : '').\"'>\";\n\n            $checkbox .= \"<label class='control-label m-r-10' for='\".$options['input_id'].\"-$key'\".($options['inner_width'] ? \" style='width: \".$options['inner_width'].\"'\" : '').\">\";\n\n            $checkbox .= \"<input id='\".$options['input_id'].\"-$key' name='$input_name' value='$key' type='\".$options['type'].\"'\n\n            \".($options['deactivate'] || $options['deactivate_key'] === $key ? 'disabled' : '').($options['onclick'] ? ' onclick=\"'.$options['onclick'].'\"' : '').($input_value[$key] == TRUE || $default_checked && $key == FALSE ? ' checked' : '').\" />\";\n\n            $checkbox .= $value;\n\n            $checkbox .= \"</label>\";\n\n            $checkbox .= \"</div>\";\n        }\n\n    } else {\n        $checkbox .= \"<div class='\".(!empty($label) ? 'pull-left' : 'text-center').\" m-r-10'>\";\n        $checkbox .= \"<input id='\".$options['input_id'].\"' style='margin:0;vertical-align:middle;' name='$input_name' value='\".$options['value'].\"' type='\".$options['type'].\"'\".($options['deactivate'] ? ' disabled' : '').($options['onclick'] ? ' onclick=\"'.$options['onclick'].'\"' : '').($input_value == $options['value'] ? ' checked' : '').\">\";\n        $checkbox .= \"</div>\";\n    }\n\n    $html = \"<div id='\".$options['input_id'].\"-field' class='\".($options['toggle'] ? 'checkbox-switch clearfix ' : '').\"form-group \".($options['inline'] && $label ? 'row ' : '').($error_class ? $error_class : '').($options['class'] ? ' '.$options['class'] : '').\"'>\";\n\n    $html .= (!empty($label)) ? \"<label class='control-label\".($options['inline'] ? \" col-xs-12 col-sm-3 col-md-3 col-lg-3\" : '').\"' data-checked='\".(!empty($input_value) ? \"1\" : \"0\").\"' for='\".$options['input_id'].\"'\".($options['inner_width'] ? \" style='width: \".$options['inner_width'].\"'\" : '').\">\" : \"\";\n\n    $html .= ($options['reverse_label'] == TRUE ? $checkbox : \"\");\n\n    $html .= (!empty($label)) ? \"<div class='overflow-hide'>\".$label.($options['required'] ? \"<span class='required'>&nbsp;*</span>\" : '').($options['tip'] ? \" <i class='pointer fa fa-question-circle text-lighter' title='\".$options['tip'].\"'></i>\" : '').\"</div></label>\" : \"\";\n\n    $html .= ($options['reverse_label'] == FALSE ? $checkbox : \"\");\n\n    $html .= $options['ext_tip'] ? \"<br/><span class='tip'><i>\".$options['ext_tip'].\"</i></span>\" : \"\";\n\n    $html .= \\defender::inputHasError($input_name) ? \"<span class='m-l-10'></span>\" : \"\";\n\n    $html .= \\defender::inputHasError($input_name) ? \"<div id='\".$options['input_id'].\"-help' class='label label-danger p-5 display-inline-block'>\".$options['error_text'].\"</div>\" : \"\";\n\n    $html .= $options['inline'] && $label ? \"</div>\" : \"\";\n\n    $html .= \"</div>\";\n\n    \\defender::add_field_session([\n        'input_name' => clean_input_name($input_name),\n        'title'      => trim($title, '[]'),\n        'id'         => $options['input_id'],\n        'type'       => $options['type'],\n        'required'   => $options['required'],\n        'safemode'   => $options['safemode'],\n        'error_text' => $options['error_text'],\n        'delimiter'  => $options['delimiter'],\n    ]);\n\n    return (string)$html;\n}\n", "<?php\n/*-------------------------------------------------------+\n| PHPFusion Content Management System\n| Copyright (C) PHP Fusion Inc\n| https://phpfusion.com/\n+--------------------------------------------------------+\n| Filename: form_colorpicker.php\n| Author: Frederick MC CHan (Chan)\n| Credits: https://farbelous.github.io/bootstrap-colorpicker/\n+--------------------------------------------------------+\n| This program is released as free software under the\n| Affero GPL license. You can redistribute it and/or\n| modify it under the terms of this license which you\n| can read by viewing the included agpl.txt or online\n| at www.gnu.org/licenses/agpl.html. Removal of this\n| copyright header is strictly prohibited without\n| written permission from the original author(s).\n+--------------------------------------------------------*/\nfunction form_colorpicker($input_name, $label = '', $input_value = '', array $options = []) {\n\n    $locale = fusion_get_locale();\n\n    $input_value = clean_input_value($input_value);\n\n    if (defined('BOOTSTRAP4')) {\n        fusion_load_script(DYNAMICS.'assets/colorpick/bs4/css/bootstrap-colorpicker.min.css', 'css');\n        fusion_load_script(DYNAMICS.'assets/colorpick/bs4/js/bootstrap-colorpicker.min.js');\n    } else {\n        fusion_load_script(DYNAMICS.'assets/colorpick/css/bootstrap-colorpicker.min.css', 'css');\n        fusion_load_script(DYNAMICS.'assets/colorpick/js/bootstrap-colorpicker.min.js');\n    }\n\n    $title = $label ? stripinput($label) : ucfirst(strtolower(str_replace(\"_\", \" \", $input_name)));\n    $input_name = stripinput($input_name);\n    $input_value = stripinput($input_value);\n    $default_options = [\n        'input_id'    => $input_name,\n        'required'    => FALSE,\n        'placeholder' => '',\n        'deactivate'  => FALSE,\n        'width'       => '',\n        'inner_width' => '100%',\n        'class'       => '',\n        'inline'      => FALSE,\n        'error_text'  => $locale['error_input_default'],\n        'safemode'    => FALSE,\n        'icon'        => \"\",\n        \"tip\"         => \"\",\n        'format'      => 'hex', //options = the color format - hex | rgb | rgba.\n    ];\n    $options += $default_options;\n    if (!$options['width']) {\n        $options['width'] = $default_options['width'];\n    }\n    $input_id = $options['input_id'] ?: $default_options['input_id'];\n\n    $error_class = \"\";\n    if (\\defender::inputHasError($input_name)) {\n        $error_class = \"has-error \";\n        if (!empty($options['error_text'])) {\n            $new_error_text = \\defender::getErrorText($input_name);\n            if (!empty($new_error_text)) {\n                $options['error_text'] = $new_error_text;\n            }\n            addNotice(\"danger\", \"<strong>$title</strong> - \".$options['error_text']);\n        }\n    }\n\n    $html = \"<div id='$input_id-field' class='form-group \".($options['inline'] && $label ? 'row ' : '').$error_class.$options['class'].\" '>\\n\";\n    $html .= $label ? \"<label class='control-label \".($options['inline'] ? 'col-xs-12 col-sm-3 col-md-3 col-lg-3' : '').\"' for='$input_id'>\".$label.($options['required'] ? \"<span class='required'>&nbsp;*</span>\" : '').\"\n    \".($options['tip'] ? \"<i class='pointer fa fa-question-circle' title='\".$options['tip'].\"'></i>\" : '').\"\n    </label>\\n\" : '';\n    $html .= $options['inline'] && $label ? \"<div class='col-xs-12 col-sm-9 col-md-9 col-lg-9'>\\n\" : \"\";\n    $html .= \"<div id='$input_id' \".($options['width'] ? \"style='width: \".$options['width'].\"'\" : '').\" class='input-group colorpicker-component bscp colorpicker-element m-b-10' data-color='$input_value' data-color-format='\".$options['format'].\"'>\";\n    $html .= \"<input type='text' name='$input_name' class='form-control \".$options['class'].\"' id='\".$input_id.\"' value='$input_value' data-color-format='\".$options['format'].\"'\".($options['placeholder'] ? \" placeholder='\".$options['placeholder'].\"'\" : '').\"\".($options['deactivate'] ? \" readonly\" : \"\").\">\";\n    $html .= \"<span class='input-group-addon input-group-append'>\";\n    $html .= \"<i class='input-group-text colorpicker-input-addon' style='background: rgba(255,255,255,1);'></i>\";\n    $html .= \"</span></div>\";\n    $html .= $options['inline'] && $label ? \"</div>\\n\" : \"\";\n    $html .= \"</div>\\n\";\n\n    \\defender::getInstance()->add_field_session([\n        'input_name' => clean_input_name($input_name),\n        'type'       => 'color',\n        'title'      => $title,\n        'id'         => $input_id,\n        'required'   => $options['required'],\n        'safemode'   => $options['safemode'],\n        'error_text' => $options['error_text']\n    ]);\n    add_to_jquery(\"$('#$input_id').colorpicker({format: '\".$options['format'].\"' \".(defined('BOOTSTRAP4') ? \", fallbackColor: '#000'\" : '').\" });\");\n\n    return $html;\n}\n", "<?php\n/*-------------------------------------------------------+\n| PHPFusion Content Management System\n| Copyright (C) PHP Fusion Inc\n| https://phpfusion.com/\n+--------------------------------------------------------+\n| Filename: form_contact.php\n| Author: Frederick MC CHan (Chan)\n+--------------------------------------------------------+\n| This program is released as free software under the\n| Affero GPL license. You can redistribute it and/or\n| modify it under the terms of this license which you\n| can read by viewing the included agpl.txt or online\n| at www.gnu.org/licenses/agpl.html. Removal of this\n| copyright header is strictly prohibited without\n| written permission from the original author(s).\n+--------------------------------------------------------*/\n\n/**\n * @param        $input_name\n * @param        $label\n * @param string $input_value\n * @param array  $options\n *\n * @return string\n */\nfunction form_contact($input_name, $label, $input_value = \"\", $options = []) {\n\n    $locale = fusion_get_locale();\n\n    $input_value = clean_input_value($input_value);\n\n    $title = $label ? stripinput($label) : ucfirst(strtolower(str_replace(\"_\", \" \", $input_name)));\n\n    $id = trim($input_name, \"[]\");\n\n    $default_options = [\n        'type'              => 'text',\n        'required'          => FALSE,\n        'label_icon'        => '',\n        'feedback_icon'     => '',\n        'safemode'          => FALSE,\n        'regex'             => '',\n        'regex_error_text'  => '',\n        'callback_check'    => FALSE,\n        'input_id'          => $id,\n        'placeholder'       => '',\n        'deactivate'        => FALSE,\n        'width'             => '',\n        'inner_width'       => '',\n        'class'             => '',\n        'inner_class'       => '',\n        'inline'            => FALSE,\n        'min_length'        => 1,\n        'max_length'        => 200,\n        'icon'              => '',\n        'autocomplete_off'  => FALSE,\n        'tip'               => '',\n        'ext_tip'           => '',\n        // prepend is prohibited\n        'append_id'         => \"p-\".$id.\"-append\",\n        'append_button'     => '',\n        'append_value'      => '',\n        'append_form_value' => '',\n        'append_size'       => '',\n        'append_class'      => 'btn-default',\n        'append_type'       => 'submit',\n        'delimiter'         => '|',\n        'stacked'           => '',\n        'group_size'        => '', // http://getbootstrap.com/components/#input-groups-sizing - sm, md, lg\n        'data'              => [],\n        'append_html'       => '',\n        'descript'          => TRUE,\n        'error_text'        => !empty($options['error_text']) ? $options['error_text'] : $locale['prefix_error'],\n        'error_text_2'      => !empty($options['error_text_2']) ? $options['error_text_2'] : $locale['contact_error'],\n    ];\n\n    $options += $default_options;\n\n    $options['type'] = \"tel\";\n\n    // NOTE (remember to parse readback value as of '|' seperator)\n    if (isset($input_value) && (!empty($input_value))) {\n        if (!is_array($input_value)) {\n            $input_value = explode($options[\"delimiter\"], $input_value);\n        }\n    } else {\n        $input_value = [];\n        $input_value['0'] = \"\";\n        $input_value['1'] = \"\";\n    }\n\n    $options += [\n        'append_button_name' => !empty($options['append_button_name']) ? $options['append_button_name'] : \"p-submit-\".$options['input_id'],\n        'append_button_id'   => !empty($options['append_button_id']) ? $options['append_button_id'] : $options['input_id'].'-append-btn',\n    ];\n\n    if (!empty($options['data'])) {\n        array_walk($options['data'], function ($a, $b) use (&$options_data) {\n            $options_data[] = \"data-$b='$a'\";\n        }, $options_data);\n    }\n\n    $error_class = \"\";\n    if (\\defender::inputHasError($input_name)) {\n        $error_class = \" has-error\";\n        if (!empty($options['error_text'])) {\n            $new_error_text = \\defender::getErrorText($input_name);\n            if (!empty($new_error_text)) {\n                $options['error_text'] = $new_error_text;\n            }\n            addNotice(\"danger\", \"<strong>$title</strong> - \".$options['error_text']);\n        }\n    }\n\n    // Fixes HTML DOM type number that does not respect max_length prop.\n    $max_length = '';\n    if ($options['max_length'] && isnum($options['max_length'])) {\n        $max_length = ' maxlength=\"'.$options['max_length'].'\"';\n    }\n\n    // Formats a prefix number\n\n    $html = \"<div id='\".$options['input_id'].\"-field' class='form-group \".($options['inline'] && $label ? 'row ' : '').($error_class ? $error_class : '').($options['class'] ? ' '.$options['class'] : '').($options['icon'] ? ' has-feedback' : '').\"'\".($options['width'] && !$label ? \" style='width: \".$options['width'].\"'\" : '').\">\";\n\n    $html .= ($label ? \"<label class='control-label\".($options['inline'] ? \" col-xs-12 col-sm-12 col-md-3 col-lg-3\" : '').\"' for='\".$options['input_id'].\"'>\".$options['label_icon'].$label.($options['required'] ? \"<span class='required'>&nbsp;*</span>\" : '').\" \".($options['tip'] ? \"<i class='pointer fa fa-question-circle' title='\".$options['tip'].\"'></i>\" : '').\"</label>\" : \"\");\n\n    $html .= ($options['inline'] && $label) ? \"<div class='col-xs-12 col-sm-12 col-md-9 col-lg-9'>\" : \"\";\n\n    $html .= \"<div class='input-group\".($options['group_size'] ? ' input-group-'.$options['group_size'] : '').\"' \".($options['width'] ? \"style='width: \".$options['width'].\"'\" : '').\">\";\n\n    $html .= \"<span class='input-group-addon input-group-prepend p-0 br-0'>\";\n\n    $html .= \"<span class='input-group-text'>\";\n\n    $html .= form_select($input_name.\"_prefix\", \"\", $input_value[0], [\"options\" => calling_codes(), \"class\" => \"m-0\", \"width\" => \"250px\"]);\n\n    $html .= \"</span>\";\n\n    $html .= \"</span>\";\n\n    $html .= \"<input type='tel' data-type='tel' \".(!empty($options_data) ? implode(' ', $options_data) : '').\" \".\"class='form-control textbox \".($options['inner_class'] ? \" \".$options['inner_class'].\" \" : '').\"' \".($options['inner_width'] ? \"style='width:\".$options['inner_width'].\";'\" : '').$max_length.\" name='$input_name' id='\".$options['input_id'].\"_contact' value='\".$input_value['1'].\"'\".($options['placeholder'] ? \" placeholder='\".$options['placeholder'].\"' \" : '').\"\".($options['autocomplete_off'] ? \" autocomplete='off'\" : '').\" \".($options['deactivate'] ? 'readonly' : '').\">\";\n\n    if ($options['append_button'] && $options['append_type'] && $options['append_form_value'] && $options['append_class'] && $options['append_value']) {\n\n        $html .= \"<span class='input-group-btn'>\\n\";\n\n        $html .= \"<button id='\".$options['append_button_id'].\"' name='\".$options['append_button_name'].\"' type='\".$options['append_type'].\"' value='\".$options['append_form_value'].\"' class='btn \".$options['append_size'].\" \".$options['append_class'].\"'>\".$options['append_value'].\"</button>\\n\";\n\n        $html .= \"</span>\\n\";\n\n    } else if ($options['append_value']) {\n\n        $html .= \"<span class='input-group-addon input-group-append' id='\".$options['append_id'].\"'><span class='input-group-text'>\".$options['append_value'].\"</span></span>\\n\";\n\n    }\n\n    $html .= ($options['feedback_icon']) ? \"<div class='form-control-feedback' style='top:0;'><i class='\".$options['icon'].\"'></i></div>\" : '';\n\n    $html .= $options['stacked'];\n\n    $html .= ($options['append_button'] || $options['append_value']) ? \"</div>\" : \"\";\n\n    $html .= $options['append_html'];\n\n    $html .= ($options['inline'] && $label) ? \"</div>\" : \"\";\n\n    $html .= ($options['ext_tip'] ? \"<br/><span class='tip'><i>\".$options['ext_tip'].\"</i></span>\" : \"\");\n\n    $html .= \\defender::inputHasError($input_name) ? \"<div class='input-error\".((!$options['inline'] || $options['append_button'] || $options['append_value']) ? \" display-block\" : \"\").\"'><div id='\".$options['input_id'].\"-help' class='label label-danger p-5 display-inline-block'>\".$options['error_text'].\"</div></div>\" : \"\";\n\n    $html .= \"</div>\";\n\n    $html .= \"</div>\";\n\n    \\defender::add_field_session([\n        'input_name'     => clean_input_name($input_name),\n        'title'          => $title,\n        'id'             => $options['input_id'],\n        'type'           => 'contact',\n        'required'       => $options['required'],\n        'safemode'       => $options['safemode'],\n        'regex'          => $options['regex'],\n        'callback_check' => $options['callback_check'],\n        'delimiter'      => $options['delimiter'],\n        'min_length'     => $options['min_length'],\n        'max_length'     => $options['max_length']\n    ]);\n\n    // This should affect all number inputs by type, not by ID\n    if (!defined('TEL_ONLY_JS')) {\n        define('TEL_ONLY_JS', TRUE);\n        // Add plugin codes\n        add_to_jquery(\"\n        // Restricts input for each element in the set of matched elements to the given inputFilter.\n        (function($) {\n          $.fn.inputFilter = function(inputFilter) {\n            return this.on(\\\"input keydown keyup mousedown mouseup select contextmenu drop\\\", function() {\n              if (inputFilter(this.value)) {\n                this.oldValue = this.value;\n                this.oldSelectionStart = this.selectionStart;\n                this.oldSelectionEnd = this.selectionEnd;\n              } else if (this.hasOwnProperty(\\\"oldValue\\\")) {\n                this.value = this.oldValue;\n                this.setSelectionRange(this.oldSelectionStart, this.oldSelectionEnd);\n              } else {\n                this.value = \\\"\\\";\n              }\n            });\n          };\n        }(jQuery));\n       \");\n    }\n    add_to_jquery(\"\n    $('#\".$options['input_id'].\"_contact').inputFilter(function(value) { return /^-?\\d*$/.test(value); });\n    \");\n\n    // Live Regex Error Check\n    if ($options['regex'] && $options['regex_error_text']) {\n        add_to_jquery(\"\n        $('#\".$options['input_id'].\"').blur(function(ev) {\n            var Inner_Object = $(this).parent('div').find('.label-danger');\n            var Outer_Object = $(this).parent('div').find('.input-error');\n            if (!$(this).val().match(/\".$options['regex'].\"/g) && $(this).val()) {\n                var ErrorText = '\".$options['regex_error_text'].\"';\n                var ErrorDOM = '<div class=\\'input-error spacer-xs\\'><div class=\\'label label-danger p-5\\'>'+ ErrorText +'</div></div>';\n                if (Inner_Object.length > 0) {\n                    object.html(ErrorText);\n                } else {\n                    $(this).after(function() {\n                        return ErrorDOM;\n                    });\n                }\n            } else {\n               Outer_Object.remove();\n            }\n        });\n        \");\n    }\n\n    if ($options['autocomplete_off']) {\n        // Delay by 20ms and reset values.\n        add_to_jquery(\"\n            $('#\".$options['input_id'].\"').val(' ');\n            setTimeout( function(){ $('#\".$options['input_id'].\"').val(''); }, 20);\n        \");\n    }\n\n    return $html;\n}\n\n/**\n * @param null $country_code\n *\n * @return array|mixed|null\n */\nfunction calling_codes($country_code = NULL) {\n    $countries = [];\n    static $calling_codes = [];\n    require_once INCLUDES.\"geomap/callingcodes.inc.php\";\n    if (!empty($countries) && empty($calling_codes)) {\n        foreach ($countries as $country) {\n            // there is an array for these areas replicated.\n            $calling_codes[$country[\"code\"].\"*\".$country[\"prefix\"]] = $country[\"name\"].\" (\".$country[\"prefix\"].\")\";\n        }\n    }\n\n    return $country_code === NULL ? $calling_codes : (isset($calling_codes[$country_code]) ? $calling_codes[$country_code] : NULL);\n}\n", "<?php\n/*-------------------------------------------------------+\n| PHPFusion Content Management System\n| Copyright (C) PHP Fusion Inc\n| https://phpfusion.com/\n+--------------------------------------------------------+\n| Filename: form_datepicker.php\n| Author: Frederick MC Chan (Chan)\n| Credits:  eternicode @ http://bootstrap-datepicker.readthedocs.org/en/latest/\n| Docs: http://bootstrap-datepicker.readthedocs.org/en/release/options.html\n+--------------------------------------------------------+\n| This program is released as free software under the\n| Affero GPL license. You can redistribute it and/or\n| modify it under the terms of this license which you\n| can read by viewing the included agpl.txt or online\n| at www.gnu.org/licenses/agpl.html. Removal of this\n| copyright header is strictly prohibited without\n| written permission from the original author(s).\n+--------------------------------------------------------*/\n/**\n * Input to save date using datepicker\n * Datetimepicker documentation - http://eonasdan.github.io/bootstrap-datetimepicker/Options/\n *\n * @param        $input_name\n * @param string $label\n * @param string $input_value\n * @param array  $options\n *                <ul>\n *                <li><strong>class</strong> (string): Empty string by default.\n *                The value of attribute class of the input.</li>\n *                <li><strong>date_format</strong> (string): dd-mm-yyyy by default.\n *                Date format for datepicker plugin.</li>\n *                <li><strong>deactivate</strong> (boolean): FALSE by default.\n *                You can pass TRUE and turn off the javascript datepicker plugin</li>\n *                <li><strong>error_text</strong> (string): empty string by default.\n *                An error message</li>\n *                <li><strong>fieldicon_off</strong> (boolean): FALSE by default.\n *                If TRUE, the calendar icon will be not displayed in the input.</li>\n *                <li><strong>inline</strong> (boolean): FALSE by default.\n *                TRUE if the input should be an inline element.</li>\n *                <li><strong>input_id</strong> (string): $input name by default.\n *                The value of attribute id of input.</li>\n *                <li><strong>required</strong> (boolean): FALSE by default</li>\n *                <li><strong>type</strong> (string): timestamp by default.\n *                Valid types:\n *                <ul>\n *                <li>date: The date will be saved as mysql date.</li>\n *                <li>timestamp: A timestamp will be saved as an integer</li>\n *                </ul>\n *                </li>\n *                <li><strong>week_start</strong> (int): 0 by default.\n *                An integer between 0 and 6. It is the same as\n *                the attribute weekStart of datepicker.</li>\n *                <li><strong>width</strong> (string): 250px by default.\n *                A valid value for CSS width</li>\n *                </ul>\n *\n * Callback Usages !important\n * ==========================\n * Configuration when type is 'timestamp'\n * Token used for $options['date_format_php'] is the <a href=\"http://php.net/manual/en/function.date.php\">PHP token equivalent.</a>\n * Token used for $options['date_format_js'] must be formatted with <a href=\"http://momentjs.com/docs/#/displaying/\">moment.js.</a>\n * Both token must match each other to parse the callback properly.\n * Example 1:\n *  \"date_format_php\" => \"d-m-Y\",\n * \"date_format_js\"  => \"DD-MM-YYYY\",\n *\n * Example 2:\n *  'date_format_js'  => 'YYYY-M-DD',\n * 'date_format_php' => 'Y-m-d',\n *\n * Currently, only user birthdate in `entire project` uses date format.\n *\n * Joining 2 datepickers (Start and End)\n * =======================================\n * In Start Datepicker, add $options['join_to_id'] with End Datepicker's input_id\n * In End Datepicker, add $options['join_from_id'] with Start Datepicker's input_id\n *\n * @return string\n */\n\n\nfunction form_datepicker($input_name, $label = '', $input_value = '', array $options = []) {\n\n    $locale = fusion_get_locale();\n\n    $input_value = clean_input_value($input_value);\n\n    if (!defined('DATEPICKER')) {\n        define('DATEPICKER', TRUE);\n        if (file_exists(DYNAMICS.\"assets/datepicker/locale/tooltip/\".$locale['datepicker'].\".js\")) {\n            $lang = $locale['datepicker'];\n        } else {\n            $lang = 'en-gb';\n        }\n        add_to_footer(\"<script src='\".DYNAMICS.\"assets/datepicker/locale/tooltip/\".$lang.\".js'></script>\");\n\n        if (defined('BOOTSTRAP4')) {\n            add_to_head(\"<link href='\".DYNAMICS.\"assets/datepicker/bs4/tempusdominus-bootstrap-4.min.css' rel='stylesheet'>\");\n        } else {\n            add_to_head(\"<link href='\".DYNAMICS.\"assets/datepicker/css/bootstrap-datetimepicker.min.css' rel='stylesheet'>\");\n        }\n\n        add_to_footer(\"<script src='\".DYNAMICS.\"assets/datepicker/js/moment.min.js'></script>\");\n\n        if (defined('BOOTSTRAP4')) {\n            add_to_footer(\"<script src='\".DYNAMICS.\"assets/datepicker/bs4/tempusdominus-bootstrap-4.min.js'></script>\");\n        } else {\n            add_to_footer(\"<script src='\".DYNAMICS.\"assets/datepicker/js/bootstrap-datetimepicker.min.js'></script>\");\n        }\n        add_to_footer(\"<script src='\".DYNAMICS.\"assets/datepicker/locale/\".$locale['datepicker'].\".js'></script>\");\n    }\n\n    $title = $label ? stripinput($label) : ucfirst(strtolower(str_replace(\"_\", \" \", $input_name)));\n\n    $input_name = stripinput($input_name);\n\n    $default_options = [\n        'input_id'               => $input_name,\n        'required'               => FALSE,\n        'placeholder'            => '',\n        'deactivate'             => FALSE,\n        'width'                  => '',\n        'inner_width'            => '', // in px i.e. 250px\n        'class'                  => '',\n        'inline'                 => FALSE,\n        'error_text'             => $locale['error_input_default'],\n        'date_format_js'         => 'M-DD-YYYY H:mm:ss',\n        'date_format_php'        => 'm-d-Y H:i:s',\n        'delimiter'              => '-',\n        'fieldicon_off'          => FALSE,\n        'filtered_dates'         => [], // must be an array\n        'include_filtered_dates' => (boolean)FALSE, // if TRUE, then only days filtered are selectable\n        'weekend'                => [], // 0 for Sunday, 1 for Monday, 6 for Saturday\n        'disable_weekend'        => (boolean)FALSE, // if true, all weekend will be non-selectable\n        'type'                   => 'timestamp',\n        'tip'                    => '',\n        'showTime'               => (boolean)FALSE,\n        'week_start'             => fusion_get_settings('week_start'),\n        'join_to_id'             => '',\n        'join_from_id'           => '',\n        'debug'                  => '',\n        'stacked'                => '',\n    ];\n\n    $options += $default_options;\n\n    if (!empty($input_value)) {\n        if ($options['type'] == \"timestamp\") {\n            $input_value = date($options['date_format_php'], isnum($input_value) ? $input_value : strtotime(str_replace('-', '/', $input_value)));\n        } else if ($options['type'] == \"date\") {\n            if (stristr($input_value, $options['delimiter'])) {\n                $input_value = explode($options['delimiter'], $input_value);\n                if (count($input_value) == 3) {\n                    $params = [\n                        'year'  => $input_value[0],\n                        'month' => $input_value[1],\n                        'day'   => $input_value[2]\n                    ];\n                    if (checkdate($params['month'], $params['day'], $params['year'])) {\n                        $input_value = (implode(\"-\", $params).\" 00:00:00\");\n                    }\n                }\n            }\n        }\n    } else {\n        $input_value = \"\";\n    }\n\n    if (!$options['width']) {\n        $options['width'] = $default_options['width'];\n    }\n\n    // Format disabled or enabled dates as JS array\n    $dateFilter = [];\n    if (!empty($options['filtered_dates']) && is_array($options['filtered_dates'])) {\n        $date_filtered = [];\n        $dateFilter[0] = \"disabledDates: \";\n        if ($options['include_filtered_dates'] == TRUE) {\n            $dateFilter[0] = \"enabledDates: \";\n        }\n        foreach ($options['filtered_dates'] as $value) {\n            $date_filtered[] = date(\"m/d/Y\", $value);\n        }\n        $dateFilter[1] = (string)\"['\".implode(\"','\", $date_filtered).\"']\";\n    }\n\n    // Format for Weekend\n    $weekendFilter = [];\n    if ($options['disable_weekend']) {\n        $weekendFilter[0] = \"daysOfWeekDisabled: \";\n        $weekendFilter[1] = (!empty($options['weekend']) && is_array($options['weekend'])) ? \"[\".implode(\",\", $options['weekend']).\"]\" : \"[0,6]\";\n    }\n\n    if (!in_array($options['type'], ['date', 'timestamp'])) {\n        $options['type'] = $default_options['type'];\n    }\n\n    $options['week_start'] = (int)$options['week_start'];\n\n    $error_class = \"\";\n    if (\\defender::inputHasError($input_name)) {\n        $error_class = \"has-error \";\n        if (!empty($options['error_text'])) {\n            $new_error_text = \\defender::getErrorText($input_name);\n            if (!empty($new_error_text)) {\n                $options['error_text'] = $new_error_text;\n            }\n            addNotice(\"danger\", \"<strong>$title</strong> - \".$options['error_text']);\n        }\n    }\n\n\n    $html = \"<div id='\".$options[\"input_id\"].\"-field' class='form-group \".($options['inline'] && $label ? 'row ' : '').$error_class.$options['class'].\"'>\\n\";\n\n    $html .= ($label ? \"<label class='control-label\".($options['inline'] ? \" col-xs-12 col-sm-3 col-md-3 col-lg-3\" : '').\"' for='\".$options[\"input_id\"].\"'>\".$label.($options['required'] ? \"<span class='required'>&nbsp;*</span> \" : '').($options['tip'] ? \"<i class='pointer fa fa-question-circle' title='\".$options['tip'].\"'></i>\" : '').\"</label>\" : \"\");\n\n    $html .= $options['inline'] && $label ? \"<div class='col-xs-12 col-sm-9 col-md-9 col-lg-9'>\\n\" : \"\";\n\n    $html .= \"<div id='\".$options[\"input_id\"].\"_datepicker' data-target-input='nearest' class='input-group date'\".($options['width'] ? \" style='width: \".$options['width'].\"'\" : \"\").\">\\n\";\n\n    $html .= \"<input type='text' name='\".$input_name.\"' id='\".$options[\"input_id\"].\"' data-target='#\".$options[\"input_id\"].\"-datepicker' value='\".$input_value.\"' class='datetimepicker-input form-control textbox'\".($options['inner_width'] ? \" style='width:\".$options['inner_width'].\";'\" : '').($options['placeholder'] ? \" placeholder='\".$options['placeholder'].\"'\" : '').\"/>\\n\";\n\n    $html .= \"<span class='input-group-addon input-group-append \".($options['fieldicon_off'] ? 'display-none' : '').\"' data-target='#\".$options[\"input_id\"].\"-datepicker' data-toggle='datetimepicker'><i class='input-group-text fa fa-calendar'></i></span>\\n\";\n\n    $html .= \"</div>\\n\";\n\n    $html .= (($options['required'] == 1 && \\defender::inputHasError($input_name)) || \\defender::inputHasError($input_name) ? \"<div id='\".$options[\"input_id\"].\"-help' class='label label-danger p-5 display-inline-block'>\".$options['error_text'].\"</div>\" : \"\");\n\n    $html .= $options['stacked'];\n\n    $html .= ($options['inline'] && $label ? \"</div>\" : \"\");\n\n    $html .= \"</div>\";\n\n    \\defender::add_field_session([\n        'input_name'  => clean_input_name($input_name),\n        'type'        => $options['type'],\n        'title'       => $title,\n        'id'          => $options[\"input_id\"],\n        'required'    => $options['required'],\n        'error_text'  => $options['error_text'],\n        \"delimiter\"   => $options['delimiter'],\n        'date_format' => $options['date_format_php'],\n        'safemode'    => TRUE,\n    ]);\n\n    if (!$options['deactivate']) {\n\n        /**\n         * Bind to and from together\n         */\n        $bindingJs = \"\";\n        if (!empty($options['join_from_id'])) {\n            if (defined('BOOTSTRAP4')) {\n                $bindingJs = \"\n                    $('#\".$options['join_from_id'].\"_datepicker').on('change.datetimepicker', function (e) {\n                        $('#\".$options[\"input_id\"].\"_datepicker').datetimepicker('minDate', e.date);\n                    });\n                    $('#\".$options[\"input_id\"].\"_datepicker').on('change.datetimepicker', function (e) {\n                        $('#\".$options['join_from_id'].\"_datepicker').datetimepicker('maxDate', e.date);\n                    });\n                \";\n            } else {\n                $bindingJs = \"\n                    $('#\".$options['join_from_id'].\"_datepicker').on('dp.change', function(e) {\n                        $('#\".$options[\"input_id\"].\"_datepicker').data('DateTimePicker').minDate(e.date);\n                    });\n                    $('#\".$options[\"input_id\"].\"_datepicker').on('dp.change', function(e) {\n                        $('#\".$options['join_from_id'].\"_datepicker').data('DateTimePicker').maxDate(e.date);\n                    });\n                \";\n            }\n        }\n\n        if (defined('BOOTSTRAP4')) {\n            $dpbuttons = \"\n                buttons: {\n                    showToday: true,\n                    showClear: true,\n                    showClose: true\n                },\n            \";\n        } else {\n            $dpbuttons = \"\n                showTodayButton: true,\n                showClear: true,\n                showClose: true,\n            \";\n        }\n\n        add_to_jquery(\"\n        moment.updateLocale('\".$locale['datepicker'].\"', {\n            week: {dow: \".$options['week_start'].\"}\n        });\n        \n        let \".$options[\"input_id\"].\"_datepicker = $('#\".$options[\"input_id\"].\"_datepicker').datetimepicker({\n            locale: '\".$locale['datepicker'].\"',\n            \".$dpbuttons.\"\n            allowInputToggle: true,\n            icons: {\n                time: 'fa fa-clock',\n                date: 'fa fa-calendar',\n                up: 'fa fa-caret-up',\n                down: 'fa fa-caret-down',\n                previous: 'fa fa-caret-left',\n                next: 'fa fa-caret-right',\n                today: 'fa fa-calendar-day',\n                clear: 'fa fa-trash',\n                close: 'fa fa-close'\n            },\n            tooltips: tooltips_locale,\n            \".($options['showTime'] == TRUE ? \"sideBySide: true,\" : \"\").\"\n            \".(!empty($dateFilter) ? $dateFilter[0].$dateFilter[1].\",\" : \"\").\"\n            \".(!empty($weekendFilter) ? $weekendFilter[0].$weekendFilter[1].\",\" : \"\").\"\n            format: '\".$options['date_format_js'].\"',\n            \".(!empty($options['join_from_id']) ? \"useCurrent: false\" : \"\").\"\n        });\n        \".$bindingJs.\"\n        \");\n    }\n\n    return (string)$html;\n}\n", "<?php\n/*-------------------------------------------------------+\n| PHPFusion Content Management System\n| Copyright (C) PHP Fusion Inc\n| https://phpfusion.com/\n+--------------------------------------------------------+\n| Filename: form_fileinput.php\n| Author: Frederick MC CHan (Chan)\n| Credits: http://plugins.krajee.com/file-input\n+--------------------------------------------------------+\n| This program is released as free software under the\n| Affero GPL license. You can redistribute it and/or\n| modify it under the terms of this license which you\n| can read by viewing the included agpl.txt or online\n| at www.gnu.org/licenses/agpl.html. Removal of this\n| copyright header is strictly prohibited without\n| written permission from the original author(s).\n+--------------------------------------------------------*/\n\n/**\n * @param            $input_name\n * @param string     $label\n * @param bool|FALSE $input_value\n * @param array      $options\n * if media is true, defender will check if any file uploaded. If no, select from media selection\n *\n * @return string\n */\nfunction form_fileinput($input_name, $label = '', $input_value = FALSE, array $options = []) {\n    $locale = fusion_get_locale();\n\n    $title = $label ? stripinput($label) : ucfirst(strtolower(str_replace(\"_\", \" \", $input_name)));\n\n    $input_name = (isset($input_name) && (!empty($input_name))) ? stripinput($input_name) : \"\";\n\n    $input_value = clean_input_value($input_value);\n\n    $template_choices = ['classic', 'modern', 'thumbnail'];\n\n    $default_options = [\n        'input_id'          => $input_name,\n        'upload_path'       => IMAGES,\n        'required'          => FALSE,\n        'safemode'          => FALSE,\n        'deactivate'        => FALSE,\n        'preview_off'       => FALSE,\n        'type'              => 'image', //// ['image', 'html', 'text', 'video', 'audio', 'flash', 'object', 'file']\n        'width'             => '',\n        'label'             => $locale['browse'],\n        'inline'            => TRUE,\n        'class'             => \"\",\n        'tip'               => \"\",\n        'ext_tip'           => \"\",\n        'error_text'        => $locale['error_input_file'],\n        'btn_class'         => 'btn-default',\n        'icon'              => 'fa fa-upload',\n        'jsonurl'           => FALSE,\n        'dropzone'          => FALSE,\n        'valid_ext'         => '.jpg,.png,.PNG,.JPG,.JPEG,.gif,.GIF,.bmp,.BMP',\n        'thumbnail'         => FALSE,\n        'thumbnail_w'       => 300,\n        'thumbnail_h'       => 300,\n        'thumbnail_folder'  => \"\",\n        'thumbnail_ratio'   => 0,\n        'thumbnail_suffix'  => '_t1',\n        'thumbnail2'        => FALSE,\n        'thumbnail2_w'      => 600,\n        'thumbnail2_h'      => 400,\n        'thumbnail2_suffix' => '_t2',\n        'thumbnail2_ratio'  => 0,\n        'delete_original'   => FALSE,\n        'max_width'         => 1800,\n        'max_height'        => 1600,\n        'max_byte'          => 15728640,\n        'max_count'         => 1,\n        'multiple'          => FALSE,\n        'template'          => 'classic',\n        'media'             => FALSE,\n        'placeholder'       => '',\n        'form_id'           => '',\n        'hide_upload'       => TRUE,\n        'hide_remove'       => FALSE,\n        'krajee_disabled'   => FALSE,\n        'replace_upload'    => FALSE, // makes upload unique (i.e. overwrite instead of creating new)\n    ];\n\n    $options += $default_options;\n\n    if (!is_dir($options['upload_path']) && !$options['jsonurl']) {\n        $options['upload_path'] = IMAGES;\n    }\n\n    $options['thumbnail_folder'] = rtrim($options['thumbnail_folder'], \"/\");\n\n    if (!in_array($options['template'], $template_choices)) {\n        $options['template'] = \"classic\";\n    }\n\n    $options['input_id'] = trim(str_replace(\"[\", \"-\", $options['input_id']), \"]\");\n\n    $error_class = \"\";\n    if (\\defender::inputHasError($input_name)) {\n        $error_class = \"has-error \";\n        if (!empty($options['error_text'])) {\n            $new_error_text = \\defender::getErrorText($input_name);\n            if (!empty($new_error_text)) {\n                $options['error_text'] = $new_error_text;\n            }\n            addNotice(\"danger\", \"<strong>$title</strong> - \".$options['error_text']);\n        }\n    }\n\n    // default max file size\n    $format = '';\n    $browseLabel = $locale['df_300'];\n    $type_for_js = NULL;\n    if ($options['type']) {\n        // file type if single filter, if not will accept as object if left empty.\n        if (!stristr($options['type'], ',') && $options['type']) {\n            if ($options['type'] == 'image') {\n                $format = \"image/*\";\n                $browseLabel = $locale['df_301'];\n            } else if ($options['type'] == 'video') {\n                $format = \"video/*\";\n                $browseLabel = $locale['df_302'];\n            } else if ($options['type'] == 'audio') {\n                $format = \"audio/*\";\n                $browseLabel = $locale['df_303'];\n            }\n        }\n        $type_for_js = json_encode((array)$options['type']);\n    }\n\n    $html = \"<div id='\".$options['input_id'].\"-field' class='form-group \".($options['inline'] && $label ? 'row ' : '').$error_class.$options['class'].\"'\".($options['width'] ? \" style='width: \".$options['width'].\" !important;'\" : '').\">\\n\";\n    $html .= ($label) ? \"<label class='control-label \".($options['inline'] ? \"col-xs-12 col-sm-3 col-md-3 col-lg-3\" : '').\"' for='\".$options['input_id'].\"'>\".$label.($options['required'] ? \"<span class='required'>&nbsp;*</span>\" : '').\"\n    \".($options['tip'] ? \"<i class='pointer fa fa-question-circle' title='\".$options['tip'].\"'></i>\" : '').\"\n    </label>\\n\" : '';\n    $html .= $options['inline'] && $label ? \"<div class='col-xs-12 col-sm-9 col-md-9 col-lg-9'>\\n\" : \"\";\n    $html .= \"<input type='file'\".($options['krajee_disabled'] == TRUE ? \" class='form-control' \" : \"\").($format ? \" accept='\".$format.\"'\" : '').\" name='\".$input_name.\"' id='\".$options['input_id'].\"'\".($options['width'] ? \" style='width: \".$options['width'].\";' \" : '').\"\".($options['deactivate'] ? 'readonly' : '').\" \".($options['multiple'] ? \"multiple='1'\" : '').\" />\\n\";\n    $html .= $options['ext_tip'] ? \"<span class='tip'><i>\".$options['ext_tip'].\"</i></span><br/>\" : \"\";\n    $html .= (\\defender::inputHasError($input_name)) ? \"<div id='\".$options['input_id'].\"-help' class='label label-danger p-5 display-inline-block'>\".$options['error_text'].\"</div>\" : '';\n\n    // Inserts Media Selector\n    // Draw the framework first\n    if ($options['media'] == TRUE) {\n        $files_list = makefilelist($options['upload_path'], \".|..|index.php|\", TRUE, 'files', 'psd|txt|md|php|exe|bat|pdf|js');\n        $container_height = 300;\n        $image_container_height = floor($container_height / 2.5);\n        $html .= \"<div id='\".$options['input_id'].\"-media' class='panel panel-default spacer-sm'>\";\n        $html .= \"<div class='panel-body'>\\n\";\n        $html .= \"<h5>\".$locale['global_901'].\"</h5>\";\n        if (!empty($files_list)) {\n            $html .= form_hidden($input_name.\"-mediaSelector\", '', $input_value,\n                ['input_id' => $options['input_id'].\"-mediaSelector\"]);\n            $html .= \"<hr/>\";\n            $html .= \"<div id='\".$options['input_id'].\"-mediaContainer' class='row' style='max-height:\".$container_height.\"px; overflow-y: scroll'>\";\n            foreach ($files_list as $files) {\n                $html .= \"<div class='col-xs-6 col-sm-3 clearfix text-center m-b-15'>\\n\";\n                $html .= \"<div class='media-container' title='$files' data-file='$files' style='height:\".$image_container_height.\"px;'>\\n\";\n                $html .= \"<img class='center-y' style='margin: 0 auto;' src='\".$options['upload_path'].$files.\"' alt='$files'/>\";\n                $html .= \"</div>\\n\";\n                $html .= \"<small>$files</small>\";\n                $html .= \"</div>\\n\";\n            }\n            $html .= \"</div>\\n\";\n            // single file selector only\n            add_to_jquery(\"\n                function mediaSelect() {\n                    $('#\".$options['input_id'].\"-media .media-container').bind('click', function(){\n                        $('.media-container').removeClass('selected');\n                        $(this).addClass('selected');\n                        var current_folder = $('#\".$options['input_id'].\"-mediaFolder').val();\n                        var file_path = $(this).data('file');\n                        $('#\".$options['input_id'].\"-mediaSelector').val(file_path);\n                    });\n                }\n                mediaSelect();\n            \");\n        }\n        $html .= (\\defender::inputHasError($input_name.\"-mediaSelector\")) ? \"<div id='\".$options['input_id'].\"-mediaSelector' class='label label-danger p-5 display-inline-block'>\".$options['error_text'].\"</div>\" : \"\";\n\n        $html .= \"</div>\\n\";\n        $html .= \"</div>\\n\";\n    }\n    $html .= $options['inline'] && $label ? \"</div>\\n\" : \"\";\n    $html .= \"</div>\\n\";\n\n    \\defender::getInstance()->add_field_session(\n        [\n            'input_name'        => trim($input_name, '[]'),\n            'type'              => ((array)$options['type'] == ['image'] ? 'image' : 'file'),\n            'title'             => $title,\n            'id'                => $options['input_id'],\n            'required'          => $options['required'],\n            'safemode'          => $options['safemode'],\n            'error_text'        => $options['error_text'],\n            'path'              => $options['upload_path'],\n            'thumbnail_folder'  => $options['thumbnail_folder'],\n            'thumbnail'         => $options['thumbnail'],\n            'thumbnail_suffix'  => $options['thumbnail_suffix'],\n            'thumbnail_w'       => $options['thumbnail_w'],\n            'thumbnail_h'       => $options['thumbnail_h'],\n            'thumbnail_ratio'   => $options['thumbnail_ratio'],\n            'thumbnail2'        => $options['thumbnail2'],\n            'thumbnail2_w'      => $options['thumbnail2_w'],\n            'thumbnail2_h'      => $options['thumbnail2_h'],\n            'thumbnail2_suffix' => $options['thumbnail2_suffix'],\n            'thumbnail2_ratio'  => $options['thumbnail2_ratio'],\n            'delete_original'   => $options['delete_original'],\n            'max_width'         => $options['max_width'],\n            'max_height'        => $options['max_height'],\n            'max_count'         => $options['max_count'],\n            'max_byte'          => $options['max_byte'],\n            'multiple'          => $options['multiple'],\n            'valid_ext'         => $options['valid_ext'],\n            'replace_upload'    => $options['replace_upload'],\n        ]\n    );\n\n\n    if ($options['krajee_disabled'] === FALSE) {\n        $browseLabel = $options['placeholder'] ?: $browseLabel;\n        $value = \"\";\n        if (!empty($input_value)) {\n            if (is_array($input_value)) {\n                $value = [];\n                foreach ($input_value as $c_value) {\n                    $value[] = (file_exists($options['upload_path'].$c_value) ? $options['upload_path'].$c_value : $c_value);\n                }\n            } else {\n                $value = (file_exists($options['upload_path'].$input_value) ? $options['upload_path'].$input_value : $input_value);\n            }\n            $value = json_encode($value);\n        }\n\n        $extra_data_js = \"\";\n        if ($options['form_id'] && $options['jsonurl']) {\n            $extra_data_js = \"\n                uploadExtraData: function() {\n                    var inputs = $('#\".$options['form_id'].\" :input');\n                    var obj = $.map(inputs, function(x, y) {\n                        return {\n                            Key: x.name,\n                            Value: $(x).val()\n                        };\n                    });\n                    return obj;\n                },\n            \";\n        }\n        if ($options['media']) {\n            \\defender::getInstance()->add_field_session(\n                [\n                    'input_name' => $input_name.\"-mediaSelector\",\n                    'title'      => trim($title, '[]'),\n                    'id'         => $options['input_id'].\"-mediaSelector\",\n                    'type'       => 'mediaSelect',\n                    'path'       => $options['upload_path'],\n                    'required'   => $options['required'],\n                    'safemode'   => $options['safemode'],\n                ]\n            );\n        }\n\n        $lang = file_exists(DYNAMICS.'assets/fileinput/js/locales/'.$locale['short_lang_name'].'.js') ? 'language: \"'.$locale['short_lang_name'].'\",' : '';\n\n        switch ($options['template']) {\n            case \"classic\":\n                add_to_jquery(\"\n                    $('#\".$options['input_id'].\"').fileinput({\n                        allowedFileTypes: \".$type_for_js.\",\n                        allowedPreviewTypes : \".$type_for_js.\",\n                        \".($value ? \"initialPreview: \".$value.\", \" : '').\"\n                        \".($options['preview_off'] ? \"showPreview: false, \" : '').\"\n                        initialPreviewAsData: true,\n                        browseClass: 'btn \".$options['btn_class'].\" button',\n                        uploadClass: 'btn btn-default button',\n                        captionClass : '',\n                        maxFileCount: '\".$options['max_count'].\"',\n                        removeClass : 'btn \".$options['btn_class'].\" button',\n                        browseLabel: '\".$browseLabel.\"',\n                        browseIcon: '<i class=\\\"\".$options['icon'].\" m-r-10\\\"></i>',\n                        \".($options['jsonurl'] ? \"uploadUrl : '\".$options['jsonurl'].\"',\" : '').\"\n                        \".($options['hide_upload'] ? 'showUpload: false,' : '').\"\n                        \".($options['hide_remove'] ? 'showRemove: false,' : '').\"\n                        dropZoneEnabled: \".($options['dropzone'] ? \"true\" : \"false\").\",\n                        \".($locale['text-direction'] == 'rtl' ? 'rtl: true,' : '').\"\n                        $extra_data_js\n                        \".$lang.\"\n                    });\n                \");\n                break;\n            case \"modern\":\n                add_to_jquery(\"\n                    $('#\".$options['input_id'].\"').fileinput({\n                        allowedFileTypes: \".$type_for_js.\",\n                        allowedPreviewTypes : \".$type_for_js.\",\n                        \".($value ? \"initialPreview: \".$value.\", \" : '').\"\n                        initialPreviewAsData: true,\n                        \".($options['preview_off'] ? \"showPreview: false, \" : '').\"\n                        browseClass: 'btn btn-modal btn-lg',\n                        uploadClass: 'btn btn-modal btn-lg',\n                        captionClass : '',\n                        maxFileCount: '\".$options['max_count'].\"',\n                        removeClass : 'btn button',\n                        browseLabel: '\".$browseLabel.\"',\n                        browseIcon: '<i class=\\\"\".$options['icon'].\"\\\"></i>',\n                        showCaption: false,\n                        showRemove: false,\n                        \".($options['jsonurl'] ? \"uploadUrl : '\".$options['jsonurl'].\"',\" : '').\"\n                        dropZoneEnabled: \".($options['dropzone'] ? \"true\" : \"false\").\",\n                        \".($options['hide_upload'] ? 'showUpload: false,' : '').\"\n                        \".($options['hide_remove'] ? 'showRemove: false,' : '').\"\n                        $extra_data_js\n                        layoutTemplates: {\n                            main2: '<div class=\\\"btn-photo-upload btn-link\\\">'+' {browse}'+' </div></span></div> {preview}',\n                        },\n                        \".$lang.\"\n                    });\n                \");\n                break;\n            case \"thumbnail\":\n                add_to_jquery(\"\n                    $('#\".$options['input_id'].\"').fileinput({\n                        allowedFileTypes: \".$type_for_js.\",\n                        allowedPreviewTypes : \".$type_for_js.\",\n                        \".($value ? \"initialPreview: \".$value.\", \" : '').\"\n                        \".($options['preview_off'] ? \"showPreview: false, \" : '').\"\n                        initialPreviewAsData: true,\n                        defaultPreviewContent: '<img class=\\\"img-responsive\\\" src=\\\"\".IMAGES.\"no_photo.png\\\" alt=\\\"\".$browseLabel.\"\\\" style=\\\"width:100%;\\\">',\n                        browseClass: 'btn btn-block btn-default',\n                        uploadClass: 'btn btn-modal',\n                        captionClass : '',\n                        maxFileCount: '\".$options['max_count'].\"',\n                        removeClass : 'btn button',\n                        browseLabel: '\".$browseLabel.\"',\n                        browseIcon: '<i class=\\\"\".$options['icon'].\"\\\"></i>',\n                        showCaption: false,\n                        showRemove: false,\n                        \".($options['jsonurl'] ? \"uploadUrl : '\".$options['jsonurl'].\"',\" : '').\"\n                        \".($options['hide_upload'] ? 'showUpload: false,' : '').\"\n                        \".($options['hide_remove'] ? 'showRemove: false,' : '').\"\n                        dropZoneEnabled: \".($options['dropzone'] ? \"true\" : \"false\").\",\n                        $extra_data_js\n                        layoutTemplates: {\n                            main2: '<div class=\\\"panel panel-default\\\">' + '{preview}' + '<div class=\\\"panel-body\\\">' + ' {browse}' + '</div></div>',\n                        },\n                        \".$lang.\"\n                    });\n                \");\n                break;\n        }\n\n        if (!defined('form_fileinput')) {\n            add_to_head(\"<link href='\".DYNAMICS.\"assets/fileinput/css/fileinput.min.css' media='all' rel='stylesheet' type='text/css' />\");\n            if ($locale['text-direction'] == 'rtl') {\n                add_to_head(\"<link href='\".DYNAMICS.\"assets/fileinput/css/fileinput-rtl.min.css' media='all' rel='stylesheet' type='text/css' />\");\n            }\n            add_to_footer(\"<script src='\".DYNAMICS.\"assets/fileinput/js/fileinput.min.js' type='text/javascript'></script>\");\n\n            if (file_exists(DYNAMICS.'assets/fileinput/js/locales/'.$locale['short_lang_name'].'.js')) {\n                add_to_footer(\"<script src='\".DYNAMICS.\"assets/fileinput/js/locales/\".$locale['short_lang_name'].\".js' type='text/javascript'></script>\");\n                //$lang = 'language: \"'.$locale['short_lang_name'].'\",';\n            }\n            define('form_fileinput', TRUE);\n        }\n\n    }\n\n    return (string)$html;\n}\n", "<?php\n/*-------------------------------------------------------+\n| PHPFusion Content Management System\n| Copyright (C) PHP Fusion Inc\n| https://phpfusion.com/\n+--------------------------------------------------------+\n| Project File: Form API - Geo Input Based\n| Filename: form_geomap.php\n| Author: Frederick MC Chan (Chan)\n| Co-Author: Joakim Falk (Falk)\n+--------------------------------------------------------+\n| This program is released as free software under the\n| Affero GPL license. You can redistribute it and/or\n| modify it under the terms of this license which you\n| can read by viewing the included agpl.txt or online\n| at www.gnu.org/licenses/agpl.html. Removal of this\n| copyright header is strictly prohibited without\n| written permission from the original author(s).\n+--------------------------------------------------------*/\n\n/**\n * @param        $input_name\n * @param string $label\n * @param string $input_value\n * @param array  $options\n *\n * @return string\n */\nfunction form_geo($input_name, $label = \"\", $input_value = \"\", array $options = []) {\n\n    $locale = fusion_get_locale();\n\n    $input_value = clean_input_value($input_value);\n\n    $title = (isset($title) && (!empty($title))) ? $title : ucfirst(strtolower(str_replace(\"_\", \" \", $input_name)));\n    $countries = [];\n    require(INCLUDES.'geomap/geomap.inc.php');\n\n    $id = trim($input_name, \"[]\");\n\n    // NOTE (remember to parse readback value as of '|' seperator)\n    if (isset($input_value) && (!empty($input_value))) {\n        if (!is_array($input_value)) {\n            $input_value = explode('|', $input_value);\n        }\n    } else {\n        $input_value = [];\n        $input_value[0] = \"\";\n        $input_value[1] = \"\";\n        $input_value[2] = \"\";\n        $input_value[3] = \"\";\n        $input_value[4] = \"\";\n        $input_value[5] = \"\";\n    }\n\n    $default_options = [\n        'input_id'     => $id,\n        'required'     => FALSE,\n        'placeholder'  => '',\n        'deactivate'   => FALSE,\n        'width'        => '100%',\n        'class'        => '',\n        'inline'       => FALSE,\n        'tip'          => '',\n        'error_text'   => !empty($options['error_text']) ? $options['error_text'] : $locale['street_error'],\n        'error_text_2' => !empty($options['error_text_2']) ? $options['error_text_2'] : $locale['street_error'],\n        'error_text_3' => !empty($options['error_text_3']) ? $options['error_text_3'] : $locale['country_error'],\n        'error_text_4' => !empty($options['error_text_4']) ? $options['error_text_4'] : $locale['state_error'],\n        'error_text_5' => !empty($options['error_text_5']) ? $options['error_text_5'] : $locale['city_error'],\n        'error_text_6' => !empty($options['error_text_6']) ? $options['error_text_6'] : $locale['postcode_error'],\n        'safemode'     => FALSE,\n        'flag'         => '',\n        'stacked'      => '',\n    ];\n\n    $options += $default_options;\n\n    $input_id = $options['input_id'];\n\n    $validation_key = [\n        0 => 'street-1',\n        1 => 'street-2',\n        2 => 'country',\n        3 => 'region',\n        4 => 'city',\n        5 => 'postcode',\n    ];\n\n    $error_key = [\n        0 => $options['error_text'],\n        1 => $options['error_text_2'],\n        2 => $options['error_text_3'],\n        3 => $options['error_text_4'],\n        4 => $options['error_text_5'],\n        5 => $options['error_text_6'],\n    ];\n\n    $error_class = \"\";\n    for ($i = 0; $i <= 5; $i++) {\n        if (\\defender::inputHasError($input_name.'-'.$validation_key[$i])) {\n            $error_class = \"has-error \";\n            addNotice(\"danger\", \"<strong>$title</strong> - \".$error_key[$i]);\n        }\n    }\n\n    $html = \"<div id='$input_id-field' class='form-group \".($options['inline'] && $label ? 'row ' : '').$error_class.$options['class'].\"' >\";\n\n    $html .= ($label) ? \"<label class='control-label\".($options['inline'] ? \" col-xs-12 col-sm-3 col-md-3 col-lg-3\" : '').\"' for='$input_id'>\".$label.($options['required'] ? \"<span class='required'>&nbsp;*</span>\" : '').\"\n    \".($options['tip'] ? \"<i class='pointer fa fa-question-circle' title='\".$options['tip'].\"'></i>\" : '').\"\n    </label>\" : '';\n\n    $html .= $options['inline'] && $label ? \"<div class='col-xs-12 col-sm-9 col-md-9 col-lg-9'>\" : '';\n\n    $html .= \"<div class='row'>\";\n\n    $html .= \"<div class='col-xs-12 col-sm-12 col-md-12 col-lg-12 m-b-10'>\";\n\n    $html .= \"<input type='text' name='\".$input_name.\"[]' class='form-control' id='\".$input_id.\"-street' value='\".$input_value['0'].\"' placeholder='\".$locale['street1'].($options['required'] ? \"*\" : '').\"'\".($options['deactivate'] ? \" readonly\" : '').\" />\";\n\n    $html .= (($options['required'] == 1 && \\defender::inputHasError($input_name.'-'.$validation_key[0])) || \\defender::inputHasError($input_name.'-'.$validation_key[0])) ? \"<div id='\".$options['input_id'].\"-street-help' class='label label-danger p-5 display-inline-block'>\".$options['error_text'].\"</div>\" : \"\";\n\n    $html .= \"</div>\";\n\n    $html .= \"<div class='col-xs-12 col-sm-12 col-md-12 col-lg-12 m-b-10'>\";\n    // Street 2 is not needed even on required.\n    $html .= \"<input type='text' name='\".$input_name.\"[]' class='form-control' id='\".$input_id.\"-street2' value='\".$input_value['1'].\"' placeholder='\".$locale['street2'].\"'\".($options['deactivate'] ? \" readonly\" : '').\" />\";\n\n    $html .= \"</div>\";\n\n    $html .= \"<div class='col-xs-12 col-sm-5 col-md-5 col-lg-5 m-b-10'>\";\n\n    $html .= \"<select name='\".$input_name.\"[]' id='$input_id-country' style='width:100%;'>\";\n\n    $html .= \"<option value=''></option>\";\n    foreach ($countries as $arv => $countryname) { // outputs: key, value, class - in order\n        $country_key = str_replace(\" \", \"-\", $countryname);\n        $select = ($input_value[2] == $country_key) ? \"selected\" : '';\n        $html .= \"<option value='$country_key' \".$select.\">\".translate_country_names($countryname).\"</option>\";\n    }\n\n    $html .= \"</select>\";\n\n    $html .= (($options['required'] == 1 && \\defender::inputHasError($input_name.'-'.$validation_key[2])) || \\defender::inputHasError($input_name.'-'.$validation_key[2])) ? \"<div id='\".$options['input_id'].\"-country-help' class='label label-danger p-5 display-inline-block'>\".$options['error_text_3'].\"</div>\" : \"\";\n\n    $html .= \"</div>\";\n\n    $html .= \"<div class='col-xs-12 col-sm-7 col-md-7 col-lg-7 m-b-10'>\";\n\n    $html .= \"<div id='state-spinner' style='display:none;'><img src='\".fusion_get_settings('siteurl').\"images/loader.svg'></div>\";\n\n    $html .= \"<input type='hidden' name='\".$input_name.\"[]' id='$input_id-state' value='\".$input_value['3'].\"' style='width:100%;' />\";\n\n    $html .= (($options['required'] == 1 && \\defender::inputHasError($input_name.'-'.$validation_key[3])) || \\defender::inputHasError($input_name.'-'.$validation_key[3])) ? \"<div id='\".$options['input_id'].\"-state-help' class='label label-danger p-5 display-inline-block'>\".$options['error_text_4'].\"</div>\" : \"\";\n\n    $html .= \"</div>\";\n\n    $html .= \"<div class='col-xs-12 col-sm-5 col-md-5 col-lg-5 m-b-10'>\";\n\n    $html .= \"<input type='text' name='\".$input_name.\"[]' id='\".$input_id.\"-city' class='form-control textbox' value='\".$input_value['4'].\"' placeholder='\".$locale['city'].($options['required'] ? \"*\" : '').\"'\".($options['deactivate'] ? \" readonly\" : '').\" />\";\n\n    $html .= (($options['required'] == 1 && \\defender::inputHasError($input_name)) || \\defender::inputHasError($input_name)) ? \"<div id='\".$options['input_id'].\"-city-help' class='label label-danger p-5 display-inline-block'>\".$options['error_text_5'].\"</div>\" : \"\";\n\n    $html .= \"</div>\";\n\n    $html .= \"<div class='col-xs-12 col-sm-7 col-md-4 col-lg-7 m-b-10'>\";\n\n    $html .= \"<input type='text' name='\".$input_name.\"[]'  id='\".$input_id.\"-postcode' class='form-control textbox' value='\".$input_value['5'].\"' placeholder='\".$locale['postcode'].($options['required'] ? \"*\" : '').\"'\".($options['deactivate'] ? \" readonly\" : '').\" />\";\n\n    $html .= (($options['required'] == 1 && \\defender::inputHasError($input_name.'-'.$validation_key[5])) || \\defender::inputHasError($input_name.'-'.$validation_key[5])) ? \"<div id='\".$options['input_id'].\"-postcode-help' class='label label-danger p-5 display-inline-block'>\".$options['error_text_6'].\"</div>\" : \"\";\n\n    $html .= \"</div>\";\n\n    $html .= \"</div>\"; // close inner row\n\n    $html .= $options['stacked'];\n\n    $html .= $options['inline'] && $label ? \"</div>\" : \"\";\n\n    $html .= \"</div>\";\n\n    \\defender::getInstance()->add_field_session([\n        'input_name'   => $input_name,\n        'type'         => 'address',\n        'title'        => $title,\n        'id'           => $input_id,\n        'required'     => $options['required'],\n        'safemode'     => $options['safemode'],\n        'error_text'   => $options['error_text'],\n        'error_text_2' => $options['error_text_2'],\n        'error_text_3' => $options['error_text_3'],\n        'error_text_4' => $options['error_text_4'],\n        'error_text_5' => $options['error_text_5'],\n        'error_text_6' => $options['error_text_6']\n    ]);\n\n    $flag_function = '';\n    $flag_plugin = '';\n    if ($options['flag']) {\n        $flag_function = \"\n        function show_flag(item) {\n        if(!item.id) {return item.text;}\n        var icon = '\".IMAGES.\"small_flag/flag_'+ item.id.replace(/-/gi,'_').toLowerCase() +'.png';\n        return '<img style=\\\"float:left; margin-right:5px; margin-top:3px;\\\" src=\\\"' + icon + '\\\"/></i>' + item.text;\n        }\";\n        $flag_plugin = \"\n         formatResult: show_flag,\n         formatSelection: show_flag,\n         escapeMarkup: function(m) { return m; },\n        \";\n    }\n\n    $states_array[] = [\"id\" => \"Other\", \"text\" => fusion_get_locale('other_states')];\n    $states_array = json_encode($states_array);\n\n    add_to_jquery(\"\n    \".$flag_function.\"\n    $('#$input_id-country').select2({\n    $flag_plugin\n    placeholder: '\".$locale['sel_country'].\" \".($options['required'] == 1 ? '*' : '').\"'\n    });\n\n    $('#\".$input_id.\"-state').select2({\n            placeholder: '\".$locale['sel_state'].\" \".($options['required'] == 1 ? '*' : '').\"',\n            allowClear: true,\n            data: $states_array\n    });\n\n    $('#\".$input_id.\"-country').bind('change', function(){\n        var ce_id = $(this).val();\n        $.ajax({\n        url: '\".fusion_get_settings('site_path').\"includes/geomap/form_geomap.json.php',\n        type: 'GET',\n        data: { id : ce_id },\n        dataType: 'json',\n        beforeSend: function(e) {\n            //$('#state-spinner').show();\n            $('#\".$input_id.\"-state').hide();\n        },\n        success: function(data) {\n            console.log(data);\n            //$('#state-spinner').hide();\n            $('#\".$input_id.\"-state').select2({\n                placeholder: '\".$locale['sel_state'].\" \".($options['required'] == 1 ? '*' : '').\"',\n                allowClear: true,\n                data : data\n            });\n        },\n        error : function() {\n            console.log('Error Fetching');\n        }\n        })\n    }).trigger('change');\n    \");\n\n    load_select2_script();\n\n    return $html;\n}\n\nfunction form_location($input_name, $label = '', $input_value = FALSE, array $options = []) {\n    $locale = fusion_get_locale();\n    $title = $label ? stripinput($label) : ucfirst(strtolower(str_replace(\"_\", \" \", $input_name)));\n\n    if (!defined('PLOCATION')) {\n        define('PLOCATION', TRUE);\n        add_to_jquery(\"\n        function plocation(item) {\n            if(!item.id) {return item.text;}\n            var flag = item.flag;\n            var region = item.region;\n            return '<table><tr><td style=\\\"\\\"><img style=\\\"height:16px;\\\" src=\\\"\".IMAGES.\"/' + flag + '\\\"/></td><td style=\\\"padding-left:10px\\\"><div>' + item.text + '</div></div></td></tr></table>';\n        }\n        \");\n    }\n\n    $input_name = (isset($input_name) && (!empty($input_name))) ? stripinput($input_name) : \"\";\n\n    $default_options = [\n        'options'        => [],\n        'required'       => FALSE,\n        'regex'          => '',\n        'input_id'       => $input_name,\n        'placeholder'    => $locale['choose-location'],\n        'deactivate'     => FALSE,\n        'safemode'       => FALSE,\n        'allowclear'     => FALSE,\n        'flag'           => FALSE,\n        'multiple'       => FALSE,\n        'width'          => '250px',\n        'keyflip'        => FALSE,\n        'tags'           => FALSE,\n        'jsonmode'       => FALSE,\n        'chainable'      => FALSE,\n        'max_select'     => 1,\n        'error_text'     => $locale['error_input_default'],\n        'class'          => '',\n        'inline'         => FALSE,\n        'tip'            => '',\n        'ext_tip'        => '',\n        'delimiter'      => ',',\n        'callback_check' => '',\n        \"stacked\"        => \"\",\n        'icon'           => '',\n        'file'           => '',\n    ];\n\n    $options += $default_options;\n\n    $countries = [];\n    if ($options['multiple'] == FALSE) {\n        require(INCLUDES.'geomap/geomap.inc.php');\n    }\n\n    // always trim id\n    $options['input_id'] = trim($options['input_id'], \"[]\");\n\n    $length = \"minimumInputLength: 1,\";\n\n    $error_class = \"\";\n    if (\\defender::inputHasError($input_name)) {\n        $error_class = \"has-error \";\n        if (!empty($options['error_text'])) {\n            $new_error_text = \\defender::getErrorText($input_name);\n            if (!empty($new_error_text)) {\n                $options['error_text'] = $new_error_text;\n            }\n            addNotice(\"danger\", \"<strong>$title</strong> - \".$options['error_text']);\n        }\n    }\n\n    $html = \"<div id='\".$options['input_id'].\"-field' class='form-group \".($options['inline'] ? 'row ' : '').$error_class.$options['class'].\" \".($options['icon'] ? 'has-feedback' : '').\"'  \".($options['width'] && !$label ? \"style='width: \".$options['width'].\"'\" : '').\">\";\n\n    $html .= ($label) ? \"<label class='control-label \".($options['inline'] ? \"col-xs-12 col-sm-3 col-md-3 col-lg-3\" : 'col-xs-12 col-sm-12 col-md-12 col-lg-12 p-l-0').\"' for='\".$options['input_id'].\"'>$label \".($options['required'] == TRUE ? \"<span class='required'>*</span>\" : '').\"\n    \".($options['tip'] ? \"<i class='pointer fa fa-question-circle' title='\".$options['tip'].\"'></i>\" : '').\"\n    </label>\" : '';\n\n    $html .= ($options['inline'] && $label) ? \"<div class='col-xs-12 \".($label ? \"col-sm-9 col-md-9 col-lg-9\" : \"col-sm-12\").\"'>\" : \"\";\n\n    if ($options['multiple'] == TRUE) {\n\n        $html .= \"<input \".($options['required'] ? \"class='req'\" : '').\" type='hidden' name='$input_name' id='\".$options['input_id'].\"' data-placeholder='\".$options['placeholder'].\"' style='width: \".($options['width'] ? $options['width'] : $default_options['width']).\"' \".($options['deactivate'] ? 'disabled' : '').\" />\";\n\n        $path = $options['file'] ? $options['file'] : DYNAMICS.\"assets/location/location.json.php\";\n        if (!empty($input_value)) {\n            // json mode.\n            $encoded = $options['file'] ? $options['file'] : location_search($input_value);\n        } else {\n            $encoded = json_encode([]);\n        }\n        add_to_jquery(\"\n        $('#\".$options['input_id'].\"').select2({\n        $length\n        multiple: \".($options['multiple'] ? \"true\" : \"false\").\",\n        maximumSelectionSize: \".$options['max_select'].\",\n        ajax: {\n        url: '$path',\n        dataType: 'json',\n        data: function (term, page) {\n                return {q: term};\n              },\n              results: function (data, page) {\n                return {results: data};\n              }\n        },\n        formatSelection: plocation,\n        escapeMarkup: function(m) { return m; },\n        formatResult: plocation,\n        \".$options['allowclear'].\"\n        })\".(!empty($encoded) ? \".select2('data', $encoded );\" : '').\"\n    \");\n\n    } else {\n\n        $html .= \"<select name='\".$input_name.\"' id='\".$options['input_id'].\"' style='width:\".($options['width'] ? $options['width'] : $default_options['width']).\"' />\";\n        $html .= \"<option value=''></option>\";\n        foreach ($countries as $arv => $countryname) { // outputs: key, value, class - in order\n            $country_key = str_replace(\" \", \"-\", $countryname);\n            $select = ($input_value == $country_key) ? \"selected\" : '';\n            $html .= \"<option value='$country_key' \".$select.\">\".translate_country_names($countryname).\"</option>\";\n        }\n        $html .= \"</select>\";\n\n        $flag_function = '';\n        $flag_plugin = '';\n        if ($options['flag']) {\n            $flag_function = \"\n            function show_flag(item) {\n                if(!item.id) {return item.text;}\n                var icon = '\".IMAGES.\"small_flag/flag_'+ item.id.replace(/-/gi,'_').toLowerCase() +'.png';\n                return '<img style=\\\"float:left; margin-right:5px; margin-top:3px;\\\" src=\\\"' + icon + '\\\"/></i>' + item.text;\n            }\n            \";\n            $flag_plugin = \"\n            formatResult: show_flag,\n            formatSelection: show_flag,\n            escapeMarkup: function(m) { return m; },\n            \";\n        }\n\n        add_to_jquery(\"\n        \".$flag_function.\"\n        $('#\".$options['input_id'].\"').select2({\n            $flag_plugin\n            placeholder: '\".$locale['sel_country'].\" \".($options['required'] == 1 ? '*' : '').\"'\n        });\n        \");\n\n    }\n\n    $html .= $options['stacked'];\n    $html .= $options['ext_tip'] ? \"<br/><span class='tip'><i>\".$options['ext_tip'].\"</i></span>\" : \"\";\n    if ($options['deactivate']) {\n        $html .= form_hidden($input_name, \"\", $input_value, [\"input_id\" => $options['input_id']]);\n    }\n\n    $html .= \\defender::inputHasError($input_name) ? \"<div class='input-error\".((!$options['inline']) ? \" display-block\" : \"\").\"'><div id='\".$options['input_id'].\"-help' class='label label-danger p-5 display-inline-block'>\".$options['error_text'].\"</div></div>\" : '';\n\n    $html .= ($options['inline'] && $label) ? \"</div>\" : \"\";\n\n    $html .= \"</div>\";\n\n    \\defender::add_field_session([\n        'input_name'     => clean_input_name($input_name),\n        'type'           => 'textbox',\n        'title'          => trim($title, '[]'),\n        'id'             => $options['input_id'],\n        'regex'          => $options['regex'],\n        'callback_check' => $options['callback_check'],\n        'required'       => $options['required'],\n        'safemode'       => $options['safemode'],\n        'error_text'     => $options['error_text']\n    ]);\n\n    load_select2_script();\n\n    return $html;\n}\n\nfunction map_country($states, $country) {\n    $states_list = [];\n    $flag = \"small_flag/flag_\".str_replace('-', '_', strtolower($country)).\".png\";\n    foreach ($states[$country] as $states_name) {\n        $states_list[] = [\n            'id' => \"$states_name\", 'text' => \"$states_name, $country\", 'flag' => \"$flag\", \"region\" => \"$country\"\n        ];\n    }\n\n    return $states_list;\n}\n\nfunction map_region($states) {\n    $states_list = [];\n    foreach ($states as $country_name => $country_states) {\n        $flag = \"small_flag/flag_\".str_replace('-', '_', strtolower($country_name)).\".png\";\n        foreach ($country_states as $states_name) { // add [] to prevent duplicate since Sabah exist in Yemen and Malaysia.\n            $states_list[$states_name][] = [\n                'id'     => \"$states_name\", 'text' => \"$states_name, $country_name\", 'flag' => \"$flag\",\n                \"region\" => \"$country_name\"\n            ];\n        }\n    }\n\n    return $states_list;\n}\n\n/* Returns Json Encoded Object used in form_select_user */\nfunction location_search($q) {\n    $states = [];\n    include INCLUDES.\"geomap/geomap.inc.php\";\n    // since search is on user_name.\n    $found = 0;\n    foreach (array_keys($states) as $k) { // type the country then output full states\n        if (preg_match('/^'.$q.'/', $k, $matches)) {\n            header('Content-Type: application/json');\n            $states_list = map_country($states, $k);\n            return json_encode($states_list);\n        }\n    }\n    if (!$found) { // a longer version\n        $region_list = map_region($states);\n        if (array_key_exists($q, $region_list)) {\n            header('Content-Type: application/json');\n            return json_encode($region_list[$q]);\n        }\n    }\n\n    return FALSE;\n}\n", "<?php\n/*-------------------------------------------------------+\n| PHPFusion Content Management System\n| Copyright (C) PHP Fusion Inc\n| https://phpfusion.com/\n+--------------------------------------------------------+\n| Filename: form_hidden.php\n| Author: Frederick MC Chan (Chan)\n+--------------------------------------------------------+\n| This program is released as free software under the\n| Affero GPL license. You can redistribute it and/or\n| modify it under the terms of this license which you\n| can read by viewing the included agpl.txt or online\n| at www.gnu.org/licenses/agpl.html. Removal of this\n| copyright header is strictly prohibited without\n| written permission from the original author(s).\n+--------------------------------------------------------*/\n/**\n * @param        $input_name\n * @param string $label\n * @param string $input_value\n * @param array  $options\n *\n * @return string\n */\nfunction form_hidden($input_name, $label = \"\", $input_value = \"\", array $options = []) {\n\n    $title = $label ? stripinput($label) : ucfirst(strtolower(str_replace(\"_\", \" \", $input_name)));\n\n    $input_value = clean_input_value($input_value);\n\n    $html = '';\n    $default_options = [\n        'input_id'    => $input_name,\n        'show_title'  => FALSE,\n        'width'       => '100%',\n        'class'       => '',\n        'inline'      => FALSE,\n        'required'    => FALSE,\n        'placeholder' => '',\n        'deactivate'  => FALSE,\n        'delimiter'   => ',',\n        'error_text'  => '',\n    ];\n    $options += $default_options;\n\n    if ($options['show_title']) {\n        $html .= \"<div id='\".$options['input_id'].\"-field' class='form-group \".($options['inline'] ? 'display-block overflow-hide ' : '').$options['class'].\" '>\\n\";\n        $html .= ($label) ? \"<label class='control-label\".($options['inline'] ? \" col-xs-12 col-sm-3 col-md-3 col-lg-3\" : '').\"' for='\".$options['input_id'].\"'>\".$title.($options['required'] ? \"<span class='required'>&nbsp;*</span>\" : '').\"</label>\\n\" : '';\n        $html .= $options['inline'] ? \"<div class='col-xs-12 col-sm-9 col-md-9 col-lg-9'>\\n\" : '';\n    }\n    $html .= \"<input type='hidden' name='$input_name' id='\".$options['input_id'].\"' value='$input_value'\".($options['width'] ? \" style='width:\".$options['width'].\"'\" : '').($options['show_title'] ? \"\" : \" readonly\").\" />\\n\";\n    if ($options['show_title']) {\n        $html .= \"<div id='\".$options['input_id'].\"-help'></div>\";\n        $html .= ($options['inline']) ? \"</div>\\n\" : \"\";\n        $html .= \"</div>\\n\";\n    }\n\n    \\defender::add_field_session([\n        'input_name' => clean_input_name($input_name),\n        'title'      => trim($title, '[]'),\n        'type'       => 'textbox',\n        'id'         => $options['input_id'],\n        'required'   => $options['required'],\n        'safemode'   => '0',\n        \"delimiter\"  => $options['delimiter'],\n        'error_text' => $options['error_text']\n    ]);\n\n    return $html;\n}\n", "<?php\n/*-------------------------------------------------------+\n| PHPFusion Content Management System\n| Copyright (C) PHP Fusion Inc\n| https://phpfusion.com/\n+--------------------------------------------------------+\n| Filename: form_main.php\n| Author: Frederick MC Chan (Chan)\n+--------------------------------------------------------+\n| This program is released as free software under the\n| Affero GPL license. You can redistribute it and/or\n| modify it under the terms of this license which you\n| can read by viewing the included agpl.txt or online\n| at www.gnu.org/licenses/agpl.html. Removal of this\n| copyright header is strictly prohibited without\n| written permission from the original author(s).\n+--------------------------------------------------------*/\n/**\n * @param string $form_name\n * @param string $method     - 'post' or 'get'\n * @param string $action_url - form current uri (defaults: FORM_REQUEST)\n * @param array  $options    :\n *                           form_id = default as form_name\n *                           class = default empty\n *                           enctype = true or false , set true to allow file upload\n *                           max_tokens = store into session number of tokens , default as 1.\n *\n * @return string\n */\nfunction openform($form_name, $method, $action_url = FORM_REQUEST, array $options = []) {\n\n    $method = (strtolower($method) == 'post') ? 'post' : 'get';\n\n    $default_options = [\n        'form_id'    => $form_name,\n        'class'      => '',\n        'enctype'    => FALSE,\n        'max_tokens' => fusion_get_settings('form_tokens'),\n        'inline'     => FALSE,\n        'on_submit'  => '',\n        'honeypot'   => TRUE,\n    ];\n\n    $options += $default_options;\n\n    if (!$action_url) {\n        $action_url = FORM_REQUEST;\n    }\n\n    $class = $options['class'];\n\n    if (!fusion_safe()) {\n        $class .= \" warning\";\n    }\n\n    $html = \"<form name='\".$form_name.\"' id='\".$options['form_id'].\"' method='\".$method.\"' action='\".$action_url.\"' class='\".($options['inline'] ? \"form-inline \" : '').($class ? $class : 'm-0').\"'\".($options['enctype'] ? \" enctype='multipart/form-data'\" : '').($options['on_submit'] ? \" onSubmit='\".$options['on_submit'].\"'\" : '').\">\\n\";\n\n    if ($method == 'post') {\n        $token = fusion_get_token($options['form_id'], $options['max_tokens']);\n        $html .= \"<input type='hidden' name='fusion_token' value='\".$token.\"' />\\n\";\n        $html .= \"<input type='hidden' name='form_id' value='\".$options['form_id'].\"' />\\n\";\n        if ($options['honeypot']) {\n            $input_name = 'fusion_'.random_string();\n            $html .= \"<input type='hidden' name='$input_name' value=''>\\n\";\n            Defender::getInstance()->addHoneypot([\n                'honeypot'   => $options['form_id'].'_honeypot',\n                'input_name' => $input_name,\n                'form_name'  => $form_name,\n                'type'       => 'honeypot',\n            ]);\n        }\n    }\n\n    return (string)$html;\n}\n\n/**\n * @return string\n */\nfunction closeform() {\n    return (string)\"</form>\\n\";\n}\n\nfunction clean_input_name($value) {\n    $re = '/\\[(.*?)\\]/m';\n    return preg_replace($re, '', $value);\n}\n\nfunction clean_input_value($value) {\n    if (is_string($value)) {\n        return descript($value);\n    }\n    if (is_array($value)) {\n        return array_map('descript', $value);\n    }\n    return '';\n}\n\n\nfunction load_select2_script() {\n    static $loaded = FALSE;\n    if ($loaded === FALSE) {\n        /**\n         * @return string\n         * @see load_select2_script()\n         */\n        function select2csspath() {\n            return DYNAMICS.\"assets/select2/select2.css\";\n        }\n\n        $select2_locale_path = DYNAMICS.\"assets/select2/select2_locale_\".fusion_get_locale('select2').\".js\";\n        fusion_load_script(DYNAMICS.\"assets/select2/select2.js\");\n\n        if (is_file($select2_locale_path)) {\n            fusion_load_script($select2_locale_path);\n        }\n\n        /**\n         * @uses  select2csspath()\n         */\n        fusion_add_hook(\"fusion_core_styles\", \"select2csspath\");\n\n        $loaded = TRUE;\n    }\n}\n", "<?php\n/*-------------------------------------------------------+\n| PHPFusion Content Management System\n| Copyright (C) PHP Fusion Inc\n| https://phpfusion.com/\n+--------------------------------------------------------+\n| Filename: form_name.php\n| Author: Frederick MC CHan (Chan)\n+--------------------------------------------------------+\n| This program is released as free software under the\n| Affero GPL license. You can redistribute it and/or\n| modify it under the terms of this license which you\n| can read by viewing the included agpl.txt or online\n| at www.gnu.org/licenses/agpl.html. Removal of this\n| copyright header is strictly prohibited without\n| written permission from the original author(s).\n+--------------------------------------------------------*/\n\nfunction form_name($input_name, $label = \"\", $input_value = FALSE, array $options = []) {\n\n    $locale = fusion_get_locale();\n\n    $title = (isset($label) && (!empty($label))) ? $label : ucfirst(strtolower(str_replace(\"_\", \" \", $input_name)));\n\n    // NOTE (remember to parse readback value as of '|' seperator)\n    if (!empty($input_value)) {\n        if (!is_array($input_value)) {\n            $input_value = explode('|', $input_value);\n        }\n    } else {\n        $input_value['0'] = '';\n        $input_value['1'] = '';\n        $input_value['2'] = '';\n    }\n\n    $input_value = clean_input_value($input_value);\n\n    $options += [\n        'input_id'     => $input_name,\n        'required'     => FALSE,\n        'placeholder'  => '',\n        'deactivate'   => FALSE,\n        'width'        => '100%',\n        'class'        => '',\n        'inline'       => FALSE,\n        'error_text'   => !empty($options['error_text']) ? $options['error_text'] : $locale['firstname_error'],\n        'error_text_2' => !empty($options['error_text']) ? $options['error_text_2'] : $locale['lastname_error'],\n        'tip'          => '',\n        'safemode'     => FALSE,\n        'stacked'      => '',\n    ];\n\n    $error_class = \\defender::inputHasError($input_name.'-firstname') || \\defender::inputHasError($input_name.'-lastname') ? \"has-error \" : \"\";\n    $html = \"<div id='\".$options['input_id'].\"-field' class='form-group \".($options['inline'] && $label ? 'row ' : '').$error_class.$options['class'].\"' >\\n\";\n\n    if ($label) {\n        $html .= \"<label class='control-label \".($options['inline'] ? \"col-xs-12 col-sm-3 col-md-3 col-lg-3\" : '').\"' for='\".$options['input_id'].\"'> \".$label.($options['required'] ? \"<span class='required'>&nbsp;*</span>\" : '').\"\n\t    \".($options['tip'] ? \"<i class='pointer fa fa-question-circle' title='\".$options['tip'].\"'></i>\" : '').\"\n\t    </label>\\n\";\n    }\n\n    $html .= $options['inline'] && $label ? \"<div class='col-xs-12 col-sm-9 col-md-9 col-lg-9'>\\n\" : \"\";\n\n    $html .= \"<div class='row p-l-15'>\\n\";\n\n    $html .= \"<div class='col-xs-12 col-sm-4 col-md-4 col-lg-4 m-b-10 p-l-0'>\\n\";\n\n    $html .= \"<input type='text' name='\".$input_name.\"[]' class='form-control textbox' id='\".$options['input_id'].\"-firstname' value='\".$input_value['0'].\"' placeholder='\".$locale['first_name'].\" \".($options['required'] ? '*' : '').\"' \".($options['deactivate'] == \"1\" ? \"readonly\" : '').\" />\\n\";\n\n    $html .= ($options['required'] == 1 && \\defender::inputHasError($input_name[0])) || \\defender::inputHasError($input_name[0]) ? \"<div id='\".$options['input_id'].\"-firstname-help' class='label label-danger p-5 display-inline-block'>\".$options['error_text'].\"</div>\" : \"\";\n\n    $html .= \"</div>\\n\";\n\n    $html .= \"<div class='col-xs-12 col-sm-4 col-md-4 col-lg-4 m-b-10'>\\n\";\n    $html .= \"<input type='text' name='\".$input_name.\"[]' class='form-control textbox' id='\".$options['input_id'].\"-lastname' value='\".$input_value['1'].\"' placeholder='\".$locale['last_name'].\" \".($options['required'] ? '*' : '').\"' \".($options['deactivate'] == \"1\" ? \"readonly\" : '').\" />\\n\";\n    $html .= ($options['required'] == 1 && \\defender::inputHasError($input_name[1])) || \\defender::inputHasError($input_name[1]) ? \"<div id='\".$options['input_id'].\"-lastname-help' class='label label-danger p-5 display-inline-block'>\".$options['error_text_2'].\"</div>\" : \"\";\n    $html .= \"</div>\\n\";\n\n    $html .= $options['stacked'];\n\n    $html .= \"</div>\\n\"; // close inner row\n\n    $html .= $options['inline'] && $label ? \"</div>\\n\" : \"\";\n\n    $html .= \"</div>\\n\";\n\n    \\defender::getInstance()->add_field_session([\n        'input_name'   => $input_name,\n        'type'         => 'name',\n        'title'        => $title,\n        'id'           => $options['input_id'],\n        'required'     => $options['required'],\n        'safemode'     => $options['safemode'],\n        'error_text'   => $options['error_text'],\n        'error_text_2' => $options['error_text_2']\n    ]);\n\n    return $html;\n}\n", "<?php\n/*-------------------------------------------------------+\n| PHPFusion Content Management System\n| Copyright (C) PHP Fusion Inc\n| https://phpfusion.com/\n+--------------------------------------------------------+\n| Filename: form_ordering.php\n| Author: Core Development Team (coredevs@phpfusion.com)\n+--------------------------------------------------------+\n| This program is released as free software under the\n| Affero GPL license. You can redistribute it and/or\n| modify it under the terms of this license which you\n| can read by viewing the included agpl.txt or online\n| at www.gnu.org/licenses/agpl.html. Removal of this\n| copyright header is strictly prohibited without\n| written permission from the original author(s).\n+--------------------------------------------------------*/\n\nfunction make_order_opts($result, $id_col, $cat_col, $title_col, $order_col) {\n    $master_sort = sorter($result, $order_col);\n    $option = [];\n    foreach ($master_sort as $data) {\n        $title = $data[$title_col];\n        $order = $data[$order_col];\n        $cat = $data[$cat_col];\n        $id = $data[$id_col];\n        $option[] = [\"id\" => \"$id\", \"title\" => \"\".$order.\". \".$title.\"\", \"order\" => \"$order\", \"cat\" => \"$cat\"];\n        if (array_key_exists(\"children\", $data)) {\n            $option = array_merge($option,\n                make_order_opts($data['children'], $id_col, $cat_col, $title_col, $order_col));\n        }\n    }\n\n    return $option;\n}\n\nfunction form_select_order($title, $input_name, $input_id, $option_array, $input_value, $chain_to_parent_id, $array = FALSE) {\n\n    if (isset($title) && ($title !== \"\")) {\n        $title = stripinput($title);\n    } else {\n        $title = \"\";\n    }\n    if (isset($input_name) && ($input_name !== \"\")) {\n        $input_name = stripinput($input_name);\n    } else {\n        $input_name = \"\";\n    }\n    if (!is_array($array)) {\n        $state_validation = \"\";\n        $placeholder = \"\";\n        $multiple = \"\";\n        $allowclear = \"\";\n        $width = \"style='width:250px;'\";\n    } else {\n        $required = (array_key_exists('required', $array)) ? $array['required'] : \"\";\n        $is_multiple = (array_key_exists('is_multiple', $array)) ? $array['is_multiple'] : \"\";\n        $placeholder = (array_key_exists('placeholder', $array)) ? $array['placeholder'] : \"\";\n        $width = (array_key_exists('width', $array)) ? \"style='width:\".$array['width'].\"'\" : \"style='width:250px;'\";\n        $allowclear = ($placeholder !== \"\") ? \"allowClear:true\" : \"\";\n        // $requested by Tyler for his project\n        if (($required == \"1\") && (empty($_POST['$input_name']))) {\n            $state_validation = \"has-error\";\n        } else {\n            $state_validation = \"\";\n        }\n        $multiple = ($is_multiple == \"1\") ? \"multiple\" : \"\";\n    }\n\n    $input_value = clean_input_value($input_value);\n\n\n    $html = \"\";\n    $html .= \"<div class='form-group \".$state_validation.\" lres'><label class='col-lg-3 control-label' for='$input_id'>$title</label>\";\n    $html .= \"<div class='col-lg-9'>\";\n    $html .= \"<select name='$input_name' id='$input_id' $width $multiple>\";\n    if (is_array($option_array)) {\n        foreach ($option_array as $arr) { // outputs: key, value, class - in order\n            // will not select\n            //print_p($option_array);\n            //print_p($input_value);\n            // accepts format input:\n            /*\n             *  $arr['cat'] = \"the parent's value\"\n             *  $arr['order'] = \"the order\"\n             *  $arr['title'] = \"the name\"\n             */\n            if (array_key_exists(\"cat\", $arr)) {\n                $subclass = \"class='\".$arr['cat'].\"'\";\n            } else {\n                $subclass = \"\";\n            } // this one is used as chain selects\n            $html .= \"<option $subclass value='\".$arr['order'].\"'>\".$arr['title'].\"</option>\";\n        }\n    } else {\n        $html .= \"<option value=''></option>\";\n    }\n    $html .= \"</select>\";\n    add_to_jquery(\"\n        $('#\".$input_id.\"').select2({\n        placeholder: '\".$placeholder.\"',\n        $allowclear\n        });\n    \");\n    add_to_jquery(\"$('#\".$input_id.\"').chained('#\".$chain_to_parent_id.\"');\");\n    $html .= \"</div></div>\";\n\n    load_select2_script();\n    fusion_load_script(DYNAMICS.\"assets/chainselect/jquery.chained.js\");\n\n    return $html;\n}\n", "<?php\n/*-------------------------------------------------------+\n| PHPFusion Content Management System\n| Copyright (C) PHP Fusion Inc\n| https://phpfusion.com/\n+--------------------------------------------------------+\n| Filename: form_select.php\n| Author: Frederick MC Chan (Chan)\n| Co-Author: Tak\u00e1cs \u00c1kos (Rimelek)\n+--------------------------------------------------------+\n| This program is released as free software under the\n| Affero GPL license. You can redistribute it and/or\n| modify it under the terms of this license which you\n| can read by viewing the included agpl.txt or online\n| at www.gnu.org/licenses/agpl.html. Removal of this\n| copyright header is strictly prohibited without\n| written permission from the original author(s).\n+--------------------------------------------------------*/\n\n/**\n * Select2 dynamics plugin version 3.5 (stable)\n *\n * Note on Tags Support\n * $options['tags'] = default $input_value must not be multidimensional array but only as $value = array(TRUE,'2','3');\n * For tagging - set both tags and multiple to TRUE\n * http://select2.github.io/select2/\n *\n * @param        $input_name\n * @param string $label\n * @param        $input_value\n * @param array  $options\n *\n * Setting up a select chain\n *\n * There will be 2 select box, Parent Select and Child Select\n * Parent Select has options value of: array(1 => 'Parent A', 2 => 'Parent B')\n * Parent Child has options value of: array(3 => 'Child A', 4 => 'Child B');\n * The way that these two select chain to each other is via $options['chain_index'] with a value of:\n * array(3 => 1, 4 => 1); ***\n * The above array is the 'id of child A' => 'id of parent of A'\n * key - current option value (i.e. +60)\n * value - parent value that this option value is chained against (i.e. Malaysia)\n *\n * Implementation\n * 1. Do nothing for Parent Select\n * 2. In Child Select add:\n * $options['chainable'] - set to true\n * $options['chain_to_id'] - unique input_id of the Parent Select\n * $options['chain_index'] - the chain array (see ***)\n *\n * Example code\n * form_select('parent', 'Parent Sample', $parent_callback_value, ['options'=>$parent_opts]);\n * form_select('child', 'Child Sample', $child_callback_value, ['options' => $child_opts, 'chainable'=>TRUE, 'chain_to_id'=>'parent', 'chain_index'=>$chain_index_opts]);\n *\n * @return string\n *\n * @package dynamics/select2\n */\nfunction form_select($input_name, $label, $input_value, $options = []) {\n    $locale = fusion_get_locale();\n\n    $title = $label ? stripinput($label) : ucfirst(strtolower(str_replace(\"_\", \" \", $input_name)));\n\n    $default_options = [\n        'options'              => [],\n        'required'             => FALSE,\n        'regex'                => '',\n        'input_id'             => $input_name,\n        'placeholder'          => $locale['choose'],\n        'deactivate'           => FALSE,\n        'safemode'             => FALSE,\n        'allowclear'           => FALSE,\n        'multiple'             => FALSE,\n        'width'                => '',\n        'inner_width'          => '250px',\n        'keyflip'              => FALSE,\n        'tags'                 => FALSE,\n        'jsonmode'             => FALSE,\n        'chainable'            => FALSE,      // Set to True to Enable Chaining\n        'chain_to_id'          => '',         // Set which select it has to be chained to.\n        'db'                   => '',         // Specify which DB to map\n        'id_col'               => '',         // Chain Primary Key Column Name\n        'cat_col'              => '',         // Chain Category Column Name\n        'title_col'            => '',         // Chain Title Column Name\n        'custom_query'         => '',         // SQL query replacements\n        'value_filter'         => ['col' => '', 'value' => NULL], // Specify if building opts has to specifically match these conditions\n        'optgroup'             => FALSE,      // Enable the option group output - if db, id_col, cat_col, and title_col is specified.\n        'option_pattern'       => \"&#8212;\",\n        'display_search_count' => \"5\",\n        'max_select'           => FALSE,\n        'error_text'           => $locale['error_input_default'],\n        'class'                => '',\n        'inline'               => FALSE,\n        'tip'                  => '',\n        'ext_tip'              => '',\n        'delimiter'            => ',',\n        'callback_check'       => '',\n        'stacked'              => '',\n        'onchange'             => '',\n        'select2_disabled'     => FALSE, // if select2_disabled is set to true, then we will not use the select2 plugin\n        'parent_value'         => $locale['root'],\n        'add_parent_opts'      => FALSE,\n        'disable_opts'         => '',\n        'hide_disabled'        => FALSE,\n        'no_root'              => FALSE,\n        'show_current'         => FALSE,\n        'db_cache'             => TRUE,\n        'data'                 => []\n    ];\n\n    $options += $default_options;\n\n    $input_value = clean_input_value($input_value);\n\n    $disable_opts = '';\n    if ($options['disable_opts']) {\n        $disable_opts = is_array($options['disable_opts']) ? $options['disable_opts'] : explode(',', $options['disable_opts']);\n    }\n    $list = [];\n\n    static $select_db = [];\n    // New DB Caching Function.\n    if ($options['db'] && $options['id_col'] && $options['title_col']) {\n\n        // Cache result\n        $cache = ($options['custom_query'] ? FALSE : TRUE);\n\n        if (empty($select_db[$options['db']]) || (!$cache or $options['db_cache'] === FALSE)) {\n            if (!empty($options['cat_col'])) {\n                $select_db[$options['db']] = dbquery_tree_full($options['db'], $options['id_col'], $options['cat_col'], \"ORDER BY \".$options['cat_col'].\" ASC, \".$options['id_col'].\" ASC, \".$options['title_col'].\" ASC\", ($options['custom_query'] ?: \"\"));\n            } else {\n                // if there is a custom query\n                if ($options['custom_query']) {\n                    $select_result = dbquery($options['custom_query']);\n                } else {\n                    $select_result = dbquery(\"SELECT * FROM \".$options['db'].\" ORDER BY \".$options['id_col'].\" ASC, \".$options['title_col'].\" ASC\");\n                }\n\n                // then make into hierarchy\n                if (dbrows($select_result)) {\n                    while ($data = dbarray($select_result)) {\n                        $list[0][$data[$options['id_col']]] = $data;\n                    }\n                    $select_db[$options['db']] = $list;\n                }\n            }\n            /*\n             * Build opt functions\n             */\n            if (!function_exists('get_form_select_opts')) {\n                // @todo: implement all options settings inherited from dbquery_select_hierarchy\n                function get_form_select_opts($data, $options, $id = 0, $level = 0) {\n                    $list = [];\n                    //array('text' => 'Parent Text', 'children' => array(1 => 'Child A' , 2 => 'Child B'));\n                    if (!empty($data[$id])) {\n                        foreach ($data[$id] as $key => $value) {\n                            // Displays defined pattern\n                            $pattern = \"\";\n                            if ($options['option_pattern']) {\n                                $pattern = str_repeat($options['option_pattern'], $level).\" \";\n                            }\n                            // Build List\n                            if (!empty($options['value_filter']['col']) && (!empty($options['value_filter']['value']) || $options['value_filter']['value'] !== NULL)) {\n                                if (isset($value[$options['value_filter']['col']]) && $value[$options['value_filter']['col']] == $options['value_filter']['value']) {\n                                    $list[$key] = $pattern.$value[$options['title_col']];\n                                }\n                            } else {\n                                $list[$key] = $pattern.$value[$options['title_col']];\n                            }\n                            // Build Child\n                            if (isset($data[$key])) {\n                                $child = get_form_select_opts($data, $options, $key, $level + 1);\n                                if ($options['optgroup']) {\n                                    $list[$key] = [\n                                        'text'     => $list[$key],\n                                        'children' => $child,\n                                    ];\n                                } else {\n                                    $list = (!empty($list)) ? $list + $child : $child;\n                                }\n                            }\n                        }\n                    } else {\n                        // the list does not start with a root\n                        foreach (array_keys($data) as $id) {\n                            foreach ($data[$id] as $key => $value) {\n                                // Displays defined pattern\n                                $pattern = \"\";\n                                if ($options['option_pattern']) {\n                                    $pattern = str_repeat($options['option_pattern'], $level).\" \";\n                                }\n                                // Build List\n                                if (!empty($options['value_filter']['col']) && (!empty($options['value_filter']['value']) || $options['value_filter']['value'] !== NULL)) {\n                                    if (isset($value[$options['value_filter']['col']]) && $value[$options['value_filter']['col']] == $options['value_filter']['value']) {\n                                        $list[$key] = $pattern.html_entity_decode($value[$options['title_col']]);\n                                    }\n                                } else {\n                                    $list[$key] = $pattern.html_entity_decode($value[$options['title_col']]);\n                                }\n                                // Build Child\n                                if (isset($data[$key])) {\n                                    $child = get_form_select_opts($data, $options, $key, $level + 1);\n                                    if ($options['optgroup']) {\n                                        $list[$key] = [\n                                            'text'     => $list[$key],\n                                            'children' => $child,\n                                        ];\n                                    } else {\n                                        $list = (!empty($list)) ? $list + $child : $child;\n                                    }\n                                }\n                            }\n                        }\n                    }\n\n                    return (array)$list;\n                }\n            }\n            /**\n             * Build Chainable Reference Array\n             * array key    current id\n             *      value   parent id\n             */\n            if (!function_exists('get_form_select_chain_index')) {\n                function get_form_select_chain_index($data, $options) {\n                    $list = [];\n                    if (!empty($data)) {\n                        $data = flatten_array($data);\n                        foreach ($data as $value) {\n                            $list[$value[$options['id_col']]] = $value[$options['cat_col']];\n                        }\n                    }\n\n                    return (array)$list;\n                }\n            }\n        }\n        // Automatic build chain index.\n        if ($options['chainable'] && $options['chain_to_id'] && empty($options['chain_index'])) {\n            $options['chain_index'] = get_form_select_chain_index($select_db[$options['db']], $options);\n        }\n\n        if (!empty($select_db[$options['db']])) {\n            // Build options and override declared options\n            $options['options'] = get_form_select_opts($select_db[$options['db']], $options);\n        } else {\n            $options['options'] = ['0' => $locale['no_opts']];\n            $options['deactivate'] = 1;\n        }\n    } else if (empty($options['options'])) {\n        $options['options'] = ['0' => $locale['no_opts']];\n        $options['deactivate'] = 1;\n    }\n\n    // Build a chain index and initialize the JS chain plugin\n    // $options['chainable']    - true\n    // $options['chain_to_id']  - parent id\n    // $options['chain_index'] - a list of array of current id and the parent id as value (see get_form_select_chain_index function how it's done)\n    if ($options['chainable'] && $options['chain_to_id'] && !empty($options['chain_index'])) {\n\n        fusion_load_script(DYNAMICS.\"assets/chainselect/jquery.chained.js\");\n\n        add_to_jquery(\"$('#\".$options['input_id'].\"').chained('#\".$options['chain_to_id'].\"');\");\n    }\n\n    // Optgroup with Hierarchy\n    if (!function_exists('form_select_build_optgroup')) {\n        function form_select_build_optgroup($array, $input_value, $options) {\n            $html = '';\n            $disable_opts = '';\n            if ($options['disable_opts']) {\n                $disable_opts = is_array($options['disable_opts']) ? $options['disable_opts'] : explode(',', $options['disable_opts']);\n            }\n\n            foreach ($array as $arr => $value) {\n\n                // where options is more than one value, pass to data attributes.\n                $data_attributes = '';\n                if (count($value) > 1) {\n                    $data_options = [];\n                    foreach ($value as $datakey => $dataval) {\n                        $data_options[] = \"data-$datakey='$dataval'\";\n                    }\n                    $data_attributes = \" \".implode(' ', $data_options).\" \";\n                }\n\n                $select = \"\";\n                $chain = (isset($options['chain_index'][$arr]) ? \" class='\".$options['chain_index'][$arr].\"' \" : \"\");\n                $text_value = isset($value['text']) ? $value['text'] : $value;\n                // if you have data attributes, you must have text key\n                if (!empty($text_value) && !is_array($text_value)) {\n                    if ($options['keyflip']) { // flip mode = store array values\n                        if ($input_value !== '') {\n                            $select = ($input_value == $text_value) ? \" selected\" : \"\";\n                        }\n                        $disabled = $disable_opts && in_array($arr, $disable_opts);\n                        $hide = $disabled && $options['hide_disabled'];\n                        $item = (!$hide ? \"<option\".$data_attributes.\"value='$text_value'\".$chain.$select.($disabled ? 'disabled' : '').\">\".html_entity_decode($text_value).\" \".($options['show_current'] && $input_value == $text_value ? '(Current Item)' : '').\"</option>\\n\" : \"\");\n\n                    } else {\n                        if ($input_value !== '') {\n                            $input_value = stripinput($input_value); // not sure if can turn FALSE to zero not null.\n                            $select = (isset($input_value) && $input_value == $arr) ? ' selected' : '';\n                        }\n                        $disabled = $disable_opts && in_array($arr, $disable_opts);\n                        $hide = $disabled && $options['hide_disabled'];\n                        $item = (!$hide ? \"<option\".$data_attributes.\"value='$arr'\".$chain.$select.($disabled ? 'disabled' : '').\">\".html_entity_decode($text_value).\" \".($options['show_current'] && $input_value == $text_value ? '(Current Item)' : '').\"</option>\\n\" : \"\");\n                        //$item = \"<option value='$arr'\".$chain.$select.\">$text_value</option>\\n\";\n                    }\n                    if (isset($value['children'])) {\n                        $html .= \"<optgroup label='\".$value['text'].\"'>\\n\";\n                        $html .= $item;\n                        $html .= form_select_build_optgroup($value['children'], $input_value, $options);\n                        $html .= \"</optgroup>\\n\";\n                    } else {\n                        $html .= $item;\n                    }\n                }\n\n            }\n\n            return (string)$html;\n        }\n    }\n\n    if (!$options['width']) {\n        $options['width'] = $default_options['width'];\n    }\n    if ($options['multiple']) {\n        if ($input_value) {\n            $input_value = explode($options['delimiter'], $input_value);\n        } else {\n            $input_value = [];\n        }\n    }\n\n    // always trim id\n    $options['input_id'] = trim($options['input_id'], \"[]\");\n    $allowclear = ($options['placeholder'] && $options['multiple'] || $options['allowclear']) ? \"allowClear:true,\" : '';\n\n    $error_class = \"\";\n    if (\\defender::inputHasError($input_name)) {\n        $error_class = \" has-error \";\n        if (!empty($options['error_text'])) {\n            $new_error_text = \\defender::getErrorText($input_name);\n            if (!empty($new_error_text)) {\n                $options['error_text'] = $new_error_text;\n            }\n            addNotice(\"danger\", \"<strong>$title</strong> - \".$options['error_text']);\n        }\n    }\n\n    $html = \"<div id='\".$options['input_id'].\"-field' class='form-group \".($options['inline'] && $label ? 'row' : '').$error_class.' '.$options['class'].\"' \".($options['width'] && !$label ? \"style='width: \".$options['width'].\"'\" : '').\">\\n\";\n    $html .= ($label) ? \"<label class='control-label \".($options['inline'] ? \"col-xs-12 col-sm-12 col-md-3 col-lg-3\" : '').\"' for='\".$options['input_id'].\"'>\".$label.($options['required'] == TRUE ? \"<span class='required'>&nbsp;*</span>\" : '').\"\n    \".($options['tip'] ? \"<i class='pointer fa fa-question-circle' title='\".$options['tip'].\"'></i>\" : '').\"\n    </label>\\n\" : '';\n    $html .= $options['inline'] && $label ? \"<div class='col-xs-12 col-sm-9 col-md-9 col-lg-9'>\\n\" : \"\";\n    if ($options['jsonmode'] || $options['tags']) {\n        // json mode.\n        $html .= \"<div id='\".$options['input_id'].\"-spinner' style='display:none;'>\\n<img src='\".fusion_get_settings('siteurl').\"images/loader.svg'>\\n</div>\\n\";\n        $html .= \"<input \".($options['required'] ? \"class='req'\" : '').\" type='hidden' name='$input_name' id='\".$options['input_id'].\"' style='width: \".($options['width'] ? $options['inner_width'] : $default_options['width']).\"'/>\\n\";\n    } else {\n        // normal mode\n\n        $html .= \"<select \".($options['select2_disabled'] == TRUE ? \" class='form-control' \" : \"\").\" name='$input_name' id='\".$options['input_id'].\"' style='width: \".($options['inner_width'] ? $options['inner_width'] : $default_options['inner_width']).\"'\".($options['deactivate'] ? \" disabled\" : \"\").($options['onchange'] ? ' onchange=\"'.$options['onchange'].'\"' : '').($options['multiple'] ? \" multiple\" : \"\").\">\\n\";\n        $html .= ($options['allowclear']) ? \"<option value=''></option>\\n\" : '';\n        // add parent value\n        if ($options['no_root'] == FALSE && !empty($options['cat_col']) || $options['add_parent_opts'] === TRUE) { // api options to remove root from selector. used in items creation.\n            $this_select = '';\n            if ($input_value !== NULL) {\n                if ($input_value !== '') {\n                    $this_select = 'selected';\n                }\n            }\n            $html .= \"<option value='0' \".$this_select.\" >\".$options['parent_value'].\"</option>\\n\";\n        }\n\n        /**\n         * Supported Formatting\n         * ---------------------\n         * Have an array that looks like this in 'options' key\n         * array('text' => 'Parent Text', 'children' => array(1 => 'Child A' , 2 => 'Child B'));\n         * or\n         * array(1 => 'Option A', 2 => 'Option B');\n         */\n        if (is_array($options['options'])) {\n            // Test if this is an optgroup\n            $test_array = $options['options'];\n            foreach ($test_array as $id => $v) {\n                if (isset($v['text'])) {\n                    $options['optgroup'] = TRUE;\n                    break;\n                }\n            }\n            if ($options['optgroup']) {\n                $html .= form_select_build_optgroup($options['options'], $input_value, $options);\n            } else {\n                foreach ($options['options'] as $arr => $v) { // outputs: key, value, class - in order\n                    $select = '';\n                    $chain = '';\n                    // Chain method always bind to options's array key\n                    if (isset($options['chain_index'][$arr])) {\n                        $chain = \" class='\".$options['chain_index'][$arr].\"' \";\n                    }\n\n                    // do a disable for filter_opts item.\n                    if ($options['keyflip']) { // flip mode = store array values\n                        if ($input_value !== '') {\n                            $select = ($input_value == $v) ? \" selected\" : \"\";\n                        }\n                        $disabled = $disable_opts && in_array($arr, $disable_opts);\n                        $hide = $disabled && $options['hide_disabled'];\n                        $html .= (!$hide ? \"<option value='$v'\".$chain.$select.($disabled ? 'disabled' : '').\">\".html_entity_decode($v).\" \".($options['show_current'] && $input_value == $v ? '(Current Item)' : '').\"</option>\\n\" : \"\");\n                    } else {\n                        if ($input_value !== '') {\n                            //$input_value = stripinput($input_value); // not sure if can turn FALSE to zero not null.\n                            $select = (isset($input_value) && $input_value == $arr) ? ' selected' : '';\n                        }\n                        $disabled = $disable_opts && in_array($arr, $disable_opts);\n                        $hide = $disabled && $options['hide_disabled'];\n                        $html .= (!$hide ? \"<option value='$arr'\".$chain.$select.($disabled ? 'disabled' : '').\">\".html_entity_decode($v).\" \".($options['show_current'] && $input_value == $v ? '(Current Item)' : '').\"</option>\\n\" : \"\");\n                    }\n                }\n            }\n        }\n        $html .= \"</select>\\n\";\n    }\n\n    $html .= $options['stacked'];\n    $html .= $options['ext_tip'] ? \"<br/>\\n<div class='m-t-10 tip'><i>\".$options['ext_tip'].\"</i></div>\" : \"\";\n    $html .= \\defender::inputHasError($input_name) && !$options['inline'] ? \"<br/>\" : \"\";\n    $html .= \\defender::inputHasError($input_name) ? \"<div id='\".$options['input_id'].\"-help' class='label label-danger p-5 display-inline-block'>\".$options['error_text'].\"</div>\" : \"\";\n    $html .= $options['inline'] && $label ? \"</div>\\n\" : '';\n    $html .= \"</div>\\n\";\n    if ($options['required']) {\n        $html .= \"<input class='req' id='dummy-\".$options['input_id'].\"' type='hidden'>\\n\"; // for jscheck\n    }\n    // Generate Defender Tag\n    $input_name = ($options['multiple']) ? str_replace(\"[]\", \"\", $input_name) : $input_name;\n    \\defender::add_field_session([\n        'input_name'     => clean_input_name($input_name),\n        'title'          => clean_input_name($title),\n        'id'             => $options['input_id'],\n        'type'           => 'dropdown',\n        'regex'          => $options['regex'],\n        'required'       => $options['required'],\n        'safemode'       => $options['safemode'],\n        'error_text'     => $options['error_text'],\n        'callback_check' => $options['callback_check'],\n        'delimiter'      => $options['delimiter'],\n    ]);\n    // Initialize Select2\n    if ($options['select2_disabled'] === FALSE) {\n        // Select 2 Multiple requires hidden DOM.\n        if ($options['jsonmode'] === FALSE) {\n            // not json mode (normal)\n            $max_js = '';\n            if ($options['multiple'] && $options['max_select']) {\n                $max_js = \"maximumSelectionSize : \".$options['max_select'].\",\";\n            }\n\n            $tag_js = '';\n            if ($options['tags']) {\n                $tag_value = json_encode(array_values($options['options']));\n                // The format yield must be : `tags:[\"red\", \"green\", \"blue\", \"orange\", \"white\", \"black\", \"purple\", \"cyan\", \"teal\"]`\n                $tag_js = ($tag_value) ? \"tags: \".html_entity_decode($tag_value).\"\" : \"tags: []\";\n            }\n\n\n            if ($options['required']) {\n                add_to_jquery(\"\n                if ($('#\".$options['input_id'].\"').select2('val')) { $('dummy-\".$options['input_id'].\"').val($('#\".$options['input_id'].\"').select2('val'));} else { $('dummy-\".$options['input_id'].\"').val('');}\n                $('#\".$options['input_id'].\"').select2({\n                    \".($options['placeholder'] ? \"placeholder: '\".$options['placeholder'].\"',\" : '').\"\n                    minimumResultsForSearch: \".$options['display_search_count'].\",\n                    \".$max_js.\"\n                    \".$allowclear.\"\n                    \".$tag_js.\"\n                }).bind('change', function(e) {\t$('#dummy-\".$options['input_id'].\"').val($(this).val()); });\n                \");\n            } else {\n                add_to_jquery(\"\n                $('#\".$options['input_id'].\"').select2({\n                    \".($options['placeholder'] ? \"placeholder: '\".$options['placeholder'].\"',\" : '').\"\n                    minimumResultsForSearch: \".$options['display_search_count'].\",\n                    \".$max_js.\"\n                    \".$allowclear.\"\n                    \".$tag_js.\"\n                });\n            \");\n            }\n\n        } else {\n            // json mode\n            add_to_jquery(\"\n                var this_data = [{id:0, text: '\".$options['placeholder'].\"'}];\n                $('#\".$options['input_id'].\"').select2({\n                placeholder: '\".$options['placeholder'].\"',\n                data: this_data\n                });\n            \");\n        }\n\n        // For Multiple Callback JS\n        if (is_array($input_value) && $options['multiple']) { // stores as value;\n            $vals = '';\n            foreach ($input_value as $arr => $val) {\n                $val = html_entity_decode($val);\n                $vals .= ($arr == count($input_value) - 1) ? \"'$val'\" : \"'$val',\";\n            }\n            add_to_jquery(\"$('#\".$options['input_id'].\"').select2('val', [$vals]);\");\n        }\n    }\n\n    load_select2_script();\n\n    return (string)$html;\n}\n\n/**\n * Selector for registered user\n *\n * @param        $input_name\n * @param string $label\n * @param bool   $input_value - user id\n * @param array  $options\n *\n * @return string\n */\nfunction form_user_select($input_name, $label = \"\", $input_value = FALSE, array $options = []) {\n    $locale = fusion_get_locale();\n\n    $title = $label ? stripinput($label) : ucfirst(strtolower(str_replace(\"_\", \" \", $input_name)));\n    $input_value = clean_input_value($input_value);\n\n    $default_options = [\n        'required'          => FALSE,\n        'regex'             => '',\n        'input_id'          => $input_name,\n        'placeholder'       => $locale['sel_user'],\n        'deactivate'        => FALSE,\n        'safemode'          => FALSE,\n        'allowclear'        => FALSE,\n        'multiple'          => FALSE,\n        'inner_width'       => '250px',\n        'width'             => '',\n        'keyflip'           => FALSE,\n        'tags'              => FALSE,\n        'jsonmode'          => FALSE,\n        'chainable'         => FALSE,\n        'max_select'        => 1,\n        'error_text'        => '',\n        'class'             => '',\n        'stacked'           => '',\n        'inline'            => FALSE,\n        'tip'               => '',\n        'ext_tip'           => '',\n        'delimiter'         => ',',\n        'callback_check'    => '',\n        'file'              => '',\n        'allow_self'        => FALSE,\n        'callback_function' => '',\n        'image_path'        => IMAGES.\"avatars/\",\n    ];\n\n    $options += $default_options;\n\n    $options['input_id'] = trim($options['input_id'], \"[]\");\n\n    $allowclear = ($options['placeholder'] && $options['multiple'] || $options['allowclear']) ? \"allowClear:true,\" : '';\n    $length = \"minimumInputLength: 1,\";\n    $error_class = \"\";\n\n    if (defender::inputHasError($input_name)) {\n        $error_class = \"has-error \";\n        $new_error_text = defender::getErrorText($input_name);\n        if (!empty($new_error_text)) {\n            $options['error_text'] = $new_error_text;\n        }\n        addNotice(\"danger\", \"<strong>$title</strong> - \".$options['error_text']);\n    }\n\n    $html = \"<div id='\".$options['input_id'].\"-field' class='form-group \".($options['inline'] && $label ? 'row ' : '').$error_class.$options['class'].\"' style='width:\".$options['width'].\"'>\\n\";\n    $html .= ($label) ? \"<label class='control-label \".($options['inline'] ? 'col-xs-12 col-sm-12 col-md-3 col-lg-3' : '').\"' for='\".$options['input_id'].\"'>$label \".($options['required'] == TRUE ? \"<span class='required'>*</span>\" : '').\"</label>\\n\" : '';\n    $html .= $options['inline'] && $label ? \"<div class='col-xs-12 col-sm-9 col-md-9 col-lg-9'>\\n\" : \"\";\n    $html .= \"<input \".($options['required'] ? \"class='req'\" : '').\" type='hidden' name='$input_name' id='\".$options['input_id'].\"' data-placeholder='\".$options['placeholder'].\"' style='width:\".$options['inner_width'].\"'\".($options['deactivate'] ? ' disabled' : '').\"/>\\n\";\n    if ($options['deactivate']) {\n        $html .= form_hidden($input_name, '', $input_value, [\"input_id\" => $options['input_id']]);\n    }\n\n    $html .= $options['stacked'];\n    $html .= $options['ext_tip'] ? \"<br/>\\n<div class='m-t-10 tip'><i>\".$options['ext_tip'].\"</i></div>\" : \"\";\n    $html .= \\defender::inputHasError($input_name) && !$options['inline'] ? \"<br/>\" : \"\";\n    $html .= \\defender::inputHasError($input_name) ? \"<div id='\".$options['input_id'].\"-help' class='label label-danger p-5 display-inline-block'>\".$options['error_text'].\"</div>\" : \"\";\n\n    $html .= $options['inline'] && $label ? \"</div>\\n\" : '';\n\n    $html .= \"</div>\\n\";\n\n    $root_prefix = fusion_get_settings(\"site_seo\") == 1 ? fusion_get_settings('siteurl').\"includes/\" : INCLUDES;\n\n    $root_img = fusion_get_settings(\"site_seo\") == 1 && !defined('ADMIN_PANEL') ? fusion_get_settings('siteurl') : '';\n\n    $path = $options['file'] ? $options['file'] : $root_prefix.\"dynamics/assets/users/users.json.php\".($options['allow_self'] ? \"?allow_self=true\" : \"\");\n\n    if (!empty($input_value)) {\n        // json mode.\n        $encoded = $options['callback_function'] && is_callable($options['callback_function']) ? $options['callback_function']($input_value) : user_search($input_value);\n    } else {\n        $encoded = json_encode([]);\n    }\n\n    defender::getInstance()->add_field_session([\n        'input_name' => clean_input_name($input_name),\n        'title'      => $title,\n        'id'         => $options['input_id'],\n        'type'       => 'dropdown',\n        'required'   => $options['required'],\n        'safemode'   => $options['safemode'],\n        'error_text' => $options['error_text']\n    ]);\n\n    add_to_jquery(\"\n        function avatar(item) {\n            if(!item.id) {return item.text;}\n            var avatar = item.avatar;\n            var level = item.level;\n            return '<table><tr><td style=\\\"\\\"><img style=\\\"height:35px;\\\" class=\\\"img-rounded\\\" src=\\\"\".$root_img.$options['image_path'].\"' + avatar + '\\\"/></td><td style=\\\"padding-left:10px; padding-right:10px;line-height:1.2;\\\"><div><strong>' + item.text + '</strong></div>' + level + '</div></td></tr></table>';\n        }\n        $('#\".$options['input_id'].\"').select2({\n        $length\n        multiple: true,\n        maximumSelectionSize: \".$options['max_select'].\",\n        placeholder: '\".$options['placeholder'].\"',\n        ajax: {\n        url: '$path',\n        dataType: 'json',\n        data: function (term, page) {\n                return {q: term};\n              },\n              results: function (data, page) {\n                //console.log(page);\n                return {results: data};\n              }\n        },\n        formatSelection: avatar,\n        escapeMarkup: function(m) { return m; },\n        formatResult: avatar,\n        \".$allowclear.\"\n        })\".(!empty($encoded) ? \".select2('data', $encoded );\" : '').\"\n    \");\n\n    load_select2_script();\n\n    return $html;\n}\n\n/* Returns Json Encoded Object used in form_select_user */\nfunction user_search($user_id) {\n    $encoded = json_encode([]);\n    if (isnum($user_id)) {\n        $user_id = stripinput($user_id);\n        $result = dbquery(\"SELECT user_id, user_name, user_avatar, user_level FROM \".DB_USERS.\" WHERE user_status=:status AND user_id=:id\", [':status' => 0, ':id' => $user_id]);\n        if (dbrows($result) > 0) {\n            while ($udata = dbarray($result)) {\n                $user_id = $udata['user_id'];\n                $user_avatar = ($udata['user_avatar']) ? $udata['user_avatar'] : \"no-avatar.jpg\";\n                $user_name = $udata['user_name'];\n                $user_level = getuserlevel($udata['user_level']);\n                $user_opts[] = [\n                    'id'     => $user_id,\n                    'text'   => $user_name,\n                    'avatar' => $user_avatar,\n                    \"level\"  => $user_level\n                ];\n            }\n            if (!isset($user_opts)) {\n                $user_opts = [];\n            }\n            $encoded = json_encode($user_opts);\n        }\n    }\n\n    return $encoded;\n}\n\n/**\n * Select2 hierarchy\n * Returns a full hierarchy nested dropdown.\n *\n * @param        $input_name\n * @param string $label\n * @param string $input_value\n * @param array  $options\n * @param        $db       - your db\n * @param        $name_col - the option text to show\n * @param        $id_col   - unique id\n * @param        $cat_col  - parent id\n *                         ## The rest of the Params are used by the function itself -- no need to handle ##\n * @param bool   $self_id  - not required\n * @param bool   $id       - not required\n * @param bool   $level    - not required\n * @param bool   $index    - not required\n * @param bool   $data     - not required\n *\n * @return string\n */\nfunction form_select_tree($input_name, $label, $input_value, array $options, $db, $name_col, $id_col, $cat_col, $self_id = FALSE, $id = FALSE, $level = FALSE, $index = FALSE, $data = FALSE) {\n    $html = '';\n    $locale = fusion_get_locale();\n    $title = $label ? stripinput($label) : ucfirst(strtolower(str_replace(\"_\", \" \", $input_name)));\n    $default_options = [\n        'required'        => FALSE,\n        'regex'           => '',\n        'input_id'        => $input_name,\n        'placeholder'     => $locale['choose'],\n        'deactivate'      => FALSE,\n        'safemode'        => FALSE,\n        'allowclear'      => FALSE,\n        'multiple'        => FALSE,\n        'width'           => '',\n        'inner_width'     => '250px',\n        'keyflip'         => FALSE,\n        'tags'            => FALSE,\n        'jsonmode'        => FALSE,\n        'chainable'       => FALSE,\n        'max_select'      => FALSE,\n        'error_text'      => $locale['error_input_default'],\n        'class'           => '',\n        'inline'          => FALSE,\n        'tip'             => '',\n        'delimiter'       => ',',\n        'callback_check'  => '',\n        'file'            => '',\n        'parent_value'    => $locale['root'],\n        'add_parent_opts' => FALSE,\n        'disable_opts'    => '',\n        'hide_disabled'   => FALSE,\n        'no_root'         => FALSE,\n        'show_current'    => FALSE,\n        'query'           => '',\n        'full_query'      => '',\n    ];\n    $options += $default_options;\n\n    $options['input_id'] = trim($options['input_id'], \"[]\");\n    if ($options['multiple']) {\n        if ($input_value) {\n            $input_value = explode('|', $input_value);\n        } else {\n            $input_value = [];\n        }\n    }\n    if (!$options['width']) {\n        $options['width'] = $default_options['width'];\n    }\n    $allowclear = ($options['placeholder'] && $options['multiple'] || $options['allowclear']) ? \"allowClear:true\" : '';\n    $disable_opts = '';\n    if ($options['disable_opts']) {\n        $disable_opts = is_array($options['disable_opts']) ? $options['disable_opts'] : explode(',', $options['disable_opts']);\n    }\n    /* Child patern */\n    $opt_pattern = str_repeat(\"&#8212;\", $level);\n\n    if (!$level) {\n        $level = 0;\n        if (!isset($index[$id])) {\n            $index[$id] = ['0' => $locale['no_opts']];\n        }\n\n        $error_class = '';\n        if (\\defender::inputHasError($input_name)) {\n            $error_class = \"has-error \";\n            if (!empty($options['error_text'])) {\n                $new_error_text = \\defender::getErrorText($input_name);\n                if (!empty($new_error_text)) {\n                    $options['error_text'] = $new_error_text;\n                }\n                addNotice(\"danger\", \"<strong>$title</strong> - \".$options['error_text']);\n            }\n        }\n\n        $html = \"<div id='\".$options['input_id'].\"-field' class='form-group \".($options['inline'] && $label ? 'row ' : '').$error_class.$options['class'].\"' \".($options['inline'] && $options['width'] && !$label ? \"style='width: \".$options['width'].\"'\" : '').\">\\n\";\n        $html .= ($label) ? \"<label class='control-label \".($options['inline'] ? 'col-xs-12 col-sm-12 col-md-3 col-lg-3' : '').\"' for='\".$options['input_id'].\"'>\".$label.($options['required'] == TRUE ? \"<span class='required'>&nbsp;*</span>\" : '').\" \".($options['tip'] ? \"<i class='pointer fa fa-question-circle' label=\".$options['tip'].\"></i>\" : '').\"</label>\\n\" : '';\n        $html .= $options['inline'] && $label ? \"<div class='col-xs-12 col-sm-9 col-md-9 col-lg-9'>\\n\" : \"\";\n    }\n    if ($level == 0) {\n        add_to_jquery(\"\n        $('#\".$options['input_id'].\"').select2({\n        placeholder: '\".$options['placeholder'].\"',\n        $allowclear\n        });\n        \");\n        if (is_array($input_value) && $options['multiple']) { // stores as value;\n            $vals = '';\n            foreach ($input_value as $arr => $val) {\n                $vals .= ($arr == count($input_value) - 1) ? \"'$val'\" : \"'$val',\";\n            }\n            add_to_jquery(\"$('#\".$options['input_id'].\"').select2('val', [$vals]);\");\n        }\n        $html .= \"<select name='$input_name' id='\".$options['input_id'].\"' style='width: \".($options['inner_width'] ? $options['inner_width'] : $default_options['inner_width']).\"'\".($options['deactivate'] ? \" disabled\" : \"\").($options['multiple'] ? \" multiple\" : \"\").\">\";\n        $html .= $options['allowclear'] ? \"<option value=''></option>\\n\" : '';\n        if ($options['no_root'] == FALSE) { // api options to remove root from selector. used in items creation.\n            $this_select = '';\n            if ($input_value !== NULL) {\n                if ($input_value !== '') {\n                    $this_select = 'selected';\n                }\n            }\n            $html .= ($options['add_parent_opts'] == TRUE) ? \"<option value='0' \".$this_select.\">$opt_pattern \".$locale['parent'].\"</option>\\n\" : \"<option value='0' \".$this_select.\" >$opt_pattern \".$options['parent_value'].\"</option>\\n\";\n        }\n\n        $index = dbquery_tree($db, $id_col, $cat_col, $options['query'], $options['full_query']);\n        if (!empty($index)) {\n            $data = dropdown_select($db, $id_col, $name_col, $cat_col, implode(',', flatten_array($index)), $options['query'], $options['full_query']);\n        }\n    }\n\n    if (!$id) {\n        $id = 0;\n    }\n\n    if (isset($index[$id]) && !empty($data)) {\n        foreach ($index[$id] as $key => $value) {\n            // value is the array\n            //$hide = $disable_branch && $value == $self_id ? 1 : 0;\n            $name = $data[$value][$name_col];\n            //print_p($data[$value]);\n\n            $name = PHPFusion\\QuantumFields::parse_label($name);\n            $select = ($input_value !== \"\" && ($input_value == $value)) ? 'selected' : '';\n            $disabled = $disable_opts && in_array($value, $disable_opts);\n            $hide = $disabled && $options['hide_disabled'];\n            // do a disable for filter_opts item.\n            $html .= (!$hide) ? \"<option value='$value' \".$select.\" \".($disable_opts && in_array($value, $disable_opts) ? 'disabled' : '').\" >$opt_pattern $name \".($options['show_current'] && $self_id == $value ? '(Current Item)' : '').\"</option>\\n\" : '';\n            if (isset($index[$value]) && (!$hide)) {\n                $html .= form_select_tree($input_name, $label, $input_value, $options, $db, $name_col, $id_col, $cat_col, $self_id, $value, $level + TRUE, $index, $data);\n            }\n        }\n    }\n    if (!$level) {\n        $html .= \"</select>\\n\";\n        $html .= (($options['required'] == 1 && \\defender::inputHasError($input_name)) || \\defender::inputHasError($input_name)) ? \"<div id='\".$options['input_id'].\"-help' class='label label-danger p-5 display-inline-block'>\".$options['error_text'].\"</div>\" : \"\";\n        $html .= $options['inline'] && $label ? \"</div>\\n\" : '';\n        $html .= \"</div>\\n\";\n        if ($options['required']) {\n            $html .= \"<input class='req' id='dummy-\".$options['input_id'].\"' type='hidden'>\\n\"; // for jscheck\n        }\n        $input_name = ($options['multiple']) ? str_replace(\"[]\", \"\", $input_name) : $input_name;\n        \\defender::add_field_session(\n            [\n                'input_name'     => $input_name,\n                'title'          => trim($title, '[]'),\n                'id'             => $options['input_id'],\n                'type'           => 'dropdown',\n                'regex'          => $options['regex'],\n                'required'       => $options['required'],\n                'safemode'       => $options['safemode'],\n                'error_text'     => $options['error_text'],\n                'callback_check' => $options['callback_check'],\n                'delimiter'      => $options['delimiter'],\n            ]\n        );\n    }\n\n    load_select2_script();\n\n    return $html;\n}\n\n/*\n * Optimized performance by adding a self param to implode to fetch only certain rows\n */\nfunction dropdown_select($db, $id_col, $name_col, $cat_col, $index_values, $filter = '', $query_replace = '') {\n    $data = [];\n    $query = \"SELECT $id_col, $name_col, $cat_col FROM \".$db.\" \".($filter ? $filter.\" AND \" : 'WHERE').\" $id_col IN ($index_values) ORDER BY $name_col ASC\";\n    if (!empty($query_replace)) {\n        $query = $query_replace;\n    }\n    $result = dbquery($query);\n    while ($row = dbarray($result)) {\n        $id = $row[$id_col];\n        $data[$id] = $row;\n    }\n\n    return $data;\n}\n", "<?php\n/*-------------------------------------------------------+\n| PHPFusion Content Management System\n| Copyright (C) PHP Fusion Inc\n| https://phpfusion.com/\n+--------------------------------------------------------+\n| Filename: form_text.php\n| Author: Frederick MC Chan (Chan)\n| Co-Author: Dan C. (JoiNNN)\n+--------------------------------------------------------+\n| This program is released as free software under the\n| Affero GPL license. You can redistribute it and/or\n| modify it under the terms of this license which you\n| can read by viewing the included agpl.txt or online\n| at www.gnu.org/licenses/agpl.html. Removal of this\n| copyright header is strictly prohibited without\n| written permission from the original author(s).\n+--------------------------------------------------------*/\n\n/**\n * Generates a text input\n * TODO: Document each option\n *\n * Generates the HTML for a textbox or password input\n *\n * @param string $input_name  Name of the input, by\n *                            default it's also used as the ID for the input\n * @param string $label       The label\n * @param string $input_value The value to be displayed\n *                            in the input, usually a value from DB prev. saved\n * @param array  $options     Various options\n *\n * @return string\n *\n * To add an inline button (set prepend or append - respectively)\n * register these options accordingly into the function\n * $options['append_button'] = true\n * $options['append_type'] = button or submit\n * $options['append_form_value'] = the value of the button\n * $options['append_class'] = your pick of .btn classes (bootstrap .btn-success, .btn-info, etc)\n * $options['append_value'] = the label\n * $options['append_button_name'] = your button name , default: p-submit-\".$options['input_id'].\"\n * $options['append_button_id'] = your button name , default: \".$input_name.\"-append-btn\n *\n * To add a decorative labels (set prepend or append - respectively)\n * $options['append_value'] = \"your-value\" - You can also insert HTML <i class='fa fa-something'></i> for glyphs\n *\n */\n\nfunction form_text($input_name, $label = \"\", $input_value = \"\", array $options = []) {\n\n    $locale = fusion_get_locale();\n\n    $title = $label ? stripinput($label) : ucfirst(strtolower(str_replace(\"_\", \" \", $input_name)));\n\n    $input_id = trim(str_replace(\"[\", \"-\", $input_name), \"]\");\n\n    $input_value = clean_input_value($input_value);\n\n    $default_options = [\n        'type'               => 'text',\n        'required'           => FALSE,\n        'label_icon'         => '',\n        'feedback_icon'      => '',\n        'safemode'           => FALSE,\n        'regex'              => '',\n        'regex_error_text'   => '',\n        'callback_check'     => FALSE,\n        'input_id'           => $input_id,\n        'placeholder'        => '',\n        'deactivate'         => FALSE,\n        'width'              => '',\n        'inner_width'        => '',\n        'class'              => '',\n        'inner_class'        => '',\n        'inline'             => FALSE,\n        'min_length'         => 1,\n        'max_length'         => 200,\n        'number_min'         => 0,\n        'number_max'         => 0,\n        'number_step'        => 1,\n        'icon'               => '',\n        'autocomplete_off'   => FALSE,\n        'tip'                => '',\n        'ext_tip'            => '',\n        'append_button'      => '',\n        'append_value'       => '',\n        'append_form_value'  => '',\n        'append_size'        => '',\n        'append_class'       => 'btn-default',\n        'append_type'        => 'submit',\n        'prepend_id'         => \"p-\".$input_id.\"-prepend\",\n        'append_id'          => \"p-\".$input_id.\"-append\",\n        'prepend_button'     => '',\n        'prepend_value'      => '',\n        'prepend_form_value' => '',\n        'prepend_size'       => '',\n        'prepend_class'      => 'btn-default',\n        'prepend_type'       => 'submit',\n        'error_text'         => '',\n        'delimiter'          => ',',\n        'stacked'            => '',\n        'group_size'         => '', // http://getbootstrap.com/components/#input-groups-sizing - sm, md, lg\n        'password_strength'  => FALSE,\n        'data'               => [],\n        'append_html'        => '',\n        'censor_words'       => TRUE,\n        'password_toggle'    => TRUE,\n        'descript'           => TRUE\n    ];\n\n    $options += $default_options;\n\n    $valid_types = [\n        'text', 'number', 'password', 'email', 'url', 'color', 'date', 'datetime', 'datetime-local', 'month', 'range', 'search', 'tel', 'time', 'week'\n    ];\n\n    $options['type'] = in_array($options['type'], $valid_types) ? $options['type'] : 'text';\n\n    $options += [\n        'append_button_name'  => !empty($options['append_button_name']) ? $options['append_button_name'] : \"p-submit-\".$options['input_id'],\n        'prepend_button_name' => !empty($options['append_button_name']) ? $options['append_button_name'] : \"p-submit-\".$options['input_id'],\n        'append_button_id'    => !empty($options['append_button_id']) ? $options['append_button_id'] : $options['input_id'].'-append-btn',\n        'prepend_button_id'   => !empty($options['prepend_button_id']) ? $options['prepend_button_id'] : $options['input_id'].'-prepend-btn',\n    ];\n\n    if (!empty($options['data'])) {\n        array_walk($options['data'], function ($a, $b) use (&$options_data) {\n            $options_data[] = \"data-$b='$a'\";\n        }, $options_data);\n    }\n\n    // Error messages based on settings\n    if ($options['type'] == 'password') {\n        $options['error_text'] = empty($options['error_text']) ? $locale['error_input_password'] : $options['error_text'];\n    } else if ($options['type'] == 'email') {\n        $options['error_text'] = empty($options['error_text']) ? $locale['error_input_email'] : $options['error_text'];\n    } else if ($options['type'] == 'number') {\n        $options['error_text'] = empty($options['error_text']) ? $locale['error_input_number'] : $options['error_text'];\n    } else if ($options['type'] == 'url') {\n        $options['error_text'] = empty($options['error_text']) ? $locale['error_input_url'] : $options['error_text'];\n    } else if ($options['regex']) {\n        $options['error_text'] = empty($options['error_text']) ? $locale['error_input_regex'] : $options['error_text'];\n    } else if ($options['safemode']) {\n        $options['error_text'] = empty($options['error_text']) ? $locale['error_input_safemode'] : $options['error_text'];\n    } else {\n        $options['error_text'] = empty($options['error_text']) ? $locale['error_input_default'] : $options['error_text'];\n    }\n\n    $error_class = \"\";\n    if (\\defender::inputHasError($input_name)) {\n        $error_class = \" has-error\";\n        if (!empty($options['error_text'])) {\n            $new_error_text = \\defender::getErrorText($input_name);\n            if (!empty($new_error_text)) {\n                $options['error_text'] = $new_error_text;\n            }\n            addNotice(\"danger\", \"<strong>$title</strong> - \".$options['error_text']);\n        }\n    }\n\n    $min = '';\n    $max = '';\n    $step = '';\n    switch ($options['type']) {\n        case \"number\":\n            $input_type = \"number\";\n            $min = ((!empty($options['number_min']) || $options['number_min'] === \"0\") && isnum($options['number_min']) ? \"min='\".$options['number_min'].\"' \" : '');\n            $max = ((!empty($options['number_max']) || $options['number_max'] === \"0\") && isnum($options['number_max']) ? \"max='\".$options['number_max'].\"' \" : '');\n            // $step = \"step='\".str_replace(\",\", \".\", $options['number_step']).\"' \";\n            $step = \"step='any' \";\n            break;\n        case \"text\":\n            $input_type = \"text\";\n            break;\n        case \"password\":\n            $input_type = \"password\";\n\n            if ($options['password_toggle'] == TRUE) {\n                if (!defined('PWTOGGLE')) {\n                    define('PWTOGGLE', TRUE);\n                    add_to_footer(\"<script>function togglePasswordInput(button_id, field_id) {var button=$('#'+button_id);var input=$('#'+field_id);if(input.attr('type')=='password'){input.attr('type','text');button.text('\".$locale['hide'].\"');}else{input.attr('type','password');button.text('\".$locale['show'].\"');}}</script>\");\n                }\n\n                $options['append_button'] = TRUE;\n                $options['append_type'] = \"button\";\n                $options['append_form_value'] = 'show';\n                $options['append_class'] = 'btn-default';\n                $options['append_value'] = $locale['show'];\n                $options['append_button_name'] = $options['input_id'].'_pwdToggle';\n                $options['append_button_id'] = $options['input_id'].'_pwdToggle';\n                add_to_jquery(\"\n                    $('#\".$options['input_id'].\"_pwdToggle').bind('click', function(e) {\n                        togglePasswordInput('\".$options['input_id'].\"_pwdToggle', '\".$options['input_id'].\"');\n                    });\n                \");\n            }\n            break;\n        default:\n            $input_type = \"text\";\n    }\n\n    // Fixes HTML DOM type number that does not respect max_length prop.\n    $max_length = '';\n    if ($options['max_length'] && isnum($options['max_length'])) {\n        $max_length = ' maxlength=\"'.$options['max_length'].'\"';\n        if ($input_type == 'number') {\n            $max_length .= ' oninput=\"javascript: if (this.value.length > this.maxLength) this.value = this.value.slice(0, this.maxLength);\"';\n        }\n    }\n\n    if ($options['password_strength'] == TRUE) {\n        if (!defined('PWSTRENGTH')) {\n            define('PWSTRENGTH', TRUE);\n\n            if (file_exists(DYNAMICS.\"assets/password/lang/\".$locale['password_strength'].\".js\")) {\n                $path = DYNAMICS.\"assets/password/lang/\".$locale['password_strength'].\".js\";\n            } else {\n                $path = DYNAMICS.\"assets/password/lang/en.js\";\n            }\n\n            add_to_footer(\"<script type='text/javascript' src='$path'></script>\");\n            add_to_footer(\"<script src='\".DYNAMICS.\"assets/password/i18next.js'></script>\");\n            add_to_footer(\"<script src='\".DYNAMICS.\"assets/password/pwstrength-bootstrap.min.js'></script>\");\n        }\n\n        add_to_jquery(\"\n            i18next.init({\n                lng: '\".$locale['password_strength'].\"',resources: {\".$locale['password_strength'].\": {translation: pwstrength_locale}}\n            }, function () {\n                var options = {};\n                options.ui = {\n                    \".(!defined('BOOTSTRAP4') ? 'bootstrap3: true,' : '').\"\n                    container: '#\".$options['input_id'].\"-field',\n                    showVerdictsInsideProgressBar: true,\n                    viewports: {\n                        progress: '.pwstrength_viewport_progress'\n                    }\n                };\n\n                $('#\".$options['input_id'].\"').pwstrength(options);\n            });\n        \");\n    }\n\n    $html = \"<div id='\".$options['input_id'].\"-field' class='form-group \".($options['inline'] && $label ? 'row ' : '').($error_class ? $error_class : '').($options['class'] ? ' '.$options['class'] : '').($options['icon'] ? ' has-feedback' : '').\"'\".($options['width'] && !$label ? \" style='width: \".$options['width'].\"'\" : '').\">\";\n    $html .= ($label) ? \"<label class='control-label \".($options['inline'] ? \"col-xs-12 col-sm-12 col-md-3 col-lg-3\" : '').\"' for='\".$options['input_id'].\"'>\".$options['label_icon'].$label.($options['required'] ? \"<span class='required'>&nbsp;*</span>\" : '').\" \".($options['tip'] ? \"<i class='pointer fa fa-question-circle' title='\".$options['tip'].\"'></i>\" : '').\"</label>\" : '';\n    $html .= ($options['inline'] && $label) ? \"<div class='col-xs-12 col-sm-12 col-md-9 col-lg-9'>\" : \"\";\n\n    $html .= ($options['append_button'] || $options['prepend_button'] || $options['append_value'] || $options['prepend_value']) ? \"<div class='input-group\".($options['group_size'] ? ' input-group-'.$options['group_size'] : '').\"' \".($options['width'] ? \"style='width: \".$options['width'].\"'\" : '').\">\" : \"\";\n\n    if ($options['prepend_button'] && $options['prepend_type'] && $options['prepend_form_value'] && $options['prepend_class'] && $options['prepend_value']) {\n        $html .= \"<span class='input-group-btn input-group-prepend'>\";\n        $html .= \"<button id='\".$options['prepend_button_id'].\"' name='\".$options['prepend_button_name'].\"' type='\".$options['prepend_type'].\"' value='\".$options['prepend_form_value'].\"' class='btn \".$options['prepend_size'].\" \".$options['prepend_class'].\"'>\".$options['prepend_value'].\"</button>\";\n        $html .= \"</span>\\n\";\n    } else if ($options['prepend_value']) {\n        $html .= \"<span class='input-group-addon input-group-prepend' id='\".$options['prepend_id'].\"'><span class='input-group-text'>\".$options['prepend_value'].\"</span></span>\";\n    }\n\n    $html .= \"<input type='\".$input_type.\"' data-type='\".$input_type.\"' \".(!empty($options_data) ? implode(' ', $options_data) : '').\" \".$min.$max.$step.\"class='form-control textbox \".($options['inner_class'] ? \" \".$options['inner_class'].\" \" : '').\"' \".($options['inner_width'] ? \"style='width:\".$options['inner_width'].\";'\" : '').$max_length.\" name='\".$input_name.\"' id='\".$options['input_id'].\"' value='\".$input_value.\"'\".($options['placeholder'] ? \" placeholder='\".$options['placeholder'].\"' \" : '').\"\".($options['autocomplete_off'] ? \" autocomplete='off'\" : '').\" \".($options['deactivate'] ? 'readonly' : '').\">\";\n\n    if ($options['append_button'] && $options['append_type'] && $options['append_form_value'] && $options['append_class'] && $options['append_value']) {\n        $html .= \"<span class='input-group-btn input-group-append'>\";\n        $html .= \"<button id='\".$options['append_button_id'].\"' name='\".$options['append_button_name'].\"' type='\".$options['append_type'].\"' value='\".$options['append_form_value'].\"' class='btn \".$options['append_size'].\" \".$options['append_class'].\"'>\".$options['append_value'].\"</button>\";\n        $html .= \"</span>\\n\";\n\n    } else if ($options['append_value']) {\n        $html .= \"<span class='input-group-addon input-group-append' id='\".$options['append_id'].\"'><span class='input-group-text'>\".$options['append_value'].\"</span></span>\";\n    }\n\n    $html .= ($options['feedback_icon'] ? \"<div class='form-control-feedback' style='top:0;'><i class='\".$options['icon'].\"'></i></div>\" : '');\n\n    $html .= $options['stacked'];\n\n    $html .= ($options['append_button'] || $options['prepend_button'] || $options['append_value'] || $options['prepend_value']) ? \"</div>\" : \"\";\n\n    $html .= $options['ext_tip'] ? \"<br/>\\n<span class='tip'><i>\".$options['ext_tip'].\"</i></span>\" : \"\";\n\n    $html .= (\\defender::inputHasError($input_name) ? \"<div class='input-error\".((!$options['inline'] || $options['append_button'] || $options['prepend_button'] || $options['append_value'] || $options['prepend_value']) ? \" display-block\" : \"\").\"'><div id='\".$options['input_id'].\"-help' class='label label-danger p-5 display-inline-block'>\".$options['error_text'].\"</div></div>\" : \"\");\n\n    $html .= $options['append_html'];\n\n    $html .= ($options['password_strength'] == TRUE ? '<div class=\"m-t-5 pwstrength_viewport_progress\"></div>' : \"\");\n\n    $html .= (($options['inline'] && $label) ? \"</div>\" : \"\");\n\n    $html .= \"</div>\";\n\n    // Add input settings in the SESSION\n    \\defender::add_field_session([\n        'input_name'     => clean_input_name($input_name),\n        'title'          => clean_input_name($title),\n        'id'             => $options['input_id'],\n        'type'           => $options['type'],\n        'required'       => $options['required'],\n        'safemode'       => $options['safemode'],\n        'regex'          => $options['regex'],\n        'callback_check' => $options['callback_check'],\n        'delimiter'      => $options['delimiter'],\n        'min_length'     => $options['min_length'],\n        'max_length'     => $options['max_length'],\n        'censor_words'   => $options['censor_words'],\n        'descript'       => $options['descript']\n    ]);\n\n    // This should affect all number inputs by type, not by ID\n    if ($options['type'] == 'number' && !defined('NUMBERS_ONLY_JS')) {\n        define('NUMBERS_ONLY_JS', TRUE);\n        add_to_jquery(\"$('input[data-type=\\\"number\\\"]').keypress(function(e) {\n        var key_codes = [96, 97, 98, 99, 100, 101, 102, 103, 44, 46, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 0, 8];\n        if (!($.inArray(e.which, key_codes) >= 0)) { e.preventDefault(); }\n        });\\n\");\n    }\n\n    // Live Regex Error Check\n    if ($options['regex'] && $options['regex_error_text']) {\n\n        add_to_jquery(\"\n        $('#\".$options['input_id'].\"').blur(function(ev) {\n            var Inner_Object = $(this).parent('div').find('.label-danger');\n            var Outer_Object = $(this).parent('div').find('.input-error');\n            if (!$(this).val().match(/\".$options['regex'].\"/g) && $(this).val()) {\n                var ErrorText = '\".$options['regex_error_text'].\"';\n                var ErrorDOM = '<div class=\\'input-error spacer-xs\\'><div class=\\'label label-danger p-5\\'>'+ ErrorText +'</div></div>';\n                if (Inner_Object.length > 0) {\n                    object.html(ErrorText);\n                } else {\n                    $(this).after(function() {\n                        return ErrorDOM;\n                    });\n                }\n            } else {\n               Outer_Object.remove();\n            }\n        });\n        \");\n    }\n\n    if ($options['autocomplete_off']) {\n        // Delay by 20ms and reset values.\n        add_to_jquery(\"\n            $('#\".$options['input_id'].\"').val(' ');\n            setTimeout( function(){ $('#\".$options['input_id'].\"').val(''); }, 20);\n        \");\n    }\n\n    return $html;\n}\n", "<?php\n/*-------------------------------------------------------+\n| PHPFusion Content Management System\n| Copyright (C) PHP Fusion Inc\n| https://phpfusion.com/\n+--------------------------------------------------------+\n| Filename: form_textarea.php\n| Author: Frederick MC Chan (Chan)\n+--------------------------------------------------------+\n| This program is released as free software under the\n| Affero GPL license. You can redistribute it and/or\n| modify it under the terms of this license which you\n| can read by viewing the included agpl.txt or online\n| at www.gnu.org/licenses/agpl.html. Removal of this\n| copyright header is strictly prohibited without\n| written permission from the original author(s).\n+--------------------------------------------------------*/\nfunction form_textarea($input_name, $label = '', $input_value = '', array $options = []) {\n\n    $locale = fusion_get_locale('', [\n        LOCALE.LOCALESET.\"admin/html_buttons.php\",\n        LOCALE.LOCALESET.\"error.php\"\n    ]);\n\n    require_once INCLUDES.\"bbcode_include.php\";\n    require_once INCLUDES.\"html_buttons_include.php\";\n\n    $title = $label ? stripinput($label) : ucfirst(strtolower(str_replace(\"_\", \" \", $input_name)));\n\n    $input_name = (isset($input_name) && (!empty($input_name))) ? stripinput($input_name) : \"\";\n\n    if (!empty($options['bbcode'])) {\n        $options['type'] = \"bbcode\";\n    } else if (!empty($options['html'])) {\n        $options['type'] = \"html\";\n    }\n\n    $default_options = [\n        'input_id'            => $input_name,\n        'type'                => '',\n        'inline_editing'      => FALSE,\n        'required'            => FALSE,\n        'tinymce_forced_root' => TRUE,\n        'placeholder'         => '',\n        'deactivate'          => FALSE,\n        'width'               => '',\n        'inner_width'         => '100%',\n        'height'              => '200px',\n        'class'               => '',\n        'inner_class'         => '',\n        'inline'              => FALSE,\n        'length'              => 200,\n        'error_text'          => $locale['error_input_default'],\n        'safemode'            => FALSE,\n        'form_name'           => 'input_form',\n        'tinymce'             => 'simple',\n        'tinymce_css'         => '',\n        'tinymce_image'       => TRUE, // Turns on or off the image selection feature in TinyMCE\n        'no_resize'           => FALSE,\n        'autosize'            => FALSE,\n        'bbcode'              => FALSE,\n        'html'                => FALSE,\n        'preview'             => FALSE,\n        'path'                => IMAGES,\n        'maxlength'           => '',\n        'tip'                 => '',\n        'ext_tip'             => '',\n        'input_bbcode'        => '',\n        'wordcount'           => FALSE,\n        'file_filter'         => ['.png', '.PNG', '.svg', '.SVG', '.bmp', '.BMP', '.jpg', '.JPG', '.jpeg', '.gif', '.GIF', '.tiff', '.TIFF'],\n        'tinymce_theme'       => 'modern',\n        'tinymce_skin'        => 'lightgray',\n        'tinymce_spellcheck'  => TRUE,\n        'rows'                => 5,\n        'censor_words'        => TRUE,\n        'descript'            => TRUE\n    ];\n\n    $options += $default_options;\n\n    $input_value = clean_input_value($input_value);\n\n\n    if ($options['type'] == \"tinymce\") {\n\n        $options['tinymce'] = !empty($options['tinymce']) && in_array($options['tinymce'], [TRUE, 'simple', 'advanced']) ? $options['tinymce'] : \"simple\";\n\n        $default_tinymce_css = (defined(\"ADMIN_PANEL\") && file_exists(THEMES.\"admin_themes/\".fusion_get_settings(\"admin_theme\").\"/tinymce.css\") ? THEMES.\"admin_themes/\".fusion_get_settings(\"admin_theme\").\"/tinymce.css\" : THEMES.\"templates/tinymce.css\");\n\n        $options['tinymce_css'] = (!empty($options['tinymce_css']) && file_exists($options['tinymce_css']) ? $options['tinymce_css'] : $default_tinymce_css);\n\n        $options['tinymce_spellcheck'] = $options['tinymce_spellcheck'] == TRUE ? 'true' : 'false';\n\n        $tinymce_list = [];\n        if (!empty($options['path']) && $options['tinymce_image'] == TRUE) {\n            $image_list = [];\n            if (is_array($options['path'])) {\n                foreach ($options['path'] as $dir) {\n                    if (file_exists($dir) && is_dir($dir)) {\n                        $image_list[$dir] = makefilelist($dir, \".|..|\");\n                    }\n                }\n            } else {\n                if (file_exists($options['path']) && is_dir($options['path'])) {\n                    $image_list[$options['path']] = makefilelist($options['path'], '.|..|');\n                }\n            }\n            foreach ($image_list as $key => $images) {\n                foreach ($images as $keys => $image_name) {\n                    $image_1 = explode('.', $image_name);\n                    $last_str = count($image_1) - 1;\n                    if (in_array(\".\".$image_1[$last_str], $options['file_filter'])) {\n                        $tinymce_list[] = ['title' => $image_name, 'value' => $key.$image_name];\n                    }\n                }\n            }\n        }\n\n        $tinymce_list = json_encode($tinymce_list);\n        $tinymce_smiley_vars = \"\";\n        if (!defined('tinymce')) {\n            add_to_head('<script src=\"'.INCLUDES.'jquery/jquery-ui/jquery-ui.min.js\"></script>');\n            add_to_head('<link rel=\"stylesheet\" href=\"'.INCLUDES.'jquery/jquery-ui/jquery-ui.min.css\">');\n            add_to_head('<script src=\"'.INCLUDES.'elFinder/js/elfinder.min.js\"></script>');\n            add_to_head('<link rel=\"stylesheet\" href=\"'.INCLUDES.'elFinder/css/elfinder.min.css\">');\n            add_to_head('<link rel=\"stylesheet\" href=\"'.INCLUDES.'elFinder/css/theme.css\">');\n            add_to_head(\"<script src='\".INCLUDES.\"jscripts/tinymce/tinymce.min.js'></script>\");\n            add_to_head(\"<script src='\".INCLUDES.\"elFinder/js/tinymceElfinder.min.js'></script>\");\n\n            add_to_jquery('\n                const mceElf = new tinymceElfinder({\n                    // connector URL (Set your connector)\n                    url: \"'.fusion_get_settings('siteurl').'includes/elFinder/php/connector.php'.fusion_get_aidlink().'\",\n                    // upload target folder hash for this tinyMCE\n                    uploadTargetHash: \"l1_lw\", // Hash value on elFinder of writable folder\n                    // elFinder dialog node id\n                    nodeId: \"elfinder\", // Any ID you decide\n                        ui: [\"toolbar\", \"tree\", \"path\", \"stat\"],\n                        uiOptions: {\n                            toolbar: [\n                                [\"home\", \"back\", \"forward\", \"up\", \"reload\"],\n                                [\"mkdir\", \"mkfile\", \"upload\"],\n                                [\"open\"],\n                                [\"copy\", \"cut\", \"paste\", \"rm\", \"empty\"],\n                                [\"duplicate\", \"rename\", \"edit\", \"resize\", \"chmod\"],\n                                [\"quicklook\", \"info\"],\n                                [\"extract\", \"archive\"],\n                                [\"search\"],\n                                [\"view\", \"sort\"],\n                                [\"preference\", \"help\"]\n                            ]\n                        }\n                });\n            ');\n\n            define('tinymce', TRUE);\n            // PHPFusion Parse Cache Smileys\n            $smileys = cache_smileys();\n            $tinymce_smiley_vars = \"\";\n            if (!empty($smileys)) {\n                $tinymce_smiley_vars = \"var shortcuts = {\\n\";\n                foreach ($smileys as $params) {\n                    $tinymce_smiley_vars .= \"'\".strtolower($params['smiley_code']).\"' : '<img alt=\\\"\".$params['smiley_text'].\"\\\" src=\\\"\".IMAGES.\"smiley/\".$params['smiley_image'].\"\\\"/>',\\n\";\n                }\n                $tinymce_smiley_vars .= \"};\\n\";\n                $tinymce_smiley_vars .= \"\n                ed.on('keyup', function(e){\n                    var marker = tinymce.activeEditor.selection.getBookmark();\n                    // Store editor contents\n                    var content = tinymce.activeEditor.getContent({'format':'raw'});\n                    // Loop through all shortcuts\n                    for(var key in shortcuts){\n                        // Check if the editor html contains the looped shortcut\n                        if(content.toLowerCase().indexOf(key) != -1) {\n                            // Escaping special characters to be able to use the shortcuts in regular expression\n                            var k = key.replace(/[<>*()?']/ig, \\\"\\\\$&\\\");\n                            tinymce.activeEditor.setContent(content.replace(k, shortcuts[key]));\n                        }\n                    }\n                    // Now put cursor back where it was\n                    tinymce.activeEditor.selection.moveToBookmark(marker);\n                });\n                \";\n            }\n        }\n\n        $images = '';\n\n        if ($options['tinymce_image']) {\n            $images = \"file_picker_callback : mceElf.browser,\";\n        }\n\n        // Mode switching for TinyMCE\n        switch ($options['tinymce']) {\n            case 'advanced':\n                add_to_jquery(\"\n                tinymce.init({\n                    \".$images.\"\n                    relative_urls: false,\n                    remove_script_host: false,\n                    selector: '#\".$options['input_id'].\"',\n                    inline: \".($options['inline_editing'] == TRUE ? \"true\" : \"false\").\",\n                    theme: '\".$options['tinymce_theme'].\"',\n                    skin: '\".(defined('TINYMCE_SKIN') ? TINYMCE_SKIN : $options['tinymce_skin']).\"',\n                    \".(defined('TINYMCE_SKIN_PATH') ? \"skin_url: '\".TINYMCE_SKIN_PATH.\"', \" : '').\"\n                    browser_spellcheck: \".$options['tinymce_spellcheck'].\",\n                    entity_encoding: 'raw',\n                    language:'\".$locale['tinymce'].\"',\n                    directionality : '\".$locale['text-direction'].\"',\n                    \".($options['tinymce_forced_root'] ? \"forced_root_block: '',\" : '').\"\n                    width: '100%',\n                    height: 300,\n                    plugins: [\n                        'advlist autolink \".($options['autosize'] ? \" autoresize \" : \"\").\" link image lists charmap print preview hr anchor pagebreak spellchecker',\n                        'searchreplace wordcount visualblocks visualchars code fullscreen insertdatetime media nonbreaking',\n                        'save table contextmenu directionality template paste textcolor \".($options['inline_editing'] ? \" save \" : \"\").\"'\n                    ],\n                    image_list: $tinymce_list,\n                    content_css: '\".$options['tinymce_css'].\"',\n                    toolbar1: '\".($options['inline_editing'] ? \" save \" : \"\").\" insertfile undo redo | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | newdocument fullscreen preview cut copy paste pastetext spellchecker searchreplace code',\n                    toolbar2: 'styleselect formatselect removeformat | fontselect fontsizeselect bold italic underline strikethrough subscript superscript blockquote | forecolor backcolor',\n                    toolbar3: 'hr pagebreak insertdatetime | link unlink anchor | image media | table charmap visualchars visualblocks emoticons',\n                    image_advtab: true,\n                    style_formats: [\n                        {title: 'Bold text', inline: 'b'},\n                        {title: 'Red text', inline: 'span', styles: {color: '#ff0000'}},\n                        {title: 'Red header', block: 'h1', styles: {color: '#ff0000'}},\n                        {title: 'Example 1', inline: 'span', classes: 'example1'},\n                        {title: 'Example 2', inline: 'span', classes: 'example2'},\n                        {title: 'Table styles'},\n                        {title: 'Table row 1', selector: 'tr', classes: 'tablerow1'}\n                    ],\n                    setup: function(ed) {\n                        // add tabkey listener\n                        ed.on('keydown', function(event) {\n                            if (event.keyCode == 9) { // tab pressed\n                                if (event.shiftKey) { ed.execCommand('Outdent'); } else { ed.execCommand('Indent'); }\n                                event.preventDefault();\n                                return false;\n                            }\n                        });\n                        // auto smileys parsing\n                        \".$tinymce_smiley_vars.\"\n                    }\n                });\n                \");\n                break;\n            case 'simple':\n                add_to_jquery(\"\n                tinymce.init({\n                    \".$images.\"\n                    relative_urls: false,\n                    remove_script_host: false,\n                    selector: '#\".$options['input_id'].\"',\n                    inline: \".($options['inline_editing'] == TRUE ? \"true\" : \"false\").\",\n                    theme: '\".$options['tinymce_theme'].\"',\n                    skin: '\".(defined('TINYMCE_SKIN') ? TINYMCE_SKIN : $options['tinymce_skin']).\"',\n                    \".(defined('TINYMCE_SKIN_PATH') ? \"skin_url: '\".TINYMCE_SKIN_PATH.\"', \" : '').\"\n                    browser_spellcheck: \".$options['tinymce_spellcheck'].\",\n                    entity_encoding: 'raw',\n                    menubar: false,\n                    statusbar: false,\n                    content_css: '\".$options['tinymce_css'].\"',\n                    image_list: $tinymce_list,\n                    plugins: [\n                        'advlist autolink \".($options['autosize'] ? \" autoresize \" : \"\").\" link image lists charmap print preview hr anchor pagebreak spellchecker',\n                        'searchreplace wordcount visualblocks visualchars code fullscreen insertdatetime media nonbreaking',\n                        'contextmenu directionality template paste\".($options['bbcode'] ? \" bbcode \" : \"\").($options['autosize'] ? \" autoresize \" : \"\").($options['inline_editing'] ? \" save \" : \"\").\"'\n                    ],\n                    width: '100%',\n                    height: 100,\n                    image_advtab: true,\n                    toolbar1: 'undo redo | bold italic underline | emoticons | visualblocks | bullist numlist blockquote | hr \".($options['tinymce_image'] ? \" image \" : \"\").\" | fullscreen \".($options['inline_editing'] ? \" save \" : \"\").\" | code',\n                    language: '\".$locale['tinymce'].\"',\n                    directionality : '\".$locale['text-direction'].\"',\n                    \".($options['tinymce_forced_root'] ? \"forced_root_block: '',\" : '').\"\n                    object_resizing: \".($options['autosize'] ? \"false\" : \"true\").\",\n                    resize: \".($options['autosize'] ? \"false\" : \"true\").\",\n                    setup: function(ed) {\n                        // add tabkey listener\n                        ed.on('keydown', function(event) {\n                            if (event.keyCode == 9) { // tab pressed\n                                if (event.shiftKey) { ed.execCommand('Outdent'); } else { ed.execCommand('Indent'); }\n                                event.preventDefault();\n                                return false;\n                            }\n                        });\n                        // auto smileys parsing\n                        \".$tinymce_smiley_vars.\"\n                    }\n                });\n\n                $('#inject').bind('click', function () {\n                    tinyMCE.activeEditor.execCommand(\\\"mceInsertContent\\\", true, '[b]I am injecting in stuff..[/b]');\n                });\n                \");\n                break;\n            case 'default':\n                add_to_jquery(\"\n                tinymce.init({\n                    \".$images.\"\n                    relative_urls: false,\n                    remove_script_host: false,\n                    selector: '#\".$options['input_id'].\"',\n                    inline: \".($options['inline_editing'] == TRUE ? \"true\" : \"false\").\",\n                    content_css: '\".$options['tinymce_css'].\"',\n                    theme: '\".$options['tinymce_theme'].\"',\n                    skin: '\".(defined('TINYMCE_SKIN') ? TINYMCE_SKIN : $options['tinymce_skin']).\"',\n                    \".(defined('TINYMCE_SKIN_PATH') ? \"skin_url: '\".TINYMCE_SKIN_PATH.\"', \" : '').\"\n                    browser_spellcheck: \".$options['tinymce_spellcheck'].\",\n                    entity_encoding: 'raw',\n                    language:'\".$locale['tinymce'].\"',\n                    directionality : '\".$locale['text-direction'].\"',\n                    \".($options['tinymce_forced_root'] ? \"forced_root_block: '',\" : '').\"\n                    setup: function(ed) {\n                        // add tabkey listener\n                        ed.on('keydown', function(event) {\n                            if (event.keyCode == 9) { // tab pressed\n                                if (event.shiftKey) { ed.execCommand('Outdent'); } else { ed.execCommand('Indent'); }\n                                event.preventDefault();\n                                return false;\n                            }\n                        });\n                        // auto smileys parsing\n                        \".$tinymce_smiley_vars.\"\n                    }\n                });\n                \");\n                break;\n        }\n    } else {\n\n        if ($options['bbcode']) {\n            $options['type'] = 'bbcode';\n        } else if ($options['html']) {\n            $options['type'] = 'html';\n        }\n\n        if ($options['autosize'] || defined('AUTOSIZE')) {\n            add_to_footer(\"<script src='\".DYNAMICS.\"assets/autosize/autosize.min.js'></script>\");\n            add_to_jquery(\"autosize($('#\".$options['input_id'].\"'));\");\n        }\n    }\n\n    if ($input_value) {\n        $input_value = html_entity_decode(stripslashes($input_value), ENT_QUOTES, $locale['charset']);\n        $input_value = htmlspecialchars_decode($input_value);\n    }\n\n    $error_class = \"\";\n    if (\\defender::inputHasError($input_name)) {\n        $error_class = \" has-error\";\n        if (!empty($options['error_text'])) {\n            $new_error_text = \\defender::getErrorText($input_name);\n            if (!empty($new_error_text)) {\n                $options['error_text'] = $new_error_text;\n            }\n            addNotice(\"danger\", \"<strong>$title</strong> - \".$options['error_text']);\n        }\n    }\n\n    $html = \"<div id='\".$options['input_id'].\"-field' class='form-group \".($options['inline'] && $label ? 'row' : '').$error_class.$options['class'].\"'\".($options['width'] ? \" style='width: \".$options['width'].\" !important;'\" : '').\">\\n\";\n    $html .= ($label) ? \"<label class='control-label \".($options['inline'] ? \"col-xs-12 col-sm-3 col-md-3 col-lg-3\" : '').\"' for='\".$options['input_id'].\"'>\".$label.($options['required'] == 1 ? \"<span class='required'>&nbsp;*</span>\" : '').\" \".($options['tip'] ? \"<i class='pointer fa fa-question-circle' title='\".$options['tip'].\"'></i>\" : '').\"</label>\\n\" : '';\n    $html .= ($options['inline']) ? \"<div class='clearfix\".($label ? ' col-xs-12 col-sm-9 col-md-9 col-lg-9' : '').\"'>\\n\" : '';\n    $tab_active = 0;\n    $tab_title = [];\n    if ($options['preview'] && ($options['type'] == \"html\" || $options['type'] == \"bbcode\")) {\n        $tab_title['title'][] = $locale['preview'];\n        $tab_title['id'][] = \"prw-\".$options['input_id'];\n        $tab_title['icon'][] = '';\n        $tab_title['title'][] = $locale['texts'];\n        $tab_title['id'][] = \"txt-\".$options['input_id'];\n        $tab_title['icon'][] = '';\n        $tab_active = tab_active($tab_title, 1);\n    }\n\n    $html .= ($options['type'] == \"html\" || $options['type'] == \"bbcode\") ? \"<div class='panel panel-default panel-txtarea m-b-0' \".($options['preview'] ? \"style='border-radius:0;'\" : '').\">\\n\n    <div class='panel-heading clearfix'>\\n\" : '';\n\n    if ($options['preview'] && ($options['type'] == \"bbcode\" || $options['type'] == \"html\")) {\n        $html .= openeditortab($tab_title, $tab_active, $options['input_id'].\"-link\", \"\", \"editor-wrapper\");\n    }\n\n    if ($options['type'] == \"bbcode\" && $options['form_name']) {\n        $html .= \"<div class='bbcode_input'>\\n\";\n        $html .= display_bbcodes('100%', $options['input_id'], $options['form_name'], $options['input_bbcode']);\n        $html .= $options['preview'] ? \"</div>\\n\" : \"\";\n    } else if ($options['type'] == \"html\" && $options['form_name']) {\n        $html .= \"<div class='m-t-10 m-b-10'>\\n\";\n        $html .= display_html($options['form_name'], $options['input_id'], TRUE, TRUE, TRUE, $options['path']); // @todo: image_path to be turned off by default\n        $html .= $options['preview'] ? \"</div>\\n\" : \"\";\n    }\n\n    $html .= ($options['type'] == \"html\" || $options['type'] == \"bbcode\") ? \"</div>\\n</div>\\n<div class='panel-body p-0'>\\n\" : '';\n\n    if ($options['preview'] && ($options['type'] == \"bbcode\" || $options['type'] == \"html\")) {\n        $html .= \"<div id='tab-content-\".$options['input_id'].\"-link' class='tab-content p-0'>\\n\";\n        $html .= opentabbody($tab_title['title'][1], \"txt-\".$options['input_id'], $tab_active);\n    }\n\n    if ($options['inline_editing'] == TRUE) {\n        $html .= \"<div id='\".$options['input_id'].\"' \".($options['width'] ? \"style='display:block; width: \".$options['width'].\";'\" : '').\">\".$input_value.\"</div>\\n\";\n    } else {\n        $html .= \"<textarea name='$input_name' style='display:block; width: \".$options['inner_width'].\"; height:\".$options['height'].\";\".($options['no_resize'] ? ' resize: none;' : '').\"' rows='\".$options['rows'].\"' cols='' class='form-control m-0 \".($options['inner_class'] ? \" \".$options['inner_class'].\" \" : '').($options['autosize'] ? 'animated-height' : '').\" \".(($options['type'] == \"html\" || $options['type'] == \"bbcode\") ? \"no-shadow no-border\" : '').\" textbox'\".($options['placeholder'] ? \" placeholder='\".$options['placeholder'].\"' \" : '').\" id='\".$options['input_id'].\"'\".($options['deactivate'] ? ' readonly' : '').\" \".($options['maxlength'] ? \" maxlength='\".$options['maxlength'].\"'\" : '').\">\".$input_value.\"</textarea>\\n\";\n    }\n\n    if ($options['preview'] && ($options['type'] == \"bbcode\" || $options['type'] == \"html\")) {\n        $html .= closetabbody();\n        $html .= opentabbody($tab_title['title'][0], \"prw-\".$options['input_id'].\"\", $tab_active);\n        $html .= $locale['global_003'];\n        $html .= closetabbody();\n        $html .= \"</div>\\n\";\n        add_to_jquery(\"\n            // preview syntax\n            var form = $('#\".$options['form_name'].\"');\n            $('#tab-prw-\".$options['input_id'].\"').bind('click',function(){\n            var text = $('#\".$options['input_id'].\"').val();\n            var format = '\".($options['type'] == \"bbcode\" ? 'bbcode' : 'html').\"';\n            var data = {\n                \".(defined('ADMIN_PANEL') ? \"'mode': 'admin', \" : \"\").\"\n                'text' : text,\n                'editor' : format,\n                'url' : '\".$_SERVER['REQUEST_URI'].\"',\n                'form_id' : 'prw-\".$options['form_name'].\"',\n                'fusion_token' : '\".fusion_get_token(\"prw-\".$options['form_name'], 30).\"'\n            };\n            var sendData = form.serialize() + '&' + $.param(data);\n            $.ajax({\n                url: '\".FUSION_ROOT.INCLUDES.\"dynamics/assets/preview/preview.ajax.php',\n                type: 'POST',\n                dataType: 'html',\n                data : sendData,\n                success: function(result) {\n                    //console.log(result);\n                    $('#prw-\".$options['input_id'].\"').html(result);\n                },\n                error: function(result) {\n                    alert('\".$locale['error_preview'].\"' + '\\\\n\".$locale['error_preview_text'].\"');\n                }\n                });\n            });\n        \");\n    }\n\n    if (($options['type'] == \"html\" || $options['type'] == \"bbcode\") && $options['wordcount'] === TRUE) {\n        $html .= \"</div>\\n<div class='panel-footer clearfix'>\\n\";\n        $html .= \"<div class='overflow-hide'><i><small>\".$locale['word_count'].\": <span id='\".$options['input_id'].\"-wordcount'></span></small></i></div>\";\n        add_to_jquery(\"\n        if ($('#\".$options['input_id'].\"').length) {\n            var init_str = $('#\".$options['input_id'].\"').val().replace(/<[^>]+>/ig, '').replace(/\\\\n/g,'').replace(/ /g, '').length;\n            $('#\".$options['input_id'].\"-wordcount').text(init_str);\n        }\n        $('#\".$options['input_id'].\"').on('input propertychange paste', function() {\n        var str = $(this).val().replace(/<[^>]+>/ig, '').replace(/\\\\n/g,'').replace(/ /g, '').length;\n        $('#\".$options['input_id'].\"-wordcount').text(str);\n        });\n        \");\n        $html .= \"</div>\\n<!---panel-footer-->\";\n    }\n    if ((!$options['type'] == \"bbcode\" && !$options['type'] == \"html\")) {\n        $html .= $options['ext_tip'] ? \"<span class='tip'><i>\".$options['ext_tip'].\"</i></span>\" : \"\";\n    }\n    $html .= $options['inline'] ? \"</div>\\n\" : '';\n    if (($options['type'] == \"bbcode\" || $options['type'] == \"html\")) {\n        if ($options['wordcount']) {\n            $html .= \"</div>\\n\";\n            $html .= $options['ext_tip'] ? \"<br/>\\n<span class='tip'><i>\".$options['ext_tip'].\"</i></span>\" : \"\";\n\n        } else {\n            $html .= \"</div>\\n\";\n            $html .= \"</div>\\n\";\n            $html .= $options['ext_tip'] ? \"<br/>\\n<span class='tip'><i>\".$options['ext_tip'].\"</i></span>\" : \"\";\n\n        }\n    }\n\n    $html .= (($options['required'] == 1 && \\defender::inputHasError($input_name)) || \\defender::inputHasError($input_name)) ? \"<div id='\".$options['input_id'].\"-help' class='label label-danger text-white p-5 display-inline-block'>\".$options['error_text'].\"</div>\" : \"\";\n    $html .= \"</div>\\n\";\n\n    \\defender::add_field_session([\n        'input_name'   => clean_input_name($input_name),\n        'type'         => 'textarea',\n        'title'        => $label,\n        'id'           => $options['input_id'],\n        'required'     => $options['required'],\n        'safemode'     => $options['safemode'],\n        'error_text'   => $options['error_text'],\n        'censor_words' => $options['censor_words'],\n        'descript'     => $options['descript']\n    ]);\n\n    return $html;\n}\n\nfunction openeditortab($tab_title, $link_active_arrkey, $id, $link = FALSE, $class = FALSE, $getname = \"section\") {\n    $link_mode = $link ? $link : 0;\n    $html = \"<div class='nav-wrapper $class'>\\n\";\n    $html .= \"<ul class='nav' \".($id ? \"id='\".$id.\"'\" : \"\").\" >\\n\";\n    if (!empty($tab_title['title'])) {\n        foreach ($tab_title['title'] as $arr => $v) {\n            $v_title = str_replace(\"-\", \" \", $v);\n            $tab_id = $tab_title['id'][$arr];\n            $icon = (isset($tab_title['icon'][$arr])) ? $tab_title['icon'][$arr] : \"\";\n            $link_url = $link ? clean_request($getname.'='.$tab_id, [$getname], FALSE) : '#';\n            if ($link_mode) {\n                $html .= ($link_active_arrkey == $tab_id) ? \"<li class='active m-r-10'>\\n\" : \"<li class='m-r-10'>\\n\";\n            } else {\n                $html .= ($link_active_arrkey == \"\".$tab_id) ? \"<li class='active m-r-10'>\\n\" : \"<li  class='m-r-10'>\\n\";\n            }\n            $html .= \"<a class='btn btn-default btn-sm m-l-10 pointer' \".(!$link_mode ? \"id='tab-\".$tab_id.\"' data-toggle='tab' data-target='#\".$tab_id.\"'\" : \"href='$link_url'\").\">\\n\".($icon ? \"<i class='\".$icon.\"'></i>\" : '').\" \".$v_title.\" </a>\\n\";\n            $html .= \"</li>\\n\";\n        }\n    }\n    $html .= \"</ul>\\n\";\n\n    return $html;\n}\n", ".label-danger{margin-top:5px}.top-0{top:0!important}.top-5{top:5px!important}.top-10{top:10px!important}.top-20{top:20px!important}.top-30{top:30px!important}.top-40{top:40px!important}.top-50{top:50px!important}.bottom-0{bottom:0!important}.bottom-5{bottom:5px!important}.bottom-10{bottom:10px!important}.bottom-20{bottom:20px!important}.bottom-30{bottom:30px!important}.bottom-40{bottom:40px!important}.bottom-50{bottom:50px!important}.left-0{left:0!important}.left-10{left:10px!important}.left-15{left:15px!important}.left-20{left:20px!important}.left-30{left:30px!important}.left-40{left:40px!important}.left-50{left:50px!important}.right-0{right:0!important}.right-10{right:10px!important}.right-15{right:15px!important}.right-20{right:20px!important}.right-30{right:30px!important}.right-40{right:40px!important}.right-50{right:50px!important}.center-margin-x{margin:0 auto}.row.flexbox{display:-webkit-box;display:flex;overflow:hidden}.row.flexbox.auto_width>div{-webkit-box-flex:1;flex:1}.row.equal-height,.row.equal-height>[class*=col-]{display:-webkit-box;display:flex;flex-wrap:wrap}.row.equal-height>[class*=col-]{-webkit-background-clip:content-box;-o-background-clip:content-box;background-clip:content-box;display:-webkit-flex;-webkit-flex-wrap:wrap;-webkit-box-orient:vertical;-webkit-box-direction:normal;flex-direction:column;-webkit-flex-direction:row}.row.equal-height:after,.row.equal-height:before{content:normal}.row.equal-height>[class*=col-]>*{width:100%}.center-y{position:relative;top:50%;-webkit-transform:translateY(-50%);-ms-transform:translateY(-50%);transform:translateY(-50%)}.center-x,.center-xy{position:relative;left:50%}.center-x{-webkit-transform:translateX(-50%);-ms-transform:translateX(-50%);transform:translateX(-50%)}.center-xy{top:50%;-webkit-transform:translate(-50%,-50%);-ms-transform:translate(-50%,-50%);transform:translate(-50%,-50%)}.align-top,.vt{vertical-align:top!important;display:table-cell}.align-bottom,.align-middle,.va,.vb{vertical-align:middle!important;display:table-cell}.align-bottom,.vb{vertical-align:bottom!important}.align-left{text-align:left}.align-center,.thumb>span{text-align:center}.align-right{text-align:right}.pull-left{float:left}.editor-wrapper>ul>li,.pull-right{float:right}.spacer-xs{margin:15px 0}.spacer-sm{margin:20px 0}.spacer-md{margin:40px 0}.spacer-lg{margin:80px 0}.m-0{margin:0!important}.m-1{margin:1px!important}.m-2{margin:2px!important}.m-3{margin:3px!important}.m-5{margin:5px!important}.m-10{margin:10px!important}.m-b-0{margin-bottom:0!important}.m-b-5{margin-bottom:5px!important}.m-b-10{margin-bottom:10px!important}.m-b-15{margin-bottom:15px!important}.m-b-20{margin-bottom:20px!important}.m-b-50{margin-bottom:50px!important}.m-t-0{margin-top:0!important}.m-t-3{margin-top:3px!important}.m-t-5{margin-top:5px!important}.m-t-10{margin-top:10px!important}.m-t-15{margin-top:15px!important}.m-t-20{margin-top:20px!important}.m-t-30{margin-top:30px!important}.m-l-0{margin-left:0!important}.m-l-5{margin-left:5px!important}.m-l-10{margin-left:10px!important}.m-l-15{margin-left:15px!important}.m-l-20{margin-left:20px!important}.m-l-30{margin-left:30px!important}.m-r-0{margin-right:0!important}.m-r-5{margin-right:5px!important}.m-r-10{margin-right:10px!important}.m-r-15{margin-right:15px!important}.m-r-20{margin-right:20px!important}.m-r-30{margin-right:30px!important}.m-auto{margin:0 auto!important}.m-l--15{margin-left:-15px!important}.m-r--15{margin-right:-15px!important}.p-0{padding:0!important}.p-5{padding:5px!important}.p-10{padding:10px!important}.p-15{padding:15px!important}.p-20{padding:20px!important}.p-25{padding:25px!important}.p-t-0{padding-top:0!important}.p-t-5{padding-top:5px!important}.p-t-10{padding-top:10px!important}.p-t-15{padding-top:15px!important}.p-t-20{padding-top:20px!important}.p-l-0{padding-left:0!important}.p-l-5{padding-left:5px!important}.p-l-10{padding-left:10px!important}.p-l-15{padding-left:15px!important}.p-l-20{padding-left:20px!important}.p-r-0{padding-right:0!important}.p-r-5{padding-right:5px!important}.p-r-10{padding-right:10px!important}.p-r-15{padding-right:15px!important}.p-r-20{padding-right:20px!important}.p-b-0{padding-bottom:0!important}.p-b-5{padding-bottom:5px!important}.p-b-10{padding-bottom:10px!important}.p-b-15{padding-bottom:15px!important}.p-b-20{padding-bottom:20px!important}.overflow-hide{overflow:hidden}.display-none{display:none}.display-block{display:block;width:100%}.display-inline{display:inline}#profile-li>li>a,.display-inline-block{display:inline-block}.display-table{display:table}.display-table-row{display:table-row}.display-table-cell{display:table-cell}.position-relative{position:relative}.position-absolute{position:absolute}.transition{-webkit-transition:all .2s ease-in-out;transition:all .2s ease-in-out}.no-shadow,li.panel{box-shadow:none!important}.bbr-0{border-radius:0!important}.br-0{border:0!important}.br-l-0{border-left:0}.br-r-0{border-right:0}.br-t-0{border-top:0}.br-b-0{border-bottom:0}.text-white{color:#fff!important}.text-dark{color:#333!important}.text-black{color:#444!important}.text-lighter{opacity:.8}.text-darker{opacity:1}.text-bigger{font-size:110%!important}.text-smaller{font-size:85%!important}.font-bold,.strong,.text-bold{font-weight:700!important}.font-light,.text-light{font-weight:300!important}.font-normal,.text-normal{font-weight:400!important;text-transform:none!important;text-decoration:none!important;color:inherit!important}.text-active{color:#428bca}.text-disabled{color:#f7f7f7}.text-serif{font-family:'Times New Roman',Courier,\"Courier New\",serif}.text-uppercase,.uppercase{text-transform:uppercase}.text-capitalize{text-transform:capitalize}.dms-switch:hover,.list-group-item:hover .status,.text-underline{text-decoration:underline}.img-center{display:inline-block;position:relative!important;left:100%!important;margin-left:-200%!important}.thumb>img{height:auto;margin-left:auto;margin-right:auto}.thumb>span{background-color:#ddd}.pdisabled{background-color:#fcf8e3!important;border-color:#faebcc!important}.pdisabled>.handle>a{color:#8a6d3b!important}.blur{-webkit-filter:blur(5px) grayscale(50%)}.pointer{cursor:pointer}.no-border{border:0!important}.bordered{border:1px solid}ul.block,ul.error-list{list-style:none outside none}ol.decimal{list-style:decimal inside}#profile-li ul,#profile-li>li,dd,dl,dt,ul,ul>li{padding:0}li.panel{margin-bottom:0!important;background:0 0;border:0}.list-style-none>li,ul.dropdown-menu,ul.dropdown-menu>li>ul{list-style:none}ul>li{list-style-position:inside}.icon-xs{font-size:16px!important;width:16px}.icon-sm{font-size:32px!important;width:32px}.icon-md{font-size:48px!important;width:48px}.icon-lg{font-size:128px!important;width:128px}.icon-xl{font-size:256px!important;width:256px}.HTML-img:hover ul.dropdown-menu,.clearfix,tr:hover>td .tbl_actions{display:block}.clearfix:after,li:after{visibility:hidden;display:block;font-size:0;content:\" \";clear:both;height:0}* html,* html .clearfix{zoom:1}* html .floatfix{width:100%}.no-opacity,.opacity-none{opacity:0}.low-opacity{opacity:.2}.mid-opacity{opacity:.45}.high-opacity{opacity:.8}.full-opacity{opacity:1}#profile-li>li>a{padding:8px 3px;width:100%;outline:0}.select2-input{color:#999!important;border:0!important}.select2-offscreen{display:none}.tbl{display:table-cell!important}.required{color:red!important}a img{border:0}dd,dl,dt{margin:0;overflow:hidden}.animated-height{-webkit-transition:height .2s;transition:height .2s}.user-tooltip{width:250px;padding-bottom:10px}.form-inline>.form-group{width:auto!important}table{font-size:100%}.icon-wrapper img{max-width:48px;margin:15px auto 5px}.icon-wrapper>.icon-container{text-align:center}.tablesorter-default .header,.tablesorter-default .tablesorter-header{background:url(data:image/gif;base64,R0lGODlhFQAJAIAAACMtMP///yH5BAEAAAEALAAAAAAVAAkAAAIXjI+AywnaYnhUMoqt3gZXPmVg94yJVQAAOw==) no-repeat center right}.tablesorter-default thead .headerSortUp,.tablesorter-default thead .tablesorter-headerAsc,.tablesorter-default thead .tablesorter-headerSortUp{background:url(data:image/gif;base64,R0lGODlhFQAEAIAAACMtMP///yH5BAEAAAEALAAAAAAVAAQAAAINjI8Bya2wnINUMopZAQA7) no-repeat center right}.tablesorter-default thead .headerSortDown,.tablesorter-default thead .tablesorter-headerDesc,.tablesorter-default thead .tablesorter-headerSortDown{background:url(data:image/gif;base64,R0lGODlhFQAEAIAAACMtMP///yH5BAEAAAEALAAAAAAVAAQAAAINjB+gC+jP2ptn0WskLQA7) no-repeat center right}td.min,th.min{width:1%}.image-wrap{position:relative;overflow:hidden;width:100%}.image-wrap.cropfix{max-width:100%!important;margin:0!important}.word-break{word-break:break-all;word-wrap:break-word}.no-break{white-space:nowrap}.sl{margin:20px 0}.sl .uip{margin:5px 0}.side>li img,.sl>li img{width:19px;margin-right:8px!important}.stacked{display:inline-block;width:auto;margin-right:10px}.icon-stack{position:relative;display:inline-block;width:100%;line-height:2em;vertical-align:middle;text-align:center}.icon-stack>.icon,.icon-stack>.icon::before{position:absolute;top:50%;-webkit-transform:translateY(-50%);-ms-transform:translateY(-50%);transform:translateY(-50%);width:100%;text-align:center;left:0;margin:0}.clearBg{background-color:transparent!important}.whiteBg{background-color:#fff!important}.btn-modal.btn-file{border:1px dashed #ccc;width:100%}.file-preview-frame{display:block!important}.panel>.file-preview{border:transparent}.file-preview-image{width:100%;height:200px}.file-input .panel{width:200px}.file-input .panel .file-preview-image{display:inline-block;max-width:100%;vertical-align:middle}.file-input .panel .file-default-preview,.file-input .panel .file-preview-frame,.file-input .panel .file-preview-other{height:143px;max-height:143px;width:100%;display:block;margin:0;border:0;box-shadow:none;padding:0;float:none;overflow:hidden}.file-input img{height:100%;width:auto;margin:0 auto}.comments-form-panel,.comments-panel{margin-bottom:20px}.arrow_box,.comments-form-header,.comments-header{position:relative;padding:10px 0}.comments-form-header:after,.comments-form-header:before,.comments-header:after,.comments-header:before{top:100%;left:5%;border:solid transparent;content:\" \";height:0;width:0;position:absolute;pointer-events:none}.arrow_box{background:#fff;border:1px solid #ddd;margin-left:15px;margin-bottom:20px;padding:3px 15px 15px}.arrow_box:after,.arrow_box:before{right:100%;top:33%;content:\" \";height:0;width:0;position:absolute;pointer-events:none}.arrow_box:after{border:12px transparent;border-right-color:#fff;margin-top:-12px}.arrow_box:before{border:14px transparent;border-right-color:#ddd;margin-top:-14px}.comment-actions{margin-top:10px}.comment-actions>.btn-group{display:-webkit-inline-box;display:inline-flex}.comments_reply_form{margin-bottom:30px}.panel-txtarea .preview-response{background-color:#f5f4f4;word-wrap:break-word;word-break:break-all}.panel-txtarea .bbcode{margin:5px 1px}.editor-wrapper .nav{display:inline-block;float:right;padding:0}.editor-wrapper .panel-footer,.editor-wrapper .panel-heading{background:0 0}.media-container{overflow:hidden;border:3px solid transparent}.media-container.selected{border:3px solid #3879d9}.media-container,.media-container img,ul.navbar-nav li.no-link{position:relative}.shoutboxwrapper{margin-top:20px;word-wrap:break-word}ul>li.divider{display:block;height:10px;border-bottom:1px solid #ddd}#delete_status-field{float:left;width:auto;margin-bottom:0}.logo-xs-left{text-align:left}.logo-xs-center{text-align:center;margin-left:auto;margin-right:auto}.logo-xs-right{text-align:right}@media (min-width:768px){.logo-sm-left{text-align:left}.logo-sm-center{text-align:center;margin-left:auto;margin-right:auto}.logo-sm-right{text-align:right}}@media (min-width:992px){.logo-md-left{text-align:left}.logo-md-center{text-align:center;margin-left:auto;margin-right:auto}.logo-md-right{text-align:right}}@media (min-width:1200px){.logo-lg-left{text-align:left}.logo-lg-center{text-align:center;margin-left:auto;margin-right:auto}.logo-lg-right{text-align:right}}.control-label>img,label img{margin-right:5px;max-width:24px}.text-overflow-hide{overflow:hidden;text-overflow:ellipsis}.order-caret-down-current:hover:after,.order-caret-up-current:after,.order-caret-up:hover:after{font-family:'FontAwesome 5 Free',sans-serif;content:'\\f0d8';display:inline-block;color:#23282d;margin-left:10px}.order-caret-down-current:after,.order-caret-down:hover:after,.order-caret-up-current:hover:after{font-family:'FontAwesome 5 Free',sans-serif;content:'\\f0d7';display:inline-block;color:#23282d;margin-left:10px}.tbl_actions{display:none}.tbl_actions>span:after{content:\"|\";display:inline-block;padding:0 5px;color:#ccc}.tbl_actions>span:last-child:after{content:\"\"}.text-normal label{font-weight:400}.thumb>img{display:block;width:100%}.avatar.img-rounded>svg{border-radius:6px}.avatar.img-circle>svg{border-radius:50%}.rank-label{padding:6px 10px}.rank-label>.detail{background:rgba(0,0,0,.1);margin:0 -10px 0 10px;padding:7px 12px;border-radius:0 .28571429rem .28571429rem 0;display:inline-block;font-weight:700;opacity:.8}.rank-label.label-super-admin{background-color:#504cc7}.rank-label.label-mod{background-color:#00b5ad;border-color:#00b5ad}.rank-label.label-member{background-color:#2185d0;border-color:#2185d0}#site-links{min-height:20px}#site-links li{display:block;margin:30px;padding:10px}#panel-side1 li img.handle,#panel-side2 li img.handle,#panel-side3 li img.handle,#panel-side4 li img.handle,#panel-side5 li img.handle,#panel-side6 li img.handle,#site-links li img.handle{cursor:ns-resize}.state-highlight{background:#ffc;height:20px}.floatfix{overflow:hidden}#panel-side1,#panel-side2,#panel-side3,#panel-side4,#panel-side5,#panel-side6,#site-links{list-style:none;height:auto!important}#panel-side1 li,#panel-side2 li,#panel-side3 li,#panel-side4 li,#panel-side5 li,#panel-side6 li{display:block}html[dir=rtl] body{direction:rtl}html[dir=rtl] .pull-left{float:right!important}html[dir=rtl] .pull-right{float:left!important}html[dir=rtl] .center-x{left:inherit;right:50%;-webkit-transform:translateX(50%);-ms-transform:translateX(50%);transform:translateX(50%)}html[dir=rtl] .center-xy{left:inherit;right:50%;-webkit-transform:translate(50%,-50%);-ms-transform:translate(50%,-50%);transform:translate(50%,-50%)}.admin-form-type-1{display:-ms-grid;display:grid;-ms-grid-columns:70% 30%;grid-template-columns:70% 30%}@media (max-width:991px){.admin-form-type-1{-ms-grid-columns:1fr;grid-template-columns:1fr}}"], "buggy_code_start_loc": [23, 29, 19, 29, 86, 32, 31, 26, 88, 34, 68, 111, 56, 79, 1], "buggy_code_end_loc": [24, 29, 32, 29, 86, 33, 31, 27, 88, 34, 68, 530, 56, 79, 2], "fixing_code_start_loc": [23, 30, 20, 30, 87, 33, 32, 27, 89, 35, 69, 112, 57, 80, 1], "fixing_code_end_loc": [24, 32, 31, 32, 89, 37, 35, 32, 100, 37, 73, 535, 59, 83, 2], "type": "CWE-352", "message": "CSRF + Cross-site scripting (XSS) vulnerability in search.php in PHPFusion 9.03.110 allows remote attackers to inject arbitrary web script or HTML", "other": {"cve": {"id": "CVE-2021-28280", "sourceIdentifier": "cve@mitre.org", "published": "2021-04-29T15:15:10.957", "lastModified": "2022-04-25T20:16:01.227", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "CSRF + Cross-site scripting (XSS) vulnerability in search.php in PHPFusion 9.03.110 allows remote attackers to inject arbitrary web script or HTML"}, {"lang": "es", "value": "CSRF + Una vulnerabilidad de Cross-site scripting (XSS) en el archivo search.php en PHPFusion versi\u00f3n 9.03.110, permite a atacantes remotos inyectar script web o HTML arbitrario"}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 6.1, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 2.7}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:M/Au:N/C:N/I:P/A:N", "accessVector": "NETWORK", "accessComplexity": "MEDIUM", "authentication": "NONE", "confidentialityImpact": "NONE", "integrityImpact": "PARTIAL", "availabilityImpact": "NONE", "baseScore": 4.3}, "baseSeverity": "MEDIUM", "exploitabilityScore": 8.6, "impactScore": 2.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": true}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-352"}, {"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:php-fusion:phpfusion:9.03.110:*:*:*:*:*:*:*", "matchCriteriaId": "29149A91-66BD-4C42-9D94-7EE9044F1727"}]}]}], "references": [{"url": "https://anotepad.com/notes/2skndayt", "source": "cve@mitre.org", "tags": ["Exploit", "Third Party Advisory"]}, {"url": "https://github.com/PHPFusion/PHPFusion/commit/08d6c2ea49bd06fcce32275252f5f25abe61965c", "source": "cve@mitre.org", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://github.com/PHPFusion/PHPFusion/commit/1c2b32321cf11ed1cd3ff835f8da0d172c849ce6", "source": "cve@mitre.org", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://github.com/PHPFusion/PHPFusion/commit/da9f89ae70219f357fba6fffd2dae1ec886d8a3b", "source": "cve@mitre.org", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://github.com/PHPFusion/PHPFusion/commit/fda266c3bb35c650a8c4c51b6923abdfb66ef5cd", "source": "cve@mitre.org", "tags": ["Patch", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/PHPFusion/PHPFusion/commit/08d6c2ea49bd06fcce32275252f5f25abe61965c"}}